import{b as we,e as Be,g as Fe}from"./chunk-ZBFN4RUB.js";import{b as P}from"./chunk-3U6BMQLZ.js";import{b as Te,e as Q}from"./chunk-SUJDRDW4.js";import{a as Ie,b as Le}from"./chunk-MDCTC4QF.js";import{b as D}from"./chunk-KHTVZWEX.js";import{c as Ne}from"./chunk-B3W5V2XP.js";import{b as Ce}from"./chunk-KDLA3TQ2.js";import{a as Oe,c as Ae,d as Ee,e as Ve}from"./chunk-XZ52TEBV.js";import{b as J}from"./chunk-LCDA6FHZ.js";import{c as be,d as ye}from"./chunk-H7Y5XCPW.js";import{b as M}from"./chunk-JLNQ6WQT.js";import{a as ve}from"./chunk-IXBI5R7J.js";import{b as Me}from"./chunk-GYJJE3EF.js";import{a as Z,b as Se,g as w}from"./chunk-4OZVVJHM.js";import{b as Re}from"./chunk-E25QWDXZ.js";import{b as he,d as ge,f as z,i as K}from"./chunk-LCTRO7CL.js";import{a as de,g as $,p as pe}from"./chunk-NH3JQE75.js";import{a as xe}from"./chunk-XXOIKNT6.js";import{a as I,c as L}from"./chunk-DBLGLVAQ.js";import{F as oe,l as _}from"./chunk-EPTSNNZF.js";import{a as A}from"./chunk-I6LCIPDY.js";import{a as R}from"./chunk-7W6RATG7.js";import{g as fe}from"./chunk-HWN5REN7.js";import{c as W,d as ue,o as le,p as H,s as ce,t as me}from"./chunk-B4JAL745.js";import{a as se,e as ae,g as k,u as ie,x as ne,y as q}from"./chunk-2HUIJUS4.js";import{f as re}from"./chunk-5MNDZ6BX.js";import{a as N}from"./chunk-PYQRTZNZ.js";import{r as U}from"./chunk-5PTS4JDF.js";import{a as O,b as C,g as te}from"./chunk-JEGVIFEP.js";function B(t){if(t==null)return null;let r=t.offset!=null?t.offset:be,a=t.rotation!=null?t.rotation:0,s=t.scale!=null?t.scale:ye,c=L(1,0,0,0,1,0,r[0],r[1],1),m=L(Math.cos(a),-Math.sin(a),0,Math.sin(a),Math.cos(a),0,0,0,1),n=L(s[0],0,0,0,s[1],0,0,0,1),l=I();return $(l,m,n),$(l,c,l),l}var X=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},j=class{constructor(r,a,s){this.name=r,this.lodThreshold=a,this.pivotOffset=s,this.stageResources=new X,this.numberOfVertices=0}};function St(t,r){return te(this,null,function*(){let a=De(Re(t));if(a.fileType==="wosr"){let u=yield r.cache?r.cache.loadWOSR(a.url,r):Ie(a.url,r),{engineResources:d,referenceBoundingBox:x}=Le(u,r);return{lods:d,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let s;if(r.cache)s=yield r.cache.loadGLTF(a.url,r,!!r.usePBR);else{let{loadGLTF:u}=yield import("./chunk-7AS3D7PT.js");s=yield u(new ve(r.streamDataRequester),a.url,r,r.usePBR)}let c=s.model.meta?.ESRI_proxyEllipsoid,m=s.meta.isEsriSymbolResource&&c!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";m&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,ke(s,c));let n=!!r.usePBR,l=s.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:m,mrrFactors:Ve}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:Ae},i=C(O({},r.materialParameters),{treeRendering:m}),{engineResources:e,referenceBoundingBox:o}=je(s,l,i,r,a.specifiedLodIndex);return{lods:e,referenceBoundingBox:o,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}})}function De(t){let r=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return r?{fileType:"gltf",url:r[1],specifiedLodIndex:r[4]!=null?Number(r[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function je(t,r,a,s,c){let m=t.model,n=new Array,l=new Map,i=new Map,e=m.lods.length,o=oe();return m.lods.forEach((u,d)=>{let x=s.skipHighLods===!0&&(e>1&&d===0||e>3&&d===1)||s.skipHighLods===!1&&c!=null&&d!==c;if(x&&d!==0)return;let f=new j(u.name,u.lodThreshold,[0,0,0]);u.parts.forEach(p=>{let h=x?new D({},s):Ge(m,p,f,r,a,l,i,s),{geometry:T,vertexCount:y}=Ue(p,h??new D({},s)),g=T.boundingInfo;g!=null&&d===0&&(_(o,g.bbMin),_(o,g.bbMax)),h!=null&&(f.stageResources.geometries.push(T),f.numberOfVertices+=y)}),x||n.push(f)}),{engineResources:n,referenceBoundingBox:o}}function Ge(t,r,a,s,c,m,n,l){let i=r.material+(r.attributes.normal?"_normal":"")+(r.attributes.color?"_color":"")+(r.attributes.texCoord0?"_texCoord0":"")+(r.attributes.tangent?"_tangent":""),e=t.materials.get(r.material),o=r.attributes.texCoord0!=null,u=r.attributes.normal!=null;if(e==null)return null;let d=_e(e.alphaMode);if(!m.has(i)){if(o){let F=(V,Pe=!1)=>{if(V!=null&&!n.has(V)){let G=t.textures.get(V);if(G!=null){let b=G.data;n.set(V,new Ce(P(b)?b.data:b,C(O({},G.parameters),{preMultiplyAlpha:!P(b)&&Pe,encoding:P(b)&&b.encoding!=null?b.encoding:void 0})))}}};F(e.textureColor,d!==w.Opaque),F(e.textureNormal),F(e.textureOcclusion),F(e.textureEmissive),F(e.textureMetallicRoughness)}let f=e.color[0]**(1/2.1),p=e.color[1]**(1/2.1),h=e.color[2]**(1/2.1),T=e.emissiveFactor[0]**(1/2.1),y=e.emissiveFactor[1]**(1/2.1),g=e.emissiveFactor[2]**(1/2.1),E=e.textureColor!=null&&o?n.get(e.textureColor):null,Y=Oe({normalTexture:e.textureNormal,metallicRoughnessTexture:e.textureMetallicRoughness,metallicFactor:e.metallicFactor,roughnessFactor:e.roughnessFactor,emissiveTexture:e.textureEmissive,emissiveFactor:e.emissiveFactor,occlusionTexture:e.textureOcclusion}),ee=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:fe;m.set(i,new D(O(C(O({},s),{transparent:d===w.Blend,customDepthTest:Se.Lequal,textureAlphaMode:d,textureAlphaCutoff:e.alphaCutoff,diffuse:[f,p,h],ambient:[f,p,h],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?Z.None:Z.Back,hasVertexColors:!!r.attributes.color,hasVertexTangents:!!r.attributes.tangent,normalType:u?J.Attribute:J.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclustion,textureId:E?.id,colorMixMode:e.colorMixMode,normalTextureId:e.textureNormal!=null&&o?n.get(e.textureNormal).id:void 0,textureAlphaPremultiplied:E!=null&&!!E.parameters.preMultiplyAlpha,occlusionTextureId:e.textureOcclusion!=null&&o?n.get(e.textureOcclusion).id:void 0,emissiveTextureId:e.textureEmissive!=null&&o?n.get(e.textureEmissive).id:void 0,metallicRoughnessTextureId:e.textureMetallicRoughness!=null&&o?n.get(e.textureMetallicRoughness).id:void 0,emissiveFactor:[T,y,g],mrrFactors:Y?Ee:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:Y,colorTextureTransformMatrix:B(e.colorTextureTransform),normalTextureTransformMatrix:B(e.normalTextureTransform),scale:[ee[0],ee[1]],occlusionTextureTransformMatrix:B(e.occlusionTextureTransform),emissiveTextureTransformMatrix:B(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:B(e.metallicRoughnessTextureTransform)}),c),l))}let x=m.get(i);if(a.stageResources.materials.push(x),o){let f=p=>{p!=null&&a.stageResources.textures.push(n.get(p))};f(e.textureColor),f(e.textureNormal),f(e.textureOcclusion),f(e.textureEmissive),f(e.textureMetallicRoughness)}return x}function Ue(t,r){let a=t.attributes.position.count,s=Fe(t.indices||a,t.primitiveType),c=A(3*a),{typedBuffer:m,typedBufferStride:n}=t.attributes.position;he(c,m,t.transform,3,n);let l=[[R.POSITION,new M(c,s,3,!0)]];if(t.attributes.normal!=null){let e=A(3*a),{typedBuffer:o,typedBufferStride:u}=t.attributes.normal;pe(S,t.transform),ge(e,o,S,3,u),U(S)&&K(e,e),l.push([R.NORMAL,new M(e,s,3,!0)])}if(t.attributes.tangent!=null){let e=A(4*a),{typedBuffer:o,typedBufferStride:u}=t.attributes.tangent;de(S,t.transform),Te(e,o,S,4,u),U(S)&&K(e,e,4),l.push([R.TANGENT,new M(e,s,4,!0)])}if(t.attributes.texCoord0!=null){let e=A(2*a),{typedBuffer:o,typedBufferStride:u}=t.attributes.texCoord0;we(e,o,2,u),l.push([R.UV0,new M(e,s,2,!0)])}let i=t.attributes.color;if(i!=null){let e=new Uint8Array(4*a);i.elementCount===4?i instanceof ue?Q(e,i,255):i instanceof H?Be(e,i):i instanceof me&&Q(e,i,1/256):(e.fill(255),i instanceof W?z(e,i.typedBuffer,255,4,i.typedBufferStride):t.attributes.color instanceof le?Me(e,i.typedBuffer,4,t.attributes.color.typedBufferStride):t.attributes.color instanceof ce&&z(e,i.typedBuffer,1/256,4,i.typedBufferStride)),l.push([R.COLOR,new M(e,s,4,!0)])}return{geometry:new Ne(r,l),vertexCount:a}}var S=I();function _e(t){switch(t){case"BLEND":return w.Blend;case"MASK":return w.Mask;case"OPAQUE":case null:case void 0:return w.Opaque}}function ke(t,r){for(let a=0;a<t.model.lods.length;++a){let s=t.model.lods[a];for(let c of s.parts){let m=c.attributes.normal;if(m==null)return;let n=c.attributes.position,l=n.count,i=N(),e=N(),o=N(),u=new Uint8Array(4*l),d=new Float64Array(3*l),x=re(xe(),c.transform),f=0,p=0;for(let h=0;h<l;h++){n.getVec(h,e),m.getVec(h,i),q(e,e,c.transform),ae(o,e,r.center),k(o,o,r.radius);let T=o[2],y=se(o),g=Math.min(.45+.55*y*y,1);k(o,o,r.radius),x!==null&&q(o,o,x),ie(o,o),a+1!==t.model.lods.length&&t.model.lods.length>1&&ne(o,o,i,T>-1?.2:Math.min(-4*T-3.8,1)),d[f]=o[0],d[f+1]=o[1],d[f+2]=o[2],f+=3,u[p]=255*g,u[p+1]=255*g,u[p+2]=255*g,u[p+3]=255,p+=4}c.attributes.normal=new W(d),c.attributes.color=new H(u)}}}export{B as a,St as b,De as c};
