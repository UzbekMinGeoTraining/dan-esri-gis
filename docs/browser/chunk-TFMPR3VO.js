import{a as A}from"./chunk-UFJ62PBU.js";import{a as j}from"./chunk-QN72YLVS.js";import{a as F}from"./chunk-4OP3NYKC.js";import{a as C,b as O,c as b,d as L,e as U,g as E,h as M}from"./chunk-VAL6FFWA.js";import{b as v}from"./chunk-G54NHNUC.js";import"./chunk-NPHNUKYC.js";import{a as P}from"./chunk-4IUQ56CO.js";import{a as w}from"./chunk-2K35ZAGK.js";import"./chunk-E3DN7XQP.js";import"./chunk-XH7FW5RT.js";import{n as G}from"./chunk-GT4Y5PVV.js";import{c as W}from"./chunk-VGH5GCLB.js";import"./chunk-FPU7DPG3.js";import"./chunk-ZZBU366R.js";import"./chunk-SVK2E2V5.js";import"./chunk-PA5IAWXD.js";import"./chunk-AR3SF3CU.js";import"./chunk-WP7QHDBV.js";import"./chunk-AJSXTGZB.js";import{a as S}from"./chunk-JU3UMX5L.js";import"./chunk-QPPQKNYU.js";import"./chunk-RIUAG34V.js";import"./chunk-EHDNZUTT.js";import"./chunk-NH7OOX2I.js";import"./chunk-RNN6GAXL.js";import"./chunk-4IVMQ5PX.js";import"./chunk-CQUOQXLP.js";import"./chunk-5DAF2FXI.js";import"./chunk-VI4TDFI5.js";import"./chunk-2HN33SWB.js";import"./chunk-523X5JOP.js";import"./chunk-BXR2KKYP.js";import"./chunk-U3ETEC6R.js";import"./chunk-OC7V2CEX.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-GB5RQL32.js";import"./chunk-25T3ULWN.js";import"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-AYOI2Y26.js";import"./chunk-IH2TDIRR.js";import"./chunk-3FCM74ZB.js";import"./chunk-6EZNY6L4.js";import"./chunk-MBVOWLUI.js";import"./chunk-EN6CTWVM.js";import"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-EBGO44EK.js";import"./chunk-7W6RATG7.js";import{k as g}from"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-2HUIJUS4.js";import{d as z}from"./chunk-MBJHSEMD.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-LAJXTVEO.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as d}from"./chunk-GGZQ5GCM.js";import{U as R}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as m}from"./chunk-BMVJCP2M.js";import"./chunk-GMC3I5VG.js";import{c as o}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{t as I}from"./chunk-3IBUFXWY.js";import"./chunk-BP73DJTS.js";import{a as x,b as T,g as _}from"./chunk-JEGVIFEP.js";var D={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"},f=class{constructor(e,t,r=null,a=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=r||t.width,this.height=a||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=o(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?T(x({},D),{maxCutOff:[1,1,1],factor:[1,1,1]}):this._symbolizerParameters||D}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((t,r)=>!!this._bandIds?.[r]&&t===this._bandIds[r])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){let t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?g.LINEAR:g.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=o(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=O(e,this.transformGrid))),!0)}getUniforms(){let{symbolizerParameters:e,transformGrid:t,width:r,height:a,opacity:i}=this,u=L(t,[r,a],[this.source.width,this.source.height],i),p=U(e.colormap,e.colormapOffset),c=this.symbolizerParameters.type==="stretch"?E(this.symbolizerParameters):null,l=this.symbolizerParameters.type==="hillshade"?M(this.symbolizerParameters):null;return new W(u,p,c||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){let{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){let e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>t!=null?t.descriptor.width*t.descriptor.height*4:0).reduce((t,r)=>t+r,0)}return this._memoryUsed}release(){return this._rasterTexture=o(this._rasterTexture),this._transformGridTexture=o(this._transformGridTexture),this._colormapTexture=o(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){let r=this.source?this.source.extractBands(t):null;if(!(r?.pixels&&r.pixels.length>0))return void(this._rasterTexture=o(this._rasterTexture));let a=t==null&&this.bandIds==null||t!=null&&this.bandIds!=null&&t.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&a)return;this._rasterTexture=o(this._rasterTexture);let i=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=C(e,r,i,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){let t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some((a,i)=>a!==t[i])?(this._colormapTexture=o(this._colormapTexture),this._colormapTexture=b(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=b(e,r),void(this._colormap=r)):(this._colormapTexture=o(this._colormapTexture),void(this._colormap=null))}};var h=class extends F(P(A(j(w)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new I("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));let s=z(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{let e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t),this.tileInfo=this._isAlignedMapTile?t:e.toTileInfo(),this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(s)}destroy(){this.layer.decreaseRasterJobHandlerUsage()}get _blankTile(){let s=document.createElement("canvas"),e=s.getContext("2d"),[t,r]=this.tileInfo.size;return s.width=t,s.height=r,e.clearRect(0,0,t,r),e.getImageData(0,0,t,r)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){let s=this.layer.tileInfo,e=this.tileInfo.lodAt(0)?.scale,t=this.layer.tileInfo.lodAt(s.lods.length-1)?.scale;return this.levelRangeFromScaleRange(e,t)}_getFullExtent(){return G(this.layer.serviceRasterInfo,this.view.basemapTerrain?.spatialReference??this.view.spatialReference)}fetchTile(s,e){return _(this,null,function*(){let t=this.tileInfo,r=this._canSymbolizeInWebGL(),a={tileInfo:t,requestRawData:r,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,noClip:!1},{layer:i}=this,[u,p,c]=s,l=yield i.fetchTile(u,p,c,a);if(l instanceof HTMLImageElement)return l;let y=l?.pixelBlock;if(y==null)return this._blankTile;if(!r&&(y=yield i.applyRenderer(l),y==null))return this._blankTile;let n=new f([u,p,c],y,t.size[0],t.size[1]);return r?(n.symbolizerRenderer=i.symbolizer.rendererJSON,n.symbolizerParameters=i.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(u)),n.transformGrid=l.transformGrid,n.bandIds=i.bandIds):(n.isRendereredSource=!0,n.bandIds=null),n.interpolation=i.interpolation,n})}_getSymbolizerOptions(s){let e=this.tileInfo.lodAt(s).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(s){this._canSymbolizeInWebGL()&&JSON.stringify(s.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(s.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(s.lij[0])))}createFetchPopupFeaturesQueryGeometry(s,e){return v(s,e,this.view)}refresh(){this.emit("data-changed")}doRefresh(){return _(this,null,function*(){this.suspended||this.emit("data-changed")})}_canSymbolizeInWebGL(){let s=S(),{symbolizer:e}=this.layer,t=e.lookup?.colormapLut?.indexedColormap,r=!!this.layer.rasterFunction?.hasClipFunction,a=t&&t.length>4*(s.maxTextureSize||4906);return e.canRenderInWebGL&&!a&&!r}};m([d({readOnly:!0})],h.prototype,"_blankTile",null),m([d({readOnly:!0})],h.prototype,"imageFormatIsOpaque",null),m([d({readOnly:!0})],h.prototype,"hasMixedImageFormats",null),m([d({readOnly:!0})],h.prototype,"dataLevelRange",null),h=m([R("esri.views.3d.layers.ImageryTileLayerView3D")],h);var me=h;export{me as default};
