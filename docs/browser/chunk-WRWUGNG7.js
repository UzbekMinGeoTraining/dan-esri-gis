import{a as it}from"./chunk-ZCE2OBOD.js";import{a as Z,b as tt,c as et}from"./chunk-P23AVMP5.js";import{a as N}from"./chunk-Q3NMBEU5.js";import"./chunk-JJAB4LLX.js";import{a as O}from"./chunk-6CHPT7MV.js";import"./chunk-NPHNUKYC.js";import"./chunk-WG27BEYC.js";import"./chunk-SK2WDIND.js";import"./chunk-ZBUUWISZ.js";import"./chunk-4UETQE5S.js";import{a as Y}from"./chunk-LZIELIAD.js";import{a as X}from"./chunk-AX5HXU45.js";import{a as J}from"./chunk-SYFXCRCK.js";import{a as Q}from"./chunk-4IUQ56CO.js";import{h as G}from"./chunk-E43YKIMQ.js";import"./chunk-RFOCIEHJ.js";import{b as W}from"./chunk-PVABL2SE.js";import{a as K}from"./chunk-2K35ZAGK.js";import{a as H}from"./chunk-GWZW2BMM.js";import"./chunk-RFGESQQ6.js";import"./chunk-B2T4EZY6.js";import"./chunk-DKD4OKJ2.js";import"./chunk-E3DN7XQP.js";import"./chunk-XH7FW5RT.js";import{f as $}from"./chunk-GT4Y5PVV.js";import{B as L,D as M,q as U}from"./chunk-CAC75TDU.js";import"./chunk-AFJD7CUR.js";import"./chunk-AN522XY4.js";import"./chunk-BYXBJQAS.js";import"./chunk-DI7IQ2JQ.js";import"./chunk-4HNIM6ZU.js";import"./chunk-RNEZKVER.js";import"./chunk-PX37YUF5.js";import"./chunk-6FC373YD.js";import"./chunk-J2D4NQQB.js";import"./chunk-7YHK56KB.js";import"./chunk-PHK5IJNU.js";import"./chunk-OH475TQV.js";import"./chunk-ACVF7Z7X.js";import"./chunk-DSHXH3B4.js";import"./chunk-AJSXTGZB.js";import"./chunk-CO3N3TAZ.js";import"./chunk-TPSXW4OU.js";import"./chunk-IWNXLWJE.js";import"./chunk-TCQSMTOV.js";import{b as q}from"./chunk-JLO7PPGZ.js";import"./chunk-NRJMGJMB.js";import"./chunk-YNYZNNM2.js";import"./chunk-2F2E6NNR.js";import"./chunk-JU3UMX5L.js";import{c as j}from"./chunk-2LC7VTRT.js";import"./chunk-SDC4SION.js";import"./chunk-F5CPBNZH.js";import"./chunk-5DAF2FXI.js";import"./chunk-BYXBJQAS.js";import"./chunk-X4WWRRJM.js";import"./chunk-UUKQEAQR.js";import"./chunk-PY5WUUCV.js";import"./chunk-M4PATAW3.js";import"./chunk-74RJCD5E.js";import"./chunk-NN4OC7FN.js";import"./chunk-Z5PXCHKK.js";import"./chunk-KCNSUZFF.js";import"./chunk-243IQYOZ.js";import"./chunk-6BV3ATJ4.js";import"./chunk-YNTLVJOI.js";import"./chunk-PVCDKA4D.js";import"./chunk-TTXY6GKV.js";import"./chunk-H7Y5XCPW.js";import"./chunk-UJ2T4QLZ.js";import"./chunk-26R336GJ.js";import"./chunk-FPZYH52G.js";import"./chunk-OC7V2CEX.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-4TKIIMKN.js";import"./chunk-PXLEIVAM.js";import"./chunk-CA2IXN6Q.js";import"./chunk-AXPRNSO3.js";import"./chunk-3HX6VT75.js";import"./chunk-U4Y7WABQ.js";import"./chunk-WYOOSF42.js";import"./chunk-R7P6RQXJ.js";import"./chunk-25T3ULWN.js";import"./chunk-QBRYULPI.js";import{a as y}from"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-NH3JQE75.js";import"./chunk-AYOI2Y26.js";import"./chunk-IH2TDIRR.js";import"./chunk-3FCM74ZB.js";import"./chunk-ZGDQY5ZD.js";import"./chunk-QH2MD2O2.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import"./chunk-7XLHE26H.js";import"./chunk-EN6CTWVM.js";import"./chunk-LVPMJTA6.js";import"./chunk-7LUQF6AI.js";import"./chunk-6GGK7PRJ.js";import"./chunk-PFIMJ2UL.js";import"./chunk-CY477QBZ.js";import"./chunk-EJO53FLN.js";import"./chunk-XXR5OT24.js";import"./chunk-4XIZVPNF.js";import"./chunk-F7VAE37R.js";import"./chunk-PM4ZR7W6.js";import"./chunk-ENLR2WBX.js";import"./chunk-RI3FIROF.js";import"./chunk-PJX4LNSV.js";import"./chunk-NNETCWLJ.js";import"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-EBGO44EK.js";import"./chunk-THY6AAMN.js";import"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-XTES2GPX.js";import"./chunk-2HUIJUS4.js";import{a as w,g as B,i as T}from"./chunk-MBJHSEMD.js";import"./chunk-K72LO6P2.js";import"./chunk-SEKMXZL5.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-5MNDZ6BX.js";import"./chunk-RDHMB7M5.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import{c as D}from"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import{y as _}from"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import{o as z}from"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import{k as F}from"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as s,S as f}from"./chunk-GGZQ5GCM.js";import{U as c}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as r}from"./chunk-BMVJCP2M.js";import{D as I,a as S,t as u}from"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{r as d}from"./chunk-3IBUFXWY.js";import{a as C}from"./chunk-BP73DJTS.js";import{a as k,b as A,g as p}from"./chunk-JEGVIFEP.js";var h=class extends f{constructor(){super(...arguments),this.attached=!1,this.container=new H,this.updateRequested=!1,this.type="imagery",this._bitmapView=new X}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this.strategy.update(t).catch(e=>{u(e)||d.getLogger(this).error(e)})}hitTest(t){return new y({attributes:{},geometry:t.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView);let t=this.layer.version>=10,e=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,i=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this.strategy=new Y({container:this._bitmapView,imageNormalizationSupported:t,imageMaxHeight:e,imageMaxWidth:i,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports(t=>p(this,null,function*(){let{source:e}=t;if(!e||e instanceof ImageBitmap)return;let i=yield this.layer.applyRenderer({extent:e.extent,pixelBlock:e.originalPixelBlock??e.pixelBlock});e.filter=a=>this.layer.pixelFilter?this.layer.applyFilter(a):A(k({},i),{extent:e.extent})})).catch(t=>{u(t)||d.getLogger(this).error(t)})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;let t=this.strategy.bitmaps;if(t.length===1&&t[0].source)return{extent:t[0].source.extent,pixelBlock:t[0].source.originalPixelBlock};if(t.length>1){let e=this.view.extent,i=t.map(o=>o.source).filter(o=>o.extent&&o.extent.intersects(e)).map(o=>({extent:o.extent,pixelBlock:o.originalPixelBlock})),a=U(i,e);return a!=null?{extent:a.extent,pixelBlock:a.pixelBlock}:null}return null}_fetchImage(t,e,i,a){return p(this,null,function*(){(a=a||{}).timeExtent=this.timeExtent,a.requestAsImageElement=!0,a.returnImageBitmap=!0;let o=yield this.layer.fetchImage(t,e,i,a);if(o.imageBitmap)return o.imageBitmap;let n=yield this.layer.applyRenderer(o.pixelData,{signal:a.signal}),l=new J(n.pixelBlock,n.extent?.clone(),o.pixelData.pixelBlock);return l.filter=v=>this.layer.applyFilter(v),l})}};r([s()],h.prototype,"attached",void 0),r([s()],h.prototype,"container",void 0),r([s()],h.prototype,"layer",void 0),r([s()],h.prototype,"strategy",void 0),r([s()],h.prototype,"timeExtent",void 0),r([s()],h.prototype,"view",void 0),r([s()],h.prototype,"updateRequested",void 0),r([s()],h.prototype,"updating",null),r([s()],h.prototype,"type",void 0),h=r([c("esri.views.2d.layers.imagery.ImageryView2D")],h);var rt=h;var P=class extends G{constructor(){super(...arguments),this.symbolTypes=["triangle"]}prepareRenderPasses(e){let i=e.registerRenderPass({name:"imagery (vf)",brushes:[tt],target:()=>this.children,drawPhase:q.MAP});return[...super.prepareRenderPasses(e),i]}doRender(e){this.visible&&e.drawPhase===q.MAP&&this.symbolTypes.forEach(i=>{e.renderPass=i,super.doRender(e)})}};var g=class extends f{constructor(t){super(t),this._loading=null,this.update=I((e,i)=>this._update(e,i).catch(a=>{u(a)||d.getLogger(this).error(a)}))}get updating(){return!!this._loading}redraw(t){if(!this.container.children.length)return;let e=this.container.children[0];e.symbolizerParameters=t,e.invalidateVAO(),this.container.symbolTypes=t.style==="wind_speed"?["scalar","triangle"]:t.style==="simple_scalar"?["scalar"]:["triangle"],this.container.requestRender()}_update(t,e,i){return p(this,null,function*(){if(!t.stationary)return;let{extent:a,spatialReference:o}=t.state,n=new _({xmin:a.xmin,ymin:a.ymin,xmax:a.xmax,ymax:a.ymax,spatialReference:o}),[l,v]=t.state.size;this._loading=this.fetchPixels(n,l,v,i);let V=yield this._loading;this._addToDisplay(V,e,t.state),this._loading=null})}_addToDisplay(t,e,i){if(t.pixelBlock==null)return this.container.children.forEach(l=>l.destroy()),void this.container.removeAllChildren();let{extent:a,pixelBlock:o}=t,n=new et(o);n.offset=[0,0],n.symbolizerParameters=e,n.rawPixelData=t,n.invalidateVAO(),n.x=a.xmin,n.y=a.ymax,n.pixelRatio=i.pixelRatio,n.rotation=i.rotation,n.resolution=i.resolution,n.width=o.width*e.symbolTileSize,n.height=o.height*e.symbolTileSize,this.container.children.forEach(l=>l.destroy()),this.container.removeAllChildren(),this.container.symbolTypes=e.style==="wind_speed"?["scalar","triangle"]:e.style==="simple_scalar"?["scalar"]:["triangle"],this.container.addChild(n)}};r([s()],g.prototype,"fetchPixels",void 0),r([s()],g.prototype,"container",void 0),r([s()],g.prototype,"_loading",void 0),r([s()],g.prototype,"updating",null),g=r([c("esri.views.2d.layers.imagery.ImageryVFStrategy")],g);var at=g;var m=class extends f{constructor(){super(...arguments),this.attached=!1,this.container=new P,this.type="imageryVF",this._dataParameters={exportParametersVersion:0,bbox:"",symbolTileSize:0,time:""},this._fetchpixels=(t,e,i,a)=>p(this,null,function*(){let o=yield this._projectFullExtentPromise,{symbolTileSize:n}=this.layer.renderer,{extent:l,width:v,height:V}=M(t,e,i,n,o);if(o!=null&&!o.intersects(t))return{extent:l,pixelBlock:null};let R={bbox:`${l.xmin}, ${l.ymin}, ${l.xmax}, ${l.ymax}`,exportParametersVersion:this.layer.exportImageServiceParameters.version,symbolTileSize:n,time:JSON.stringify(this.timeExtent||"")};if(this._canReuseVectorFieldData(R)){let x=this.getPixelData();if(x!=null&&`${x.extent.xmin}, ${x.extent.ymin}, ${x.extent.xmax}, ${x.extent.ymax}`===R.bbox)return x}let{pixelData:ot}=yield this.layer.fetchImage(l,v,V,{timeExtent:this.timeExtent,requestAsImageElement:!1,signal:a});this._dataParameters=R;let E=ot?.pixelBlock;return E==null?{extent:l,pixelBlock:null}:{extent:l,pixelBlock:this.layer.rasterInfo.dataType==="vector-uv"?L(E,"vector-uv"):E}})}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new at({container:this.container,fetchPixels:this._fetchpixels}),this.addHandles(w(()=>this.layer.renderer,t=>this._updateSymbolizerParams(t),T),"attach")}detach(){this._strategy.destroy(),this.container.children.forEach(t=>t.destroy()),this.container.removeAllChildren(),this.removeHandles("attach"),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){let t=this.container.children[0]?.rawPixelData;if(this.updating||!t)return null;let{extent:e,pixelBlock:i}=t;return{extent:e,pixelBlock:i}}hitTest(t){return new y({attributes:{},geometry:t.clone(),layer:this.layer})}update(t){this._strategy.update(t,this._symbolizerParams).catch(e=>{u(e)||d.getLogger(this).error(e)})}redraw(){let{renderer:t}=this.layer;t&&(this._updateSymbolizerParams(t),this._strategy.redraw(this._symbolizerParams))}_canReuseVectorFieldData(t){let e=this._dataParameters.exportParametersVersion===t.exportParametersVersion,i=this._dataParameters.time===t.time,a=this._dataParameters.symbolTileSize===t.symbolTileSize,o=this._dataParameters.bbox===t.bbox;return e&&i&&a&&o}_getProjectedFullExtent(t){return p(this,null,function*(){try{return $(this.layer.fullExtent,t)}catch{try{let i=(yield F(this.layer.url,{query:{option:"footprints",outSR:z(t),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return i?_.fromJSON(i):null}catch{return null}}})}_updateSymbolizerParams(t){t.type==="vector-field"&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}};r([s()],m.prototype,"attached",void 0),r([s()],m.prototype,"container",void 0),r([s()],m.prototype,"layer",void 0),r([s()],m.prototype,"timeExtent",void 0),r([s()],m.prototype,"type",void 0),r([s()],m.prototype,"view",void 0),r([s()],m.prototype,"updating",null),m=r([c("esri.views.2d.layers.imagery.VectorFieldView2D")],m);var st=m;var b=class extends it(Q(W(K))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new j,this._highlightView=void 0,this.layer=null,this.subview=null}get pixelData(){let{subview:t}=this;return this.updating||!t?null:"getPixelData"in t?t.getPixelData():null}update(t){this.subview?.update(t)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new O({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new N(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([w(()=>this.layer.exportImageServiceParameters.version,t=>{t&&this._exportImageVersion!==t&&(this._exportImageVersion=t,this.requestUpdate())},B),w(()=>this.timeExtent,t=>{let{subview:e}=this;e&&(e.timeExtent=t,"redraw"in e?this.requestUpdate():e.redrawOrRefetch())},B),this.layer.on("redraw",()=>{let{subview:t}=this;t&&("redraw"in t?t.redraw():t.redrawOrRefetch())}),w(()=>this.layer.renderer,()=>this._setSubView())])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}viewChange(){}moveEnd(){this.requestUpdate()}highlight(t,e){if(!((Array.isArray(t)?t[0]:D.isCollection(t)?t.at(0):t)instanceof y))return S();let i=[];return Array.isArray(t)||D.isCollection(t)?i=t.map(a=>a.clone()):t instanceof y&&(i=[t.clone()]),this._highlightGraphics.addMany(i),S(()=>this._highlightGraphics.removeMany(i))}doRefresh(){return p(this,null,function*(){this.requestUpdate()})}isUpdating(){let t=!this.subview||this.subview.updating||!!this._highlightView?.updating;return C("esri-2d-log-updating")&&console.log(`Updating ImageryLayerView2D (${this.layer.id}): ${t}
-> subview ${!this.subview||this.subview.updating}
-> higlightView ${this._highlightView?.updating}
`),t}_setSubView(){if(!this.view)return;let t=this.layer.renderer?.type,e="imagery";if(t==="vector-field"?e="imageryVF":t==="flow"&&(e="flow"),this.subview){let{type:i}=this.subview;if(i===e)return this._attachSubview(this.subview),void(i==="flow"?this.subview.redrawOrRefetch():i==="imagery"&&this.layer.format==="lerc"?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}this.subview=e==="imagery"?new rt({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):e==="imageryVF"?new st({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new Z({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(t){t&&!t.attached&&(t.attach(),t.attached=!0,this.container.addChildAt(t.container,0))}_detachSubview(t){t?.attached&&(this.container.removeChild(t.container),t.detach(),t.attached=!1)}};r([s()],b.prototype,"pixelData",null),r([s()],b.prototype,"subview",void 0),b=r([c("esri.views.2d.layers.ImageryLayerView2D")],b);var Se=b;export{Se as default};
