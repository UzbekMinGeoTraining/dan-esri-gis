import{a as Ji,c as $i}from"./chunk-BZMASTK7.js";import{A as Yi,a as Ki,b as ae,c as it,x as st}from"./chunk-46MQQBED.js";import{c as ke}from"./chunk-4NXFL2ST.js";import{a as Wi}from"./chunk-P3Q7EZ4D.js";import{a as ji}from"./chunk-RIQX5PWK.js";import"./chunk-5THZMT4W.js";import{a as Vt,f as Ii}from"./chunk-U3XYTVZL.js";import{a as Gi,b as Ni,c as Xi,d as Qi}from"./chunk-SYONT74X.js";import{a as xi}from"./chunk-WBMJOZIQ.js";import{a as ki,b as Bi}from"./chunk-UAAZOJXO.js";import{a as ge,d as Hi,h as zi,i as Li,l as re}from"./chunk-SNMZODUZ.js";import{b as Ui,c as _e,e as qi}from"./chunk-PDFLS2XB.js";import"./chunk-EMYDLWPI.js";import"./chunk-NJ2A46RA.js";import"./chunk-BJAL3HBH.js";import"./chunk-374RA6E7.js";import{a as Fi}from"./chunk-XBGBP7GJ.js";import{a as tt}from"./chunk-3TKN2TWC.js";import"./chunk-RZ2HUHIL.js";import"./chunk-QGKQ2OTS.js";import"./chunk-7DG45AVS.js";import{b as Re,d as Ri,g as et,l as Ci}from"./chunk-3TP25Q6W.js";import{l as Di}from"./chunk-FG5U4A7J.js";import{a as _t}from"./chunk-2HYJESCC.js";import"./chunk-VJX4SEWU.js";import{a as Ti}from"./chunk-XNS43EWI.js";import{b as yi,d as Si}from"./chunk-VAYZZQCL.js";import{d as Ai,j as Ei}from"./chunk-GVYD7GZA.js";import"./chunk-WG3SYF7L.js";import{a as Zi}from"./chunk-H5ZQROVO.js";import"./chunk-LZJYAKDL.js";import"./chunk-TKXAXJNG.js";import"./chunk-UZVBE57Y.js";import"./chunk-D3BMTQYU.js";import"./chunk-4YNUZOQW.js";import"./chunk-4EBEFT6T.js";import"./chunk-W4FJ4A5Q.js";import"./chunk-X7CRJ427.js";import"./chunk-4DR6EKLV.js";import"./chunk-2SZOQMAQ.js";import{d as Pi}from"./chunk-OT635BJR.js";import"./chunk-EDY6B353.js";import"./chunk-KS6SWJU3.js";import"./chunk-JHBR5RZV.js";import"./chunk-6J446DPN.js";import"./chunk-E3LKQDEM.js";import"./chunk-GWDYH5GG.js";import"./chunk-XCZY4IUQ.js";import"./chunk-DZBIKPHA.js";import"./chunk-F4QTXEUP.js";import"./chunk-C6VBL32Q.js";import"./chunk-OXOFK4XQ.js";import"./chunk-3DR4YGRI.js";import"./chunk-WCQK6XOZ.js";import"./chunk-RCCESRES.js";import"./chunk-FTNMSGGI.js";import"./chunk-4DJFVMMN.js";import"./chunk-MXVB4FQA.js";import"./chunk-DQVRRO4N.js";import"./chunk-MM6IP4FS.js";import"./chunk-DYNH5H2C.js";import{b as Oi}from"./chunk-BBIP22OX.js";import{b as we}from"./chunk-IWGILE5R.js";import"./chunk-F7R3VTP4.js";import"./chunk-MNU4KXU7.js";import"./chunk-QCDIRHTH.js";import"./chunk-2F2E6NNR.js";import{b as Mi}from"./chunk-CEM45EZZ.js";import"./chunk-GLY75KSJ.js";import"./chunk-H7LSTWKZ.js";import"./chunk-3KFX3FFC.js";import{a as bi,d as gt}from"./chunk-XI5TLVWU.js";import"./chunk-T6V6CYCJ.js";import"./chunk-IW2AVHBW.js";import"./chunk-SDHCGQUI.js";import"./chunk-VSPQNL6A.js";import"./chunk-XNAAMINV.js";import"./chunk-NPF6KTZO.js";import{e as oi}from"./chunk-WNU76WNW.js";import"./chunk-H4XRNT5U.js";import"./chunk-WIJFCRLT.js";import{b as li}from"./chunk-6ISQQD7M.js";import"./chunk-VHVYC3RW.js";import{d as gi,l as wt,n as _i,o as Vi}from"./chunk-ZBOVC36T.js";import"./chunk-BUWHOOA3.js";import"./chunk-RLQK45UV.js";import"./chunk-SDC4SION.js";import"./chunk-6VHG3ZEH.js";import{b as ni}from"./chunk-N3AGC3JB.js";import"./chunk-IGNHVSQC.js";import{c as wi}from"./chunk-B3W5V2XP.js";import"./chunk-NP35J4DQ.js";import"./chunk-JBGML6IF.js";import"./chunk-S2HMCZNZ.js";import"./chunk-WUAC4CFP.js";import"./chunk-ONDKJR4V.js";import"./chunk-QB4KDO4M.js";import"./chunk-NNNTRPDR.js";import"./chunk-KDLA3TQ2.js";import{a as fi,b as vi}from"./chunk-RPMDOAYZ.js";import"./chunk-J7UK2QPE.js";import"./chunk-6DXGZQQN.js";import"./chunk-3PK63SMD.js";import"./chunk-2DN2BYDF.js";import"./chunk-GQ2SPTYG.js";import"./chunk-RBWI4VLW.js";import"./chunk-MEA3RU4I.js";import"./chunk-Q6D44QVW.js";import"./chunk-3UBXEUOT.js";import{a as ft,b as vt}from"./chunk-6WV5YJL7.js";import{b as $e,c as mi}from"./chunk-3AMG6HG6.js";import"./chunk-I6ETUG5Q.js";import"./chunk-YOBNM4T6.js";import"./chunk-MEBZWNWT.js";import"./chunk-XZ52TEBV.js";import"./chunk-WAPQB6I3.js";import"./chunk-L3GHXHDP.js";import{a as hi,b as ui}from"./chunk-N6PITG7Q.js";import"./chunk-XC4LDHG5.js";import"./chunk-S3ASAZCA.js";import"./chunk-ZUUCQTSR.js";import"./chunk-GKUBZAEG.js";import"./chunk-UW734WOQ.js";import"./chunk-BIZV3H6H.js";import"./chunk-UCYGH5UZ.js";import{g as ci,l as di,m as pi}from"./chunk-ATV5GTE5.js";import"./chunk-X7WNJQZZ.js";import"./chunk-PQPFAB53.js";import"./chunk-QPPQKNYU.js";import{j as J}from"./chunk-MJXFSFCY.js";import"./chunk-6N46AY7Z.js";import"./chunk-TCQTMUK4.js";import"./chunk-AY3YVZUY.js";import"./chunk-7DCEI345.js";import"./chunk-ZG3FCPXY.js";import"./chunk-RIUAG34V.js";import"./chunk-G5SIQY64.js";import"./chunk-WW7S4V24.js";import"./chunk-UGAMS6PU.js";import"./chunk-EHDNZUTT.js";import"./chunk-ECBUS54L.js";import"./chunk-NH7OOX2I.js";import"./chunk-B72PB7U4.js";import"./chunk-644SLL4Y.js";import"./chunk-A54VD7GL.js";import{d as Ie}from"./chunk-K55ZDM2S.js";import"./chunk-Z3USGHSR.js";import"./chunk-W3OGU5I2.js";import"./chunk-OO4IIGVK.js";import"./chunk-KQHYII76.js";import"./chunk-6I6DPRXI.js";import"./chunk-RNN6GAXL.js";import"./chunk-4IVMQ5PX.js";import"./chunk-CQUOQXLP.js";import"./chunk-VMYCUJRH.js";import"./chunk-PTVRFY4B.js";import"./chunk-3ZOLHUAU.js";import"./chunk-M2F4B74F.js";import"./chunk-2WNCPIJC.js";import"./chunk-GDB2EJGA.js";import"./chunk-RDGFIF46.js";import"./chunk-C2ONI6UP.js";import"./chunk-H6LJ2DCJ.js";import"./chunk-LCDA6FHZ.js";import"./chunk-RZPELDHM.js";import"./chunk-S3J33BKD.js";import"./chunk-NPIYHDQ7.js";import"./chunk-BL63T6AU.js";import"./chunk-AOTWUAUY.js";import"./chunk-VI4TDFI5.js";import"./chunk-GXSLPADW.js";import"./chunk-2HN33SWB.js";import"./chunk-523X5JOP.js";import"./chunk-BXR2KKYP.js";import{e as ai}from"./chunk-7ISKCG7U.js";import{g as ri}from"./chunk-OFGHVREP.js";import"./chunk-YJ3RZNO6.js";import"./chunk-M4PATAW3.js";import"./chunk-26R336GJ.js";import"./chunk-OC7V2CEX.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-3HX6VT75.js";import"./chunk-R7P6RQXJ.js";import"./chunk-4I7LQWUX.js";import{b as si}from"./chunk-JLNQ6WQT.js";import{b as ii}from"./chunk-GB5RQL32.js";import{a as Je,c as mt}from"./chunk-4OZVVJHM.js";import"./chunk-IZRBPB5G.js";import{N as ti,u as Ye,z as Ze}from"./chunk-X7XJWAFC.js";import"./chunk-ILCAH2F6.js";import"./chunk-CYCLIMTY.js";import"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import{a as N}from"./chunk-RRDM7P6F.js";import"./chunk-7X2HMUNN.js";import"./chunk-LW2464MZ.js";import"./chunk-WJDHM47L.js";import"./chunk-LWJTIQQT.js";import"./chunk-IHBD2IWR.js";import"./chunk-NH3JQE75.js";import{a as _}from"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import"./chunk-HVNRUZWJ.js";import"./chunk-3IK5VXZ3.js";import"./chunk-EN6CTWVM.js";import"./chunk-IRJNWXGT.js";import"./chunk-O4AQRVFI.js";import"./chunk-NDPAZKBG.js";import"./chunk-7AZ5UVCG.js";import"./chunk-6GGK7PRJ.js";import"./chunk-EPTSNNZF.js";import{c as Qt,p as Kt,r as Yt}from"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-I6LCIPDY.js";import"./chunk-Y6H3NTW7.js";import"./chunk-4RLJMQW4.js";import"./chunk-J6ZRC6RI.js";import{a as Le}from"./chunk-EBGO44EK.js";import"./chunk-THY6AAMN.js";import{a as ei}from"./chunk-7W6RATG7.js";import"./chunk-45SNVLPM.js";import{a as ut}from"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-B4JAL745.js";import"./chunk-XTES2GPX.js";import{C as Se,D as $t,G as R,J as de,b as j,c as W,d as q,n as I,o as Zt,p as pt,s as De,u as se,v as ce,w as Jt,y as U}from"./chunk-2HUIJUS4.js";import{a as v,b as be,e as Oe,g as Qe,h as T,i as he}from"./chunk-MBJHSEMD.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import{H as L,g as He,h as qt,i as Nt,n as ie,o as ve,p as G,q as Ke,r as ye,s as ze}from"./chunk-5MNDZ6BX.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import{a as Xt,e as dt}from"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{a as u,b as ct,c as k,e as Wt}from"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import{c as Gt}from"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import{f as Bt}from"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import{b as Me,h as g,i as fe}from"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import{l as xe}from"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as l,S as te,h as me}from"./chunk-GGZQ5GCM.js";import{U as z}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as n}from"./chunk-BMVJCP2M.js";import{a as It,c as Xe,f as kt,l as jt,z as Ut}from"./chunk-GMC3I5VG.js";import{b as C,c as zt,e as Te,f as Lt}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{e as xt,r as Ht}from"./chunk-3IBUFXWY.js";import{a as Pt,u as Ft}from"./chunk-BP73DJTS.js";import{a as H,b as B,g as Ne}from"./chunk-JEGVIFEP.js";var es=2,ys=4,rt=g(2),ts=1.5,bt=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=ys,this.fovFocusedArcWidth=es*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=es/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}},E=new bt,Mt=class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new N([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:N.toUnitRGBA(new N([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:J.Occlude,cullFace:Je.Back,writeDepth:!1}}},oe=new Mt;function Ce({tiltedUpVector:t,rightVector:e,observerRenderSpace:i},s){let r=Li(t,e,i,s);return r[12]=0,r[13]=0,r[14]=0,r}function je(t,e,i,s){let r=u(),a=i.plane,o=Ss(e,a),h;if(Math.abs(o)>E.viewAngleThreshold)h=t.next(Vt(e,i.plane));else{let c=Ze(s.targetRenderSpace,i.basis1,Ye()),d=se(rs,i.basis1),p=se(Ts,i.basis2);h=t.next(Vt(e,c)).next(m=>{let f=O=>{let D=ce(R(is,O,i.origin),p),F=Math.acos(Me(D/s.farDistanceRenderSpace,-1,1)),K=Math.sin(F)*s.farDistanceRenderSpace;return q(u(),i.origin,q(u(),I(is,d,K),I(Os,p,D)))},w=f(m.renderStart),V=f(m.renderEnd);return B(H({},m),{renderStart:w,renderEnd:V})})}return h.next(c=>{c.action==="start"&&j(r,c.renderStart);let d=fe(zi(r,c.renderEnd,i.origin,a));return B(H({},c),{deltaAngle:d})})}function Ss(t,e){let i=rs;t.renderCoordsHelper.toRenderCoords(t.camera.position,i);let s=Ei(t,i,t.camera.heading,t.camera.tilt,Ai()).direction;return fe(Se(s,e))-90}function ne(t,e,i,s){return G(ss,i,s),U(t,e,ss)}var rs=u(),Ts=u(),is=u(),Os=u(),ss=_();var at=class extends st{constructor(e){super(),this._handles=new me,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=C(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,i){let s=Object.values(this._manipulators);return Xe(s.map(({manipulator:r,side:a})=>Re(r,(o,h,c,d,p)=>{let m=Es(a,i),f=h.next(V=>B(H({},V),{manipulatorType:ae.SCALE,side:a})),w=je(f,this._view,m,i);e(o,w,c)})))}updateManipulatorsTransform(e){e.arcCentersPoints(as),this._forEachManipulatorInfo(i=>this._updateArcManipulatorTransform(i,e,as[i.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(i=>this._updateArcManipulatorVisuals(i,e))}_updateArcManipulatorVisuals({manipulator:e,side:i},s){let r=[];if(s!=null){let[a,o]=Ds(i,s,this._unfocusedArcMaterial);r.push(new re(a,we.Unfocused),new re(a.instantiate({material:this._focusedArcMaterial}),we.Focused)),e.collisionType={type:"line",paths:[o]}}e.renderObjects=r,e.radius=E.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:i},s,r){let a=s.horizontalFieldOfView,o=g(s.verticalFieldOfView/2),h=g(a/2),c=Ee(i);e.renderLocation=r;let d=_(),p=O=>{He(d,O,d)};p(ye(Ae,g(-90))),c||p(Ke(Ae,o));let m=s.farDistanceRenderSpace,f,w;p(ve(Ae,W(ns,m,m,m))),p(ze(Ae,As(i))),p(Ce(s,Ae)),c?(f=h,w=s.tiltedUpVector):(w=s.rightVector,f=o),f*=i==="right"||i==="bottom"?-1:1;let V=G(Ae,f,w);V!=null&&p(V),e.modelTransform=d}_createManipulators(){let e=this._createArcManipulator("left"),i=this._createArcManipulator("right"),s=this._createArcManipulator("top"),r=this._createArcManipulator("bottom");this._manipulators={left:e,right:i,top:s,bottom:r},[[r.manipulator,s.manipulator],[e.manipulator,i.manipulator]].forEach(([a,o])=>{a.metadata={pairedManipulator:o},o.metadata={pairedManipulator:a}})}_createArcManipulator(e){let i=new ge({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:i,side:e};return this._updateArcManipulatorVisuals(s),this._handles.add(i.events.on("focus-changed",r=>{let a=i.metadata?.pairedManipulator;a!=null&&(a.hovering!==i.hovering&&(a.hovering=i.hovering),a.grabbing!==i.grabbing&&(a.grabbing=i.grabbing))})),s}_createArcMaterial(e){let i=E.getFovArcWidth(e),s=new Pi({renderOccluded:J.OccludeAndTransparent,isDecoration:!0,width:i});return this._handles.add(v(()=>N.toUnitRGBA(this._view.effectiveTheme.accentColor),r=>s.setParameters({color:r}),T)),s}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:i})=>e(i,ae.SCALE))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(i=>e(i))}get test(){return{manipulators:this._manipulators}}};function Ds(t,e,i){let{horizontalFieldOfView:s,verticalFieldOfView:r}=e,a=Ee(t),o=g(Me((a?r:s)/2,0,15)),h=Rs(-o/2,o/2,a?1:Math.max(Math.sin(g(90-r/2)),.1));return[_i(i,h),h]}function Rs(t,e,i,s=10){Le(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");let r=e-t;if(r<=0||i<=0)return[k(0,0,.01),k(0,0,-.01)];let a=[],o=r/s;for(let h=0;h<s;h++){let c=t+h*o;h===s-1&&(c=e);let d=Math.cos(c)*i,p=Math.sin(c)*i,m=k(d-i,0,p);a.push(m)}return a}function Cs(t){switch(t){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function As(t){return Cs(t)*Ps}function Ee(t){return t==="left"||t==="right"}function os(t){return t==="left"?"right":t==="right"?"left":t==="top"?"bottom":"top"}function Es(t,{observerRenderSpace:e,targetRenderSpace:i,tiltedUpVector:s,rightVector:r,farDistanceRenderSpace:a}){let o=R(ns,i,e),h=Ee(t)?r:s,c=I(Fs,h,a);return Ie(e,o,c)}var Ps=Math.PI/2,Ae=_(),ns=u(),Fs=u(),as={top:u(),bottom:u(),left:u(),right:u()};var Pe=class extends ge{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.collisionRadius}),this._handles=new me,this._setupManipulatorVisual(i)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){let i=this._createMaterial(),s=1,r=[k(0,0,0),k(0,0,s)],a=wt(i,r,e,16,!1),o=wt(i,r,e*ke,16,!1),h=ls(!1,i,e),c=ls(!0,i,e),d=_();ie(d,r[r.length-1]),L(d,d,Ke(hs,Math.PI/2)),L(d,d,ye(hs,Math.PI/2)),h.transformation=d,c.transformation=d,this.renderObjects=[new re(a,we.Unfocused),new re(o,we.Focused),new re(h,we.Unfocused),new re(c,we.Focused)];let p=k(0,E.getScaleOrientArrowTipLength(!0),0),m=U(p,p,d),f=[...r,m];this.collisionType={type:"line",paths:[f]}}_createMaterial(){let e=new tt({cullFace:Je.Back,renderOccluded:J.OccludeAndTransparent,isDecoration:!0});return this._handles.add(v(()=>N.toUnitRGBA(this.view.effectiveTheme.accentColor),i=>e.setParameters({color:i}),T)),e}};function ls(t,e,i){let s=E.getScaleOrientArrowTipLength(t),r=2*i;t&&(r*=ke);let a=s/2;return Vi(e,s,a,a,r,0)}var hs=_();var nt=class extends st{constructor(e){super(),this._handles=new me,this._tool=e.tool,this._view=e.view;let i=E.scaleOrientHandleRadius;this._manipulatorHeading=new Pe(this._view,i),this._manipulatorTilt=new Pe(this._view,i),this._manipulatorDistance=new Pe(this._view,i),this.forEachManipulator(s=>this._tool.manipulators.add(s))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,i){return Re(this._manipulatorHeading,(s,r,a,o,h)=>{let c=this._view,{tiltParallelToSurface:d,farDistanceRenderSpace:p,upVector:m,observerRenderSpace:f,targetRenderSpace:w,rightVector:V}=i,O=Math.sin(g(d))*p,D=q(ot,f,I(yt,m,O)),F=R(yt,w,D),K=I(Hs,V,de(F)),x=Ie(D,F,K),Y=je(r,c,x,i).next(Z=>B(H({},Z),{manipulatorType:ae.ROTATE}));e(s,Y,a)})}createTiltDragPipeline(e,i){return Re(this._manipulatorTilt,(s,r,a,o,h)=>{let{observerRenderSpace:c,farDistanceRenderSpace:d,upVector:p,targetDirection:m}=i,f=ce(m,p),w=Zt(ot,m,p,-f);I(w,se(w,w),d);let V=I(yt,p,d),O=Ie(c,w,V),D=je(r,this._view,O,i).next(F=>B(H({},F),{manipulatorType:ae.ROTATE}));e(s,D,a)})}createDistanceDragPipeline(e,i){return Re(this._manipulatorDistance,(s,r,a,o,h)=>{let c=ri(i.observerRenderSpace,i.targetDirection),d=r.next(Ci(this._view,s.location)).next(Ii(this._view,c)).next(p=>B(H({},p),{manipulatorType:ae.SCALE}));e(s,d,a)})}updateManipulators(e){let{targetRenderSpace:i}=e;this._manipulatorHeading.renderLocation=i,this._manipulatorTilt.renderLocation=i,this._manipulatorDistance.renderLocation=i;let s=_(),r=p=>{He(s,p,s)},a=E.scaleOrientSize*(it/70);r(ve(Ue,W(ot,a,a,a))),r(Ce(e,Ue));let o=E.scaleOrientHandleRadius*ke*a,h=I(ot,e.targetDirection,o);r(ie(Ue,h));let c=ze(Ue,-St);L(c,c,ye(cs,-St)),this._manipulatorHeading.modelTransform=L(_(),s,c);let d=ye(Ue,St);L(d,d,ze(cs,Math.PI)),this._manipulatorTilt.modelTransform=He(_(),s,d),this._manipulatorDistance.modelTransform=s}forEachManipulator(e){e(this._manipulatorHeading,ae.ROTATE),e(this._manipulatorTilt,ae.ROTATE),e(this._manipulatorDistance,ae.SCALE)}},Ue=_(),cs=_(),ot=u(),yt=u(),Hs=u(),St=Math.PI/2;var Be=class extends ge{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.observerSize,interactive:!1}),this._handles=new me;let s=Hi(this._color);this.renderObjects=[new re(gi(s,E.observerSize,32,32))],i.manipulators.add(this),this._handles.add([v(()=>this._color,r=>{s.setParameters({color:r})},T)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return N.toUnitRGBA(this.view.effectiveTheme.accentColor)}};n([l()],Be.prototype,"_color",null);var ds=Symbol("dragHandles"),ps=Symbol("hideManipulators"),us=Symbol("hideFoVManipulators"),ms=Symbol("hideObserverManipulator"),X=class extends te{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new at({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new nt({view:this.view,tool:this.parentTool}),this._observerManipulator=new Be(this.view,this.parentTool),this.addHandles([v(()=>this.viewshedComputedData?.observerRenderSpace,e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},he),v(()=>this.viewshedComputedData?.heading,e=>{e&&(this._moveManipulation.angle=g(90-e))},T),v(()=>{let{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}},({viewshedComputedData:e,observer:i},s)=>{this._grabbing&&i!==s?.observer||(this.removeHandles(ds),e?.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(Ft),ds))},T),v(()=>{let e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},T),v(()=>{let e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},T),v(()=>{let e=this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1),i=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||i)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:i})=>{this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=e},T),v(()=>{let e=this.viewshedComputedData;if(!e?.isValid())return null;let{observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:a}=e;return{viewshedCompData:e,observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:a}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},T)]);let t=e=>{let i=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{let s=this._someManipulatorHovering();s&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||s||(this._forceHoveringTask=Bt(r=>Ne(this,null,function*(){yield this._forceHoveringTestPromise??Ut(E.hoverTimeoutMilliseconds,r),jt(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))}),e.events.on("grab-changed",s=>{this._grabbing=s.action==="start",s.action==="end"&&i.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:r})=>{r!==this&&r._setInteractive(!this._grabbing)}),this._setInteractive(r=>r.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",s=>{s.action==="start"&&i.tool?.updateInteractionVisualsVisibility()})])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=Te(this._forceHoveringTask),this._moveManipulation=C(this._moveManipulation),this._fieldOfViewManipulation=C(this._fieldOfViewManipulation),this._scaleOrientManipulation=C(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=C(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(t){let e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){let{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){let{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){let e=typeof t=="boolean";this._forEachManipulation(i=>i.interactive=e?t:t(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator(i=>{e=e||i===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Yi({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:it})}_buildObserverDragPipeline(t){let e={mode:"absolute-height",offset:0},i=t.observer;if(i==null)return null;let s=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,a,o,h,c)=>{h=h.next(et(this,["observer"]));let d=Kt(i,s);if(d==null)return{steps:o,cancel:h};let p=Di.fromGeometry(d,ii(this.view.viewingMode));return{steps:o.next(Ri({operations:p})).next(m=>(this.observer=p.data.geometry,m)),cancel:h}},e,s,void 0)}_buildFOVDragPipeline(t){let e=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,r,a)=>{if(t==null)return{steps:r,cancel:a};let o=t.viewshed,h=null;return a=a.next(et(t,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(c=>{if(c.action==="start")return h=null,e=t.horizontalFieldOfView,i=t.verticalFieldOfView,c;let d=c.deltaAngle;if(h==null&&d!==0){let f=c.side==="bottom"||c.side==="left"?d>0:d<0;h=Ee(c.side)?e===0&&f||e===360&&!f:i===0&&f}let p=h?os(c.side):c.side,m=0;switch(p){case"left":m=e/2-d;break;case"right":m=e/2+d;break;case"top":m=i+2*d;break;case"bottom":m=i-2*d}return Ee(p)?(m=gt.normalize(m),m=m>270?0:m>180?180:m,o.horizontalFieldOfView=2*m):o.verticalFieldOfView=m,c}),cancel:a}},t)}_buildScaleOrientDragPipeline(t){let e=0,i=0,s=(r,a)=>(o,h,c)=>{if(t==null)return{steps:h,cancel:c};let d=t.viewshed;return c=c.next(et(d,[r])),{steps:h=h.next(a(d,t)),cancel:c}};return Xe([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(r,a)=>o=>(o.action==="start"&&(i=t.heading),r.heading=gt.normalize(i+o.deltaAngle),o)),t),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(r,a)=>o=>{o.action==="start"&&(e=t.tilt);let h=e+o.deltaAngle;return h<-90?h=180:h>270&&(h=0),r.tilt=Ls.clamp(h),o}),t),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(r,a)=>o=>{let h=R(zs,o.renderEnd,a.observerRenderSpace),c=de(h)*a.metersPerUnit,d=ce(h,a.targetDirection)<0?E.scaleOrientMinDistance:c;return r.farDistance=d,o}),t)])}_updateManipulatorVisibility(){let t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating,r=[],a=o=>{r.push(o.disableDisplay())};t||!s&&e?this.removeHandles(ps):(this._scaleOrientManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a),this.addHandles(r,ps),r=[]),t||!s&&e||s&&i?this.removeHandles(us):(this._fieldOfViewManipulation.forEachManipulator(a),this.addHandles(r,us)),t||!s?this.removeHandles(ms):this.addHandles(this._observerManipulator.disableDisplay(),ms)}_resetHoveringTask(){this._forceHoveringTask=Te(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation(e=>{e.forEachManipulator(t)}),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};n([l({constructOnly:!0})],X.prototype,"analysis",void 0),n([l({constructOnly:!0})],X.prototype,"analysisViewData",void 0),n([l({constructOnly:!0})],X.prototype,"parentTool",void 0),n([l({constructOnly:!0,nonNullable:!0})],X.prototype,"view",void 0),n([l()],X.prototype,"viewshed",null),n([l()],X.prototype,"_grabbing",void 0),n([l()],X.prototype,"grabbing",null),n([l()],X.prototype,"viewshedComputedData",void 0),n([l()],X.prototype,"observer",null),X=n([z("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],X);var zs=u(),Ls=new bi(0,180);var Tt=Symbol("interactionVisuals"),A=class extends Gi{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Ki({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Wi(this.view.state.viewingMode),this._createInteractionVisuals();let t=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Oe(()=>t,({viewshedComputedData:e})=>{let i=new X({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:i,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([v(()=>t?.some(e=>e.viewshedComputedData.isValid()),e=>{e&&this.finishToolCreation()},he),v(()=>this._stagedViewshed,e=>{let i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=e!=null&&i!=null?this._findSubTool(e)?.viewshedComputedData:null},he),v(()=>this.firstGrabbedManipulator,e=>{if(e!=null){let i=this._findSubTool(e)?.viewshed;this.selectedViewshed=i,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},Qe),v(()=>this.view.activeTool,e=>{e!==this&&e!=null&&(this.selectedViewshed=null)}),be(()=>{let e=this.selectedViewshedComputedData;return e==null?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{let{subTool:i,observer:s,target:r}=e;i?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):i?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(r,!1)},T),v(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),v(()=>this.selectedViewshed,e=>{let i=this._selectedManipulator,s=this._selectedSubTool;e==null?this._selectManipulator(null):i!=null&&s.hasManipulator(i)||this._selectManipulator(s.discManipulator)},T)])}destroy(){this.subToolHandles=C(this.subToolHandles),this.removeHandles(Tt)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(t){let e=this._selectedManipulator;e!==t&&(this._selectedManipulator=t,e!=null&&(e.selected=!1),t!=null&&(t.selected=!0),this._findSubTool(e)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(t){this.analysisViewData.selectedViewshed=t}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:t})=>t.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach(t=>t.subTool.onManipulatorSelectionChanged())}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":_t.cancel===t.key?this._cancelKeyHandler(t):_t.delete.includes(t.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickPlacementHandler(t)}_clickPlacementHandler(t){if(!this.creating||this.hasFocusedManipulators)return;let e=this._intersectScreen(t,vs);if(e!=null){if(this._creationState==="placing-observer"){e.mapPoint.z=(e.mapPoint.z??0)+ts;let i=new Ti({observer:e.mapPoint.clone(),feature:e.feature});this.analysis.viewsheds.add(i),this._stagedViewshed=i,this._creationState="placing-target",this._updateStagedViewshed(e.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(e.scenePoint);let i=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=i}t.stopPropagation()}}_doubleClickHandler(t){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(!this.creating)return;let e=this._intersectScreen(t,vs);e!=null&&(this._updateInteractionVisualsLocation(e.scenePoint,!1),this._updateStagedViewshed(e.scenePoint))}_cancelKeyHandler(t){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void t.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void t.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(t){let e=this._stagedViewshed,i=this._stagedViewshedComputedData;if(e==null||i==null)return;let{heading:s,tilt:r,farDistance:a}=Is(this.view,i,t);e.farDistance=a,e.tilt=r,e.heading=s}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(t,e){let i=Oi(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);let s=this._intersector.results.min,r=e.scenePoint;if(!s.getIntersectionPoint(r))return null;let a=e.mapPoint;return a.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,a),a==null?null:(e.feature=Mi(s,this.view),e)}_createInteractionVisuals(){this.removeHandles(Tt);let t=this._settings.visualElements,e=new ki({view:this.view,attached:!1,style:{glowWidth:t.heightPlane.glowWidth,innerWidth:t.heightPlane.innerWidth},isDecoration:!0}),i=new ji({view:this.view,extensionType:t.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:J.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:e,verticalLine:i},this.addHandles([v(()=>t.zVerticalLine,s=>s.apply(i),he),v(()=>t.heightPlane,s=>s.apply(e),he),It(()=>{e.destroy(),i.destroy(),this._interactionVisualElements=null})],Tt)}updateInteractionVisualsVisibility(t=!1){let e=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,a=(m,f)=>{let w=this._interactionVisualElements;w!=null&&(w.verticalLine.attached=f,w.laserline.attached=m)};if(e)return void a(i,!1);if(s==null||r==null)return void a(!1,!1);let o=s.moveInteractionState,h=t?o.grabbing:o.dragging,c=s.scaleOrientInteractionState,d=t?c.grabbing:c.dragging,p=i&&(h||d);if(a(p,h),p){let m=h?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(m,h)}}_updateInteractionVisualsLocation(t,e){let i=this._interactionVisualElements;if(i==null)return;let{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=t,s.intersectsWorldUpAtLocation=e?t:null,t!=null&&r.setStartEndFromWorldDownAtLocation(t)}_findSubTool(t){if(t==null)return null;let e=t instanceof ge?i=>i.subTool.hasManipulator(t):i=>i.subTool.viewshed===t;return this.subToolHandles?.find(e)?.subTool}get test(){}};function Is(t,e,i){let s=e.observerRenderSpace,r=R(ks,i,s),a=de(r)*e.metersPerUnit,o=t.renderCoordsHelper.basisMatrixAtPosition(s,Bs),h=W(js,o[8],o[9],o[10]),c=Ze(s,h,Gs),d=ti(c,i,Us),p=R(d,d,s),m=(de(p)<1e-4?90:fe(Se(r,p)))*(ce(h,r)<0?-1:1)+90,f=W(fs,o[4],o[5],o[6]),w=fe(Se(f,p)),V=W(fs,o[0],o[1],o[2]);return{heading:ce(p,V)<0?360-w:w,tilt:m,farDistance:a}}n([l({constructOnly:!0})],A.prototype,"view",void 0),n([l()],A.prototype,"analysisViewData",void 0),n([l()],A.prototype,"removeIncompleteOnCancel",void 0),n([l()],A.prototype,"automaticManipulatorSelection",void 0),n([l({constructOnly:!0})],A.prototype,"analysis",void 0),n([l()],A.prototype,"subToolHandles",void 0),n([l()],A.prototype,"_stagedViewshed",void 0),n([l()],A.prototype,"_stagedViewshedComputedData",void 0),n([l()],A.prototype,"_creationState",void 0),n([l({readOnly:!0})],A.prototype,"cursor",null),n([l()],A.prototype,"_selectedManipulator",void 0),n([l()],A.prototype,"_selectedSubTool",null),n([l()],A.prototype,"selectedViewshed",null),n([l()],A.prototype,"selectedViewshedComputedData",null),n([l()],A.prototype,"stagedViewshed",null),n([l()],A.prototype,"grabbing",null),n([l()],A.prototype,"creating",null),n([l()],A.prototype,"isPlacingTarget",null),A=n([z("esri.views.3d.analysis.Viewshed.ViewshedTool")],A);var ks=u(),js=u(),Us=u(),fs=u(),Bs=_(),Gs=Ye(),vs={mapPoint:new xe,scenePoint:u(),feature:null},Ge=A;var lt=class extends Ui{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new tt(B(H({},oe.shapeMaterialParameters),{isDecoration:this.isDecoration,writeDepth:!1})),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){let e=this._viewshedComputedData;if(e==null)return;let i=_(),s=e.farDistanceRenderSpace;ve(i,k(s,s,s)),Ce(e,We),L(i,We,i),ie(We,this._viewshedComputedData.observerRenderSpace),L(i,We,i),this.transform=i}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(e){this._material!=null&&e(this._material)}createGeometries(e){let{_material:i,viewshedComputedData:s}=this;s==null||i==null||!s.isValid()||Ws(i,s).forEach(r=>e.addGeometry(r))}};function Ws(t,e){let{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=W(qs,0,0,1),a=W(gs,0,1,0),o=W(_s,1,0,0);ne(r,r,g(s/2),a),ne(r,r,g(i/2),o);let h=S=>Math.ceil(Math.abs(S)/rt)+1,c=g(i),d=j(Ns,o),p=h(c),m=ws(-c/(p-1)),f=G(We,m,d),w=g(-s),V=h(w),O=ws(w/(V-1)),D=j(gs,a),F=G(Vs,g(i)/2,o);U(D,D,F);let K=Vs,x=[],Y=j(_s,r);for(let S=0;S<p;S++){G(K,O,D);for(let M=0;M<V;M++){let y=3*(M*p+S);x[y]=Y[0],x[y+1]=Y[1],x[y+2]=Y[2],U(Y,Y,K)}U(D,D,f),U(r,r,f),j(Y,r)}let Z=p*V;x[3*Z]=0,x[3*Z+1]=0,x[3*Z+2]=0;let ee=[];for(let S=0;S<p-1;S++)for(let M=0;M<V-1;M++){let y=6*(M*(p-1)+S);ee[y]=M*p+S,ee[y+1]=(M+1)*p+S,ee[y+2]=M*p+S+1,ee[y+3]=M*p+S+1,ee[y+4]=(M+1)*p+S,ee[y+5]=(M+1)*p+S+1}let ue=[ee];if(i!==360&&s!==0){let S=[],M=[];for(let y=0;y<V-1;y++){let P=3*y;S[P]=Z,S[P+1]=(y+1)*p,S[P+2]=y*p,M[P]=Z,M[P+1]=y*p+p-1,M[P+2]=(y+1)*p+p-1}ue.push(S,M)}if(s!==180&&i!==0){let S=[],M=[];for(let y=0;y<p-1;y++){let P=3*y;S[P]=Z,S[P+1]=y,S[P+2]=y+1,M[P]=Z,M[P+1]=y+(V-1)*p+1,M[P+2]=y+(V-1)*p}ue.push(S,M)}return ue.map(S=>{let M=[[ei.POSITION,new si(x,S,3,!0)]];return new wi(t,M)})}function ws(t){return isNaN(t)?1:t}var qs=u(),gs=u(),_s=u(),Ns=u(),We=_(),Vs=_();var le=class extends te{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:u(),topRight:u(),bottomLeft:u(),bottomRight:u()},this._arcCenterPoints={top:u(),bottom:u(),left:u(),right:u()},this._parallelCenters={top:u(),bottom:u()}}initialize(){let t={view:this.view,isDecoration:!0},e=B(H({},t),{color:this._color,renderOccluded:J.OccludeAndTransparent}),i=B(H({},e),{stipplePattern:Fi(2)});this._observerVisualElement=new Bi(H(H({},t),oe.observerPointConfiguration)),this._shapeVisualElement=new lt(t),this._frameLinesVisualElement=new _e(e),this._leftArcVisualElement=new _e(e),this._rightArcVisualElement=new _e(e),this._topArcVisualElement=new _e(e),this._bottomArcVisualElement=new _e(e),this._centralLongitude=new _e(i),this._centralLatitude=new _e(i),this.addHandles([v(()=>{let s=this.viewshedComputedData;if(!s?.isValid())return null;let r=this._viewshedCorners,a=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(r),s.arcCentersPoints(a),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:r,arcCenters:a,parallelCenters:o,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{let r=s!=null;this._forEachVisualElement(a=>a.attached=r),r&&this._updateVisualElements(s)},{initial:!0,equals:xt}),v(()=>{let{viewshedComputedData:s}=this,{horizontalFieldOfView:r,verticalFieldOfView:a}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:r,verticalFieldOfView:a}},({viewshedComputedData:s})=>{let{_shapeVisualElement:r}=this;s!==r.viewshedComputedData&&(r.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},T),v(()=>{let{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}},({visible:s,selected:r,staged:a,horFovNot360:o})=>{let h=r||a;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&o;let c=s&&(r||o);this._leftArcVisualElement.visible=c,this._rightArcVisualElement.visible=c,this._forEachLineVisualElement(d=>{d.width=h?oe.frameWidthSelected:oe.frameWidthNotSelected,d.renderOccluded=r?J.OccludeAndTransparent:J.Occlude}),[this._centralLatitude,this._centralLongitude].forEach(d=>{d.width=2*(h?oe.frameWidthSelected:oe.frameWidthNotSelected),d.visible=s&&r})},T),v(()=>{let{analysisViewData:{interactive:s,tool:r},_selected:a,visible:o}=this,h=this.view.activeTool,c=!r?.active&&h instanceof Ge&&h.creating;return{observerVisible:o&&!a&&(!s||(r?.creating??!1)||c),color:this._color}},({observerVisible:s,color:r})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(a=>a.color=r)},T)])}get _color(){let{viewshedComputedData:t,_selected:e,analysisViewData:i}=this;if(t==null)return N.toUnitRGBA(oe.frameColor);let s=i.tool?.active||i.interactive,r=t.viewshed===i.tool?.stagedViewshed,a=s&&(e||r)?this.view.effectiveTheme.accentColor:oe.frameColor;return N.toUnitRGBA(a)}get _selected(){let{viewshedComputedData:t,analysisViewData:{selectedViewshedComputedData:e}}=this;return t!=null&&t===e}get _staged(){let{analysisViewData:{tool:t},viewshedComputedData:e}=this;return t!=null&&t.creating&&t.stagedViewshed===e?.viewshed}destroy(){this._observerVisualElement=C(this._observerVisualElement),this._shapeVisualElement=C(this._shapeVisualElement),this._frameLinesVisualElement=C(this._frameLinesVisualElement),this._leftArcVisualElement=C(this._leftArcVisualElement),this._rightArcVisualElement=C(this._rightArcVisualElement),this._topArcVisualElement=C(this._topArcVisualElement),this._bottomArcVisualElement=C(this._bottomArcVisualElement),this._centralLongitude=C(this._centralLongitude),this._centralLatitude=C(this._centralLatitude)}_forEachLineVisualElement(t){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_forEachVisualElement(t){this._forEachLineVisualElement(t),t(this._observerVisualElement),t(this._shapeVisualElement)}_updateVisualElements(t){let{viewshedComputedData:e,corners:i,arcCenters:s,parallelCenters:r}=t,a=ct(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(a,i),this._updateFrameArcs(e,i,r),this._updateCentralHelperArcs(e,s)}_updateFrameLines(t,e){this._frameLinesVisualElement.geometry=[[t,e.topLeft],[t,e.topRight],[t,e.bottomLeft],[t,e.bottomRight]]}_updateFrameArcs(t,e,i){let{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:a,tiltedUpVector:o}=t,h=g(a),c=u(),d=_();G(d,h/2,o),U(c,r,d),Fe(this._leftArcVisualElement,s,e.bottomLeft,e.topLeft,"forward",c),G(d,-h/2,o),W(c,0,0,0),U(c,r,d),Fe(this._rightArcVisualElement,s,e.bottomRight,e.topRight,"forward",c);let p=a>180?"backward":"forward";Fe(this._topArcVisualElement,i.top,e.topRight,e.topLeft,p,o),Fe(this._bottomArcVisualElement,i.bottom,e.bottomRight,e.bottomLeft,p,o)}_updateCentralHelperArcs(t,e){let i=t.observerRenderSpace,s=t.horizontalFieldOfView>=180?"backward":"forward";Fe(this._centralLatitude,i,e.right,e.left,s,t.tiltedUpVector),Fe(this._centralLongitude,i,e.top,e.bottom,"forward",t.leftVector)}get test(){}};function Fe(t,e,i,s,r,a,o=rt){let h=u();R(h,i,e);let c=de(h),d=u();R(d,s,e),se(d,d),I(d,d,c);let p=Se(h,d),m=ct(a);r==="backward"&&(De(m,m),p=-(2*Math.PI-p));let f=[],w=Math.ceil(Math.abs(p)/o),V=_();G(V,p/w,m);let O=u();j(O,h);let D=u();j(D,i);for(let F=0;F<w;F++){let K=u();j(K,D),U(O,O,V),q(D,e,O);let x=u();j(x,D),f.push([K,x])}t.geometry=f}n([l()],le.prototype,"view",void 0),n([l()],le.prototype,"analysisViewData",void 0),n([l()],le.prototype,"viewshedComputedData",void 0),n([l()],le.prototype,"visible",void 0),n([l()],le.prototype,"_color",null),n([l()],le.prototype,"_selected",null),n([l()],le.prototype,"_staged",null),le=n([z("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],le);var bs=le;var Ve=class extends te{get visible(){return this.analysisViewData.visible}constructor(t){super(t)}initialize(){let t=this.analysisViewData,e=Oe(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:i})=>{let s=new bs({view:this.view,viewshedComputedData:i,analysisViewData:t});return{visualization:s,remove:()=>s.destroy()}});this._viewshedVisualizations=e,this.addHandles([kt(e),v(()=>this.visible,i=>this._viewshedVisualizations.forEach(({visualization:s})=>s.visible=i),T)])}get test(){}};n([l({constructOnly:!0})],Ve.prototype,"analysisViewData",void 0),n([l({constructOnly:!0,nonNullable:!0})],Ve.prototype,"view",void 0),n([l({constructOnly:!0})],Ve.prototype,"isDecoration",void 0),n([l()],Ve.prototype,"visible",null),Ve=n([z("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],Ve);var Dt,b=Dt=class extends te{constructor(t){super(t),this.observerRenderSpaceOverride=null}get observer(){return this.viewshed.observer??new xe}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,u())}get target(){let t=this.targetRenderSpace;return this.renderSpaceToPoint(t,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){let t=R(u(),this.targetRenderSpace,this.observerRenderSpace);return se(t,t)}get tiltedUpVector(){let t=ne(u(),this.upVector,-g(this.tiltParallelToSurface),this.leftVector);return se(t,t)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,_())}get upVector(){let t=this._basis;return k(t[8],t[9],t[10])}get northVector(){let t=this._basis;return k(t[4],t[5],t[6])}get leftVector(){let t=this.upVector,e=ne(u(),this.northVector,-g(this.heading),t);return Jt(e,t,e)}get rightVector(){return De(u(),this.leftVector)}clone(){return new Dt({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(t,e,i){let{observerRenderSpace:s,targetRenderSpace:r}=this,a=R(Ot,r,s);return ne(a,a,-g(e),this.leftVector),ne(a,a,-g(t),this.tiltedUpVector),q(i,a,s)}cornerPoints(t){let e=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-e,i,t.topLeft),this.pointOnSphere(e,i,t.topRight),this.pointOnSphere(-e,-i,t.bottomLeft),this.pointOnSphere(e,-i,t.bottomRight)}arcCentersPoints(t){let e=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,t.top),this.pointOnSphere(0,-i,t.bottom),this.pointOnSphere(-e,0,t.left),this.pointOnSphere(e,0,t.right)}parallelCenterPoints(t){let e=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(g(this.verticalFieldOfView/2)),s=I(Ot,this.tiltedUpVector,i);q(t.top,e,s),R(t.bottom,e,s)}renderSpaceToPoint(t,e){let i=Ot;return this.renderCoordsHelper.fromRenderCoords(t,i,e),new xe(i[0],i[1],i[2],e)}_pointToRenderSpace(t,e){let i=Wt(t.toArray());return this.renderCoordsHelper.toRenderCoords(i,t.spatialReference,e),e}_computeTargetRenderSpace(t){let{leftVector:e,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,a=u();return I(a,i,r),ne(a,a,-g(this.heading),s),ne(a,a,-g(this.tiltParallelToSurface),e),q(a,t,a),a}};n([l()],b.prototype,"renderCoordsHelper",void 0),n([l()],b.prototype,"viewshed",void 0),n([l()],b.prototype,"observerRenderSpaceOverride",void 0),n([l()],b.prototype,"observer",null),n([l()],b.prototype,"effectiveObserverRenderSpace",null),n([l()],b.prototype,"effectiveObserver",null),n([l()],b.prototype,"effectiveTargetRenderSpace",null),n([l()],b.prototype,"farDistance",null),n([l()],b.prototype,"farDistanceRenderSpace",null),n([l()],b.prototype,"heading",null),n([l()],b.prototype,"tilt",null),n([l()],b.prototype,"feature",null),n([l()],b.prototype,"tiltParallelToSurface",null),n([l()],b.prototype,"horizontalFieldOfView",null),n([l()],b.prototype,"verticalFieldOfView",null),n([l()],b.prototype,"observerRenderSpace",null),n([l()],b.prototype,"target",null),n([l()],b.prototype,"targetRenderSpace",null),n([l()],b.prototype,"targetDirection",null),n([l()],b.prototype,"tiltedUpVector",null),n([l()],b.prototype,"_basis",null),n([l()],b.prototype,"upVector",null),n([l()],b.prototype,"northVector",null),n([l()],b.prototype,"leftVector",null),n([l()],b.prototype,"rightVector",null),n([l()],b.prototype,"isValid",null),n([l()],b.prototype,"metersPerUnit",null),b=Dt=n([z("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],b);var Ot=u();var pe=class extends oi{constructor(){super(...arguments),this.sectionAngles=Xt()}get sectionAnglesDeg(){return dt(this.sectionAngles.map(t=>fe(t)))}set sectionAnglesDeg(t){this.sectionAngles=dt(t.map(e=>g(e)))}get projectionMatrix(){return L(_(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){let t=this.sectionAngles[0],e=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];Le(t<=e),Le(i<=s);let r=2*Math.tan(this.fovX/2),a=2*Math.tan(this.fovY/2),o=Math.tan(t),h=Math.tan(e),c=Math.tan(i),d=h-o,p=Math.tan(s)-c,m=r/d,f=a/p,w=-(o+d/2)/r*2,V=-(c+p/2)/a*2,O=_();ie(O,[w,V,0]);let D=_();ve(D,[m,f,1]);let F=_();return L(F,D,O)}get _sectionRatioX(){let t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/i)}setViewport(t,e){let i=e*this._sectionRatioX;return this.viewport=[t[0],t[1],i,e],i}};n([l()],pe.prototype,"sectionAngles",void 0),n([l()],pe.prototype,"sectionAnglesDeg",null),n([l()],pe.prototype,"projectionMatrix",null),n([l()],pe.prototype,"sectionMatrix",null),n([l()],pe.prototype,"_sectionRatioX",null),pe=n([z("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],pe);var Ct=class{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){let i=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*i}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}},Rt=["front","left","right","back","top","bottom"];function Xs(t){return!["top","bottom"].includes(t)}var ht=class{constructor(e){this._fbos=e,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new Ct,this._maxTextureSize=Math.min(Pt("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){let e=this.faces;return e.length===0?null:e[0].nearFar}get numActiveFaces(){let e=this._faces,i=0;return Object.keys(e).forEach(s=>{e[s]&&(i+=1)}),i}get faces(){let e=this._faces,i=[];for(let s of Rt){let r=e[s];r&&i.push(r)}return i}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,i,s,r){let{effectiveObserverRenderSpace:a,tiltedUpVector:o,targetRenderSpace:h,farDistanceRenderSpace:c,horizontalFieldOfView:d,verticalFieldOfView:p}=i,m=u();R(m,h,a);let f=u(),w=u(),V=(M,y)=>{let P=u(),Et=_();return G(Et,M,y),U(P,m,Et),q(P,a,P),P},O,D=o,F=Math.min(90,d),K=Math.min(90,Math.max(0,(d-90)/2)),x=-45,Y=45,Z=-45,ee=45;if(Xs(e)){let M=y=>Me(y,-45,45);Z=M(-p/2)-this.settings.toleranceBottomTop,ee=M(+p/2)+this.settings.toleranceBottomTop}switch(e){case"front":O=h,x=-F/2,Y=F/2;break;case"left":O=V(Math.PI/2,o),x=45-K;break;case"right":O=V(-Math.PI/2,o),Y=-45+K;break;case"top":O=q(f,a,o),D=De(w,m);break;case"bottom":O=R(f,a,o),D=m;break;case"back":O=V(Math.PI,o)}let ue=new pe({center:O,eye:a,up:D,far:c});ue.sectionAnglesDeg=[x-this.settings.toleranceSides,Y+this.settings.toleranceSides,Z,ee],ue.fovY=Math.PI/2;let S=ue.setViewport(s,r);return this._faces[e]=ue,S}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){let i=new Set,{horizontalFieldOfView:s,verticalFieldOfView:r}=e,a=-r/2,o=r/2;return s===0||r===0||(a<=45&&o>=-45&&i.add("front"),s>90&&(i.add("left"),i.add("right")),s>270&&i.add("back"),o>45-this.settings.toleranceBottomTop&&i.add("top"),a<-45+this.settings.toleranceBottomTop&&i.add("bottom")),i}_computeBaseTextureSize(e,i,s,r){let a=i/e.pixelRatio,o=this.settings.textureSizeModifier(s),h=Math.max(e.fullWidth,e.fullHeight),c=fi(Math.floor(h*a*o)),d=Math.floor(this._maxTextureSize/r),p=Me(c,this._minTextureSize,d);return vi(p)}_ensureFBO(e){let i=this._width,s=this._height;this._handle?.fbo?.width===i&&this._handle?.fbo?.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(i,s,"viewshed shadow map",ft.RGBA4));let r=e?vt.DEPTH_STENCIL_TEXTURE:vt.DEPTH16_BUFFER;this._handle.acquireDepth(r)}clearFBO(e){let i=this._fbos.rctx;this._ensureFBO(e),i.bindFramebuffer(this._handle?.fbo),i.setClearColor(1,1,1,1),i.clear(ut.COLOR|ut.DEPTH)}dispose(){this._handle=Lt(this._handle)}start(e,i,s,r,a=!1){this._faces={};let o=this._computeActiveFaces(i),h=o.size;if(h===0)return!1;let c=this._computeBaseTextureSize(e,r,s,h),d=0,p=0,m=0;return Rt.filter(f=>o.has(f)).forEach(f=>{let w=Qs(f,h);w>p&&(m=Math.max(m,d),d=0),p=w;let V=w*c;d+=this._setupFaceCamera(f,i,[d,V],c)}),m=Math.max(m,d),this._width=this.settings.textureResizeModulo(m),this._height=Ks(h)*c,this.clearFBO(a),!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,faceTypes:Rt,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",ft.RGBA4)}}};function Qs(t,e){if(e<4)return 0;let i=t==="front"||t==="left";return e===4?i?0:1:i||t==="right"?0:1}function Ks(t){return t<4?1:2}var qe=class extends ui{constructor(e,i,s){super(e,i,new hi($i,()=>import("./chunk-DIP4MAVD.js")),s)}initializePipeline(){return pi({colorWrite:di,blending:ci})}};var $=class extends mi{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(t=>Js(this.view,t))}constructor(t){super(t),this._techniques=null,this._passParameters=new Ji,this._viewsheds=new Gt,this._shadowMap=null,this.consumes={required:[$e.VIEWSHED],optional:["normals"]},this.produces=$e.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new ht(this.fboCache),this.addHandles([v(()=>this.view.resolutionScale,t=>{let e=this._shadowMap;e&&(e.settings.textureSizeQuality=t)},T),be(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),be(()=>this.view._stage.renderView.techniques,t=>this._techniques=t,T),v(()=>this._viewshedsInView.map(t=>[t.observerRenderSpace,t.heading,t.tilt,t.farDistance,t.horizontalFieldOfView,t.verticalFieldOfView]),()=>this.requestRender(mt.UPDATE),Qe)])}destroy(){this._shadowMap=zt(this._shadowMap)}precompile(){if(this.hasViewsheds){this._techniques?.precompile(qe);for(let t of this._viewshedsInView)if(this._shadowMap?.isActive(t))return void this.view._stage.renderer.precompileViewshedShadowMap()}}render(t){let e=this.bindParameters,i=this.renderingContext,s=t.find(({name:o})=>o===$e.VIEWSHED);if(!this.hasViewsheds||!e.depth)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=t.find(({name:o})=>o==="normals")?.getTexture();let r=this._techniques?.acquire(qe);if(!r?.compiled)return this.requestRender(mt.UPDATE),r?.release(),s;let a=this.view._stage.renderer.isFeatureEnabled(Zi.HighResolutionViewshed);for(let o of this._viewshedsInView){if(!this._renderShadowCubeMap(e,o,a)||!this._shadowMap?.ready)continue;let h=this._setupViewshedParameters(o,e.camera);i.bindTechnique(r,e,h),i.bindFramebuffer(s.fbo),i.screen.draw()}return r.release(),this.shadowMap?.dispose(),s}updateViewsheds(t){let e=this._viewsheds,{removes:i,adds:s}=t;if(i&&(Array.isArray(i)?e.removeMany(i):e.remove(i)),s)if(Array.isArray(s)){let r=s.filter(a=>!e.includes(a));e.addMany(r)}else e.includes(s)||e.add(s)}_renderShadowCubeMap(t,e,i){let s=this._shadowMap;if(!s)return!1;let r=this.view.basemapTerrain.hasStencilEnabledExtents,a=s.start(t.camera,e,i,this._contentPixelRatio,r);return a&&s.faces.forEach(o=>this.view._stage.renderer.renderViewshedShadowMap(o)),s.finish(),a}_setupViewshedParameters(t,e){let i=this._shadowMap;if(!i)return this._passParameters;let s=this._passParameters,r=t.effectiveObserverRenderSpace;s.localOrigin=r,s.observerOffset=R(er,t.observerRenderSpace,t.effectiveObserverRenderSpace),s.fovs=[g(t.horizontalFieldOfView),g(t.verticalFieldOfView)],s.headingAndTilt=[g(t.heading),g(t.tiltParallelToSurface)],s.upVector=t.tiltedUpVector;let a=Ys(t.targetRenderSpace,r);s.targetVector=a;let o=new Array,h=new Array;for(let c=0;c<i.numActiveFaces;c++)qt(At,i.viewshedViewMatrices[c],r),o.push(...At),Zs(i.viewshedProjectionMatrices[c],At,Ms),h.push(...Ms);return s.viewMatrices=o,s.projectionMatrices=h,s.volumeOffset=this.selectedViewshed?.()===t.viewshed?$s(t,this.view,e.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Ys(t,e){let i=u();return R(i,t,e)}function Zs(t,e,i){let s=k(.5,.5,.5);return ie(i,s),Nt(i,i,s),L(i,i,t),L(i,i,e),i}function Js(t,e){let i=ai(e.observerRenderSpace,e.farDistanceRenderSpace);return!!t.ready&&t.frustum.intersectsSphere(i)}function $s(t,e,i){if(t==null)return 0;let{observerRenderSpace:s,targetRenderSpace:r}=t,a=pt(i,s)>pt(i,r)?t.observer:t.target;return e.pixelSizeAt(a)}n([l()],$.prototype,"_techniques",void 0),n([l()],$.prototype,"selectedViewshed",void 0),n([l()],$.prototype,"shadowMap",null),n([l()],$.prototype,"hasViewsheds",null),n([l()],$.prototype,"_contentPixelRatio",null),n([l()],$.prototype,"_viewshedsInView",null),n([l()],$.prototype,"consumes",void 0),n([l()],$.prototype,"produces",void 0),$=n([z("esri.views.3d.webgl-engine.lib.Viewshed")],$);var er=u(),At=_(),Ms=_();var Q=class extends xi(te){constructor(t){super(t),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(t){this._unselectOtherViewsheds(t),this._selectedViewshed=t}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){let t=this.view;this._viewshedRenderer=new $({view:t,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed}),this._intersector=li(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=ni.MIN,this.viewshedComputedDataHandles=Oe(()=>this.analysis.viewsheds,e=>{let i=new b({renderCoordsHelper:t.renderCoordsHelper,viewshed:e}),s=Symbol();return this.addHandles([v(()=>({valid:i.isValid(),canProject:Yt(i.observer?.spatialReference,this.view.spatialReference)||Qt()}),({valid:r,canProject:a},o)=>{this.visible&&(r&&a?this._addViewshedsToRenderer(i):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(i),a||qi(this.analysis,i.observer.spatialReference,Ht.getLogger(this)))},T),v(()=>[t.state.camera,t.slicePlane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature],()=>{this._updateObserverFromFeature(t,i)},T)]),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}}),this._analysisVisualization=new Ve({view:t,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([v(()=>this.visible,e=>{let i=this.viewshedComputedDataHandles;if(i==null)return;e||(this.selectedViewshed=null);let s=i.map(r=>r.viewshedComputedData).filter(r=>r.isValid()).toArray();e?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),v(()=>t.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:i})=>i.renderCoordsHelper=e)}),Xi(this,Ge),be(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},he)])}destroy(){this._placementTask=Te(this._placementTask),Qi(this),this._analysisVisualization=C(this._analysisVisualization);let t=this.viewshedComputedDataHandles;t!=null&&this._removeViewshedsFromRenderer(t.map(e=>e.viewshedComputedData).toArray())}createViewsheds(t){return Ne(this,null,function*(){return this._placementTask=Te(this._placementTask),this._placementTask=Ni(this,t),this.tool!=null&&this.tool.createViewsheds(),yield this._placementTask.promise})}_addViewshedsToRenderer(t){this._viewshedRenderer.updateViewsheds({adds:t})}_removeViewshedsFromRenderer(t){this._viewshedRenderer.updateViewsheds({removes:t})}_updateObserverFromFeature(t,e){let i=e.observerRenderSpace,s=e.targetRenderSpace,r=j(u(),i),a={observer:i,observerSurfaceNormal:null,observerAdjusted:r,observerFeatureId:yi(e.feature),target:s,targetSurfaceNormal:null,targetAdjusted:j(u(),s),targetFeatureId:null};Si(t,this._intersector,a,o=>Math.min(o,.05*e.farDistanceRenderSpace)),e.observerRenderSpaceOverride=$t(r,i)?null:r}_unselectOtherViewsheds(t){if(t!=null)for(let e of this.view.tools.items)e!==this.tool&&e instanceof Ge&&(e.analysisViewData.selectedViewshed=null)}get test(){}};n([l({readOnly:!0})],Q.prototype,"type",void 0),n([l({constructOnly:!0,nonNullable:!0})],Q.prototype,"analysis",void 0),n([l()],Q.prototype,"tool",void 0),n([l()],Q.prototype,"_selectedViewshed",void 0),n([l()],Q.prototype,"selectedViewshed",null),n([l()],Q.prototype,"selectedViewshedComputedData",null),n([l()],Q.prototype,"viewshedComputedDataHandles",void 0),n([l()],Q.prototype,"_analysisVisualization",void 0),n([l()],Q.prototype,"_placementTask",void 0),n([l()],Q.prototype,"_viewshedRenderer",void 0),Q=n([z("esri.views.3d.analysis.ViewshedAnalysisView3D")],Q);var Hh=Q;export{Hh as default};
