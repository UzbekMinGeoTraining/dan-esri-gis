import{c as de}from"./chunk-NVD74CNP.js";import{a as $t,c as ut,d as ht}from"./chunk-ELOFFQD3.js";import{a as X}from"./chunk-J2D4NQQB.js";import{a as kt,b as at}from"./chunk-RI2HJFLU.js";import{p as fe}from"./chunk-4YNUZOQW.js";import{j as le,k as pe,l as me,m as gt,p as ue}from"./chunk-Q5GL3CSI.js";import{a as ae,f as ft,i as ce}from"./chunk-4DR6EKLV.js";import{a as ie}from"./chunk-2SZOQMAQ.js";import{a as he}from"./chunk-OT635BJR.js";import{a as ne,g as se}from"./chunk-SDHCGQUI.js";import{b as dt}from"./chunk-KHTVZWEX.js";import{c as H}from"./chunk-B3W5V2XP.js";import{a as re}from"./chunk-6N46AY7Z.js";import{b as j}from"./chunk-TCQTMUK4.js";import{b as oe}from"./chunk-I6ZCG7XQ.js";import{b as ee}from"./chunk-LCDA6FHZ.js";import{b as v}from"./chunk-JLNQ6WQT.js";import{a as te}from"./chunk-GB5RQL32.js";import{a as Y}from"./chunk-4OZVVJHM.js";import{b as Yt}from"./chunk-LCTRO7CL.js";import{b as Xt}from"./chunk-IHBD2IWR.js";import{p as Kt}from"./chunk-NH3JQE75.js";import{a as Q}from"./chunk-XXOIKNT6.js";import{a as Qt}from"./chunk-DBLGLVAQ.js";import{a as z,c as G,d as Ut,f as Ft,y as jt}from"./chunk-EPTSNNZF.js";import{p as Ht}from"./chunk-AOA5JMXK.js";import{a as qt,b as Jt}from"./chunk-7KH77MT4.js";import{b as mt,e as K}from"./chunk-Y6H3NTW7.js";import{a as C}from"./chunk-7W6RATG7.js";import{G as pt,b as Zt,c as N,e as ct,m as Wt,u as J,w as lt,y as F}from"./chunk-2HUIJUS4.js";import{e as Gt,f as Nt}from"./chunk-5MNDZ6BX.js";import{o as Tt}from"./chunk-T7BKG6V3.js";import{a as Lt}from"./chunk-3CR7P5WT.js";import{a as O,b as Bt,e as zt,i as Vt}from"./chunk-PYQRTZNZ.js";import{y as Rt}from"./chunk-N27U3N2T.js";import{ba as vt}from"./chunk-4DLSYLKE.js";import{b as q,t as Mt}from"./chunk-3IBUFXWY.js";import{a as wt,b as Dt,g as it}from"./chunk-JEGVIFEP.js";function ge(t,e,r,n){let o=ut(t.rings,!!t.hasZ&&n.mode!=="on-the-ground",ht.CCW_IS_HOLE,t.spatialReference),s=z(o.position.length),i=ae(o.position,t.spatialReference,0,s,0,o.position,0,o.position.length/3,e,r,n),c=i!=null;return new xt(o.position,s,be(o.polygons,o.position,s),ye(o.outlines,o.position,s),c,i)}function Ke(t,e){let r=ut(t.rings,!1,ht.CCW_IS_HOLE),n=Ht(r.position,t.spatialReference,0,r.position,e,0);for(let o=2;o<r.position.length;o+=3)r.position[o]=fe;return{position:r.position,polygons:be(r.polygons,r.position),outlines:ye(r.outlines,r.position),projectionSuccess:n}}function ye(t,e,r=null){return t.filter(({count:n})=>n>1).map(({index:n,count:o})=>{let s=3*n,i=3*o;return r!=null?new $(n,o,G(e,s,i),G(r,s,i)):new k(n,o,G(e,s,i))})}function be(t,e,r=null){let n=new Array;for(let{index:o,count:s,holeIndices:i,pathLengths:c}of t){if(s<=1)continue;let l=3*o,b=3*s,_=i.map(g=>g-o),x=r!=null?new yt(o,s,G(e,3*o,3*s),G(r,l,b),_,c):new bt(o,s,G(e,3*o,3*s),_,c);n.push(x)}return n}var k=class{constructor(e,r,n){this.index=e,this.count=r,this.position=n}},$=class extends k{constructor(e,r,n,o){super(e,r,n),this.mapPositions=o}},yt=class extends ${constructor(e,r,n,o,s,i){super(e,r,n,o),this.holeIndices=s,this.pathLengths=i}},bt=class extends k{constructor(e,r,n,o,s){super(e,r,n),this.holeIndices=o,this.pathLengths=s}},xt=class{constructor(e,r,n,o,s,i){this.position=e,this.mapPositions=r,this.polygons=n,this.outlines=o,this.projectionSuccess=s,this.sampledElevation=i}};function co(t,e,r){let n=(e.length>0?e[0]:t.length/3)-1,o=$t(t,n,r);if(o!==Lt.Z){t=t.slice();for(let s=0;s<t.length;s+=3)t[s+o]=t[s+2]}return X(t,e,3)}function lo(t){let e=[[C.POSITION,new v(t.attributeData.position,t.indices,3,!0)]],r=K(t.indices.length);return t.attributeData.colorFeature!=null?e.push([C.COLORFEATUREATTRIBUTE,new v([t.attributeData.colorFeature],r,1,!0)]):t.attributeData.color&&e.push([C.COLOR,new v(t.attributeData.color,r,4,!0)]),t.attributeData.uvMapSpace&&e.push([C.UVMAPSPACE,new v(t.attributeData.uvMapSpace,t.indices,4,!0)]),t.attributeData.boundingRect&&e.push([C.BOUNDINGRECT,new v(t.attributeData.boundingRect,t.indices,9,!0)]),new H(t.material,e,t.mapPositions,j.Mesh,t.attributeData.objectAndLayerIdColor)}function po(t,e=null){let r=[[C.POSITION,new v(t.attributeData.position,t.indices,3,!0)],[C.UV0,new v(t.attributeData.uv0,t.indices,2,!0)]];return new H(t.material,r,t.mapPositions,j.Mesh,e)}function _e(t){switch(t.type){case"extent":if(t instanceof Rt)return Tt.fromExtent(t);break;case"polygon":return t}return null}var xe=class{constructor(e,r,n){this.renderData=e,this.layerUid=r,this.graphicUid=n,this.outGeometries=new Array}};var Te=["polygon","extent"],Se=class extends ue{constructor(e,r,n,o){super(e,r,n,o),this.ensureDrapedStatus(!1)}doLoad(){return it(this,null,function*(){if(!this._drivenProperties.size){let b=se(this._getSymbolSize());if(b)throw new Mt("graphics3dextrudesymbollayer:invalid-size",b)}let e=this.symbolLayer?.material?.color,r=this._getCombinedOpacityAndColor(e),n=zt(r),o=r[3],s=o<1||this.needsDrivenTransparentPass,i=this.symbolLayer?.material?.emissiveFactor,c=i?Wt(Bt(i)):Vt,l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:o,transparent:s,cullFace:s?Y.None:Y.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,emissiveFactor:c,offsetTransparentBackfaces:!0,normalType:ee.Compressed};this._materials[M.Main]=new dt(l,this._context),this._materials[M.Bottom]=new dt(Dt(wt({},l),{cullFace:Y.Back}),this._context),this._context.stage.addMany(this._materials)})}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){let r=e.graphic;if(!this._validateGeometry(r.geometry,Te,this.symbolLayer.type))return null;let n=this._getVertexOpacityAndColor(e.renderingInfo,255),o=this.setGraphicElevationContext(r);return this._createAs3DShape(r,e.renderingInfo,n,o,r.uid)}layerOpacityChanged(e,r){let n=this.symbolLayer?.material?.color,o=this._getCombinedOpacity(n),s=o<1||this.needsDrivenTransparentPass;this._materials[M.Main]?.setParameters({opacity:o,transparent:s}),this._materials[M.Bottom]?.setParameters({opacity:o,transparent:s});let i=this._getLayerOpacity();e.forEach(c=>r(c)?.layerOpacityChanged(i,this._context.isAsync))}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,ft)}slicePlaneEnabledChanged(e,r){return this._materials[M.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[M.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(n=>{let o=r(n);o?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){let e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[M.Main]?.setParameters(e),this._materials[M.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let r;return r=e.size&&this._drivenProperties.size?de(e.size,2)??0:this._getSymbolSize(),r/=this._context.renderCoordsHelper.unitInMeters,r}applyRendererDiff(e,r){return this._drivenPropertiesChanged(r)?gt.RecreateSymbol:gt.RecreateGraphics}queryForSnapping(e,r,n,o){return it(this,null,function*(){let s=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/vt(r),{objectId:i,target:c}=e,l=q(c);switch(l.z=(l.z??0)+s,e.type){case"edge":{let{start:b,end:_}=e,x=q(b),g=q(_);return x.z=(x.z??0)+s,g.z=(g.z??0)+s,[at(i,l,1/0,x,g)]}case"vertex":return[kt(i,l,1/0),at(i,c,1/0,c,l)];default:return[]}})}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,r,n,o,s){let i=_e(e.geometry);if(i==null)return null;if(i.rings.length===0||!i.rings.some(w=>w.length>0))return this._logGeometryValidationWarnings(i.rings,"rings","ExtrudeSymbol3DLayer"),null;let c=ge(i,this._context.elevationProvider,this._context.renderCoordsHelper,o);this._logGeometryCreationWarnings(c,i.rings,"rings","ExtrudeSymbol3DLayer");let l=ne(i);if(l==null)return null;let b=new Array,_=new Array,x=Ut(),g=Q(),P=O(),p=this._context.renderCoordsHelper.viewingMode===te.Global;p||this._context.renderCoordsHelper.worldUpAtPosition(null,P),Xt(i.spatialReference,[l.x,l.y,0],g,this._context.renderCoordsHelper.spatialReference);let d=Q();Nt(d,g);let h=Qt();Kt(h,d);let{polygons:y,mapPositions:u,position:f}=c,m=new Map,S=this._materials[M.Main];for(let w of y){let L=w.count;if(this._context.clippingExtent&&(Ft(w.mapPositions,x),!jt(x,this._context.clippingExtent)))continue;let T=X(w.mapPositions,w.holeIndices,3);if(T.length===0)continue;let B=T.length,V=6*L,ot=mt(V+B),rt=mt(B),W=z(3*V),It=z(3*V),Ct=z(3*V),Et=z(V);Be(f,u,T,w,W,Ct,It,Et,ot,rt,this._getExtrusionSize(r),P,p),Yt(W,W,d);let Ot=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:this._context.layer.uid}),nt=new St(W,Ct,Jt(It),Et),st=Pe(S,ot,ot.length-rt.length,nt,n,Ot),ve=L,Re=L,Le=2*w.count,At=new Pt(ve,Re,Le,B/3);Me(st,At,g),m.set(st,At),b.push(st,Pe(this._materials[M.Bottom],rt,0,nt,n,Ot)),_.push(nt.heights)}if(b.length===0)return null;let a=new he({geometries:b,layerUid:this._context.layer.uid,graphicUid:s,isElevationSource:!0});a.transformation=g;let I=oe(this.symbolLayer,{opacity:this._getLayerOpacity()}),E=I?new pe(this._materials[M.Main],I,this._context.slicePlaneEnabled):null,R=new me(this,a,b,null,null,(w,L,T,B,V)=>Ge(w,L,T,B,V,_,m),o,E);return R.alignedSampledElevation=c.sampledElevation,R.needsElevationUpdates=ft(o.mode),R}};function Pe(t,e,r,n,o,s){let i=K(e.length),c=[[C.POSITION,new v(n.positions,e,3,!0)],[C.NORMALCOMPRESSED,new v(n.normals,e,2,!0)],[C.COLOR,new v(o,i,4,!0)]];return new H(t,c,n.elevation,j.Mesh,s,r)}function Be(t,e,r,n,o,s,i,c,l,b,_,x,g){{let P=r.length/3,p=2*n.count;ze(t,e,n.index,n.count,r,0,P,o,s,i,c,l,b,p,_,x,g)}{let P=0,p=2*n.count,d=0,h=n.pathLengths[0];Ie(o,s,c,i,P,h,n.count,p,l,d,_),p+=4*h,d+=2*h,P+=h;for(let y=1;y<n.pathLengths.length;++y){let u=n.pathLengths[y];Ie(o,s,c,i,P,u,n.count,p,l,d,_),p+=4*u,d+=2*u,P+=u}}}function ze(t,e,r,n,o,s,i,c,l,b,_,x,g,P,p,d,h){Zt(D,d);{let y=p>0?1:-1,u=3*r,f=0,m=3*f,S=n,a=3*S;for(let I=0;I<n;++I){let E=t[u],R=t[u+1],w=t[u+2];h&&(D[0]=E,D[1]=R,D[2]=w,J(D,D)),c[m+0]=E,c[m+1]=R,c[m+2]=w;let L=e[u+0],T=e[u+1],B=e[u+2];l[m+0]=L,l[m+1]=T,l[m+2]=B,b[m+0]=-y*D[0],b[m+1]=-y*D[1],b[m+2]=-y*D[2],_[f]=0,c[a+0]=E+p*D[0],c[a+1]=R+p*D[1],c[a+2]=w+p*D[2],l[a+0]=L,l[a+1]=T,l[a+2]=B,_[S]=p,m+=3,a+=3,u+=3,f+=1,S+=1}}{let y=3*s,u=0,f=3*P,m=p<0?De:we,S=p<0?we:De;for(let a=0;a<i;++a)g[u]=o[y+m[0]],g[u+1]=o[y+m[1]],g[u+2]=o[y+m[2]],x[f]=o[y+S[0]]+n,x[f+1]=o[y+S[1]]+n,x[f+2]=o[y+S[2]]+n,u+=3,f+=3,y+=3}}function tt(t,e,r,n,o,s,i){n[s]=n[i],i*=3,t[s*=3]=t[i],t[s+1]=t[i+1],t[s+2]=t[i+2],e[s]=e[i],e[s+1]=e[i+1],e[s+2]=e[i+2],r[s]=o[0],r[s+1]=o[1],r[s+2]=o[2]}var Z=O();function Ie(t,e,r,n,o,s,i,c,l,b,_){let x=o,g=o+1,P=o+i,p=o+i+1,d=c,h=c+1,y=c+2*s,u=c+2*s+1;_<0&&(x=o+i+1,p=o);let f=3*b;for(let m=0;m<s;++m)m===s-1&&(g=o,_>0?p=o+i:x=o+i),Ve(t,x,g,P,Z),tt(t,e,n,r,Z,d,x),tt(t,e,n,r,Z,h,g),tt(t,e,n,r,Z,y,P),tt(t,e,n,r,Z,u,p),l[f]=d,l[f+1]=y,l[f+2]=u,l[f+3]=d,l[f+4]=u,l[f+5]=h,f+=6,x++,g++,P++,p++,d+=2,h+=2,y+=2,u+=2}var _t=O(),Ce=O(),Ee=O(),Oe=O(),Ae=O();function Ve(t,e,r,n,o){e*=3,r*=3,n*=3,N(_t,t[e++],t[e++],t[e++]),N(Ce,t[r++],t[r++],t[r++]),N(Ee,t[n++],t[n++],t[n++]),ct(Oe,Ce,_t),ct(Ae,Ee,_t),lt(o,Ae,Oe),J(o,o)}var U=O();function Ge(t,e,r,n,o,s,i){let c=t.stageObject,l=c.geometries,b=l.length,_=e.mode!=="absolute-height",x=0,g=c.transformation,P=Gt(Q(),g);for(let p=0;p<b;p+=2){let d=l[p];if(!le(d))continue;let h=d.getMutableAttribute(C.POSITION).data,y=s[p/2],u=new ie(d.mapPositions),f=h.length/3,m=!1,S=0;{let a=0;for(let I=0;I<f;I++){U[0]=h[a],U[1]=h[a+1],U[2]=h[a+2],n(u,et),_&&(S+=et.sampledElevation),re.TESTS_DISABLE_OPTIMIZATIONS?(N(A,u.array[u.offset],u.array[u.offset+1],et.z+y[a/3]),r!=null&&o.toRenderCoords(A,r,A),F(A,A,P)):(N(A,h[a],h[a+1],h[a+2]),F(A,A,g),o.setAltitude(A,et.z+y[a/3]),F(A,A,P)),h[a]=A[0],h[a+1]=A[1],h[a+2]=A[2];let E=Ne/o.unitInMeters;(Math.abs(U[0]-h[a])>=E||Math.abs(U[1]-h[a+1])>=E||Math.abs(U[2]-h[a+2])>=E)&&(m=!0),u.offset+=3,a+=3}}if(m){let a=i.get(d);a&&Me(d,a,g),c.geometryVertexAttributeUpdated(l[p],C.NORMALCOMPRESSED),d.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[p],C.POSITION),l[p+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[p+1],C.POSITION)}x+=S/f}return x/b}function Me(t,e,r){let n=t.getMutableAttribute(C.POSITION),o=t.getMutableAttribute(C.NORMALCOMPRESSED).data,{topVertexStart:s,topVertexCount:i,topFaceStart:c,topFaceCount:l}=e,b=n.data,_=i,x=t.attributes.get(C.POSITION).indices,g=c+l,P=s+i,p=z(3*_);for(let m=0;m<_;++m){let S=3*m;p[S+0]=0,p[S+1]=0,p[S+2]=0}let d=Ue,h=Fe,y=je,u=He,f=D;for(let m=c;m<g;++m){let S=3*m;for(let a=0;a<3;++a){let I=x[S+a];u[a]=I;let E=3*I;N(A,b[E+0],b[E+1],b[E+2]),F(d[a],A,r)}pt(h,d[1],d[0]),pt(y,d[2],d[0]),lt(f,h,y),J(f,f);for(let a=0;a<3;++a){let I=3*(u[a]-s);p[I+0]+=f[0],p[I+1]+=f[1],p[I+2]+=f[2]}}for(let m=s;m<P;++m){let S=3*(m-s),a=p[S+0],I=p[S+1],E=p[S+2],R=Math.sqrt(a*a+I*I+E*E);qt(o,m,a/R,I/R,E/R)}}var A=O(),D=O(),et=new ce,we=[0,2,1],De=[0,1,2],Ne=.01,Ue=[O(),O(),O()],Fe=O(),je=O(),He=[0,0,0],M;(function(t){t[t.Main=0]="Main",t[t.Bottom=1]="Bottom"})(M||(M={}));var St=class{constructor(e,r,n,o){this.positions=e,this.elevation=r,this.normals=n,this.heights=o}},Pt=class{constructor(e,r,n,o){this.topVertexStart=e,this.topVertexCount=r,this.topFaceStart=n,this.topFaceCount=o}};export{co as a,lo as b,po as c,_e as d,xe as e,ge as f,Ke as g,Se as h,Be as i};
