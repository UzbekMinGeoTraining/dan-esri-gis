import{n as tt,q as nt,v as et}from"./chunk-ADMU4VMS.js";import{m as at}from"./chunk-3TP25Q6W.js";import{d as it,e as ot,f as st}from"./chunk-4AMJ3NIP.js";import{b as X}from"./chunk-RLWJFGVZ.js";import{a as $}from"./chunk-I6DDZT7I.js";import{a as K}from"./chunk-XGJXAYNE.js";import{a as Y}from"./chunk-TOUCHIYC.js";import{m as W}from"./chunk-AB4CTIUZ.js";import{v as J}from"./chunk-3KFX3FFC.js";import{d as V}from"./chunk-RLQK45UV.js";import{a as Q}from"./chunk-JMSMQ4Z7.js";import{d as C,f as T}from"./chunk-O4AQRVFI.js";import{a as j}from"./chunk-MBJHSEMD.js";import{a as E}from"./chunk-PYQRTZNZ.js";import{Q as y,S as B}from"./chunk-GGZQ5GCM.js";import{U as q}from"./chunk-TFUPB3ZG.js";import{a as h}from"./chunk-BMVJCP2M.js";import{D as H,c as F,u as N}from"./chunk-GMC3I5VG.js";import{d as z,e as S}from"./chunk-WGF2T2BG.js";import{a as v,b as x,g as d}from"./chunk-JEGVIFEP.js";function Ht(n){return it(n)??tt(n)}function Ct(n,t){return ot(n,t)??nt(n,t)}function Tt(n,t,e){return _[0]=n[0],_[1]=n[1],_[2]=n.length===3?n[2]:0,b[0]=t[0],b[1]=t[1],b[2]=t.length===3?t[2]:0,st(_,b,e)??et(_,b,e)}var _=E(),b=E();var k=class{constructor(t){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.drawConstraints=null,this.editGeometryOperations=t.editGeometryOperations,this.elevationInfo=t.elevationInfo,this.pointer=t.pointer,this.vertexHandle=t.vertexHandle,this.excludeFeature=t.excludeFeature,this.feature=t.feature,this.visualizer=t.visualizer,this.selfSnappingZ=t.selfSnappingZ,this.drawConstraints=t.drawConstraints}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}};function Ut({predicate:n=()=>!0,snappingManager:t,snappingContext:e,updatingHandles:o,useZ:i=!0}){let s=new at;if(t==null)return{snappingStep:[rt,s],cancelSnapping:rt};let a,p=null,l=null,u=null,c=()=>{p=S(p),t.doneSnapping(),l?.frameTask.remove(),l=null,a=z(a),u=null},ct=Pt(t,i,s),G=null,g=null,f=null;return{snappingStep:[r=>{if(!n(r))return r;let{action:I}=r;if(I==="start"){let{info:w}=r,Z=vt(t.view);if(l=xt(e,r,Z),l.context.selfSnappingZ=null,!i&&w!=null){let P=yt(e.coordinateHelper,w.handle.component);P!=null&&(l.context.selfSnappingZ={value:P,elevationInfo:e.elevationInfo??J})}}if(l!=null){let{context:w,originalScenePos:Z,originalPos:P}=l,{mapEnd:L,mapStart:M,scenePoints:ft}=r,D=lt(P,A(L,M)),R=A(M,P),dt=x(v({},r),{action:"update"}),ht=l.context,O=St(Z,ft),U=t.update({point:D,scenePoint:O,context:w});if(f=U,pt(L,U,R,i),G=D,g=O,I!=="end"){let{frameTask:mt}=l;p==null&&(p=new AbortController),u=gt=>{o.addPromise(N(ct({frameTask:mt,event:dt,context:ht,point:D,scenePoint:O,delta:R,getLastState:()=>({point:G,scenePoint:g,updatePoint:gt.forceUpdate?null:f})},p.signal)))},u({forceUpdate:!1}),a==null&&(a=j(()=>t.options.effectiveEnabled,()=>u?.({forceUpdate:!0})))}}return I==="end"&&c(),r},s],cancelSnapping:r=>(c(),r)}}function Pt(n,t,e){return H((ct,G)=>d(this,[ct,G],function*({frameTask:o,point:i,scenePoint:s,context:a,event:p,delta:l,getLastState:u},c){let g=yield o.schedule(()=>n.snap({point:i,scenePoint:s,context:a,signal:c}),c);if(g.valid){let f=yield o.schedule(()=>g.apply(),c),r=u();r.point!=null&&i!==r.point&&(f=n.update({point:r.point,scenePoint:r.scenePoint,context:a})),r.updatePoint!=null&&Q(f,r.updatePoint)||(pt(p.mapEnd,f,l,t),e.execute(p))}}))}function vt(n){return n.type==="3d"?n.resourceController.scheduler.registerTask(C.SNAPPING):T}function xt(n,t,e){return{context:new k({editGeometryOperations:n.editGeometryOperations,elevationInfo:n.elevationInfo,pointer:n.pointer,vertexHandle:t.info!=null?t.info.handle:null,excludeFeature:n.excludeFeature,feature:n.feature,visualizer:n.visualizer}),originalPos:t.snapOrigin!=null?n.coordinateHelper.vectorToDehydratedPoint(t.snapOrigin):t.mapStart,originalScenePos:t.scenePoints!=null?t.scenePoints.sceneStart:null,frameTask:e}}function lt(n,[t,e,o]){let i=V(n);return i.x+=t,i.y+=e,i.hasZ&&(i.z+=o),i}function St(n,t){return n==null||t==null?null:lt(n,A(t.sceneEnd,t.sceneStart))}function A(n,t){let e=n.hasZ&&t.hasZ?n.z-t.z:0;return[n.x-t.x,n.y-t.y,e]}function pt(n,t,[e,o,i],s){n.x=t.x+e,n.y=t.y+o,s&&n.hasZ&&t.hasZ&&(n.z=t.z+i)}function yt(n,t){if(!n.hasZ())return null;let e=t.vertices,o=null;for(let i of e){let s=n.getZ(i.pos);if(o!=null&&s!=null&&Math.abs(s-o)>1e-6)return null;o==null&&(o=s)}return o}function rt(n){return n}var ut=class{draw(t,e){let o=_t(t),i=this.sortUniqueHints(o),s=[];for(let a of i)a instanceof K&&s.push(this.visualizeIntersectionPoint(a,e)),a instanceof W&&s.push(this.visualizeLine(a,e)),a instanceof X&&s.push(this.visualizeParallelSign(a,e)),a instanceof $&&s.push(this.visualizeRightAngleQuad(a,e)),a instanceof Y&&s.push(this.visualizePoint(a,e));return F(s)}sortUniqueHints(t){return t}};function _t(n){let t=[];for(let e of n){let o=!0;for(let i of t)if(e.equals(i)){o=!1;break}o&&t.push(e)}return t}var m=class extends B{constructor(n){super(n),this.constrainResult=t=>t,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=H((t,e,o,i)=>d(this,null,function*(){let s=this._frameTask;if(s==null)return;let a=yield s.schedule(()=>e.snap(x(v({},t),{context:o,signal:i})),i);a.valid&&(yield s.schedule(()=>{this.stagedPoint=a.apply(),t!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=e.update(x(v({},this._snapPoints),{context:o})))},i))}))}get stagedPoint(){return this._stagedPoint}set stagedPoint(n){this._stagedPoint=this.constrainResult(n)}initialize(){let n=this.view.type==="3d"?this.view?.resourceController?.scheduler:null;this._frameTask=n!=null?n.registerTask(C.SNAPPING):T}destroy(){this._abortController=S(this._abortController),this._frameTask=z(this._frameTask)}update(n,t,e){this._snapPoints=n;let{point:o,scenePoint:i}=n,s=t.update({point:o,scenePoint:i,context:e});return this.stagedPoint=s,s}snap(n,t,e){return d(this,null,function*(){let{point:o,scenePoint:i}=n;return this.stagedPoint=t.update({point:o,scenePoint:i,context:e}),this._snapPoints=n,this._abortController==null&&(this._abortController=new AbortController),this._snap(n,t,e,this._abortController.signal)})}snapAgainNearPreviousMapPoint(n,t){return d(this,null,function*(){this._snapPoints!=null&&(yield this.snap(this._snapPoints,n,t))})}abort(){this._abortController=S(this._abortController),this._snapPoints=null}};h([y({constructOnly:!0})],m.prototype,"view",void 0),h([y()],m.prototype,"stagedPoint",null),h([y()],m.prototype,"constrainResult",void 0),h([y()],m.prototype,"_stagedPoint",void 0),m=h([q("esri.views.interactive.snapping.SnappingOperation")],m);export{ut as a,Ht as b,Ct as c,Tt as d,k as e,Ut as f,m as g};
