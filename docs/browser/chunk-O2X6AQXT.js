import{a as f}from"./chunk-GEZWIVEL.js";import{b as p}from"./chunk-V5Q4ZJF2.js";import{a as I}from"./chunk-TJH2I4RU.js";import{a as v}from"./chunk-CJTT5UF4.js";import{b as d}from"./chunk-EYI3QUAE.js";import{f as L}from"./chunk-LAJXTVEO.js";import{a as N}from"./chunk-EUZMXXZJ.js";import{t as b}from"./chunk-3IBUFXWY.js";import{a as T,g as c}from"./chunk-JEGVIFEP.js";var S=class{constructor(){this._serviceMetadatas=new Map,this._itemDatas=new Map}fetchServiceMetadata(a,t){return c(this,null,function*(){let r=this._serviceMetadatas.get(a);if(r)return r;let s=yield I(a,t);return this._serviceMetadatas.set(a,s),s})}fetchItemData(a){return c(this,null,function*(){let{id:t}=a;if(!t)return null;let{_itemDatas:r}=this;if(r.has(t))return r.get(t);let s=yield a.fetchData();return r.set(t,s),s})}fetchCustomParameters(a,t){return c(this,null,function*(){let r=yield this.fetchItemData(a);return r&&typeof r=="object"&&(t?t(r):r.customParameters)||null})}};function y(e){let a={id:e.id,name:e.name},t=p(e.type);return t!=="FeatureLayer"&&(a.layerType=t),a}function M(e,a,t){return c(this,null,function*(){if(e?.layers==null||e?.tables==null){let r=yield t.fetchServiceMetadata(a,{customParameters:l(e)?.customParameters});(e=e||{}).layers=e.layers||r?.layers?.map(y),e.tables=e.tables||r?.tables?.map(y)}return e})}function l(e){if(!e)return null;let{layers:a,tables:t}=e;return a?.length?a[0]:t?.length?t[0]:null}function C(e,a){return a==null?null:[...e.layers||[],...e.tables||[]].find(t=>t.id===a)}function se(e,a){return[...e.layers||[],...e.tables||[]].filter(({layerType:t})=>t?t===a:a==="ArcGISFeatureLayer")}function w(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function ne(e){switch(e){case"catalog":return"CatalogLayer";case"feature":return"ArcGISFeatureLayer";case"oriented-imagery":return"OrientedImageryLayer";case"subtype-group":return"SubtypeGroupLayer"}return null}function P(e){switch(e){case"CatalogLayer":return"CatalogLayer";case"OrientedImageryLayer":return"OrientedImageryLayer";case"SubtypeGroupLayer":return"SubtypeGroupLayer"}return"FeatureLayer"}function F(e,a,t){return c(this,null,function*(){if(!e?.url)return a??{};if(a??={},!a.layers){let n=yield t.fetchServiceMetadata(e.url);a.layers=n.layers?.map(y)}let{serverUrl:r,portalItem:s}=yield f(e.url,{sceneLayerItem:e,customParameters:l(a)?.customParameters}).catch(()=>({serverUrl:null,portalItem:null}));if(r==null)return a.tables=[],a;if(!a.tables&&s){let n=yield s.fetchData().catch(()=>null);if(n?.tables)a.tables=n.tables.map(y);else{let o=yield t.fetchServiceMetadata(r,{customParameters:l(n)?.customParameters}).catch(()=>null);a.tables=o?.tables?.map(y)}}if(a.tables)for(let n of a.tables)n.url=`${r}/${n.id}`;return a})}function Se(e){return c(this,null,function*(){let{portalItem:a}=e;!a||a instanceof N||(a=new N(a));let t=yield D(a);return new t.constructor(T({portalItem:a},t.properties))})}function D(e){return c(this,null,function*(){yield e.load();let a=new S;return x(yield O(e,a))})}function O(e,a){return c(this,null,function*(){switch(e.type){case"3DTiles Service":return U();case"CSV":return _();case"Feature Collection":return J(e);case"Feature Service":return K(e,a);case"Feed":return H();case"GeoJson":return k();case"Group Layer":return Q();case"Image Service":return V(e,a);case"KML":return R();case"Knowledge Graph Layer":return B();case"Map Service":return A(e,a);case"Media Layer":return X();case"Scene Service":return j(e,a);case"Stream Service":return W();case"Vector Tile Service":return $();case"WFS":return E();case"WMS":return q();case"WMTS":return z();default:throw new b("portal:unknown-item-type","Unknown item type '${type}'",{type:e.type})}})}function x(e){return c(this,null,function*(){let a=e.className,t=v[a];return{constructor:yield t(),properties:e.properties}})}function A(e,a){return c(this,null,function*(){return(yield Y(e,a))?{className:"TileLayer"}:{className:"MapImageLayer"}})}function K(e,a){return c(this,null,function*(){let t=yield G(e,a);if(typeof t=="object"){let{sourceJSON:r,className:s}=t,n={sourceJSON:r};return t.id!=null&&(n.layerId=t.id),{className:s||"FeatureLayer",properties:n}}return{className:"GroupLayer"}})}function j(e,a){return c(this,null,function*(){let t=yield G(e,a,()=>c(this,null,function*(){try{if(!e.url)return[];let{serverUrl:r}=yield f(e.url,{sceneLayerItem:e});return(yield a.fetchServiceMetadata(r))?.tables??[]}catch{return[]}}));if(typeof t=="object"){let r={},s;if(t.id!=null?(r.layerId=t.id,s=`${e.url}/layers/${t.id}`):s=e.url,e.typeKeywords?.length){for(let o of Object.keys(L))if(e.typeKeywords.includes(o))return{className:L[o]}}let n=yield a.fetchServiceMetadata(s,{customParameters:yield a.fetchCustomParameters(e,o=>l(o)?.customParameters)});return{className:L[n?.layerType]||"SceneLayer",properties:r}}return t===!1&&(yield a.fetchServiceMetadata(e.url))?.layerType==="Voxel"?{className:"VoxelLayer"}:{className:"GroupLayer"}})}function J(e){return c(this,null,function*(){yield e.load();let a=d(e,"Map Notes"),t=d(e,"Markup");if(a||t)return{className:"MapNotesLayer"};if(d(e,"Route Layer"))return{className:"RouteLayer"};let r=yield e.fetchData();return w(r)===1?{className:"FeatureLayer"}:{className:"GroupLayer"}})}function V(e,a){return c(this,null,function*(){yield e.load();let t=e.typeKeywords?.map(h=>h.toLowerCase())??[];if(t.includes("elevation 3d layer"))return{className:"ElevationLayer"};if(t.includes("tiled imagery"))return{className:"ImageryTileLayer"};let r=yield a.fetchItemData(e),s=r?.layerType;if(s==="ArcGISTiledImageServiceLayer")return{className:"ImageryTileLayer"};if(s==="ArcGISImageServiceLayer")return{className:"ImageryLayer"};let n=yield a.fetchServiceMetadata(e.url,{customParameters:yield a.fetchCustomParameters(e)}),o=n.cacheType?.toLowerCase(),m=n.capabilities?.toLowerCase().includes("tilesonly"),i=n.tileInfo?.format?.toLowerCase()??"",u=o==null&&["jpg","jpeg","png","png8","png24","png32","mixed"].includes(i);return o==="map"||u||m?{className:"ImageryTileLayer"}:{className:"ImageryLayer"}})}function W(){return{className:"StreamLayer"}}function $(){return{className:"VectorTileLayer"}}function k(){return{className:"GeoJSONLayer"}}function U(){return{className:"IntegratedMesh3DTilesLayer"}}function _(){return{className:"CSVLayer"}}function R(){return{className:"KMLLayer"}}function B(){return{className:"KnowledgeGraphLayer"}}function E(){return{className:"WFSLayer"}}function q(){return{className:"WMSLayer"}}function z(){return{className:"WMTSLayer"}}function H(){return{className:"StreamLayer"}}function Q(){return{className:"GroupLayer"}}function X(){return{className:"MediaLayer"}}function Y(e,a){return c(this,null,function*(){let{tileInfo:t}=yield a.fetchServiceMetadata(e.url,{customParameters:yield a.fetchCustomParameters(e)});return t})}function G(e,a,t){return c(this,null,function*(){let{url:r,type:s}=e,n=s==="Feature Service";if(!r)return{};if(/\/\d+$/.test(r)){if(n){let i=yield a.fetchServiceMetadata(r,{customParameters:yield a.fetchCustomParameters(e,u=>l(u)?.customParameters)});return{id:i.id,className:p(i.type),sourceJSON:i}}return{}}yield e.load();let o=yield a.fetchItemData(e);if(n){let i=yield M(o,r,a),u=g(i);if(typeof u=="object"){let h=C(i,u.id);u.className=P(h?.layerType)}return u}if(s==="Scene Service"&&(o=yield F(e,o,a)),w(o)>0)return g(o);let m=yield a.fetchServiceMetadata(r);return t&&(m.tables=yield t()),g(m)})}function g(e){return w(e)===1&&{id:l(e)?.id}}export{S as a,y as b,M as c,l as d,se as e,w as f,ne as g,P as h,F as i,Se as j,O as k};
