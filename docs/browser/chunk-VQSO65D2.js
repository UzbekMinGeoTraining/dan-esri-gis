import{b as xt}from"./chunk-LG6GNVKY.js";import{a as Ce,c as Oe,d as we}from"./chunk-SYONT74X.js";import{a as _e}from"./chunk-WBMJOZIQ.js";import{a as be,b as Dt}from"./chunk-UAAZOJXO.js";import{a as At,d as Ht,l as Mt}from"./chunk-SNMZODUZ.js";import{c as ht,e as kt}from"./chunk-PDFLS2XB.js";import"./chunk-EMYDLWPI.js";import"./chunk-NJ2A46RA.js";import"./chunk-BJAL3HBH.js";import"./chunk-374RA6E7.js";import"./chunk-3TKN2TWC.js";import"./chunk-RZ2HUHIL.js";import"./chunk-QGKQ2OTS.js";import"./chunk-7DG45AVS.js";import{b as Et}from"./chunk-3TP25Q6W.js";import"./chunk-FG5U4A7J.js";import"./chunk-VJX4SEWU.js";import{a as Vt,b as St}from"./chunk-OQ4WL4CW.js";import{b as Pt,d as ve}from"./chunk-VAYZZQCL.js";import"./chunk-PD3MYUGK.js";import"./chunk-M2LOI65L.js";import"./chunk-NUHIEXKU.js";import"./chunk-4QB6GMEG.js";import{a as ct}from"./chunk-NUNUXWV4.js";import"./chunk-TKXAXJNG.js";import{b as ye}from"./chunk-UZVBE57Y.js";import"./chunk-D3BMTQYU.js";import{a as fe}from"./chunk-UYKI77KI.js";import"./chunk-4DR6EKLV.js";import"./chunk-2SZOQMAQ.js";import"./chunk-OT635BJR.js";import"./chunk-WCQK6XOZ.js";import"./chunk-RCCESRES.js";import"./chunk-MM6IP4FS.js";import{a as Rt}from"./chunk-BBIP22OX.js";import{c as G}from"./chunk-IWGILE5R.js";import"./chunk-F7R3VTP4.js";import"./chunk-MNU4KXU7.js";import{b as nt}from"./chunk-CEM45EZZ.js";import"./chunk-GLY75KSJ.js";import{a as ge}from"./chunk-H7LSTWKZ.js";import{f as he,l as me,o as It}from"./chunk-3KFX3FFC.js";import"./chunk-IW2AVHBW.js";import"./chunk-SDHCGQUI.js";import"./chunk-VSPQNL6A.js";import"./chunk-WNU76WNW.js";import"./chunk-H4XRNT5U.js";import"./chunk-WIJFCRLT.js";import{b as ce}from"./chunk-6ISQQD7M.js";import"./chunk-VHVYC3RW.js";import{d as Tt}from"./chunk-ZBOVC36T.js";import"./chunk-RLQK45UV.js";import"./chunk-SDC4SION.js";import"./chunk-6VHG3ZEH.js";import{a as J,b as ot}from"./chunk-N3AGC3JB.js";import"./chunk-IGNHVSQC.js";import"./chunk-B3W5V2XP.js";import"./chunk-NP35J4DQ.js";import"./chunk-JBGML6IF.js";import"./chunk-S2HMCZNZ.js";import"./chunk-WUAC4CFP.js";import"./chunk-ONDKJR4V.js";import"./chunk-QB4KDO4M.js";import"./chunk-NNNTRPDR.js";import"./chunk-KDLA3TQ2.js";import"./chunk-RPMDOAYZ.js";import"./chunk-J7UK2QPE.js";import"./chunk-6DXGZQQN.js";import"./chunk-3PK63SMD.js";import"./chunk-GQ2SPTYG.js";import"./chunk-RBWI4VLW.js";import"./chunk-MEA3RU4I.js";import"./chunk-3AMG6HG6.js";import"./chunk-I6ETUG5Q.js";import"./chunk-L3GHXHDP.js";import"./chunk-N6PITG7Q.js";import"./chunk-XC4LDHG5.js";import"./chunk-S3ASAZCA.js";import"./chunk-ZUUCQTSR.js";import"./chunk-GKUBZAEG.js";import"./chunk-UW734WOQ.js";import"./chunk-BIZV3H6H.js";import"./chunk-UCYGH5UZ.js";import"./chunk-ATV5GTE5.js";import"./chunk-X7WNJQZZ.js";import"./chunk-PQPFAB53.js";import"./chunk-QPPQKNYU.js";import"./chunk-MJXFSFCY.js";import"./chunk-6N46AY7Z.js";import"./chunk-TCQTMUK4.js";import"./chunk-AY3YVZUY.js";import"./chunk-7DCEI345.js";import"./chunk-ZG3FCPXY.js";import"./chunk-RIUAG34V.js";import"./chunk-G5SIQY64.js";import"./chunk-WW7S4V24.js";import"./chunk-UGAMS6PU.js";import"./chunk-EHDNZUTT.js";import"./chunk-ECBUS54L.js";import"./chunk-NH7OOX2I.js";import"./chunk-B72PB7U4.js";import"./chunk-644SLL4Y.js";import"./chunk-A54VD7GL.js";import"./chunk-K55ZDM2S.js";import"./chunk-W3OGU5I2.js";import"./chunk-OO4IIGVK.js";import"./chunk-KQHYII76.js";import"./chunk-6I6DPRXI.js";import"./chunk-RNN6GAXL.js";import"./chunk-4IVMQ5PX.js";import"./chunk-CQUOQXLP.js";import"./chunk-VMYCUJRH.js";import"./chunk-PTVRFY4B.js";import{a as ue,e as pe}from"./chunk-3ZOLHUAU.js";import"./chunk-M2F4B74F.js";import"./chunk-2WNCPIJC.js";import"./chunk-GDB2EJGA.js";import"./chunk-RDGFIF46.js";import"./chunk-C2ONI6UP.js";import"./chunk-H6LJ2DCJ.js";import"./chunk-RZPELDHM.js";import"./chunk-S3J33BKD.js";import"./chunk-NPIYHDQ7.js";import"./chunk-BL63T6AU.js";import"./chunk-AOTWUAUY.js";import"./chunk-VI4TDFI5.js";import"./chunk-GXSLPADW.js";import"./chunk-2HN33SWB.js";import"./chunk-523X5JOP.js";import"./chunk-BXR2KKYP.js";import"./chunk-7ISKCG7U.js";import{b as pt,c as de,e as wt,f as dt}from"./chunk-OFGHVREP.js";import"./chunk-42DKYLC7.js";import"./chunk-YJ3RZNO6.js";import{h as se,o as ae}from"./chunk-M4PATAW3.js";import"./chunk-26R336GJ.js";import"./chunk-OC7V2CEX.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-3HX6VT75.js";import"./chunk-R7P6RQXJ.js";import"./chunk-4I7LQWUX.js";import"./chunk-JLNQ6WQT.js";import"./chunk-GB5RQL32.js";import"./chunk-4OZVVJHM.js";import{e as le}from"./chunk-X7XJWAFC.js";import"./chunk-ILCAH2F6.js";import"./chunk-CYCLIMTY.js";import"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import{a as h}from"./chunk-RRDM7P6F.js";import"./chunk-7X2HMUNN.js";import"./chunk-LW2464MZ.js";import"./chunk-WJDHM47L.js";import"./chunk-LWJTIQQT.js";import"./chunk-IHBD2IWR.js";import"./chunk-NH3JQE75.js";import{a as ne}from"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import{a as Lt}from"./chunk-63EK7JRZ.js";import"./chunk-HVNRUZWJ.js";import{a as Z}from"./chunk-AYOI2Y26.js";import"./chunk-3IK5VXZ3.js";import"./chunk-EN6CTWVM.js";import{j as re}from"./chunk-KLUVHTFQ.js";import"./chunk-JMSMQ4Z7.js";import"./chunk-IRJNWXGT.js";import"./chunk-LVPMJTA6.js";import{d as et,f as Ct}from"./chunk-O4AQRVFI.js";import"./chunk-NDPAZKBG.js";import"./chunk-7AZ5UVCG.js";import"./chunk-6GGK7PRJ.js";import"./chunk-NNETCWLJ.js";import"./chunk-EPTSNNZF.js";import{j as tt}from"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-I6LCIPDY.js";import"./chunk-Y6H3NTW7.js";import"./chunk-4RLJMQW4.js";import"./chunk-J6ZRC6RI.js";import"./chunk-EBGO44EK.js";import"./chunk-THY6AAMN.js";import"./chunk-7W6RATG7.js";import"./chunk-45SNVLPM.js";import"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-B4JAL745.js";import"./chunk-XTES2GPX.js";import{E as oe,G as Ot,H as N,b as O,d as k,e as B,n as x,q as ie,u as it}from"./chunk-2HUIJUS4.js";import"./chunk-VDNXTMSC.js";import{a as lt,h as T,i as Xt}from"./chunk-MBJHSEMD.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import{i as ee}from"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-5MNDZ6BX.js";import"./chunk-RDHMB7M5.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import{A as te,r as Yt,s as bt}from"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{a as m,b as Y,e as M}from"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import{c as Qt}from"./chunk-VQHENXDQ.js";import{a as at}from"./chunk-VWF5VUO3.js";import{f as Kt}from"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import{l as ut}from"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as r,S as w,h as U}from"./chunk-GGZQ5GCM.js";import{U as b}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as n}from"./chunk-BMVJCP2M.js";import{a as st,c as X,u as $t}from"./chunk-GMC3I5VG.js";import{b as I,e as yt,g as Jt}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{b as Q,r as q}from"./chunk-3IBUFXWY.js";import{g as Zt}from"./chunk-BP73DJTS.js";import{a as A,b as H,g as qt}from"./chunk-JEGVIFEP.js";var z=class extends w{constructor(t){super(t),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};n([r()],z.prototype,"target",void 0),n([r()],z.prototype,"intersectedGraphic",void 0),n([r()],z.prototype,"intersectedLocation",void 0),n([r()],z.prototype,"elevationAlignedTargetLocation",void 0),n([r({type:Boolean})],z.prototype,"visible",void 0),z=n([b("esri.views.3d.analysis.LineOfSightAnalysisResult")],z);var Te=z;var D=class extends w{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:m(),observerSurfaceNormal:null,observerFeatureId:null,target:m(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:m(),targetAdjusted:m()},this.computationResult={start:m(),end:m(),intersection:m(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};n([r()],D.prototype,"target",void 0),n([r()],D.prototype,"elevationAlignedTargetLocation",void 0),n([r()],D.prototype,"inputPoints",void 0),n([r()],D.prototype,"computationResult",void 0),n([r()],D.prototype,"result",void 0),D=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],D);var Gt,P=Gt=class extends w{constructor(t){super(t)}clone(){return new Gt({type:this.type,id:Q(this.id),mapPoint:Q(this.mapPoint),renderPoint:Y(this.renderPoint),normal:Q(this.normal),ray:Q(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&Jt(this.mapPoint,t.mapPoint)&&oe(this.renderPoint,t.renderPoint)&&Zt(this.normal,t.normal)&&de(this.ray,t.ray)&&this.graphic===t.graphic}};n([r()],P.prototype,"type",void 0),n([r({constructOnly:!0})],P.prototype,"id",void 0),n([r({constructOnly:!0})],P.prototype,"mapPoint",void 0),n([r({constructOnly:!0})],P.prototype,"renderPoint",void 0),n([r({constructOnly:!0})],P.prototype,"normal",void 0),n([r({constructOnly:!0})],P.prototype,"graphic",void 0),n([r({constructOnly:!0})],P.prototype,"ray",void 0),P=Gt=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],P);var F=class extends w{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=ce(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=ot.MIN}getScreenPointIntersection(t){let e=ee(t,le.get()),i=ye(this.view.state.camera,e,zt);return this._getRayIntersection(i)}_getRayIntersection(t,e){let{view:i,intersector:o}=this;if(t==null||i.sceneIntersectionHelper==null)return null;o.options.store=ot.MIN,i.sceneIntersectionHelper.intersectToolIntersectorRay(t,o,e);let l=o.results.min;if(l.target==null)return null;let s=m();if(!l.getIntersectionPoint(s)||e?.maxDistance!=null&&ie(s,t.origin)>e.maxDistance**2)return null;let a=i.renderCoordsHelper.fromRenderCoords(s,new ut({spatialReference:i.spatialReference})),c=Y(l.normal);if(ge(l))return new P({type:J.TERRAIN,id:l.target.lij.slice(),mapPoint:a,renderPoint:s,normal:c,ray:wt(t),graphic:null});let p=nt(l,i);if(p==null)return null;let{layer:d,sourceLayer:u}=p,g=u?.type==="scene"?re(p,u.objectIdField):p.uid;return new P({type:J.OBJECT,id:`${d?.uid}/${g}`,mapPoint:a,renderPoint:s,normal:c,ray:wt(t),graphic:p})}updateFromGroundIntersection(t,e,i){let o=He,l=Me,s=De,a=Le;O(l,t),this.view.renderCoordsHelper.worldUpAtPosition(l,s),it(s,s);let c=this.view.basemapTerrain.visibleElevationBounds,p=(e>=0?1:-1)*((c?Math.abs(c.max-c.min):100)+Math.abs(e));x(a,s,p),k(o,l,a),dt(o,l,zt);let d=this._getRayIntersection(zt,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:p});if(d!=null){let u=Le;return x(u,s,e),k(i,d.renderPoint,u),Y(d.normal)}return O(i,t),null}};n([r()],F.prototype,"view",void 0),n([r()],F.prototype,"intersector",void 0),F=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],F);var He=m(),Me=m(),De=m(),Le=m(),zt=pt();var f=class extends at.EventedMixin(w){constructor(t){super(t),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new Z,this._frameTask=Ct,this._computationHandles=new U,this._externalObserverUpdate=!0}initialize(){let t=this.view.resourceController?.scheduler;this._frameTask=t?t.registerTask(et.LINE_OF_SIGHT_TOOL):Ct,this._intersector=new F({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(t){let e=t.computation,{inputPoints:i,computationResult:o}=e,{observerAdjusted:l,targetAdjusted:s}=i,{start:a,end:c}=o;O(a,l),O(c,s),this._canCompute(e)?this._computeIntersection(t):ke(t),e.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:e.result})}_adjustStartEndPositions(t){let{view:e}=this,{inputPoints:i}=t,{observer:o,target:l,observerAdjusted:s,targetAdjusted:a}=i;O(s,o),O(a,l),ve(e,this._intersector.intersector,i);let{observerSurfaceNormal:c,targetSurfaceNormal:p}=i,d=this._screenPixelSize,u=gt;c!=null?O(u,c):B(u,a,s);let g=d;it(u,u),x(u,u,Math.min(g,1)),k(s,s,u),p!=null?O(u,p):B(u,s,a);let v=e.state.camera.computeScreenPixelSizeAt(a);it(u,u),x(u,u,Math.min(v,1)),k(a,a,u)}_computeIntersection({computation:t,interpolationInfo:e}){let{view:i}=this,{sceneIntersectionHelper:o,renderCoordsHelper:l}=i;if(o==null)return;let s=this._intersector.intersector,{computationResult:a,inputPoints:c}=t,{observer:p,target:d}=c,{start:u,end:g}=a,v=dt(u,g,Ge);s.options.store=ot.MIN,o.intersectToolIntersectorRay(v,s);let R=s.results.min,S=a.intersection,$=gt,_=!0;if(R!=null&&R.getIntersectionPoint(S)){O(e.originalIntersection,S),O(e.originalObserver,u),O(e.originalTarget,g),l.fromRenderCoords(S,$,i.spatialReference);let L=1-N(g,d)/N(u,d);_=N(p,S)>=L*N(p,d)}let j=new ut($,i.spatialReference);{let{result:L,target:E}=t;L!=null?(L.target=E,L.intersectedGraphic=_?null:nt(R,i),L.intersectedLocation=_?null:j,L.visible=_):t.result=new Te({target:E,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:_?null:nt(R,i),intersectedLocation:_?null:j,visible:_})}a.isValid=c.isValid=!0,a.isTargetVisible=_}_canCompute(t){let e=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(e==null||t.elevationAlignedTargetLocation==null||i==null)return!1;let{observerAdjusted:o,targetAdjusted:l}=t.inputPoints,s=i.intersectsPoint(o),a=i.intersectsPoint(l);return s&&a}_onObserverPositionChange(t,e,i,o,l){if(this._externalObserverUpdate=l,t==null)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(e==null)return kt(this.analysis,t.spatialReference,q.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);let s=Ie(e,i),{absoluteZ:a,elevation:c}=It(e.x,e.y,e.z,this.view.spatialReference,this.view,s),p=e.clone();p.z=a,this._effectiveObserverElevationMode=s.mode,this.analysisViewData.elevationAlignedObserver=p;let d=m();this.view.renderCoordsHelper.toRenderCoords(p,d),this._elevationAlignedObserverPositionRenderSpace=d,this._observerGroundOffsetRenderSpace=a-c,this._observerFeatureId=Pt(o),this.priority=et.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,e,i,o,l){let{inputPoints:s}=t;switch(O(s.observer,e),s.observerFeatureId=l,s.observerSurfaceNormal=null,o){case"on-the-ground":case"relative-to-ground":{let a=this._intersector.updateFromGroundIntersection(s.observer,i,s.observer);s.observerFeatureId==null&&(s.observerSurfaceNormal=a)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=et.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,e,i,o,l,s=!0){let a=t.inputPoints;if(s&&(a.isValid=!1),i==null)return e!=null&&kt(this.analysis,e.spatialReference,q.getLogger(this)),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();let c=Ie(i,o),{absoluteZ:p,elevation:d}=It(i.x,i.y,i.z,this.view.spatialReference,this.view,c),u=i.clone();switch(u.z=p,t.elevationAlignedTargetLocation=u,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,a.target),a.targetFeatureId=Pt(l),a.targetSurfaceNormal=null,c.mode){case"on-the-ground":case"relative-to-ground":{let g=this._intersector.updateFromGroundIntersection(a.target,p-d,a.target);a.targetFeatureId==null&&(a.targetSurfaceNormal=g)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=et.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return X([this._updatingHandles.add(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:tt(t.target.position,this.view.spatialReference)}),({computation:e,targetPosition:i,targetElevationInfo:o,targetFeatureInfo:l,projectedTargetPosition:s})=>{s.pending==null?this._onTargetPositionChange(e,i,s.geometry,o,l):this._updatingHandles.addPromise(s.pending)},T)])}_connectComputationToObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())},T)}_connectComputationToRenderSpaceObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:e,observer:i,observerGroundOffset:o,observerElevationMode:l,observerFeatureId:s})=>{this._onObserverRenderSpacePositionChangeForComputation(e,i,o,l,s)},T)}_connectComputationToCamera(t){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:e})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!e||t.notifyInputPointsChanged()})}_connectComputationToSlicePlane(t){return this._updatingHandles.add(()=>this.view.slicePlane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){let e=(i,o)=>{let l=this.analysis.observer,s=t.target,a=null,c=null,p=null,d=null,u=null,g=null;if(l?.position!=null){let v=tt(l.position,this.view.spatialReference);if(v.pending!=null)return this._updatingHandles.addPromise(v.pending),void v.pending.finally(()=>e(i,o));a=v.geometry,c=l.elevationInfo,p=l.feature}if(s.position!=null){let v=tt(s.position,this.view.spatialReference);if(v.pending!=null)return this._updatingHandles.addPromise(v.pending),void v.pending.finally(()=>e(i,o));d=v.geometry,u=s.elevationInfo,g=s.feature}a==null&&d==null||(fe(i,o,mt,this.view.spatialReference),a!=null&&bt(mt,a)&&this._onObserverPositionChange(l!=null?l.position:null,a,c,p,!1),d!=null&&bt(mt,d)&&this._onTargetPositionChange(t,s.position,d,u,g,!1),a!=null&&d!=null&&Yt(mt,a,d)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",({extent:i,spatialReference:o})=>e(i,o))}_connectComputationToTask(t){let e=null,i={computation:t,interpolationInfo:{originalIntersection:m(),originalObserver:m(),originalTarget:m()}};return X([this._updatingHandles.add(()=>t.inputPoints,()=>{e=yt(e),e=Kt(o=>qt(this,null,function*(){yield $t(this._frameTask.schedule(()=>this._computeResult(i),o))}))},{initial:!0,equals:()=>!1}),st(()=>e=yt(e))])}_connectComputation(t){let e=this._computationHandles;e.has(t)||e.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_onTargetCollectionChange({added:t,removed:e}){for(let i of e)this._removeTarget(i);for(let i of t)this._addTarget(i)}_onCursorTargetChange(t,e){e!=null&&this._removeTarget(e),t!=null&&this._addTarget(t)}_addTarget(t){this._computations.some(e=>e.target===t)||this._computations.add(new D({target:t}))}_removeTarget(t){let e=this._computations.findIndex(i=>i.target===t);this._computations.removeAt(e)}_connectObserver(){return X([this._updatingHandles.add(()=>({observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,projectedObserverPosition:tt(this.analysis.observer!=null?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:this.analysis.observer!=null?this.analysis.observer.elevationInfo:null,observerFeatureInfo:this.analysis.observer!=null?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:e,observerElevationInfo:i,observerFeatureInfo:o})=>{e.pending==null?this._onObserverPositionChange(t,e.geometry,i,o,!0):this._updatingHandles.addPromise(e.pending)},T)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,t=>this._onComputationCollectionChange(t),{initial:!0,final:!0})}_connectTargets(){return X([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(t,e)=>{this._onCursorTargetChange(t,e)})])}get _isCameraDirty(){let t=this.analysisViewData.elevationAlignedObserver,{view:e}=this,{renderCoordsHelper:i}=e;if(t==null||i==null)return!1;let o=gt;i.toRenderCoords(t,o);let l=e.state.camera.computeScreenPixelSizeAt(o);return Math.abs((l-this._screenPixelSize)/this._screenPixelSize)>xe}};function Ie(t,e){return t.hasZ?e??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}function ke({computation:t,interpolationInfo:e}){let{computationResult:i,inputPoints:o}=t,{start:l,end:s,intersection:a}=i,{originalIntersection:c,originalObserver:p,originalTarget:d}=e;if(O(a,c),o.isValid){let u=gt,g=N(p,c)/N(p,d);Ot(u,l,p),x(u,u,1-g),k(a,a,u),Ot(u,s,d),x(u,u,g),k(a,a,u),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}n([r({constructOnly:!0})],f.prototype,"analysis",void 0),n([r({constructOnly:!0})],f.prototype,"analysisViewData",void 0),n([r({constructOnly:!0})],f.prototype,"view",void 0),n([r()],f.prototype,"updating",null),n([r()],f.prototype,"priority",null),n([r()],f.prototype,"updateOnCameraChange",void 0),n([r()],f.prototype,"_computations",null),n([r()],f.prototype,"_elevationAlignedObserverPositionRenderSpace",null),n([r()],f.prototype,"_observerGroundOffsetRenderSpace",void 0),n([r()],f.prototype,"_effectiveObserverElevationMode",void 0),n([r()],f.prototype,"_observerFeatureId",void 0),n([r()],f.prototype,"_screenPixelSize",null),n([r({readOnly:!0})],f.prototype,"_updatingHandles",void 0),n([r()],f.prototype,"_frameTask",void 0),n([r()],f.prototype,"_isCameraDirty",null),f=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightController")],f);var xe=.1,gt=m(),Ge=pt(),mt=te();var Ft=class{constructor(){this.glowWidth=8,this.innerWidth=.75}},Pe=new Ft;function Ve(t){let e=t.accentColor;return{glowColor:e,innerColor:se(e),globalAlpha:.75*e.a}}var jt=class{constructor(){this.size=.5}},Se=new jt;function Nt(t){return ae(t.accentColor,.75)}var Ut=class{constructor(){this.size=.5,this.visibleColor=new h([3,252,111,.75]),this.occludedColor=new h([252,3,69,.75]),this.undefinedColor=new h([127,127,127,.75])}},Re=new Ut,Bt=class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new h([3,252,111,1]),this.visibleOuterColor=new h([3,252,111,.15]),this.occludedInnerColor=new h([252,3,69,1]),this.occludedOuterColor=new h([252,3,69,.1]),this.undefinedInnerColor=new h([255,255,255,1]),this.undefinedOuterColor=new h([127,127,127,.2])}},rt=new Bt;var vt=class extends At{constructor(e,i){let o=Ht(Nt(e.effectiveTheme)),l=Tt(o,Se.size,32,32),s=new Mt(l);super({view:e,renderObjects:[s],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),xt(this),this.themeHandle=lt(()=>({color:Nt(e.effectiveTheme)}),a=>{o.setParameters(a)})}destroy(){this.themeHandle.remove(),super.destroy()}},ft=class extends At{constructor(e,i){let{size:o,visibleColor:l,occludedColor:s,undefinedColor:a}=Re;super({view:e,renderObjects:[Wt(o,l,G.Custom1),Wt(o,s,G.Custom2),Wt(o,a,G.Custom3)],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),xt(this)}};function Wt(t,e,i){return new Mt(Tt(Ht(h.toUnitRGBA(e)),t,32,32),i)}var W;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(W||(W={}));var y=class extends Ce{constructor(t){super(t),this._creationMode=!1,this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new U,this._updatingHandles=new Z,this._manipulatorHandles=new U,this._targetTrackerManipulator=null}initialize(){this._intersector=new F({view:this.view}),this.addHandles(lt(()=>this.state,t=>{t===W.Created&&this.finishToolCreation()},Xt)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add(()=>this.analysisViewData?.elevationAlignedObserver,t=>this._onObserverLocationChange(t),T),this._updatingHandles.add(()=>Ve(this.view.effectiveTheme),({glowColor:t,innerColor:e,globalAlpha:i})=>this._updateLaserLineStyle(t,e,i),T),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),T),this._updatingHandles.add(()=>({active:this.active,hasGrabbedManipulators:this.hasGrabbedManipulators}),({active:t,hasGrabbedManipulators:e})=>{this._creationMode=!!t&&(this._creationMode||!e)},T)])}destroy(){this._updatingHandles=I(this._updatingHandles),this._manipulatorHandles=I(this._manipulatorHandles),this._analysisHandles=I(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?!this.hasGrabbedManipulators||this._creationMode?W.Creating:W.Created:this.analysis.observer?.position!=null?W.Created:W.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return this.analysisViewData!=null&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&this._latestPointerMovePointerType==="mouse"}get _shouldRenderTracker(){return this._showTracker&&this.analysis.observer?.position!=null&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickHandler(t)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_connectComputation(t){if(this.destroyed)return void q.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");let e=this._analysisHandles;if(e.has(t))return;let i=this._createTargetManipulator(t.target);this._targetTrackerManipulator==null&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),e.add([this._updatingHandles.add(()=>je(t),()=>Fe(i,t),T),this._updatingHandles.add(()=>t.elevationAlignedTargetLocation,o=>this._onTargetLocationChange(o,i),T)],t)}_disconnectComputation(t){if(this.destroyed)return void q.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);let e=this._getTargetManipulator(t.target);e!=null&&(this.manipulators.remove(e),this._manipulatorHandles.remove(e),this._targetTrackerManipulator!=null&&this._targetTrackerManipulator===e&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=I(this.analysisViewData.cursorTarget)}_createTargetManipulator(t){let e={target:t,type:"target"},i=new ft(this.view,e);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",o=>this._manipulatorGrabChanged(i,o)),i.events.on("immediate-click",o=>this._manipulatorClick(i,o))],i),this.manipulators.add(i),t.position!=null?i.elevationAlignedLocation=t.position:i.available=!1,i}_getTargetManipulator(t){let e=null;return this.manipulators.forEach(i=>{let o=i.manipulator;e==null&&o.metadata.type==="target"&&o.metadata.target===t&&(e=o)}),e}_createObserverManipulator(){let t=new vt(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(t),t.events.on("grab-changed",e=>this._manipulatorGrabChanged(t,e)),t.events.on("immediate-click",e=>this._manipulatorClick(t,e))],t),this.manipulators.add(t),t}_screenToIntersection(){return t=>{let e=this._intersector.getScreenPointIntersection(t.screenEnd);return e==null?null:H(A({},t),{intersection:e})}}_createTargetManipulatorDragPipeline(t){return Et(t,(e,i,o)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),o.next(ze(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return Et(t,(e,i,o)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),o.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>(t.intersection.mapPoint!=null?(this.analysis.observer==null&&(this.analysis.observer=new Vt),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){let t=this.analysis.observer?.position!=null?this.analysis.observer.clone():null;return e=>(this.analysis.observer=t,e)}_updateTargetDragStep(t){return e=>{this._updateFromIntersection(t.metadata.target,e.intersection);let i=e.intersection.mapPoint;return i!=null&&(t.elevationAlignedLocation=i),e}}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){let{laserlineVisualElement:e,grabbedManipulator:i,shouldRenderTracker:o,observerPosition:l,visible:s}=t;if(e==null)return;let a=i??(o&&l!=null?this._targetTrackerManipulator:null);a!=null&&s?(e.visible=!0,e.heightManifoldTarget=a.renderLocation,a!==this._observerManipulator?e.lineVerticalPlaneSegment=pe(this._observerManipulator.renderLocation,a.renderLocation,Ue):e.lineVerticalPlaneSegment=null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();let{glowWidth:t,innerWidth:e}=Pe;this._laserlineVisualElement=new be({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:t,innerWidth:e},isDecoration:!0})}_removeLaserLine(){this._laserlineVisualElement!=null&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(t,e,i){let o=this._laserlineVisualElement;if(o==null)return;let l=o.style;o.style=H(A({},l),{glowColor:h.toUnitRGB(t),innerColor:h.toUnitRGB(e),globalAlpha:i})}_onObserverLocationChange(t){t!=null?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t):this._observerManipulator.available=!1}_onTargetLocationChange(t,e){t!=null?(e.elevationAlignedLocation=t,e!==this._targetTrackerManipulator&&(e.available=!0)):e.available=!1}_addPointFromClickEvent(t){let e=this._intersector.getScreenPointIntersection(t);if(e?.mapPoint!=null)if(this.analysis.observer?.position!=null){this._clearCursorTracker();let i=new St;this._updateFromIntersection(i,e),this.analysis.targets.add(i)}else{let i=new Vt;this._updateFromIntersection(i,e),this.analysis.observer=i}}_clickHandler(t){this.active&&t.button!==ct.Right&&(this._addPointFromClickEvent(Rt(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==ct.Right&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this.active&&t.key==="Escape"&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||this.analysis.observer?.position==null))return;let e=Rt(t),i=this._intersector.getScreenPointIntersection(e);i?.mapPoint!=null&&(this.analysisViewData.cursorTarget==null&&(this.analysisViewData.cursorTarget=new St),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(t,e){if(e.mapPoint==null)return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(e.type){case J.OBJECT:if(e.graphic!=null){let o=e.graphic,l=he(o);l.mode==="on-the-ground"&&(l.mode="relative-to-ground",l.offset=0),t.elevationInfo=new Lt(l),t.feature=o}else t.elevationInfo=null,t.feature=null;break;case J.TERRAIN:t.elevationInfo=new Lt({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}let i=e.mapPoint.clone();i.z=me(this.view,i,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=i}_manipulatorClick(t,e){if(t.metadata.type==="observer"||t.grabbing||t.dragging||e.button!==ct.Right||this.analysis.targets.length<=1)return;let{target:i}=t.metadata;this.analysis.targets.remove(i),e.stopPropagation()}get testInfo(){}};function ze(t){let e=t.position?.clone();return i=>(t.position=e,i)}function Fe(t,e){let{isValid:i,isTargetVisible:o}=e.computationResult;t.state=i?o?G.Custom1:G.Custom2:G.Custom3}function je(t){let{isValid:e,isTargetVisible:i}=t.computationResult;return{isValid:e,isTargetVisible:i}}n([r({constructOnly:!0})],y.prototype,"view",void 0),n([r({constructOnly:!0})],y.prototype,"analysis",void 0),n([r()],y.prototype,"_creationMode",void 0),n([r({readOnly:!0})],y.prototype,"state",null),n([r({readOnly:!0})],y.prototype,"cursor",null),n([r()],y.prototype,"removeIncompleteOnCancel",void 0),n([r({readOnly:!0})],y.prototype,"updating",null),n([r({constructOnly:!0})],y.prototype,"analysisViewData",void 0),n([r({readOnly:!0})],y.prototype,"_showTracker",null),n([r()],y.prototype,"_latestPointerMovePointerType",void 0),n([r()],y.prototype,"_shouldRenderTracker",null),n([r()],y.prototype,"_laserlineVisualElement",void 0),n([r()],y.prototype,"_grabbedManipulator",void 0),y=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],y);var Ue=ue();var _t=class{constructor(e,i,o,l){this.visibleLineVisualElement=e,this.occludedLineVisualElement=i,this.undefinedLineVisualElement=o,this.targetVisualElement=l}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}};var V=class extends w{constructor(t){super(t),this._lineOfSightVisualElements=new Array,this._computationHandles=new U,this._updatingHandles=new Z}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=I(this._updatingHandles),this._computationHandles=I(this._computationHandles),this._observerVisualElement=I(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){let t=rt,e=this.view,i=this.isDecoration,o={view:e,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth,isDecoration:i},l=h.toUnitRGBA(t.visibleOuterColor),s=h.toUnitRGBA(t.visibleInnerColor),a=h.toUnitRGBA(t.occludedOuterColor),c=h.toUnitRGBA(t.occludedInnerColor),p=h.toUnitRGBA(t.undefinedOuterColor),d=h.toUnitRGBA(t.undefinedInnerColor),u=new ht(H(A({},o),{color:l,innerColor:s})),g=new ht(H(A({},o),{color:a,innerColor:c})),v=new ht(H(A({},o),{color:p,innerColor:d})),R=new Dt(H(A({view:e,attached:!0},Ee),{size:8,isDecoration:i})),S=new _t(u,g,v,R);return this._lineOfSightVisualElements.push(S),S}_destroyLineOfSightVisualization(t){t.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(t),1)}_updateLineOfSightVisualization(t,e,i){let o=rt,{computationResult:l,inputPoints:s}=t,{start:a,end:c,intersection:p,isValid:d,isTargetVisible:u}=l,{observer:g}=s,v=qe;v[12]=g[0],v[13]=g[1],v[14]=g[2];let R=B(Be,a,g),S=B(Ne,c,g),$=B(We,p,g),{visibleLineVisualElement:_,occludedLineVisualElement:j,undefinedLineVisualElement:L,targetVisualElement:E}=e,Ae=this.analysisViewData.elevationAlignedObserver==null||t.elevationAlignedTargetLocation==null,K=this.visible&&!Ae;_.visible=K,j.visible=K,L.visible=K,E.visible=K,E.attached=!i.interactiveAndEditable,K&&(_.geometry=null,j.geometry=null,L.geometry=null,E.geometry=t.elevationAlignedTargetLocation,d?u?(_.geometry=[[M(R),M(S)]],_.transform=v,_.color=h.toUnitRGBA(o.visibleOuterColor),E.color=h.toUnitRGBA(o.visibleInnerColor)):(_.geometry=[[M(R),M($)]],_.transform=v,_.color=h.toUnitRGBA(o.occludedOuterColor),j.geometry=[[M($),M(S)]],j.transform=v,E.color=h.toUnitRGBA(o.occludedInnerColor)):(L.geometry=[[M(R),M(S)]],L.transform=v,E.color=h.toUnitRGBA(o.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){let{computationResult:e}=t,{occludedOuterColor:i,visibleOuterColor:o}=rt;return{computationResult:e,occludedOuterColor:i,visibleOuterColor:o,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){let e=this._computationHandles;if(e.has(t))return;let i=this._createLineOfSightVisualization();e.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(t),o=>this._updateLineOfSightVisualization(t,i,o),{initial:!0,equals:()=>!1}),st(()=>this._destroyLineOfSightVisualization(i))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_createObserverVisualization(){let t=h.toUnitRGBA(rt.visibleInnerColor),e=new Dt(H(A({view:this.view,color:t},Ee),{isDecoration:this.isDecoration}));this._observerVisualElement=e,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:o,visible:l})=>{i!=null&&!o&&l?(e.geometry=i,this._observerVisualElement.attached=!0):e.attached=!1},T))}};n([r({constructOnly:!0})],V.prototype,"analysis",void 0),n([r({constructOnly:!0})],V.prototype,"analysisViewData",void 0),n([r({constructOnly:!0})],V.prototype,"view",void 0),n([r({readOnly:!0})],V.prototype,"visible",null),n([r({constructOnly:!0})],V.prototype,"isDecoration",void 0),n([r()],V.prototype,"updating",null),n([r()],V.prototype,"interactiveAndEditable",null),n([r()],V.prototype,"test",null),V=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],V);var Ee={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},Be=m(),Ne=m(),We=m(),qe=ne();var C=class extends _e(at.EventedMixin(w)){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new Qt,this.elevationAlignedObserver=null,this.observerEngineLocation=m(),this.cursorTarget=null,this.editable=!0}initialize(){let t=this.view,e=this.analysis;this._analysisController=new f({analysis:e,analysisViewData:this,view:t}),this._analysisVisualization=new V({analysis:e,analysisViewData:this,view:t,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)}),Oe(this,y)])}destroy(){we(this),this._analysisController=I(this._analysisController),this._analysisVisualization=I(this._analysisVisualization)}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisVisualization!=null&&this._analysisVisualization.updating}getResultForTarget(t){return this.computations.find(e=>e.target===t)?.result}get testInfo(){}};n([r({readOnly:!0})],C.prototype,"type",void 0),n([r({constructOnly:!0,nonNullable:!0})],C.prototype,"analysis",void 0),n([r()],C.prototype,"tool",void 0),n([r({readOnly:!0})],C.prototype,"results",null),n([r()],C.prototype,"priority",null),n([r()],C.prototype,"computations",void 0),n([r()],C.prototype,"elevationAlignedObserver",void 0),n([r()],C.prototype,"observerEngineLocation",void 0),n([r()],C.prototype,"cursorTarget",void 0),n([r()],C.prototype,"updating",null),n([r()],C.prototype,"editable",void 0),n([r()],C.prototype,"_analysisController",void 0),n([r()],C.prototype,"_analysisVisualization",void 0),C=n([b("esri.views.3d.analysis.LineOfSightAnalysisView3D")],C);var lr=C;export{lr as default};
