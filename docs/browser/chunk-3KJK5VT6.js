import{b as Z,eb as it,fb as Ot,j as gt,k as _t,l as Pe,m as Me,n as Te,o as be,p as we}from"./chunk-AN522XY4.js";import{k as _e,l as Se,n as yt,o as ke}from"./chunk-DI7IQ2JQ.js";import{a as P,b as Gt,d as Nt,e as pe,n as de,o as xe,p as ye,w as Yt}from"./chunk-4HNIM6ZU.js";import{a as ve,b as Ee,c as Ie}from"./chunk-JTY6HBYD.js";import{a as me}from"./chunk-YNTLVJOI.js";import{a as ue,e as he,g as fe}from"./chunk-PVCDKA4D.js";import{a as Bt,c as Wt,k as ge}from"./chunk-4TKIIMKN.js";import{G as A,L as G,V as ae,W as ce,c as ie,d as oe,y as ne}from"./chunk-PXLEIVAM.js";import{F as xt}from"./chunk-AXPRNSO3.js";import{a as ht,b as ft,c as mt,r as N,t as dt}from"./chunk-U4Y7WABQ.js";import{a as le}from"./chunk-RRDM7P6F.js";import{a as se}from"./chunk-PJX4LNSV.js";import{h as u}from"./chunk-BDF7KEUQ.js";import{s as st}from"./chunk-XTES2GPX.js";import{a as x}from"./chunk-YFBPRKIN.js";import{b as re}from"./chunk-T7BKG6V3.js";import{b as Lt}from"./chunk-5PTS4JDF.js";import{r as te,t as ee}from"./chunk-3IBUFXWY.js";import{a as $t}from"./chunk-BP73DJTS.js";import{a as g,b as k,f as W,g as v}from"./chunk-JEGVIFEP.js";function Fe(e,t,r,s,i,o,n){Ht=0;let a=(s-r)*o,c=i&&i.length,p=c?(i[0]-r)*o:a,l,d,m,f,h,y=ze(t,r,s,0,p,o,!0);if(y&&y.next!==y.prev){if(c&&(y=ar(t,r,s,i,y,o)),a>80*o){l=m=t[0+r*o],d=f=t[1+r*o];for(let _=o;_<p;_+=o){let w=t[_+r*o],T=t[_+1+r*o];l=Math.min(l,w),d=Math.min(d,T),m=Math.max(m,w),f=Math.max(f,T)}h=Math.max(m-l,f-d),h=h!==0?1/h:0}nt(y,e,o,l,d,h,n,0)}}function ze(e,t,r,s,i,o,n){let a;if(n===hr(e,t,r,s,i,o)>0)for(let c=s;c<i;c+=o)a=De(c+t*o,e[c+t*o],e[c+1+t*o],a);else for(let c=i-o;c>=s;c-=o)a=De(c+t*o,e[c+t*o],e[c+1+t*o],a);return a&&R(a,a.next)&&(at(a),a=a.next),a}function ot(e,t=e){if(!e)return e;let r,s=e;do if(r=!1,s.steiner||!R(s,s.next)&&M(s.prev,s,s.next)!==0)s=s.next;else{if(at(s),s=t=s.prev,s===s.next)break;r=!0}while(r||s!==t);return t}function nt(e,t,r,s,i,o,n,a){if(!e)return;!a&&o&&(e=Ae(e,s,i,o));let c=e;for(;e.prev!==e.next;){let p=e.prev,l=e.next;if(o?or(e,s,i,o):ir(e))t.push(p.index/r+n),t.push(e.index/r+n),t.push(l.index/r+n),at(e),e=l.next,c=l.next;else if((e=l)===c){a?a===1?nt(e=mr(e,t,r,n),t,r,s,i,o,n,2):a===2&&dr(e,t,r,s,i,o,n):nt(ot(e),t,r,s,i,o,n,1);break}}}function ir(e){let t=e.prev,r=e,s=e.next;if(M(t,r,s)>=0)return!1;let i=e.next.next,o=i,n=0;for(;i!==e.prev&&(n===0||i!==o);){if(n++,q(t.x,t.y,r.x,r.y,s.x,s.y,i.x,i.y)&&M(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function or(e,t,r,s){let i=e.prev,o=e,n=e.next;if(M(i,o,n)>=0)return!1;let a=i.x<o.x?i.x<n.x?i.x:n.x:o.x<n.x?o.x:n.x,c=i.y<o.y?i.y<n.y?i.y:n.y:o.y<n.y?o.y:n.y,p=i.x>o.x?i.x>n.x?i.x:n.x:o.x>n.x?o.x:n.x,l=i.y>o.y?i.y>n.y?i.y:n.y:o.y>n.y?o.y:n.y,d=Rt(a,c,t,r,s),m=Rt(p,l,t,r,s),f=e.prevZ,h=e.nextZ;for(;f&&f.z>=d&&h&&h.z<=m;){if(f!==e.prev&&f!==e.next&&q(i.x,i.y,o.x,o.y,n.x,n.y,f.x,f.y)&&M(f.prev,f,f.next)>=0||(f=f.prevZ,h!==e.prev&&h!==e.next&&q(i.x,i.y,o.x,o.y,n.x,n.y,h.x,h.y)&&M(h.prev,h,h.next)>=0))return!1;h=h.nextZ}for(;f&&f.z>=d;){if(f!==e.prev&&f!==e.next&&q(i.x,i.y,o.x,o.y,n.x,n.y,f.x,f.y)&&M(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;h&&h.z<=m;){if(h!==e.prev&&h!==e.next&&q(i.x,i.y,o.x,o.y,n.x,n.y,h.x,h.y)&&M(h.prev,h,h.next)>=0)return!1;h=h.nextZ}return!0}function De(e,t,r,s){let i=Q.create(e,t,r);return s?(i.next=s.next,i.prev=s,s.next.prev=i,s.next=i):(i.prev=i,i.next=i),i}function at(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function nr(e){let t=e,r=e;do(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next;while(t!==e);return r}function ar(e,t,r,s,i,o){let n=new Array;for(let a=0,c=s.length;a<c;a++){let p=ze(e,t,r,s[a]*o,a<c-1?s[a+1]*o:r*o,o,!1);p===p.next&&(p.steiner=!0),n.push(nr(p))}n.sort(fr);for(let a of n)i=cr(a,i);return i}function cr(e,t){let r=lr(e,t);if(!r)return t;let s=Le(r,e);return ot(s,s.next),ot(r,r.next)}function lr(e,t){let r=t,s=e.x,i=e.y,o,n=-1/0;do{if(i<=r.y&&i>=r.next.y&&r.next.y!==r.y){let m=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(m<=s&&m>n){if(n=m,m===s){if(i===r.y)return r;if(i===r.next.y)return r.next}o=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!o)return null;if(s===n)return o.prev;let a=o,c=o.x,p=o.y,l,d=1/0;for(r=o.next;r!==a;)s>=r.x&&r.x>=c&&s!==r.x&&q(i<p?s:n,i,c,p,i<p?n:s,i,r.x,r.y)&&(l=Math.abs(i-r.y)/(s-r.x),(l<d||l===d&&r.x>o.x)&&ct(r,e)&&(o=r,d=l)),r=r.next;return o}function Ae(e,t,r,s){let i;for(;i!==e;i=i.next){if(i=i||e,i.z===null&&(i.z=Rt(i.x,i.y,t,r,s)),i.prev.next!==i||i.next.prev!==i)return i.prev.next=i,i.next.prev=i,Ae(e,t,r,s);i.prevZ=i.prev,i.nextZ=i.next}return e.prevZ.nextZ=null,e.prevZ=null,pr(e)}function pr(e){let t,r=1;for(;;){let s,i=e;e=null,t=null;let o=0;for(;i;){o++,s=i;let n=0;for(;n<r&&s;n++)s=s.nextZ;let a=r;for(;n>0||a>0&&s;){let c;n===0?(c=s,s=s.nextZ,a--):a!==0&&s?i.z<=s.z?(c=i,i=i.nextZ,n--):(c=s,s=s.nextZ,a--):(c=i,i=i.nextZ,n--),t?t.nextZ=c:e=c,c.prevZ=t,t=c}i=s}if(t.nextZ=null,r*=2,o<2)return e}}function M(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function Ce(e,t,r,s){return!!(R(e,t)&&R(r,s)||R(e,s)&&R(r,t))||M(e,t,r)>0!=M(e,t,s)>0&&M(r,s,e)>0!=M(r,s,t)>0}function ur(e,t){let r=e;do{if(r.index!==e.index&&r.next.index!==e.index&&r.index!==t.index&&r.next.index!==t.index&&Ce(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}function hr(e,t,r,s,i,o){let n=0;for(let a=s,c=i-o;a<i;a+=o)n+=(e[c+t*o]-e[a+t*o])*(e[a+1+t*o]+e[c+1+t*o]),c=a;return n}function q(e,t,r,s,i,o,n,a){return(i-n)*(t-a)-(e-n)*(o-a)>=0&&(e-n)*(s-a)-(r-n)*(t-a)>=0&&(r-n)*(o-a)-(i-n)*(s-a)>=0}function ct(e,t){return M(e.prev,e,e.next)<0?M(e,t,e.next)>=0&&M(e,e.prev,t)>=0:M(e,t,e.prev)<0||M(e,e.next,t)<0}function Rt(e,t,r,s,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function R(e,t){return e.x===t.x&&e.y===t.y}function fr(e,t){return e.x-t.x}function mr(e,t,r,s){let i=e;do{let o=i.prev,n=i.next.next;!R(o,n)&&Ce(o,i,i.next,n)&&ct(o,n)&&ct(n,o)&&(t.push(o.index/r+s),t.push(i.index/r+s),t.push(n.index/r+s),at(i),at(i.next),i=e=n),i=i.next}while(i!==e);return i}function dr(e,t,r,s,i,o,n){let a=e;do{let c=a.next.next;for(;c!==a.prev;){if(a.index!==c.index&&xr(a,c)){let p=Le(a,c);return a=ot(a,a.next),p=ot(p,p.next),nt(a,t,r,s,i,o,n,0),void nt(p,t,r,s,i,o,n,0)}c=c.next}a=a.next}while(a!==e)}function xr(e,t){return e.next.index!==t.index&&e.prev.index!==t.index&&!ur(e,t)&&ct(e,t)&&ct(t,e)&&yr(e,t)}function yr(e,t){let r=e,s=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;do r.y>o!=r.next.y>o&&r.next.y!==r.y&&i<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(s=!s),r=r.next;while(r!==e);return s}function Le(e,t){let r=Q.create(e.index,e.x,e.y),s=Q.create(t.index,t.x,t.y),i=e.next,o=t.prev;return e.next=t,t.prev=e,r.next=i,i.prev=r,s.next=r,r.prev=s,o.next=s,s.prev=o,s}var Q=class e{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,r,s){let i=Ht<Vt.length?Vt[Ht++]:new e;return i.index=t,i.x=r,i.y=s,i.prev=null,i.next=null,i.z=null,i.prevZ=null,i.nextZ=null,i.steiner=!1,i}},Vt=[],gr=8096,Ht=0;for(let e=0;e<gr;e++)Vt.push(new Q);var _r=1e-5,V=new Wt(0,0,0,1,0),Ut=new Wt(0,0,0,1,0);function Be(e,t,r){let s=0;for(let i=1;i<r;i++){let o=e[2*(t+i-1)],n=e[2*(t+i-1)+1];s+=(e[2*(t+i)]-o)*(e[2*(t+i)+1]+n)}return s}function Sr(e,t,r,s,i){let o=0,n=2;for(let a=r;a<s;a+=3){let c=(e[a]-i)*n,p=(e[a+1]-i)*n,l=(e[a+2]-i)*n;o+=Math.abs((t[c]-t[l])*(t[p+1]-t[c+1])-(t[c]-t[p])*(t[l+1]-t[c+1]))}return o}function We(e,t){let{coords:r,lengths:s}=t,i=0,o=e,n=0;for(let a=0;a<s.length;){let c=a,p=s[a],l=Be(r,n,p),d=[];for(;++c<s.length;){let y=s[c],_=Be(r,n+p,y);if(!(_>0))break;l+=_,d.push(n+p),p+=y}let m=o.length;Fe(o,r,n,n+p,d,2,i);let f=Sr(o,r,m,o.length,i),h=Math.abs(l);if(Math.abs((f-h)/Math.max(1e-7,h))>_r)return o.length=0,!1;a=c,n+=p}return!0}function Ge(e){let{coords:t,lengths:r}=e,{buffer:s}=Ee(t,r);return s}function kr(e,t,r){let s=0;for(let i=0;i<e.lengths.length;i++){let o=e.lengths[i];for(let n=0;n<o;n++){let a=e.coords[2*(n+s)],c=e.coords[2*(n+s)+1];if(a<t||a>r||c<t||c>r)return!0}s+=o}return!1}function kt(e,t){if(e==null)return null;if(!kr(e,-128,640))return e;V.setPixelMargin(t),V.reset(Bt.Polygon);let r=0;for(let n=0;n<e.lengths.length;n++){let a=e.lengths[n],c=e.coords[2*(0+r)],p=e.coords[2*(0+r)+1];V.moveTo(c,p);for(let l=1;l<a;l++)c=e.coords[2*(l+r)],p=e.coords[2*(l+r)+1],V.lineTo(c,p);V.close(),r+=a}let s=V.result(!1);if(!s)return null;let i=[],o=[];for(let n of s){let a=0;for(let c of n)o.push(c.x),o.push(c.y),a++;i.push(a)}return new se(i,o)}function Ne(e,t){Ut.setPixelMargin(t);let r=Ut,s=-t,i=512+t,o=[],n=!1;if(!e.nextPath())return null;let a=!0;for(;a;){e.seekPathStart();let c=[];if(!e.pathSize)return null;r.reset(Bt.LineString),e.nextPoint();let p=e.x,l=e.y;if(n)r.moveTo(p,l);else{if(p<s||p>i||l<s||l>i){n=!0;continue}c.push({x:p,y:l})}let d=!1;for(;e.nextPoint();)if(p=e.x,l=e.y,n)r.lineTo(p,l);else{if(p<s||p>i||l<s||l>i){d=!0;break}c.push({x:p,y:l})}if(d)n=!0;else{if(n){let m=r.resultWithStarts();if(m)for(let f of m)o.push(f)}else o.push({line:c,start:0});a=e.nextPath(),n=!1}}return o=o.filter(c=>c.line.length>1),o.length===0?null:o}V.setExtent(512),Ut.setExtent(512);var Pr=96/72,Pt=class{static executeEffects(t,r,s,i){let o=Pr,n=Yt(t),a=new Gt(r);for(let c of t){let p=Nt(c);p&&(a=p.execute(a,c,o,s,i,n))}return a}static applyEffects(t,r,s){if(!t)return r;let i=Yt(t),o,n=new Gt(P.fromJSONCIM(r));for(let p of t){let l=Nt(p);l&&(n=l.execute(n,p,1,null,s,i))}let a=[],c=null;for(;o=n.next();)a.push(...re(o)),c=o.geometryType;return a.length===0||c===null?null:c==="esriGeometryPolygon"?{rings:a}:{paths:a}}};var Ye=null;function J(){return Ye}function Oe(){return v(this,null,function*(){Ye=yield import("./chunk-JV4XXL5J.js")})}function Re(e){switch(e){case u.BYTE:case u.UNSIGNED_BYTE:return 1;case u.SHORT:case u.UNSIGNED_SHORT:case u.HALF_FLOAT:return 2;case u.FLOAT:case u.INT:case u.UNSIGNED_INT:return 4}}function Mr(e){let t=[],r=[],s=[];for(let i of e){let o=Re(i.type)*i.count;switch(o%2||o%4||4){case 4:t.push(i);continue;case 2:r.push(i);continue;case 1:s.push(i);continue;default:throw new Error("Found unexpected dataType byte count")}}return t.push(...r),t.push(...s),t}var Mt=class e{static fromVertexSpec(t,r){let{attributes:s,optionalAttributes:i}=t,o,n,a,c=[];for(let y in s){let _=s[y];_.pack==="position"?o=k(g({},_),{name:y,offset:0}):_.pack==="id"?n=k(g({},_),{name:y,offset:4}):y==="bitset"?a=k(g({},_),{name:y,offset:7}):c.push(k(g({},_),{name:y}))}for(let y in i)if(r[y]===!0){let _=i[y];c.push(k(g({},_),{name:y}))}let p=Mr(c),l=[],d=8,m=1;for(let y of p)l.push(k(g({},y),{offset:d})),d+=Re(y.type)*y.count,y.packAlternating&&(m=Math.max(y.packAlternating.count,m));let f=Uint32Array.BYTES_PER_ELEMENT,h=d%f;return new e(o,n,a,l,d+(h?f-h:0),m)}constructor(t,r,s,i,o,n){this.position=t,this.id=r,this.bitset=s,this.standardAttributes=i,this.stride=o,this.packVertexCount=n,i.push(s),this._attributes=[t,r,s,...i]}get attributeLayout(){if(!this._attributeLayout){let t=Se(this._attributes),r=this._attributes.map(s=>({name:s.name,count:s.count,offset:s.offset,type:s.type,packPrecisionFactor:s.packPrecisionFactor,normalized:s.normalized??!1}));this._attributeLayout={attributes:r,hash:t,stride:this.stride}}return this._attributeLayout}};var Tt=class e{static fromVertexSpec(t,r){let s=Mt.fromVertexSpec(t,r);return new e(s)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,r,s,i,o,n){for(let a=0;a<this._spec.packVertexCount;a++){let c=a*this._spec.stride;this._packPosition(s,i,c),this._packId(r,c);let p=this._spec.bitset;if(n){if(p.packTessellation){let l=p.packTessellation(n,o);this._pack(l,p,c)}for(let l of this._spec.standardAttributes)if(l.packTessellation!=null){let d=l.packTessellation(n,o);this._pack(d,l,c)}else if(l.packAlternating?.packTessellation){let d=l.packAlternating.packTessellation(n,o);for(let m=0;m<this._spec.packVertexCount;m++){let f=d[m];this._pack(f,l,m*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,r){for(let s of this._spec.standardAttributes)if(s.pack&&typeof s.pack!="string"){let i=s.pack(t,r);for(let o=0;o<this._spec.packVertexCount;o++)this._pack(i,s,o*this._spec.stride)}else if(s.packAlternating?.pack){let i=s.packAlternating.pack(t,r);for(let o=0;o<this._spec.packVertexCount;o++){let n=i[o];this._pack(n,s,o*this._spec.stride)}}}_packPosition(t,r,s){let{offset:i}=this._spec.position,o=this._spec.position.packPrecisionFactor??1,n=_e(t*o,r*o);this._dataView.setUint32(s+i,n,!0)}_packId(t,r){let s=t*(this._spec.id.packPrecisionFactor??1),i=4278190080&this._dataView.getUint32(r+this._spec.id.offset,!0);this._dataView.setUint32(r+this._spec.id.offset,s|i,!0)}_pack(t,r,s){ke(this._dataView,t,r,s)}};function Tr(e){if(!e)return!1;for(let t of e)switch(t.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1}var b=class{constructor(t,r,s,i){this._instanceId=t,this._evaluator=r,this._enabledOptionalAttributes=s,this._viewParams=i,this._evaluator.evaluator=o=>this.vertexSpec.createComputedParams(o)}get _vertexPack(){if(!this._cachedVertexPack){let t=Tt.fromVertexSpec(this.vertexSpec,this._enabledOptionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}loadDependencies(){return v(this,null,function*(){Tr(this._evaluator.inputMeshParams.effects?.effectInfos)&&(yield Oe())})}enqueueRequest(t,r,s){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,r,s)}write(t,r,s,i,o){this.ensurePacked(r,s,i);let n=this.evaluatedMeshParams.effects;if(!n||n.length===0)return void this._write(t,s,void 0,o);let a=s.readGeometryForDisplay()?.clone();if(!a)return;let c=P.fromOptimizedCIM(a,s.geometryType),p=J();c.invertY();let l=t.id||"",d=Pt.executeEffects(n,c,l,p),m;for(;m=d.next();)m.invertY(),this._write(t,s,m,o)}ensurePacked(t,r,s){if(!this._evaluator.hasDynamicProperties)return;let i=this._evaluator.evaluateMeshParams(t,r,s);this._vertexPack.pack(i,this._viewParams)}_writeVertex(t,r,s,i,o){let n=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,r,s,i,n,o)}};var br=100,wr=$t("featurelayer-fast-triangulation-enabled"),j=class e extends b{loadDependencies(){return v(this,null,function*(){yield Promise.all([W(e.prototype,this,"loadDependencies").call(this),ve()])})}_write(t,r,s){let i=s?.asOptimized()??r.readGeometryForDisplay(),o=this._clip(i);o&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,r,o),t.recordEnd())}_clip(t){if(!t)return null;let r=this.hasEffects;return kt(t,r?256:8)}_writeGeometry(t,r,s){let i=s.maxLength>br,o=[],n=this.createTesselationParams(r);if(!i&&wr&&We(o,s))return void(o.length&&this._writeVertices(t,r,s.coords,n,o));let a=Ge(s);this._writeVertices(t,r,a,n)}_writeVertices(t,r,s,i,o){let n=r.getDisplayId(),a=t.vertexCount(),c=this.hasEffects,p=0;if(o)for(let l of o){let d=s[2*l],m=s[2*l+1];c&&t.recordBounds(d,m,0,0),this._writeVertex(t,n,d,m,i),p++}else for(let l=0;l<s.length;l+=2){let d=Math.round(s[l]),m=Math.round(s[l+1]);c&&t.recordBounds(d,m,0,0),this._writeVertex(t,n,d,m,i),p++}t.indexEnsureSize(p);for(let l=0;l<p;l++)t.indexWrite(l+a)}};var vr={createComputedParams:e=>e,optionalAttributes:{},attributes:{id:{type:u.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:u.UNSIGNED_BYTE,count:1},pos:{type:u.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:u.FLOAT,count:1,packTessellation:({inverseArea:e})=>e}}},Ve=class extends j{constructor(){super(...arguments),this.vertexSpec=vr}createTesselationParams(t){return{inverseArea:1/t.readGeometryArea()}}};var Er=()=>te.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils"),Ir=0,Dr=100;function D(e,t){return[!!e?.minScale&&t.scaleToZoom(e.minScale)||Ir,!!e?.maxScale&&t.scaleToZoom(e.maxScale)||Dr]}function K(e){return 1<<e}function F(e){let t=0;for(let[r,s]of e)s&&(t|=1<<r);return t}function S(e){let t;if(!e)return[0,0,0,0];if(typeof e=="string"){let n=le.fromString(e);if(!n)return Er().errorOnce(new ee("mapview:mesh-processing","Unable to parse string into color",{color:e})),[0,0,0,0];t=n.toArray()}else t=e;let[r,s,i,o]=t;return[r*(o/255),s*(o/255),i*(o/255),o]}function He(e){switch(e){case"butt":case N.Butt:return ht.BUTT;case"round":case N.Round:return ht.ROUND;case"square":case N.Square:return ht.SQUARE}}function Ue(e){switch(e){case"bevel":case dt.Bevel:return ft.BEVEL;case"miter":case dt.Miter:return ft.MITER;case"round":case dt.Round:return ft.ROUND}}function bt(e,t){return Math.round(Math.min(Math.sqrt(e*t),255))}function lt(e,t){return Math.round(e*t)/t}var wt={createComputedParams:e=>e,optionalAttributes:{zoomRange:{type:u.SHORT,count:2,packPrecisionFactor:G,pack:({scaleInfo:e},{tileInfo:t})=>D(e,t)}},attributes:{id:{type:u.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:u.UNSIGNED_BYTE,count:1},pos:{type:u.SHORT,count:2,pack:"position",packPrecisionFactor:10},color:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:e})=>S(e)}}},$=class extends j{constructor(){super(...arguments),this.vertexSpec=wt}createTesselationParams(t){return null}};var C={createComputedParams:e=>e,optionalAttributes:wt.optionalAttributes,attributes:k(g({},wt.attributes),{tlbr:{count:4,type:u.UNSIGNED_SHORT,pack:({sprite:e})=>{let{rect:t,width:r,height:s}=e,i=t.x+A,o=t.y+A;return[i,o,i+r,o+s]}},inverseRasterizationScale:{count:1,type:u.BYTE,packPrecisionFactor:16,pack:({sprite:e})=>1/e.rasterizationScale}})},vt=class extends ${constructor(){super(...arguments),this.vertexSpec=C}_write(t,r,s){let i=s?.asOptimized()??r.readGeometryForDisplay(),o=this._clip(i);if(!o)return;let n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,r,o),t.recordEnd()}};function pt(e){let{sprite:t,aspectRatio:r,scaleProportionally:s}=e,i=x(e.height),o=i>0?i:t.height,n=i*r;return n<=0?n=t.width:s&&(n*=t.width/t.height),{width:n,height:o}}function Xt(e){let{applyRandomOffset:t,sampleAlphaOnly:r}=e;return F([[Pe,t],[gt,r]])}var Zt={createComputedParams:e=>e,optionalAttributes:C.optionalAttributes,attributes:k(g({},C.attributes),{bitset:{count:1,type:u.UNSIGNED_BYTE,pack:Xt},width:{count:1,type:u.HALF_FLOAT,pack:e=>pt(e).width},height:{count:1,type:u.HALF_FLOAT,pack:e=>pt(e).height},offset:{count:2,type:u.HALF_FLOAT,pack:({offsetX:e,offsetY:t})=>[x(e),-x(t)]},scale:{count:2,type:u.UNSIGNED_BYTE,packPrecisionFactor:16,pack:({scaleX:e,scaleY:t})=>[e,t]},angle:{count:1,type:u.UNSIGNED_BYTE,pack:({angle:e})=>ge(e)}})},Xe=class extends vt{constructor(){super(...arguments),this.vertexSpec=Zt}};var qt=class{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}},L={createComputedParams:e=>e,optionalAttributes:{zoomRange:{type:u.SHORT,count:2,packPrecisionFactor:G,pack:({scaleInfo:e},{tileInfo:t})=>D(e,t)}},attributes:{id:{type:u.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:u.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:u.UNSIGNED_BYTE,count:1},color:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:e})=>S(e)},offset:{type:u.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:e,extrusionOffsetY:t})=>[lt(e,16),lt(t,16)]},normal:{type:u.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:e,normalY:t})=>[lt(e,16),lt(t,16)]},halfWidth:{type:u.HALF_FLOAT,count:1,pack:({width:e})=>x(.5*e)},referenceHalfWidth:{type:u.HALF_FLOAT,count:1,pack:({referenceWidth:e})=>x(.5*e)}}},Qt=class{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}},Ze=65535,tt=class extends b{constructor(t,r,s,i){super(t,r,s,i),this.vertexSpec=L,this._currentWrite=new Qt,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:Ze,textured:!1},this._tessParams=new qt,this._initializeTessellator()}writeLineVertices(t,r,s){let i=this._getLines(r);i!=null&&this._writeVertices(t,s,i)}_initializeTessellator(){this._lineTessellator=new Ie(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,r,s){let i=s??P.fromFeatureSetReaderCIM(r);i&&this._writeGeometry(t,r,i)}_writeGeometry(t,r,s,i){t.recordStart(this.instanceId,this.attributeLayout,i),this.writeLineVertices(t,s,r),t.recordEnd()}_getLines(t){return Ne(t,yt(this.evaluatedMeshParams))}_writeVertices(t,r,s){let{_currentWrite:i,_tessellationOptions:o,evaluatedMeshParams:n}=this,{width:a,capType:c,joinType:p,miterLimit:l,hasSizeVV:d}=n,m=x(.5*a);o.halfWidth=m,o.capType=He(c),o.joinType=Ue(p),o.miterLimit=l;let f=!d;i.out=t,i.id=r.getDisplayId(),i.vertexCount=0,i.indexCount=0,i.vertexFrom=t.vertexCount(),i.vertexBounds=f&&m<ne?0:1;for(let{line:h,start:y}of s)o.initialDistance=y%Ze,this._lineTessellator.tessellate(h,o,f)}_writeTesselatedVertex(t,r,s,i,o,n,a,c,p,l,d){let{out:m,id:f,vertexBounds:h}=this._currentWrite;return this.hasEffects&&m.recordBounds(t,r,h,h),this._tessParams.extrusionOffsetX=a,this._tessParams.extrusionOffsetY=c,this._tessParams.normalX=p,this._tessParams.normalY=l,this._tessParams.directionX=o,this._tessParams.directionY=n,this._tessParams.distance=d,this._writeVertex(m,f,t,r,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,r,s){let{out:i}=this._currentWrite;i.indexEnsureSize(3),i.indexWrite(t),i.indexWrite(r),i.indexWrite(s),this._currentWrite.indexCount+=3}};var Jt={createComputedParams:e=>e,optionalAttributes:L.optionalAttributes,attributes:k(g({},L.attributes),{bitset:{type:u.UNSIGNED_BYTE,count:1,pack:e=>0},color:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:e})=>S(e)}})},ut={createComputedParams:e=>e,optionalAttributes:L.optionalAttributes,attributes:k(g({},L.attributes),{bitset:{type:u.UNSIGNED_BYTE,count:1,pack:e=>F([[_t,!0]])},color:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:e})=>S(e)}})},H=class extends tt{constructor(){super(...arguments),this.vertexSpec=ut}},et=class e extends ${constructor(t,r,s,i){super(t,r,s,i),this.vertexSpec=Jt,this._lineMeshWriter=this._createOutlineWriter(t,r,s,i)}_createOutlineWriter(t,r,s,i){return new H(t,r,s,i)}_write(t,r,s){let i=s?.asOptimized()??r.readGeometryForDisplay(),o=this._clip(i);o&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,r,o),this._lineMeshWriter.writeLineVertices(t,P.fromOptimizedCIM(o,"esriGeometryPolyline"),r),t.recordEnd())}_clip(t){return t?kt(t,yt(this.evaluatedMeshParams)):null}ensurePacked(t,r,s){super.ensurePacked(t,r,s),this._lineMeshWriter.ensurePacked(t,r,s)}enqueueRequest(t,r,s){super.enqueueRequest(t,r,s),this._lineMeshWriter.enqueueRequest(t,r,s)}loadDependencies(){return v(this,null,function*(){yield Promise.all([W(e.prototype,this,"loadDependencies").call(this),this._lineMeshWriter.loadDependencies()])})}};var Et=Zt,Fr=ut,zr={createComputedParams:e=>e,optionalAttributes:Et.optionalAttributes,attributes:k(g({},Et.attributes),{bitset:{type:u.UNSIGNED_BYTE,count:1,pack:e=>Xt(e)},aux1:{count:1,type:u.HALF_FLOAT,pack:e=>pt(e).width},aux2:{count:1,type:u.HALF_FLOAT,pack:e=>pt(e).height},aux3:{count:2,type:u.HALF_FLOAT,pack:({offsetX:e,offsetY:t})=>[x(e),x(t)]},aux4:{count:2,type:u.UNSIGNED_BYTE,pack:({scaleX:e,scaleY:t})=>[e*it,t*it]}})},Ar={createComputedParams:e=>e,optionalAttributes:Et.optionalAttributes,attributes:k(g({},Et.attributes),{color:Fr.attributes.color,bitset:{type:u.UNSIGNED_BYTE,count:1,pack:e=>F([[_t,!0]])},aux1:{count:1,type:u.HALF_FLOAT,pack:e=>x(.5*e.width)},aux2:{count:1,type:u.HALF_FLOAT,pack:e=>x(.5*e.referenceWidth)},aux3:{count:2,type:u.HALF_FLOAT,packTessellation:({extrusionOffsetX:e,extrusionOffsetY:t})=>[e,t]},aux4:{count:2,type:u.UNSIGNED_BYTE,packTessellation:({normalX:e,normalY:t})=>[e*it+Ot,t*it+Ot]}})},jt=class extends H{constructor(){super(...arguments),this.vertexSpec=Ar}},qe=class e extends et{constructor(){super(...arguments),this.vertexSpec=zr}_createOutlineWriter(t,r,s,i){return new jt(t,r,s,i)}_write(t,r,s){let i=s?.asOptimized()??r.readGeometryForDisplay(),o=this._clip(i);if(!o)return;let n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,r,o),this._lineMeshWriter.writeLineVertices(t,P.fromOptimizedCIM(o,"esriGeometryPolyline"),r),t.recordEnd()}ensurePacked(t,r,s){super.ensurePacked(t,r,s),this._lineMeshWriter.ensurePacked(t,r,s)}enqueueRequest(t,r,s){super.enqueueRequest(t,r,s),this._lineMeshWriter.enqueueRequest(t,r,s)}loadDependencies(){return v(this,null,function*(){yield Promise.all([W(e.prototype,this,"loadDependencies").call(this),this._lineMeshWriter.loadDependencies()])})}};var Cr={optionalAttributes:C.optionalAttributes,createComputedParams:e=>e,attributes:g(g({},C.attributes),Jt.attributes)},Lr={optionalAttributes:C.optionalAttributes,createComputedParams:e=>e,attributes:g(g({},C.attributes),ut.attributes)},Kt=class extends H{constructor(){super(...arguments),this.vertexSpec=Lr}},Qe=class e extends et{constructor(){super(...arguments),this.vertexSpec=Cr}_createOutlineWriter(t,r,s,i){return new Kt(t,r,s,i)}_write(t,r,s){let i=s?.asOptimized()??r.readGeometryForDisplay(),o=this._clip(i);if(!o)return;let n=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,n),this._writeGeometry(t,r,o),this._lineMeshWriter.writeLineVertices(t,P.fromOptimizedCIM(o,"esriGeometryPolyline"),r),t.recordEnd()}ensurePacked(t,r,s){super.ensurePacked(t,r,s),this._lineMeshWriter.ensurePacked(t,r,s)}enqueueRequest(t,r,s){super.enqueueRequest(t,r,s),this._lineMeshWriter.enqueueRequest(t,r,s)}loadDependencies(){return v(this,null,function*(){yield Promise.all([W(e.prototype,this,"loadDependencies").call(this),this._lineMeshWriter.loadDependencies()])})}};var Br={createComputedParams:e=>e,optionalAttributes:{},attributes:{pos:{type:u.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:u.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:u.UNSIGNED_BYTE,count:1},offset:{type:u.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}},Je=class extends b{constructor(){super(...arguments),this.vertexSpec=Br}_write(t,r){t.recordStart(this.instanceId,this.attributeLayout);let s=r.getDisplayId();if(r.geometryType==="esriGeometryPoint"){let i=r.readXForDisplay(),o=r.readYForDisplay();this._writeQuad(t,s,i,o)}else r.geometryType==="esriGeometryMultipoint"&&r.readGeometryForDisplay()?.forEachVertex((o,n)=>{o>=0&&o<=512&&n>=0&&n<=512&&this._writeQuad(t,s,o,n)});t.recordEnd()}_writeQuad(t,r,s,i){let o=t.vertexCount();this._writeVertex(t,r,s,i),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}};var rt=class{static getPlacement(t,r,s,i,o,n){let a=pe(s);return a?(r===-1&&t.invertY(),a.execute(t,s,i,o,n)):null}};var je=96,It=class{constructor(t){let{offsetX:r,offsetY:s,postAngle:i,fontSize:o,haloSize:n,outlineSize:a,scaleFactor:c,transforms:p}=t;if(this.offsetX=r,this.offsetY=s,this.postAngle=i,this.fontSize=Math.min(o,je),this.haloSize=n??0,this.outlineSize=a??0,this.transforms=p,p&&p.infos.length>1){let l=xt(o,i,!1,r,s,p,!1);this.fontSize=Math.min(l.size,je);let d=l.size/o;this.haloSize*=d,this.outlineSize*=d,this.postAngle=l.rotation,this.offsetX=l.offsetX,this.offsetY=l.offsetY}c&&(this.fontSize*=c,this.offsetX*=c,this.offsetY*=c)}};var Wr=28,Y=[4,4],Dt=[16,4],Gr={topLeft:Dt,topRight:Dt,bottomLeft:Dt,bottomRight:Dt},Ft=[4,2],E=[4,6],Ke={topLeft:Ft,topRight:Ft,bottomLeft:E,bottomRight:E},$e={topLeft:Ft,topRight:E,bottomLeft:Ft,bottomRight:E},Nr={topLeft:E,topRight:E,bottomLeft:Y,bottomRight:Y},Yr={topLeft:Y,topRight:Y,bottomLeft:E,bottomRight:E},Or={topLeft:E,topRight:Y,bottomLeft:E,bottomRight:Y},Rr={topLeft:Y,topRight:E,bottomLeft:Y,bottomRight:E},Vr={createComputedParams:e=>e,optionalAttributes:{zoomRange:{type:u.UNSIGNED_SHORT,count:2,packPrecisionFactor:G,packTessellation:({minZoom:e,maxZoom:t})=>[e||0,t||Wr]},clipAngle:{type:u.UNSIGNED_BYTE,count:1,packTessellation:({clipAngle:e})=>Hr(e||0)},referenceSymbol:{type:u.BYTE,count:4,packPrecisionFactor:1,packTessellation:(e,t)=>{let r=e.isLineLabel||!e.referenceBounds,s=de(r?"center":t.horizontalAlignment),i=xe(r?"middle":t.verticalAlignment),{offsetX:o,offsetY:n,size:a}=r?{offsetX:0,offsetY:0,size:0}:e.referenceBounds;return[x(o),-x(n),Math.round(x(a)),s+1<<2|i+1]}}},attributes:{pos:{type:u.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:u.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:u.UNSIGNED_BYTE,count:1,packTessellation:({isBackground:e,mapAligned:t})=>F([[be,e],[we,!!t]])},offset:{type:u.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:({offsets:e})=>{let{bottomLeft:t,bottomRight:r,topLeft:s,topRight:i}=e;return[s,i,t,r]}}},textureUV:{type:u.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:({texcoords:e})=>{let{bottomLeft:t,bottomRight:r,topLeft:s,topRight:i}=e;return[s,i,t,r]}}},color:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:({color:e})=>e},fontSize:{type:u.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:({fontSize:e})=>Math.round(x(e))},referenceSize:{type:u.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:({fontSize:e},{referenceSize:t})=>Math.round(x(t??e))},outlineColor:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:e})=>S(e)},haloColor:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({haloColor:e})=>S(e)},outlineAndHaloSize:{type:u.UNSIGNED_SHORT,count:2,packPrecisionFactor:4,packTessellation:({outlineSize:e,haloSize:t})=>[Math.round(x(e)),Math.round(x(t))]}}},tr=class extends b{constructor(){super(...arguments),this.vertexSpec=Vr,this._textMeshParamsPropsInitialized=!1}ensurePacked(t,r,s){super.ensurePacked(t,r,s),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new It(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(t,r,s){let i=this._getShaping();if(!i)return;let o=r.getDisplayId();if(this.evaluatedMeshParams.placement!=null)return this._writePlacedTextMarkers(t,r,i,s);if(s?.nextPath())return s.nextPoint(),this._writeGlyphs(t,o,s.x,s.y,i,0);if(r.geometryType==="esriGeometryPolygon"){let c=r.readCentroidForDisplay();if(!c)return;let[p,l]=c.coords;return this._writeGlyphs(t,o,p,l,i,0)}if(r.geometryType==="esriGeometryMultipoint")return void r.readGeometryForDisplay()?.forEachVertex((p,l)=>this._writeGlyphs(t,o,p,l,i,0));let n=r.readXForDisplay(),a=r.readYForDisplay();return this._writeGlyphs(t,o,n,a,i,0)}_writePlacedTextMarkers(t,r,s,i){let o=i??P.fromFeatureSetReaderCIM(r);if(!o)return;let n=-1,a=rt.getPlacement(o,n,this.evaluatedMeshParams.placement,x(1),t.id,J());if(!a)return;let c=r.getDisplayId(),p=a.next();for(;p!=null;){let l=p.tx,d=-p.ty,m=-p.getAngle();this._writeGlyphs(t,c,l,d,s,m),p=a.next()}}_getShaping(t){let r=this._textMeshTransformProps,s=this.evaluatedMeshParams;if(!s.glyphs?.glyphs.length)return null;let i=x(r.fontSize),o=x(r.offsetX),n=x(r.offsetY),a=Lt(x(s.lineWidth),ae,ce),c=ie*Lt(s.lineHeightRatio,.25,4);return ye(s.glyphs,{scale:i/oe,angle:r.postAngle,xOffset:o,yOffset:n,horizontalAlignment:s.horizontalAlignment,verticalAlignment:t||s.verticalAlignment,maxLineWidth:a,lineHeight:c,decoration:s.decoration,borderLineSizePx:x(s.boxBorderLineSize),hasBackground:!!s.boxBackgroundColor,useCIMAngleBehavior:s.useCIMAngleBehavior})}_writeGlyphs(t,r,s,i,o,n,a,c){let p=this.evaluatedMeshParams,l=this._textMeshTransformProps,d=x(l.fontSize),m=l.haloSize,f=l.outlineSize,h=x(l.offsetX),y=x(l.offsetY),[_,w]=D(p.scaleInfo,this.getTileInfo());n!==0&&o.setRotation(n);let T=o.bounds,O=s+T.x+h,z=i+T.y-y,U=2*(p.minPixelBuffer?p.minPixelBuffer/d:1),I=Math.max(T.width,T.height)*U;o.textBox&&(t.recordStart(this.instanceId,this.attributeLayout,o.glyphs[0].textureBinding),t.recordBounds(O,z,I,I),this._writeTextBox(t,r,s,i,o.textBox,a,c),t.recordEnd());for(let B of o.glyphs){t.recordStart(this.instanceId,this.attributeLayout,B.textureBinding),t.recordBounds(O,z,I,I);let{texcoords:Ct,offsets:X}=B;this._writeQuad(t,r,s,i,g({texcoords:Ct,offsets:X,fontSize:d,haloSize:m,outlineSize:f,color:S(p.color),isBackground:!1,referenceBounds:a,minZoom:_,maxZoom:w},c)),t.recordEnd()}n!==0&&o.setRotation(-n)}_writeTextBox(t,r,s,i,o,n,a){let c=this.evaluatedMeshParams,{fontSize:p,haloSize:l,outlineSize:d}=this._textMeshTransformProps,{boxBackgroundColor:m,boxBorderLineColor:f}=c,h=g({isBackground:!0,fontSize:p,haloSize:l,outlineSize:d,referenceBounds:n},a);m&&(this._writeQuad(t,r,s,i,g({texcoords:Gr,offsets:o.main,color:S(m)},h)),f||(this._writeQuad(t,r,s,i,g({texcoords:Nr,offsets:o.top,color:S(m)},h)),this._writeQuad(t,r,s,i,g({texcoords:Yr,offsets:o.bot,color:S(m)},h)),this._writeQuad(t,r,s,i,g({texcoords:Or,offsets:o.left,color:S(m)},h)),this._writeQuad(t,r,s,i,g({texcoords:Rr,offsets:o.right,color:S(m)},h)))),f&&(this._writeQuad(t,r,s,i,g({texcoords:Ke,offsets:o.top,color:S(f)},h)),this._writeQuad(t,r,s,i,g({texcoords:Ke,offsets:o.bot,color:S(f)},h)),this._writeQuad(t,r,s,i,g({texcoords:$e,offsets:o.left,color:S(f)},h)),this._writeQuad(t,r,s,i,g({texcoords:$e,offsets:o.right,color:S(f)},h)))}_writeQuad(t,r,s,i,o){let n=t.vertexCount();this._writeVertex(t,r,s,i,o),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}},Hr=e=>Math.round(e*(254/360));var Ur={createComputedParams:e=>e,optionalAttributes:L.optionalAttributes,attributes:k(g({},L.attributes),{bitset:{type:u.UNSIGNED_BYTE,count:1,pack:({shouldSampleAlphaOnly:e,shouldScaleDash:t,isSDF:r})=>F([[gt,e],[Me,t],[Te,r]])},tlbr:{type:u.UNSIGNED_SHORT,count:4,pack:({sprite:e})=>{let{rect:t,width:r,height:s}=e,i=t.x+A,o=t.y+A;return[i,o,i+r,o+s]}},accumulatedDistance:{type:u.UNSIGNED_SHORT,count:1,packTessellation:({distance:e})=>e},segmentDirection:{type:u.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:e,directionY:t})=>[e,t]},offsetAlongLine:{type:u.HALF_FLOAT,count:1,pack:({offsetAlongLine:e})=>x(e)},capType:{type:u.UNSIGNED_BYTE,count:1,pack:({capType:e})=>{switch(e){case N.Butt:case"butt":return 0;case N.Square:case"square":return 1;case N.Round:case"round":return 2;default:return 0}}}})},er=class extends tt{constructor(t,r,s,i){super(t,r,s,i),this.vertexSpec=Ur,this._tessellationOptions.textured=!0}_write(t,r,s){let i=s??P.fromFeatureSetReaderCIM(r);if(!i)return;let{sprite:o}=this.evaluatedMeshParams;this._writeGeometry(t,r,i,o?.textureBinding)}};var zt=class e{static from(t){return"width"in t?this.fromSimpleMeshParams(t):this.fromComplexMeshParams(t)}static fromSimpleMeshParams(t){let r=new e(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects),{type:s,width:i,height:o,angle:n,alignment:a,outlineSize:c,referenceSize:p,sprite:l,overrideOutlineColor:d}=t;return r.rawWidth=x(i),r.rawHeight=x(o),r.angle=n,r.alignment=a,r.outlineSize=x(c),r.referenceSize=x(p),r.overrideOutlineColor=d,r.offsetX=x(t.offsetX),r.offsetY=x(t.offsetY),s!=="simple"||l.sdf||(r.rawWidth=l.width,r.rawHeight=l.height),r._computeSize(t,!1),r}static fromComplexMeshParams(t){let r=new e(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects),{alignment:s,transforms:i,size:o,scaleX:n,anchorX:a,anchorY:c,angle:p,colorLocked:l,frameHeight:d,widthRatio:m,offsetX:f,offsetY:h,outlineSize:y,referenceSize:_,scaleFactor:w,sizeRatio:T,isAbsoluteAnchorPoint:O,rotateClockwise:z,scaleSymbolsProportionally:U,sprite:I}=t;if(i&&i.infos.length>0){let X=xt(o,p,z,f,h,i);o=X.size,p=X.rotation,f=X.offsetX,h=X.offsetY,z=!1}w&&(o*=w,f*=w,h*=w);let B=n*(I.width/I.height);r.alignment=s,r.rawHeight=x(o),r.rawWidth=r.rawHeight*B,r.referenceSize=x(_),r.sizeRatio=T,r.sdfDecodeCoeff=(I.sdfDecodeCoeff??1)*T,r.angle=p,r.rotateClockwise=z,r.anchorX=a,r.anchorY=c,r.offsetX=x(f),r.offsetY=x(h),O&&o&&(I.sdf?r.anchorX=a/(o*m):r.anchorX=a/(o*B),r.anchorY=c/o);let Ct=U&&d?o/d:1;return r.outlineSize=y===0||isNaN(y)?0:x(y)*Ct,r.scaleSymbolsProportionally=U,r.colorLocked=l,r._computeSize(t,!0),r}constructor(t,r,s,i,o,n,a){this.sprite=t,this.color=r,this.outlineColor=s,this.minPixelBuffer=i,this.placement=o,this.scaleInfo=n,this.effects=a,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.sdfDecodeCoeff=1,this.alignment=mt.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(t,r){let{sprite:s,hasSizeVV:i}=t,o=!!s.sdf,n=s.sdfPaddingRatio??.5,{rawWidth:a,rawHeight:c,sizeRatio:p,outlineSize:l}=this,d=p*(o?1/(1-n):1),m=a*d,f=c*d;if(o&&!i){let U=r&&a>c?m:a,I=c,B=l+2*1;this.computedWidth=Math.min(U+B,m),this.computedHeight=Math.min(I+B,f)}else this.computedWidth=m,this.computedHeight=f;let h=o?Math.max(s.width,s.height)/Math.max(m,f):1,y=.5*(m-this.computedWidth)*h,_=.5*(f-this.computedHeight)*h,w=s.rect.x+A+y,T=s.rect.y+A+_,O=w+s.width-2*y,z=T+s.height-2*_;this.texXmin=Math.floor(w),this.texYmin=Math.floor(T),this.texXmax=Math.ceil(O),this.texYmax=Math.ceil(z),this.computedWidth*=(this.texXmax-this.texXmin)/(O-w),this.computedHeight*=(this.texYmax-this.texYmin)/(z-T),this.anchorX*=m/this.computedWidth,this.anchorY*=f/this.computedHeight}};var Xr=3.14159265359/180,Zr=128/Math.PI;function qr(e,t){return e%=t,Math.abs(e>=0?e:e+t)}function Qr(e){return qr(e*Zr,256)}function Jr(e,t,r,s,i=!1){let o=me(),n=i?1:-1;return ue(o),(t||r)&&fe(o,o,[t,-r]),s&&he(o,o,n*Xr*-s),o}var jr={createComputedParams:e=>zt.from(e),optionalAttributes:{zoomRange:{type:u.SHORT,count:2,packPrecisionFactor:G,pack:({scaleInfo:e},{tileInfo:t})=>D(e,t)}},attributes:{pos:{type:u.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:u.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:u.UNSIGNED_BYTE,count:1,pack:({sprite:e,alignment:t,scaleSymbolsProportionally:r,overrideOutlineColor:s,colorLocked:i})=>{let o=0;return e.sdf&&(o|=K(Z.bitset.isSDF)),t===mt.MAP&&(o|=K(Z.bitset.isMapAligned)),r&&(o|=K(Z.bitset.scaleSymbolsProportionally)),s&&(o|=K(Z.bitset.overrideOutlineColor)),i&&(o|=K(Z.bitset.colorLocked)),o}},offset:{type:u.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({angle:e,computedWidth:t,computedHeight:r,anchorX:s,anchorY:i,offsetX:o,offsetY:n,rotateClockwise:a})=>{let c=Jr(0,o,n,-e,a),p=-(.5+s)*t,l=-(.5-i)*r,d=[p,l],m=[p+t,l],f=[p,l+r],h=[p+t,l+r];return st(d,d,c),st(m,m,c),st(f,f,c),st(h,h,c),[d,m,f,h]}}},textureUV:{type:u.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({texXmax:e,texXmin:t,texYmax:r,texYmin:s})=>[[t,s],[e,s],[t,r],[e,r]]}},color:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:e})=>S(e)},outlineColor:{type:u.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:e})=>S(e)},sizing:{type:u.UNSIGNED_BYTE,count:4,pack:({rawWidth:e,rawHeight:t,outlineSize:r,referenceSize:s})=>{let i=Math.max(e,t);return[bt(i,128),bt(r,128),bt(s,128),0]}},placementAngle:{type:u.UNSIGNED_BYTE,count:1,packTessellation:({placementAngle:e})=>Qr(e)},sdfDecodeCoeff:{type:u.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:({sdfDecodeCoeff:e})=>e}}},rr=class extends b{constructor(){super(...arguments),this.vertexSpec=jr}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(t,r,s){let i=this.evaluatedMeshParams.sprite?.textureBinding,o=r.getDisplayId();t.recordStart(this.instanceId,this.attributeLayout,i);let n=this.evaluatedMeshParams.minPixelBuffer,a=Math.max(this.evaluatedMeshParams.computedWidth,n),c=Math.max(this.evaluatedMeshParams.computedHeight,n),p=-this.evaluatedMeshParams.anchorX*this.evaluatedMeshParams.computedWidth,l=this.evaluatedMeshParams.anchorY*this.evaluatedMeshParams.computedHeight,d=this.evaluatedMeshParams.offsetX+p,m=-this.evaluatedMeshParams.offsetY+l;if(this.evaluatedMeshParams.placement!=null)this._writePlacedMarkers(t,r,s,a,c);else if(s?.nextPath()){s.nextPoint();let f=s.x,h=s.y;t.recordBounds(f+d,h+m,a,c),this._writeQuad(t,o,f,h)}else if(r.geometryType==="esriGeometryPolygon"){let f=r.readCentroidForDisplay();if(!f)return;let[h,y]=f.coords;t.recordBounds(h+d,y+m,a,c),this._writeQuad(t,o,h,y)}else if(r.geometryType==="esriGeometryPoint"){let f=r.readXForDisplay(),h=r.readYForDisplay();t.recordBounds(f+d,h+m,a,c),this._writeQuad(t,o,f,h)}else r.readGeometryForDisplay()?.forEachVertex((h,y)=>{t.recordBounds(h+d,y+m,a,c),Math.abs(h)>1024||Math.abs(y)>1024||this._writeQuad(t,o,h,y)});t.recordEnd()}_writePlacedMarkers(t,r,s,i,o){let n=s??P.fromFeatureSetReaderCIM(r)?.clone();if(!n)return;let a=-1,c=rt.getPlacement(n,a,this.evaluatedMeshParams.placement,x(1),t.id,J());if(!c)return;let p=r.getDisplayId(),l=c.next(),d=this.evaluatedMeshParams.offsetX,m=-this.evaluatedMeshParams.offsetY;for(;l!=null;){let f=l.tx,h=-l.ty;if(Math.abs(f)>1024||Math.abs(h)>1024){l=c.next();continue}let y=-l.getAngle();t.recordBounds(f+d,h+m,i,o),this._writeQuad(t,p,f,h,y),l=c.next()}}_writeQuad(t,r,s,i,o){let n=t.vertexCount(),a=o==null?null:{placementAngle:o};this._writeVertex(t,r,s,i,a),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}};var Kr={createComputedParams:e=>e,optionalAttributes:{},attributes:{pos:{type:u.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:u.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:u.UNSIGNED_BYTE,count:1,pack:e=>0},offset:{type:u.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:({size:e})=>{let t=x(e),r=-t/2,s=-t/2;return[[r,s],[r+t,s],[r,s+t],[r+t,s+t]]}}},texCoords:{type:u.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:u.UNSIGNED_BYTE,count:2,pack:({size:e})=>[e,e]},referenceSize:{type:u.UNSIGNED_BYTE,count:1,pack:({size:e})=>x(e)},zoomRange:{type:u.UNSIGNED_BYTE,count:2,pack:({scaleInfo:e},{tileInfo:t})=>D(e,t)}}},sr=class extends b{constructor(){super(...arguments),this.vertexSpec=Kr}_write(t,r){let s=r.getDisplayId(),i=this.evaluatedMeshParams.minPixelBuffer,o=Math.max(x(this.evaluatedMeshParams.size),i),n,a;if(r.geometryType==="esriGeometryPoint")n=r.readXForDisplay(),a=r.readYForDisplay();else{let p=r.readCentroidForDisplay();if(!p)return;n=p?.coords[0],a=p?.coords[1]}t.recordStart(this.instanceId,this.attributeLayout),t.recordBounds(n,a,o,o);let c=t.vertexCount();this._writeVertex(t,s,n,a),t.indexWrite(c+0),t.indexWrite(c+1),t.indexWrite(c+2),t.indexWrite(c+1),t.indexWrite(c+3),t.indexWrite(c+2),t.recordEnd()}};export{D as a,K as b,S as c,Pt as d,b as e,Ve as f,$ as g,vt as h,Xe as i,tt as j,et as k,qe as l,Qe as m,Je as n,Wr as o,tr as p,er as q,rr as r,sr as s};
