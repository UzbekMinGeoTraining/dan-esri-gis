import{a as ne,b as se}from"./chunk-TE3AN3AP.js";import{a as ae,c as re,d as oe}from"./chunk-UZJLA2HS.js";import{a as A}from"./chunk-HTTNXZ47.js";import{a as ie}from"./chunk-LVXEBOB6.js";import{a as ee}from"./chunk-46ZNFCJZ.js";import{b as te}from"./chunk-4FRQLB6H.js";import{a as m}from"./chunk-RLWJFGVZ.js";import{A as Y,C as $,d as F,g as P,i as k,k as T}from"./chunk-AB4CTIUZ.js";import{v as q}from"./chunk-3KFX3FFC.js";import{h as D,t as X}from"./chunk-FW33MEBA.js";import{a as M,g as Q,i as O}from"./chunk-MBJHSEMD.js";import{c as g}from"./chunk-VQHENXDQ.js";import{a as J}from"./chunk-VWF5VUO3.js";import{f as K}from"./chunk-HRP5LYWJ.js";import{Q as p,S as w}from"./chunk-GGZQ5GCM.js";import{U as E}from"./chunk-TFUPB3ZG.js";import{a as j}from"./chunk-ANPNMGFG.js";import{a as r}from"./chunk-BMVJCP2M.js";import{a as U,l as I,n as B}from"./chunk-GMC3I5VG.js";import{r as V}from"./chunk-3IBUFXWY.js";import{i as W}from"./chunk-BP73DJTS.js";import{a as x,b as Z,g as v}from"./chunk-JEGVIFEP.js";var _=class extends w{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1,this.sublayerSources=new g}};r([p({constructOnly:!0})],_.prototype,"layer",void 0),r([p()],_.prototype,"enabled",void 0),r([p()],_.prototype,"updating",void 0),r([p()],_.prototype,"availability",void 0),r([p()],_.prototype,"sublayerSources",void 0),_=r([E("esri.views.interactive.snapping.FeatureSnappingLayerSource")],_);var R=_;var u=class extends w{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.forceDisabled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.gridEnabled=!1,this.attributeRulesEnabled=!1,this.featureSources=new g,this.distance=m.distance,this.touchSensitivityMultiplier=m.touchSensitivityMultiplier}get effectiveEnabled(){return!this.forceDisabled&&(this.enabledToggled?!this.enabled:this.enabled)}get effectiveGridEnabled(){return this.effectiveEnabled&&this.gridEnabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}get _effectiveFeatureSources(){let e=this.featureSources;e.some(pe)&&V.getLogger(this).warnOnce("Do not configure SubtypeGroupLayer sources in SnappingOptions.featureSources directly. Create a FeatureSnappingLayerSource for each SubtypeSublayer.");let t=e.filter(ue),i=this._get("_effectiveFeatureSources")?.filter(pe)??new g;for(let o of t){let c=i.find(l=>l.layer===o.layer.parent);if(c)c.sublayerSources.includes(o)||c.sublayerSources.add(o);else if(o.layer.parent){let l=new R({layer:o.layer.parent});l.sublayerSources.add(o),i.add(l)}}for(let o of i){let c=o.sublayerSources.filter(l=>!t.includes(l));o.sublayerSources.removeMany(c)}i.removeMany(i.filter(o=>o.sublayerSources.length===0));let n=e.filter(ce),a=this._get("_effectiveFeatureSources")??new g,{added:s,removed:d}=W(a.toArray(),[...n,...i]);return a.removeMany(d),a.addMany(s),a}};r([p()],u.prototype,"enabled",void 0),r([p()],u.prototype,"enabledToggled",void 0),r([p()],u.prototype,"forceDisabled",void 0),r([p()],u.prototype,"selfEnabled",void 0),r([p()],u.prototype,"featureEnabled",void 0),r([p()],u.prototype,"gridEnabled",void 0),r([p()],u.prototype,"attributeRulesEnabled",void 0),r([p({type:g.ofType(R)})],u.prototype,"featureSources",void 0),r([p()],u.prototype,"distance",void 0),r([p()],u.prototype,"touchSensitivityMultiplier",void 0),r([p({readOnly:!0})],u.prototype,"effectiveEnabled",null),r([p({readOnly:!0})],u.prototype,"effectiveGridEnabled",null),r([p({readOnly:!0})],u.prototype,"effectiveSelfEnabled",null),r([p({readOnly:!0})],u.prototype,"effectiveFeatureEnabled",null),r([p({readOnly:!0})],u.prototype,"_effectiveFeatureSources",null),u=r([E("esri.views.interactive.snapping.SnappingOptions")],u);var L=u;function pe(e){return e.layer.type==="subtype-group"}function ce(e){return e.layer.type!=="subtype-group"}function ue(e){return e.layer.type==="subtype-sublayer"}function de(e,t){let i=new L({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:t?.distance??m.distance,touchSensitivityMultiplier:t?.touchSensitivityMultiplier??m.touchSensitivityMultiplier});return Z(x({},M(()=>e.map?.allLayers?.toArray()??[],n=>{i.featureSources=new g(n).map(a=>new R({layer:a}))},O)),{options:i})}var h=class extends J.EventedMixin(w){constructor(e){super(e),this.options=new L,this._engineCache=new Map,this._loadTask=null,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=y.MAIN}initialize(){this.addHandles([M(()=>{let{distance:e,touchSensitivityMultiplier:t,effectiveSelfEnabled:i,effectiveFeatureEnabled:n,effectiveGridEnabled:a}=this.options;return{selfEnabled:i,featureEnabled:n,gridEnabled:this.view.type==="2d"&&a,viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,distance:e,touchSensitivityMultiplier:t}},(e,t)=>{t&&(this.doneSnapping(),this.emit("changed")),this._loadTask?.abort(),this._loadTask=K(i=>this._updateEngines(e,t,i))},O),M(()=>this.options,e=>{for(let t of this._engines)t.options=e},Q)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)||!this._loadTask?.finished}_destroyEngines(){this._engineCache.forEach(e=>e.destroy()),this._engineCache.clear(),this._engines=[]}_updateEngines(e,t,i){return v(this,null,function*(){if(!e.viewReady)return void this._destroyEngines();t?.viewSpatialReference!==e.viewSpatialReference&&this._destroyEngines();let{_engineCache:n}=this,a=[];e.featureEnabled&&!n.has("feature")&&a.push(this._setupFeatureSnappingEngine(i)),e.selfEnabled&&!n.has("self")&&a.push(this._setupSelfSnappingEngine(i)),e.gridEnabled&&!n.has("grid")&&this.view.type==="2d"&&a.push(this._setupGridSnappingEngine(i)),yield Promise.allSettled(a),i.aborted||(this._engines=Array.from(n.values()))})}_setupSelfSnappingEngine(e){return v(this,null,function*(){let{SelfSnappingEngine:t}=yield import("./chunk-K7HGXMNO.js");I(e);let i=new t({view:this.view,options:this.options});this._engineCache.set("self",i)})}_setupGridSnappingEngine(e){return v(this,null,function*(){let{view:t}=this,{GridSnappingEngine:i}=yield import("./chunk-NZHMFYNX.js");if(I(e),t.type==="2d"){let n=new i({view:t,options:this.options});this._engineCache.set("grid",n)}})}_setupFeatureSnappingEngine(e){return v(this,null,function*(){let{FeatureSnappingEngine:t}=yield import("./chunk-L3CHU33C.js");I(e);let{view:i,options:n,_engineCache:a}=this,s=new t({view:i,options:n,spatialReference:i.spatialReference});a.set("feature",s)})}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){let{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}snap(e){return ge(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){let{point:t,context:i}=e;this._removeVisualization();let n=this._currentMainCandidate;if(n==null)return t;let a=this._selectUpdateInput(e);if(a==null)return t;let{spatialReference:s}=i,d=D(a,s);if(d==null)return t;let{view:o}=this,{elevationInfo:c,visualizer:l}=i,f=[],S=P(d,o,c),b=n.constraint.closestTo(S);if(!this._arePointsWithinScreenThreshold(S,b,i)||!N(n,i.drawConstraints))return this._resetSnappingState(),t;n.targetPoint=F(b),f.push(...n.hints);for(let C of this._currentOtherActiveCandidates)N(C,i.drawConstraints)&&(C.targetPoint=F(b),f.push(...C.hints));return l!=null&&this.addHandles(l.draw(f,{spatialReference:s,elevationInfo:me(i),view:o,selfSnappingZ:i.selfSnappingZ}),H),k(b,o,t,i)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case y.MAIN:return e;case y.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=y.MAIN}_removeVisualization(){this.removeHandles(H)}_snapSinglePoint(n){return v(this,arguments,function*({point:e,context:t,signal:i}){let{view:a}=this,{elevationInfo:s}=t,d=P(e,a,s),o=yield this._fetchCandidates(d,T.ALL,t,i);return this._createSnapResult(d,y.MAIN,o,a,e,t,i)})}_snapMultiPoint(a){return v(this,arguments,function*({point:e,scenePoint:t,context:i,signal:n}){let{view:s}=this,{coordinateHelper:d,elevationInfo:o,spatialReference:c}=i;yield X(t.spatialReference,c);let l=D(t,c),f=P(l,s,o),S=yield this._fetchCandidates(f,T.FEATURE,i,n);if(S.length>0){let le=yield this._fetchCandidates(f,T.SELF,i,n);return this._createSnapResult(f,y.SCENE,[...S,...le],s,l,i,n)}let b=P(e,s,o),C=yield this._fetchCandidates(b,T.SELF,i,n);return this._createSnapResult(b,y.MAIN,C,s,{z:d.hasZ()&&e.hasZ?e.z??0:void 0,m:d.hasM()&&e.hasM?e.m??0:void 0},i,n)})}_fetchCandidates(e,t,i,n){return v(this,null,function*(){return(yield Promise.all(this._engines.map(a=>a.fetchCandidates(e,t,i,n)))).flat()})}_createSnapResult(e,t,i,n,a,s,d){return{get valid(){return!B(d)},apply:()=>{let{spatialReference:o}=s,{snappedPoint:c,hints:l}=this._processCandidates(e,t,i,s);return this._removeVisualization(),s.visualizer!=null&&this.addHandles(s.visualizer.draw(l,{spatialReference:o,elevationInfo:q,view:n,selfSnappingZ:s.selfSnappingZ}),H),k(c,n,a,s)}}}_processCandidates(e,t,i,n){if(i.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),$(e,i);let a=this._currentMainCandidate;if(a!=null){let s=fe(a,i);if(s>=0){if(!(i[s]instanceof A))return this._intersectWithOtherCandidates(s,i,e,t,n);if(this._arePointsWithinScreenThreshold(e,a.targetPoint,n))return this._updateSnappingCandidate(a,t,i,n)}}return this._intersectWithOtherCandidates(0,i,e,t,n)}_intersectWithOtherCandidates(e,t,i,n,a){let{coordinateHelper:s}=a,d=t[e],o=[];for(let c=0;c<t.length;++c){if(c===e)continue;let l=t[c],f=d.constraint.intersect(l.constraint);if(f)for(let S of f.closestPoints(d.targetPoint))o.push([new A(F(S),d,l,l.isDraped),this._squaredScreenDistance(i,S,s)])}return o.length>0&&(o.sort((c,l)=>c[1]-l[1]),o[0][1]<this._squaredPointProximityThreshold(a.pointer))?this._updateSnappingCandidate(o[0][0],n,t,a):N(d,a.drawConstraints)?this._updateSnappingCandidate(d,n,t,a):{snappedPoint:i,hints:[]}}_updateSnappingCandidate(e,t,i,n){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;let a=this._currentMainCandidate.targetPoint,s=[];s.push(...e.hints);for(let d of i){if(e instanceof A){if(d.constraint.equals(e.first.constraint)||d.constraint.equals(e.second.constraint))continue}else if(d.constraint.equals(e.constraint))continue;let o=d.constraint.closestTo(a);this._squaredScreenDistance(o,a,n.coordinateHelper)<he()&&(d.targetPoint=a,this._currentOtherActiveCandidates.push(d),s.push(...d.hints))}return{snappedPoint:a,hints:s}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(e,t,i){return this._squaredScreenDistance(e,t,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(e,t,i){return Y(this._toScreen(e,i),this._toScreen(t,i))}_toScreen(e,t){return oe(e,t.spatialReference,q,this.view)}get test(){}},y;r([p({constructOnly:!0})],h.prototype,"view",void 0),r([p()],h.prototype,"options",void 0),r([p({readOnly:!0})],h.prototype,"updating",null),r([p()],h.prototype,"_loadTask",void 0),r([p()],h.prototype,"_engines",void 0),r([p()],h.prototype,"_squaredMouseProximityThreshold",null),r([p()],h.prototype,"_squaredTouchProximityThreshold",null),h=r([E("esri.views.interactive.snapping.SnappingManager")],h),function(e){e[e.MAIN=0]="MAIN",e[e.SCENE=1]="SCENE"}(y||(y={}));var H="visualization-handle";function he(){return m.satisfiesConstraintScreenThreshold*m.satisfiesConstraintScreenThreshold}function N(e,t){return!t||t.direction==null&&t.distance==null||!(e instanceof ee||e instanceof te||e instanceof ie||e instanceof ne||e instanceof se)&&(!(e instanceof ae)||t.direction==null&&e.selfSnappingType===re.LastVertex)}function fe(e,t){return e instanceof A?G(t,e.first)>=0&&G(t,e.second)>=0?0:-1:G(t,e)}function G(e,t){let i=-1;for(let n=0;n<e.length;++n)if(t.constraint.equals(e[n].constraint)){i=n;break}return i}function ge(e){return e.scenePoint!=null}function me({coordinateHelper:e,elevationInfo:t}){return e.hasZ()?q:t}var z=new Map;function Tt(e){if(!z.has(e)){let n=de(e,{distance:10}),a=Se(e,n.options);z.set(e,{referenceCount:0,snappingManager:a,remove:()=>{n.remove(),a.destroy()}})}let t=z.get(e);t.referenceCount++;let i=U(()=>ye(e,t));return x({snappingManager:t.snappingManager},i)}function ye(e,t){t.referenceCount--,t.referenceCount>0||j(()=>{t.referenceCount===0&&(t.remove(),z.delete(e))})}function Se(e,t){return new h({view:e,options:t})}export{Tt as a};
