import{a as ei}from"./chunk-DLQRCAZ4.js";import{a as Kt,b as Yt,d as Xt,e as Zt}from"./chunk-7UCIICUA.js";import{a as Gt}from"./chunk-QN72YLVS.js";import{c as Re}from"./chunk-IVZ2RXL2.js";import{a as Bt}from"./chunk-2K35ZAGK.js";import{a as Qt}from"./chunk-6GII4ES2.js";import"./chunk-E3DN7XQP.js";import"./chunk-4RJTDUBN.js";import"./chunk-MTRBRBPC.js";import"./chunk-A7GYEEN6.js";import{t as vt,u as At}from"./chunk-HW47RMVO.js";import{b as Pt,c as St,d as xt}from"./chunk-GKDKJ4AN.js";import"./chunk-XC5QOYTY.js";import"./chunk-6GQ5JB2B.js";import"./chunk-WUZAEWWX.js";import"./chunk-ACVF7Z7X.js";import{c as ti}from"./chunk-ZLMPM3CL.js";import{a as Ce}from"./chunk-UMYW2XL7.js";import{a as Jt}from"./chunk-SV4KOVAG.js";import"./chunk-2SZOQMAQ.js";import{b as jt}from"./chunk-PA5IAWXD.js";import{a as $t}from"./chunk-AR3SF3CU.js";import"./chunk-WP7QHDBV.js";import{h as Ut}from"./chunk-2F2E6NNR.js";import"./chunk-RB4JCGG3.js";import"./chunk-CEM45EZZ.js";import{a as Ht}from"./chunk-GLY75KSJ.js";import"./chunk-H7LSTWKZ.js";import{j as Tt}from"./chunk-3KFX3FFC.js";import"./chunk-VSPQNL6A.js";import{c as It}from"./chunk-NPF6KTZO.js";import{a as kt}from"./chunk-H4XRNT5U.js";import{c as zt}from"./chunk-6ISQQD7M.js";import"./chunk-SDC4SION.js";import"./chunk-6VHG3ZEH.js";import{a as Ct,b as U}from"./chunk-N3AGC3JB.js";import"./chunk-IGNHVSQC.js";import{a as qt}from"./chunk-NP35J4DQ.js";import{a as X}from"./chunk-S2HMCZNZ.js";import{c as Lt,g as Mt}from"./chunk-QB4KDO4M.js";import{a as Wt}from"./chunk-NNNTRPDR.js";import{b as M}from"./chunk-J7UK2QPE.js";import{a as Et,b as Dt}from"./chunk-N6PITG7Q.js";import{k as Ot,l as Ft,m as Vt}from"./chunk-ATV5GTE5.js";import"./chunk-6N46AY7Z.js";import{a as Rt}from"./chunk-AY3YVZUY.js";import"./chunk-G5SIQY64.js";import"./chunk-WW7S4V24.js";import"./chunk-UGAMS6PU.js";import"./chunk-EHDNZUTT.js";import"./chunk-B72PB7U4.js";import"./chunk-A54VD7GL.js";import"./chunk-K55ZDM2S.js";import"./chunk-Z3USGHSR.js";import"./chunk-RNN6GAXL.js";import"./chunk-4IVMQ5PX.js";import"./chunk-CQUOQXLP.js";import"./chunk-3ZOLHUAU.js";import"./chunk-I6ZCG7XQ.js";import"./chunk-URULUATZ.js";import"./chunk-WOTA3FFP.js";import"./chunk-BNUQT6PD.js";import{d as Nt}from"./chunk-5DAF2FXI.js";import"./chunk-M2F4B74F.js";import"./chunk-2WNCPIJC.js";import"./chunk-GDB2EJGA.js";import"./chunk-RDGFIF46.js";import"./chunk-C2ONI6UP.js";import"./chunk-H6LJ2DCJ.js";import"./chunk-IMNO5TXZ.js";import"./chunk-LCDA6FHZ.js";import"./chunk-RZPELDHM.js";import"./chunk-S3J33BKD.js";import{a as F,m as Y}from"./chunk-NPIYHDQ7.js";import"./chunk-BL63T6AU.js";import"./chunk-AOTWUAUY.js";import"./chunk-VI4TDFI5.js";import"./chunk-GXSLPADW.js";import"./chunk-2HN33SWB.js";import"./chunk-523X5JOP.js";import"./chunk-BXR2KKYP.js";import"./chunk-7ISKCG7U.js";import{f as wt}from"./chunk-OFGHVREP.js";import"./chunk-U3ETEC6R.js";import"./chunk-FKKNYWR6.js";import{a as Ae}from"./chunk-26R336GJ.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-FIUHDVVO.js";import"./chunk-3HX6VT75.js";import{b as yt}from"./chunk-R7P6RQXJ.js";import{a as K}from"./chunk-4I7LQWUX.js";import"./chunk-JLNQ6WQT.js";import"./chunk-GB5RQL32.js";import"./chunk-R6S6A5GA.js";import"./chunk-4OZVVJHM.js";import{u as J,y as bt}from"./chunk-X7XJWAFC.js";import"./chunk-ILCAH2F6.js";import"./chunk-CYCLIMTY.js";import{a as ft}from"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-7X2HMUNN.js";import{d as _t}from"./chunk-LWJTIQQT.js";import"./chunk-IHBD2IWR.js";import"./chunk-NH3JQE75.js";import"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import"./chunk-HVNRUZWJ.js";import"./chunk-AYOI2Y26.js";import"./chunk-ZGDQY5ZD.js";import"./chunk-QH2MD2O2.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import"./chunk-7XLHE26H.js";import"./chunk-MBVOWLUI.js";import"./chunk-EN6CTWVM.js";import"./chunk-IRJNWXGT.js";import{a as et,b as tt}from"./chunk-LVPMJTA6.js";import{b as at,d as lt}from"./chunk-O4AQRVFI.js";import"./chunk-NDPAZKBG.js";import"./chunk-7AZ5UVCG.js";import"./chunk-6GGK7PRJ.js";import"./chunk-NNETCWLJ.js";import{E as rt,L as ot,N as ye,d as O,v as it,w as j,x as st,z as be}from"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-EBGO44EK.js";import{a as Ne}from"./chunk-THY6AAMN.js";import{a as ve}from"./chunk-7W6RATG7.js";import{b as Se,h as xe,i as mt,r as we,x as gt}from"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-XTES2GPX.js";import{a as dt,b as ht,e as Pe,n as ut,r as ct,s as pt,v as w}from"./chunk-2HUIJUS4.js";import{a as Ye,g as Xe,h as b}from"./chunk-MBJHSEMD.js";import"./chunk-K72LO6P2.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import{h as Ie}from"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import{a as Ze}from"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-LAJXTVEO.js";import"./chunk-5MNDZ6BX.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import{c as nt}from"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{a as L}from"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import{c as Ke}from"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import{a as je,c as Je}from"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as _}from"./chunk-GGZQ5GCM.js";import{U as D}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as m}from"./chunk-BMVJCP2M.js";import{a as Ue,l as fe,t as Ge,x as $e}from"./chunk-GMC3I5VG.js";import{b as ge,c as _e,e as Qe}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import{a as Be}from"./chunk-VEDIBGHD.js";import{r as $}from"./chunk-3IBUFXWY.js";import{B as He,M as me,u as pe}from"./chunk-BP73DJTS.js";import{a as ue,b as ce,g as x}from"./chunk-JEGVIFEP.js";var Z=class extends $t{constructor(t,i,s,r,o){super(t,i,-1,s,r),this.queue=o}},ee=class{constructor(t,i,s,r){this.loading=t,this.indexLoading=i,this.processing=s,this.idleProcessing=r}};var te=class extends Qt{constructor(t){super("PointCloudWorker","transform",{transform:i=>fi(i)},t)}};function fi(e){let t=[e.geometryBuffer];if(e.primaryAttributeData!=null&&e.primaryAttributeData.buffer&&t.push(e.primaryAttributeData.buffer),e.modulationAttributeData!=null&&e.modulationAttributeData.buffer&&t.push(e.modulationAttributeData.buffer),e.filterAttributesData!=null)for(let i of e.filterAttributesData)i!=null&&i.buffer&&t.push(i.buffer);for(let i of e.userAttributesData)i.buffer&&t.push(i.buffer);return t}function si(e,t,i){for(let r=0;r<t.length;r++)ke[r]=!1,I[r]=null;for(let r=0;r<e.length;r++)ze[r]=!1,A[r]=null;for(let r=0;r<t.length;r++){let o=ii(t[r],e,i);o>=0&&(ke[r]=!0,A[o]!=null?A[o].push(t[r]):A[o]=[t[r]])}for(let r=0;r<e.length;r++){let o=ii(e[r],t,i);o>=0&&(ze[r]=!0,I[o]!=null?I[o].push(e[r]):I[o]=[e[r]])}let s=[];for(let r=0;r<e.length;r++)A[r]!=null||ze[r]||s.push({load:[],remove:[e[r]]});for(let r=0;r<t.length;r++)I[r]!=null||ke[r]||s.push({load:[t[r]],remove:[]});for(let r=0;r<t.length;r++)I[r]!=null&&(I[r].length>1||I[r][0]!==t[r])&&s.push({load:[t[r]],remove:I[r]});for(let r=0;r<e.length;r++)A[r]!=null&&(A[r].length>1||A[r][0]!==e[r])&&s.push({load:A[r],remove:[e[r]]});return s}var ze=[!1],A=[null],ke=[!1],I=[null];function ii(e,t,i){let s=e;for(;s>0;){let r=t.indexOf(s);if(r>=0)return r;s=i.getParentId(s)}return t.indexOf(s)}function ri(e,t,i){return e.sort((s,r)=>{if(s.load.length===0&&r.load.length===0)return 0;if(s.load.length===0)return-1;if(r.load.length===0)return 1;if(s.remove.length===0&&r.remove.length===0){let o=i.getRenderObb(s.load[0]).center,n=i.getRenderObb(r.load[0]).center;return w(o,t)-w(n,t)}if(s.remove.length===0)return-1;if(r.remove.length===0)return 1;if(s.load.length===1&&r.load.length===1){let o=i.getRenderObb(s.load[0]).center,n=i.getRenderObb(r.load[0]).center;return w(o,t)-w(n,t)}if(s.load.length===1)return-1;if(r.load.length===1)return 1;{let o=i.getRenderObb(s.remove[0]).center,n=i.getRenderObb(r.remove[0]).center;return w(o,t)-w(n,t)}})}function oi(e,t,i){for(let s=0;s<e.length;++s){let r=e[s];r.load.length>t&&r.remove.length===1&&bi(e,r,i)}}function bi(e,t,i){let s=[t.remove[0]],r=[];for(;s.length===1;){let o=s.pop();r.length=0;for(let n=0;n<t.load.length;n++){let a=t.load[n],l=i.getParentId(a);for(;l!==o;)a=l,l=i.getParentId(a);let d=s.indexOf(a);d<0&&(d=s.length,s.push(a),r.push([])),r[d].push(t.load[n])}}t.load=s;for(let o=0;o<s.length;o++)r[o].length>1?e.push({remove:[s[o]],load:r[o]}):s[o]=r[o][0]}var ie=class{constructor(t,i,s){this._pages=[],this.pageSize=0,this._nodeSR=t,this._renderSR=i,this._renderSRSphericalPCPF=_t(i),this.pageSize=s}addPage(t,i,s=0){for(;this._pages.length<t;)this._pages.push(null);Pi(i,this._nodeSR,this._renderSR,s,this._renderSRSphericalPCPF),this._pages[t]={nodes:i,parents:new Uint32Array(this.pageSize)},Si(this._pages,this.pageSize)}hasPage(t){return!!this._pages[t]}getNode(t){let i=this.pageSize;return this._pages[N(t,i)].nodes[W(t,i)]}getRenderObb(t){let i=this.pageSize;return this._pages[N(t,i)].nodes[W(t,i)].obbInRenderSR}setRenderObb(t,i){let s=this.pageSize;this._pages[N(t,s)].nodes[W(t,s)].obbInRenderSR.copy(i)}getParentId(t){let i=this.pageSize;return this._pages[N(t,i)].parents[W(t,i)]}hasNodes(t,i){let s=N(t,this.pageSize),r=N(t+i-1,this.pageSize);for(let o=s;o<=r;o++)if(this._pages[o]==null)return!1;return!0}forEachNodeId(t){for(let i=0;i<this._pages.length;i++){let s=this._pages[i];if(s)for(let r=0;r<s.nodes.length;r++)t(i*this.pageSize+r)}}createVisibilityTraverse(){let t={index:this,queue:[],masks:[],tempAabb:O()};return(i,s)=>yi(t,i,s)}};function yi(e,t,i){let s=e.index;if(!s.hasNodes(0,1))return;let r=e.queue;r.length=0,r.push(0);let o=e.masks;for(o.length=0,o.push(0);r.length>0;){let n=r.pop(),a=o.pop(),l=s.getNode(n),d=s.getRenderObb(n),p=!0;if(t.clippingBox!=null){let h=1<<t.frustum.length;a&h||(d.toAaBoundingBox(e.tempAabb),j(t.clippingBox,e.tempAabb)?a|=h:st(t.clippingBox,e.tempAabb)||(p=!1))}for(let h=0;h<t.frustum.length&&p;h++){let c=1<<h;if(!(a&c)){let g=d.intersectPlane(t.frustum[h]);g>0?p=!1:g<0&&(a|=c)}}if(i.predicate(n,l,p)){let h=l.firstChild,c=l.childCount,g=!1,C=N(h,s.pageSize),z=N(h+c-1,s.pageSize);for(let y=C;y<=z;y++)if(!s.hasPage(y)){i.pageMiss(n,y),g=!0;break}if(!g)for(let y=0;y<c;y++)r.push(h+y),o.push(a)}}}function Pi(e,t,i,s,r){for(let o=0;o<e.length;o++){let n=e[o];n.obb.transform(n.obbInRenderSR,t,i,s,r)}}function Si(e,t){let i=[0];for(;i.length;){let s=i.pop(),r=e[N(s,t)].nodes[W(s,t)];for(let o=0;o<r.childCount;o++){let n=r.firstChild+o;e[N(n,t)]!=null&&(e[N(n,t)].parents[W(n,t)]=s,i.push(n))}}}function N(e,t){return e/t|0}function W(e,t){return e%t}function Ee(e){let t=e.renderer,i=t?.type,s=t?.toJSON()??null,r=null,o=!1,n=e.attributeStorageInfo;i==="point-cloud-unique-value"||i==="point-cloud-stretch"||i==="point-cloud-class-breaks"?r=q(n,t.field):i==="point-cloud-rgb"?(r=ni(n,t.field),o=r!=null):(r=ni(n,"RGB"),o=r!=null);let a=null;return t?.colorModulation&&(a=q(n,t.colorModulation.field)),{rendererJSON:s,isRGBRenderer:o,primaryAttribute:r,modulationAttribute:a}}function Oe(e){let t=e.filters;return t?t.map(i=>({filterJSON:i.toJSON(),attributeInfo:q(e.attributeStorageInfo,i.field)})):[]}function ai(e){let t=e?.pointSizeAlgorithm;return t&&t.type==="splat"?t:null}function Fe(e){let t=e?.pointSizeAlgorithm;return t&&t.type==="fixed-size"?t:null}function li(e){let t=e?.pointSizeAlgorithm;return!!t?.type&&t.type==="fixed-size"}function ni(e,t){for(let i of e??[])if(i.name===t&&i.attributeValues!=null&&i.attributeValues.valueType==="UInt8"&&i.attributeValues.valuesPerElement===3)return{name:t,storageInfo:i,useElevation:!1};return null}function q(e,t){for(let i of e??[])if(i.name===t){let s=i.encoding==="embedded-elevation";return s?{name:t,storageInfo:null,useElevation:s}:{name:t,storageInfo:i,useElevation:s}}return t?.toLowerCase()==="elevation"?{name:t,storageInfo:null,useElevation:!0}:null}var T=class extends ft{constructor(e){super(e),this.pointCloudMetadata=null}};m([_({constructOnly:!0,clonable:"reference"})],T.prototype,"pointCloudMetadata",void 0),T=m([D("esri.views.3d.layers.i3s.PointGraphic")],T);var se=class{constructor(t){this._context=t,this._highlights=new Set}get empty(){return this._highlights.size===0}destroy(){this._highlights=null}add(t,i){let s=new Ve(t,i);return this._highlights.add(s),this._enableSet(s),Ue(()=>this._removeSet(s))}_removeSet(t){this._disableSet(t),this._highlights.delete(t)}_enableSet(t){t.enabled||(t.enabled=!0,this._context.forEachNode(i=>this._enableSetForNode(t,i)))}_enableSetForNode(t,i){if(!t.enabled)return;let s=t.ids.get(i.id);s&&s.forEach(r=>this._context.addHighlight(i,r,t.id))}_disableSet(t){t.enabled&&(t.enabled=!1,this._context.forEachNode(i=>this._disableSetForNode(t,i)))}_disableSetForNode(t,i){t.enabled||this._context.removeHighlight(i,t.id)}nodeAdded(t){this._highlights.forEach(i=>this._enableSetForNode(i,t))}nodeRemoved(t){this._highlights.forEach(i=>this._disableSetForNode(i,t))}removeAll(){this._highlights.forEach(t=>this._disableSet(t))}},Ve=class{constructor(t,i){this.ids=new Map,this.enabled=!1;for(let s of t)s!=null&&this._add(s.nodeId,s.pointId);this.id=new qt(i)}_add(t,i){let s=this.ids.get(t);s?s.add(i):this.ids.set(t,new Set([i]))}};var re=class extends Dt{constructor(t,i,s){super(t,i,new Et(Zt,()=>import("./chunk-ZDQDP3SY.js")),s)}initializePipeline(t){return Vt({depthTest:{func:mt.LESS},depthWrite:Ot,colorWrite:Ft,stencilWrite:t.hasOccludees?Lt:null,stencilTest:t.hasOccludees?Mt:null,drawBuffers:t.output===F.Depth?{buffers:[gt.NONE]}:null})}};var R=class extends Wt{constructor(){super(...arguments),this.hasSlicePlane=!1,this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1,this.hasSliceInVertexProgram=!0}};m([M()],R.prototype,"hasSlicePlane",void 0),m([M()],R.prototype,"drawScreenSize",void 0),m([M()],R.prototype,"useFixedSizes",void 0),m([M()],R.prototype,"hasOccludees",void 0),m([M()],R.prototype,"clippingEnabled",void 0);var xi=new Map([["positions",[new Ne(ve.POSITION,3,xe.FLOAT,0,12)]],["colors",[new Ne(ve.COLOR,3,xe.UNSIGNED_BYTE,0,3,!0)]]]),B=class extends It{constructor(e){super(e),this.type=Ct.PCL,this.isGround=!1,this._passParameters=new Kt,this._highlights=new se({forEachNode:t=>this.forEachNode(t),addHighlight:(t,i,s)=>this._addHighlight(t,i,s),removeHighlight:(t,i)=>this._removeHighlight(t,i)}),this.produces=new Map([[X.OPAQUE_MATERIAL,t=>!(Y(t)||t===F.Highlight&&this._highlights.empty)],[X.OPAQUE_MATERIAL_WITHOUT_NORMALS,t=>Y(t)]]),this.layerUid="",this._slicePlaneEnabled=!1,this._configuration=new R,this._nodes=new Be}initializeRenderContext(e){this._context=e,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,i,s){let r=L(),o=L(),n=L(),a=L(),l=J(),d=e.camera.perScreenPixelRatio/2,p=e.camera.near;Pe(o,s,i);let h=1/dt(o);ut(o,o,h),pt(n,o),nt(l,o[0],o[1],o[2],-w(o,i));let c=new G,g=new G,C=new Array,z=O(),y=O(this._passParameters.clipBox);be(y,-i[0],-i[1],-i[2],y),this._nodes.forAll(u=>{let P=u.splatSize*this._passParameters.scaleFactor,S=u.obb.minimumDistancePlane(l),k=u.obb.maximumDistancePlane(l);S-=De(P,S+p,this._passParameters,d,u.isLeaf),k-=De(P,k+p,this._passParameters,d,u.isLeaf);let ci=k<0,pi=c.dist!=null&&g.dist!=null&&c.dist<S*h&&g.dist>k*h;if(ci||pi)return;let ae=Le(P,k+p,this._passParameters,d,u.isLeaf);if(!u.obb.intersectRay(i,o,ae))return;let mi=ae*ae;u.obb.toAaBoundingBox(z),be(z,-i[0],-i[1],-i[2],z);let gi=!j(y,z);Pe(a,u.origin,i);let _i=u.coordinates.length/3;for(let E=0;E<_i;E++){if(r[0]=a[0]+u.coordinates[3*E],r[1]=a[1]+u.coordinates[3*E+1],r[2]=a[2]+u.coordinates[3*E+2],gi&&!it(y,r))continue;let Q=w(r,o),qe=ct(r)-Q*Q;if(qe>mi)continue;let le=Q+p,de=De(P,le,this._passParameters,d,u.isLeaf);if(Q-de<0)continue;le-=de;let Te=Le(P,le,this._passParameters,d,u.isLeaf);if(qe>Te*Te)continue;let V=(Q-de)*h,he=v=>(v.point=wi(u,E,v.point),v.dist=V,v.normal=n,v.node=u,v.pointId=E,v.layerUid=this.layerUid,v);if((c.dist==null||V<c.dist)&&(t==null||t(i,s,V))&&he(c),e.options.store!==U.MIN&&(g.dist==null||V>g.dist)&&(t==null||t(i,s,V))&&he(g),e.options.store===U.ALL&&(t==null||t(i,s,V))){let v=new G;C.push(he(v))}}});let ne=u=>{let{layerUid:P,node:S,pointId:k}=u;return new Ht(u.point,P,k,()=>this.createGraphic(S,k,u.point))},H=(u,P)=>{let S=ne(P);u.set(this.type,S,P.dist,P.normal)};if(hi(c)){let u=e.results.min;(u.dist==null||c.dist<u.dist)&&H(u,c)}if(hi(g)&&e.options.store!==U.MIN){let u=e.results.max;(u.dist==null||g.dist>u.dist)&&H(u,g)}if(e.options.store===U.ALL){let u=wt(i,s);for(let P of C){let S=zt(u);H(S,P),e.results.all.push(S)}}}acquireTechniques(e){return this._nodes.length!==0&&(e.output===F.Color||Y(e.output)&&e.bind.slot===X.OPAQUE_MATERIAL_WITHOUT_NORMALS||e.output===F.Highlight)?(this._nodes.forAll(t=>this._initNode(e,t)),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=e.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.output=e.output,this._context.techniques.acquire(re,this._configuration)):null}render(e,t){let{rctx:i,bind:s,output:r}=e,o=i.bindTechnique(t,s,this._passParameters),n=r===F.Highlight;this._nodes.forAll(a=>{a.coordinates.length!==0&&(!n||a.highlights&&a.highlights.some(l=>s.highlightGroupName===l.id.highlightGroupName))&&(o.bindDraw(s,this._passParameters,a),i.bindVAO(a.vao),n?this._renderHighlightFragments(e,a):i.drawArrays(Se.POINTS,0,a.coordinates.length/3))})}_renderHighlightFragments(e,t){let{highlights:i}=t;if(i==null)return;let{rctx:s,bind:r}=e,{highlightGroupName:o}=r,n=0,a=i[0].componentIndex,l=a+1,d=()=>{for(;n<i.length&&i[n].id.highlightGroupName!==o;)a=i[n].componentIndex,++n;l=a+1};d();let p=(h,c)=>{let g=c-h;g>0&&s.drawArrays(Se.POINTS,h,g)};for(;n<i.length;){let h=i[n];if(h.id.highlightGroupName!==r.highlightGroupName){p(a,l),++n,d();continue}let c=h.componentIndex;c!==l&&(p(a,l),a=c),l=c+1,++n}p(a,l)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){rt(this._passParameters.clipBox,e||ye)}get _clippingEnabled(){return!ot(this._passParameters.clipBox,ye,(e,t)=>e===t)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let t=null;return this._nodes.filterInPlace(i=>i.id!==e||(t=i,i.vao=_e(i.vao),this._highlights.nodeRemoved(i),!1)),this._requestRender(),t}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll(e=>e.vao=_e(e.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e,t){return this._highlights.add(e,t)}_addHighlight(e,t,i){e.addHighlight(t,i),this._requestRender()}_removeHighlight(e,t){e.removeHighlight(t),this._requestRender()}_initNode(e,t){t.vao??=new kt(e.rctx,Rt,xi,new Map([["positions",Ae.createVertex(e.rctx,we.STATIC_DRAW,t.coordinates)],["colors",Ae.createVertex(e.rctx,we.STATIC_DRAW,t.rgb)]]))}_requestRender(){this._context&&this._context.requestRender()}};m([_({constructOnly:!0})],B.prototype,"createGraphic",void 0),B=m([D("esri.views.3d.layers.i3s.PointRenderer")],B);var oe=class extends Yt{constructor(t,i,s,r,o,n,a,l,d=null){super(s,o,i),this.id=t,this.obb=r,this.coordinates=n,this.rgb=a,this.attributes=l,this.pointIdFilterMap=d,this.highlights=null}addHighlight(t,i){let{highlights:s}=this;s==null&&(s=[],this.highlights=s);let r=new Me(t,i);s.push(r);let o=di(r);for(let n=s.length-1;n>0&&o<di(s[n-1]);--n)[s[n-1],s[n]]=[s[n],s[n-1]]}removeHighlight(t){let{highlights:i}=this;if(i==null)return;let s=i.filter(r=>r.id!==t);s.length===0&&(this.highlights=null),this.highlights=s}};function ui(e){return e.hasOwnProperty("splatSize")}function Le(e,t,i,s,r){if(i.drawScreenSpace)return i.fixedSize*t*s;let o=Xt(r)*t*s;return i.useFixedSizes?Math.min(i.fixedSize/2,o):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*s,e/2),o):Math.min(e/2,o)}function De(e,t,i,s,r){return i.drawScreenSpace?0:Le(e,t,i,s,r)}function wi(e,t,i){return i==null&&(i=L()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}function di(e){return e.componentIndex!=null?e.componentIndex:-1}var G=class{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}};function hi(e){return e.dist!=null&&e.point!=null&&e.pointId!=null&&e.node!=null}var Me=class{constructor(t,i){this.componentIndex=t,this.id=i}};var Ni=8,vi=J(),f=class extends ei(Gt(Bt)){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new at,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){return this.layer.parsedUrl?.path??""}get pointScale(){let e=ai(this.layer?.renderer);return e?.scaleFactor!=null?e.scaleFactor:1}get useRealWorldSymbolSizes(){let e=Fe(this.layer?.renderer);return e?.useRealWorldSymbolSizes!=null?e.useRealWorldSymbolSizes:!1}get pointSize(){let e=Fe(this.layer?.renderer);return e?.size!=null?e.size:0}get inverseDensity(){return this.layer?.renderer?1*96/this.layer.renderer.pointsPerInch:5}get availableFields(){let e=Ee(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.modulationAttribute.name);let i=Oe(this.layer);if(i)for(let s of i)s.attributeInfo&&t.add(s.attributeInfo.name);if(this.layer.outFields)for(let s of Ie(this.layer.fieldsIndex,this.layer.outFields))t.add(s);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;let e=O(),t=this.view.renderSpatialReference;return Jt(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){let e=this.layer&&this.layer.elevationInfo;return e&&e.mode==="absolute-height"?Tt(e,this.layer.spatialReference):0}initialize(){let e=this.view.resourceController,t=Ii(e);this._worker=new te(t),this.addResolvingPromise(this._worker.promise),vt(this.layer),At(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(Ce.I3S_INDEX),this._dataRequester=e.createStreamDataRequester(Ce.I3S_DATA),this._initRenderer();let i=this._initNodePages(),s=this.view.resourceController.memoryController;this._memCache=s.newCache(`pcl-${this.layer.uid}`),this._updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),b),this._updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),b),this._updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),b),this._updatingHandles.add(()=>this.layer.filters,()=>this._reload(),b),this._updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),b),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this._updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.addHandles([Ye(()=>this.view.quality,()=>this._setUpdateViewNeeded(),Xe)]),this.addResolvingPromise(i),this.when(()=>{this.addHandles([e.scheduler.registerTask(lt.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this._updatingHandles.add(()=>this.suspended,r=>{r?this._clearNodeState():this._setUpdateViewNeeded()},b)])},()=>{this._updatingHandles.removeAll(),this.removeAllHandles()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=ge(this._worker),this._destroyRenderer(),this._memCache=ge(this._memCache),this._codedDomainPopulationAbortController=Qe(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new B({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this._updatingHandles.add(()=>this._clippingBox,e=>this._renderer.clippingBox=e,b),this._updatingHandles.add(()=>this.suspended,e=>this._setPointsVisible(!e),b),this._updatingHandles.add(()=>this.pointScale,e=>this._renderer.scaleFactor=e,b),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add(()=>this.useRealWorldSymbolSizes,e=>this._renderer.useRealWorldSymbolSizes=e,b),this._updatingHandles.add(()=>this.pointSize,e=>{let t=Ze(e);this._renderer.size=e,this._renderer.sizePx=t},b),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._renderer.slicePlaneEnabled=e,b),this._updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),b),this._updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),b),this._updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,e=>{this._lodFactor=e,this._setUpdateViewNeeded()},b)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,i){let s=e.pointIdFilterMap!=null?e.pointIdFilterMap[t]:t,r=ti(this.view,i),o=this._createGraphicAttributes(e,s);return new T({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:r,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(e,t){let i={};for(let s of e.attributes)this._encodeGraphicAttribute(s.attributeInfo,s.values,t,i);return i}_encodeGraphicAttribute(e,t,i,s){let r=e.storageInfo?.attributeValues,o=r?.valuesPerElement??1;if(o===1)s[e.name]=t[i];else if(r?.valueType==="UInt8"&&o<=4){let n=0,a=i*o;for(let l=a;l<a+o;l++)n=(n<<8)+t[l];s[e.name]=n}else s[e.name]=void 0}_setPointsVisible(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=li(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(e){this._workQueue=si([...this._renderedNodes],e,this._index),ri(this._workQueue,this.view.state.contentCamera.viewForward,this._index),oi(this._workQueue,Ni,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){let e=new Array;this._loadingNodes.forEach(({abortController:t})=>e.push(t)),this._loadingNodes.clear();for(let t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){let e=new Set;this._workQueue.forEach(s=>s.load.forEach(r=>e.add(r)));let t=new Array,i=new Map;this._loadingNodes.forEach((s,r)=>{e.has(r)?i.set(r,s):t.push(s)}),this._loadingNodes=i;for(let{abortController:s}of t)s.abort();this._workQueue=this._workQueue.filter(s=>{for(let r of s.load)if(this._loadingNodes.has(r))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:e})=>e.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(e=>this._removeFromRenderer(e)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;let t=this._isRootNodeVisible();t!==this._layerIsVisible&&(this._layerIsVisible=t,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&e.run(()=>this._processIndexQueue()););this._processWorkQueue(e),this._idleQueue.runTask(e)}}_processIndexQueue(){let e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then(i=>{this._index.addPage(e,i,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(e)},()=>{this._indexPagesLoading.delete(e)}),!0}_processWorkQueue(e){for(;!e.done;){let t=this._scheduleWorkEntry();if(t==null)return void e.madeProgress();this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){let t=this._workQueue.shift();if(!t.remove.find(i=>!this._renderedNodes.has(i)))return t;this._workQueue.push(t)}return null}_processWorkEntry(e){if(e.load.length!==0)Promise.all(e.load.map(t=>{let i=new AbortController,s=this._memCache.pop(t.toString());return s!=null?this._loadingNodes.set(t,{abortController:i,promise:Promise.resolve(s)}):this._loadingNodes.has(t)||this._loadingNodes.set(t,{abortController:i,promise:this._loadNode(t,i.signal)}),this._loadingNodes.get(t).promise})).then(t=>{for(let i=0;i<e.load.length;i++)if(t[i]){let s=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(s)}for(let i of e.remove)this._removeFromRenderer(i)}).catch(()=>{}).then(()=>{for(let t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&this._indexQueue.length===0&&this._loadingNodes.size===0&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(let t of e.remove)this._removeFromRenderer(t)}_populateClassCodeCodedDomain(e,t){return x(this,null,function*(){let i="CLASS_CODE",s=this.layer.fieldsIndex.get(i);if(!s||s.domain||!e.includes(s.name))return;let r=yield Je(this.layer.queryCachedStatistics(i,{signal:t}));if(r.ok===!1)return;let o=r.value?.stats?.labels?.labels;o&&Array.isArray(o)&&(s.domain=new tt({name:"CLASS_CODE",codedValues:o.map(n=>new et({code:n.value,name:n.label}))}))})}prepareFetchPopupFeatures(e){return x(this,null,function*(){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then(()=>{this._codedDomainPopulationAbortController=null})),this._codedDomainPopulationPromise})}whenGraphicAttributes(e,t){return x(this,null,function*(){let i=this._splitGraphicsPerNode(e),s=this.layer.attributeStorageInfo,r=t.map(a=>q(s,a)).filter(pe),o=(a,l)=>x(this,null,function*(){let d=this._index.getNode(l);yield je(r,p=>x(this,null,function*(){let h=p.useElevation?yield this._loadElevationAttributeFromGeometry(d.resourceId):yield this._loadAndParseAttribute(d,p);if(h){for(let c of a)if(this._isValidPointGraphic(c)){let g=c.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(p,h,g,c.attributes)}}}))}),n=[];return i.forEach((a,l)=>{n.push(o(a,l))}),yield Promise.allSettled(n),e})}_isValidPointGraphic(e){return e instanceof T&&e.pointCloudMetadata?.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){let t=new Map;for(let i of e){if(!this._isValidPointGraphic(i))continue;let s=i.pointCloudMetadata,r=t.get(s.nodeId);r?r.push(i):t.set(s.nodeId,[i])}return t}_loadAndParseAttribute(e,t){return x(this,null,function*(){let i=yield this._loadAttribute(e.resourceId,t,null);return i!=null?St({attributeInfo:t,buffer:i},null,e.vertexCount):null})}_loadElevationAttributeFromGeometry(e){return x(this,null,function*(){let t=this.layer.store.defaultGeometrySchema,i=Pt(t,yield this._loadGeometry(e,null));return xt(i,i.length/3)})}highlight(e,t){if(!e)return Re;let i=Ke.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return i.length===0?Re:this._renderer.highlight(i.map(s=>this._graphicToPointDefinition(s)),t??Ut)}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;let{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return t!=null&&i!=null?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(let t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;let e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return Nt(this.layer.effectiveScaleRange,this.view.scale)}_initNodePages(){let e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;return this._index=new ie(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=e.nodesPerPage!=null?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then(i=>{this._index.addPage(0,i,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(e){let t=new AbortController,i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then(s=>s.nodes.map((r,o)=>({resourceId:r.resourceId!=null?r.resourceId:e*this._index.pageSize+o,obb:K.fromJSON(r.obb),obbInRenderSR:new K,firstChild:r.firstChild,childCount:r.childCount,vertexCount:r.vertexCount??r.pointCount,lodThreshold:r.lodThreshold??r.effectiveArea}))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;let e=this.view.quality,t=this.inverseDensity/this._lodFactor*e,i=this.maximumPointCount*this._lodFactor*e,s=this._computeNodesForMinimumDensity(t),r=this._computePointCount(s),o=Math.sqrt(r/(.75*i));for(;r>i;)t*=o,s=this._computeNodesForMinimumDensity(t),r=this._computePointCount(s),o=Math.sqrt(2);return this._displayNodes(s),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){let s=this._index.getNode(e[i]);s&&(t+=s.vertexCount)}return t}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,s)=>(e=s,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){let t=this.view.state.contentCamera,i=t.frustum,s=this._clippingBox,r=t.viewForward,o=w(r,t.eye),n=bt(r,-o,vi),a=t.perScreenPixelRatio/2,l=e*e,d=this._nodeIdArray;d.length=0;let p=h=>d.push(h);return this._traverseVisible({frustum:i,clippingBox:s},{predicate:(h,c,g)=>{if(!g)return!1;if(c.childCount===0)return p(h),!1;let C=this._index.getRenderObb(h);return!(this._computeAveragePixelArea(C,c.lodThreshold,c.vertexCount,n,a)<=l)||(p(h),!1)},pageMiss:(h,c)=>{p(h),this._indexQueue.includes(c)||this._indexQueue.push(c)}}),d}_computeAveragePixelArea(e,t,i,s,r){let n=Math.max(1e-7,e.minimumDistancePlane(s));return t/(n*n)/(4*r*r)/i}_loadNode(e,t){try{return this._loadNodeAsync(e,t)}catch(i){throw Ge(i)||$.getLogger(this).error(i),i}}_loadAdditionalUserAttributes(e,t,i){return x(this,null,function*(){let s=this.layer.outFields;if(!s)return[];let r=Ie(this.layer.fieldsIndex,s),o=new Set(e.map(d=>d!=null?d.name:null)),n=this.layer.attributeStorageInfo,a=[];for(let d of r){if(o.has(d))continue;let p=q(n,d);p&&a.push(t(p))}let l=yield $e(a);return fe(i),l.filter(pe)})}_loadNodeAsync(e,t){return x(this,null,function*(){let i=this._index.getNode(e),s=Ee(this.layer),r=Oe(this.layer),o=i.resourceId,n=a=>x(this,null,function*(){if(!a)return null;if(a.useElevation)return{attributeInfo:a,buffer:null};let l=yield this._loadAttribute(o,a,t);return l!=null?{attributeInfo:a,buffer:l}:null});return this._idleQueue.push(()=>x(this,null,function*(){let a=this._loadGeometry(o,t),{primaryAttribute:l,modulationAttribute:d}=s,p=n(l),h=n(d),c=r.map(S=>S.attributeInfo),g=c.map(S=>n(S)),C=this._loadAdditionalUserAttributes([l,d,...c],n,t),[z,y,ne,H,u]=yield Promise.all([a,p,h,Promise.all(g),C]);fe(t);let P={geometryBuffer:z,primaryAttributeData:y,modulationAttributeData:ne,filterAttributesData:H,userAttributesData:u,schema:this.layer.store.defaultGeometrySchema,rendererInfo:s,filterInfo:r,obbData:this._index.getRenderObb(e).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(P,t)}),t)})}_loadGeometry(e,t){return x(this,null,function*(){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)})}_loadAttribute(e,t,i){return x(this,null,function*(){if(!t?.storageInfo)return null;let s=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${s}`,i)})}_requestNodePage(e,t){let i=ce(ue({f:"json"},this.layer.customParameters),{token:this.layer.apiKey});return this._indexRequester.request(e,"json",{query:i,signal:t})}_requestData(e,t){return this._dataRequester.request(e,"binary",{query:ce(ue({},this.layer.customParameters),{token:this.layer.apiKey}),signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){let t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._memCache.put(t.id.toString(),t,Ai(t))}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){let i=this._index.getNode(e),s=Math.sqrt(i.lodThreshold/i.vertexCount),r=this._index.getRenderObb(e);if(ui(t))return t.splatSize=s,t.obb=r,ht(t.origin,t.obb.center),t;let o=K.fromData(t.obbData),n=o.halfSize,a=r.halfSize,l=.01*Math.max(a[0],a[1],a[2]);if(n[0]>a[0]+l||n[1]>a[1]+l||n[2]>a[2]+l){if(this._maxLoggedBoxWarnings>0){let d=p=>`[${p.halfSize[0]}, ${p.halfSize[1]}, ${p.halfSize[2]}]`;$.getLogger(this).warn(`Node ${e} reported bounding box too small. got ${d(r)} but points cover ${d(o)}`),--this._maxLoggedBoxWarnings==0&&$.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,o)}return new oe(e,s,yt(r.center),r,i.childCount===0,t.points,t.rgb,t.attributes,t.pointIdFilterMap)}get usedMemory(){let e=0;return this._renderer.forEachNode(t=>{e+=We,e+=me(t.coordinates);for(let i of t.attributes){let s=i.values;He(s.buffer)&&(e+=me(s))}}),e}get unloadedMemory(){let e=this._renderedNodes.size;if(e<4)return 0;let t=[...this._renderedNodes].reduce((s,r)=>s+this._index.getNode(r).vertexCount),i=this._loadingNodes.size;for(let s=0;s<this._workQueue.length;s++)i+=this._workQueue[s].load.length,i-=this._workQueue[s].remove.length;return i<0?0:i*t/e*((this.usedMemory-e*We)/t)+i*We}get performanceInfo(){return new Z(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce((e,t)=>e+this._index.getNode(t).vertexCount,0),this.maximumPointCount,new ee(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};m([_()],f.prototype,"layer",void 0),m([_()],f.prototype,"baseUrl",null),m([_()],f.prototype,"pointScale",null),m([_()],f.prototype,"useRealWorldSymbolSizes",null),m([_()],f.prototype,"pointSize",null),m([_()],f.prototype,"inverseDensity",null),m([_()],f.prototype,"maximumPointCount",void 0),m([_({readOnly:!0})],f.prototype,"availableFields",null),m([_({readOnly:!0})],f.prototype,"_clippingBox",null),m([_({readOnly:!0})],f.prototype,"_elevationOffset",null),m([_({type:Boolean})],f.prototype,"slicePlaneEnabled",void 0),m([_()],f.prototype,"updating",void 0),m([_(jt)],f.prototype,"updatingProgress",void 0),m([_({readOnly:!0})],f.prototype,"updatingProgressValue",null),m([_({readOnly:!0})],f.prototype,"visibleAtCurrentScale",null),f=m([D("esri.views.3d.layers.PointCloudLayerView3D")],f);var Er=f;function Ai(e){return 5*e.coordinates.length+128}var We=160;function Ii(e){return t=>e.immediate.schedule(t)}export{Er as default};
