import{a as rt}from"./chunk-XNAAMINV.js";import{d as st}from"./chunk-NPF6KTZO.js";import{e as at}from"./chunk-WNU76WNW.js";import{a as ot}from"./chunk-H4XRNT5U.js";import{c as ct}from"./chunk-WIJFCRLT.js";import{c as nt}from"./chunk-6ISQQD7M.js";import{a as ht}from"./chunk-6VHG3ZEH.js";import{a as N,b as Ie}from"./chunk-N3AGC3JB.js";import{a as dt}from"./chunk-KHTVZWEX.js";import{a as te}from"./chunk-S2HMCZNZ.js";import{h as lt}from"./chunk-MJXFSFCY.js";import{a as H}from"./chunk-6N46AY7Z.js";import{a as xe}from"./chunk-TCQTMUK4.js";import{a as U}from"./chunk-AY3YVZUY.js";import{a as z}from"./chunk-VMYCUJRH.js";import{a as C}from"./chunk-NPIYHDQ7.js";import{b as it}from"./chunk-7ISKCG7U.js";import{a as ee}from"./chunk-26R336GJ.js";import{h as Ze,i as Qe}from"./chunk-VTCODMOL.js";import{j as et,k as tt}from"./chunk-X7XJWAFC.js";import{a as Xe,d as Je,e as $e}from"./chunk-NH3JQE75.js";import{a as M}from"./chunk-XXOIKNT6.js";import{a as Ke}from"./chunk-DBLGLVAQ.js";import{d as Ue,e as Pe}from"./chunk-O4AQRVFI.js";import{F as Ve,l as _e,s as Ne,t as Be}from"./chunk-EPTSNNZF.js";import{a as Q}from"./chunk-4RLJMQW4.js";import{b as K}from"./chunk-J6ZRC6RI.js";import{a as p}from"./chunk-EBGO44EK.js";import{a as u}from"./chunk-7W6RATG7.js";import{r as Z}from"./chunk-BDF7KEUQ.js";import{c as R,f as Ye}from"./chunk-HWN5REN7.js";import{b as ke,c as ge,d as $,e as w,h as pe,k as je,l as qe,m as ye,p as F}from"./chunk-B4JAL745.js";import{a as Ge,b as fe}from"./chunk-XTES2GPX.js";import{c as We,e as J,v as me,y as V}from"./chunk-2HUIJUS4.js";import{g as He}from"./chunk-5MNDZ6BX.js";import{a as ze,c as D}from"./chunk-YRTBL7EE.js";import{a as v}from"./chunk-PYQRTZNZ.js";import{a as we}from"./chunk-VWF5VUO3.js";import{b as Fe}from"./chunk-5PTS4JDF.js";import{Q as x,S as De}from"./chunk-GGZQ5GCM.js";import{U as X,s as Oe}from"./chunk-TFUPB3ZG.js";import{a as I}from"./chunk-BMVJCP2M.js";import{l as q,n as Y}from"./chunk-GMC3I5VG.js";import{b as Me}from"./chunk-WGF2T2BG.js";import{t as ue}from"./chunk-3IBUFXWY.js";import{c as k,d as Ee,e as Ce,u as j}from"./chunk-BP73DJTS.js";import{g as W}from"./chunk-JEGVIFEP.js";function P(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}function _t(t){let{size:e}=t.definition,i=t.fontString(e),s=ut.get(i);if(!s){let r=P(Rt,0,0).getContext("2d");t.setFontProperties(r,e);let a=r.measureText(At);s=new Le(a.actualBoundingBoxAscent,a.actualBoundingBoxDescent),ut.set(i,s)}return s}var ut=new Map,Le=class{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,i){this.maxAscent=e,this.maxDescent=i}},Rt={canvas:null},At=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})();var se=1,ft=class{constructor(e,i,s,r){this.text=e,this._alignment=i,this._parameters=s,this._maxSize=r,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${e}--${this._parameters.key}-${this._alignment}`,this._lines=e.replaceAll(" ","\xA0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let i=0;i<this._lines.length-1;i++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){let e=P(mt,ie,ie).getContext("2d"),i=this._parameters.definition.pixelRatio,s=this._fontSize*i;this._parameters.setFontProperties(e,s);let r=2*this._haloSize,a=this._parameters.definition.font;a.style!=="italic"&&a.style!=="oblique"&&a.weight!=="bold"&&a.weight!=="bolder"||(r+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let n=0,h=0,o=0,l=0,d=0;this._lines.forEach((de,Re)=>{let B=e.measureText(de),Ae=B.width/i,ve=Ae+r;this._textWidths.push(Ae),this._lineWidths.push(ve),n=Math.max(n,ve),l=Math.max(l,B.actualBoundingBoxAscent/i),d=Math.max(d,B.actualBoundingBoxDescent/i),Re===0&&(h=B.actualBoundingBoxAscent/i),Re===this._lines.length-1&&(o=B.actualBoundingBoxDescent/i)});let c=_t(this._parameters),g=Math.max(l,c.maxAscent),m=Math.max(d,c.maxDescent),f=h,y=this._parameters.definition.font.decoration==="underline"?m:o,S=n;this._metricsCached=new Se(f,y,g,m,S)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*vt}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,se)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){let e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case E.Left:return this._horizontalPadding;case E.Center:return(this.displayWidth-this._lineWidths[e])/2;case E.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,i,s){e.save();let r=i/=this.renderPixelRatio,a=s/=this.renderPixelRatio,n=this._haloSize,h=this._firstLineYOffset+this._metrics.firstLineAscent;i+=n,s+=h;let o=this._haloSize>0;o&&this._renderHalo(e,r,a,n,h),this._parameters.setFontProperties(e,this._renderedFontSize);for(let l=0;l<this._lines.length;++l){let d=this._lines[l],c=this._getLineXOffset(l);o&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,d,i+c,s),this._renderLineDecoration(e,i+c,s,this._textWidths[l])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,d,i+this._getLineXOffset(l),s),this._renderLineDecoration(e,i+c,s,this._textWidths[l]),s+=this._lineSpacing}if(H.TEXT_SHOW_BASELINE){e.strokeStyle=gt,e.setLineDash([2,2]),e.lineWidth=1;let l=a+h;for(let d=0;d<this._lines.length;++d)this._drawLine(e,[r,l],[r+this.displayWidth,l]),l+=this._lineSpacing}if(H.TEXT_SHOW_BORDER&&(e.strokeStyle=gt,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[r,a],[this.displayWidth,this.displayHeight])),this._hasBackground){let l=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,r,a,l),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,i,s,r,a=!1){if(this._parameters.definition.font.decoration==="none"||r===0)return;let n=1,h=Math.max(this._parameters.definition.size/16,n);switch(this._parameters.definition.font.decoration){case"underline":s+=2*h;break;case"line-through":s-=.33*this._midLineAscent}let o=a?this._haloSize:0;e.strokeStyle=a?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(h+2*o),e.beginPath(),e.moveTo(this._toRenderUnit(i-o),this._toRenderUnit(s)),e.lineTo(this._toRenderUnit(i+r+o),this._toRenderUnit(s)),e.stroke()}_roundedRect(e,i,s,r){i=this._toRenderUnit(i),s=this._toRenderUnit(s);let a=this.renderedWidth,n=this.renderedHeight;r!==0?(r=Fe(r,0,Math.floor(n/2)),e.beginPath(),e.moveTo(i,s+r),e.arcTo(i,s,i+r,s,r),e.lineTo(i+a-r,s),e.arcTo(i+a,s,i+a,s+r,r),e.lineTo(i+a,s+n-r),e.arcTo(i+a,s+n,i+a-r,s+n,r),e.lineTo(i+r,s+n),e.arcTo(i,s+n,i,s+n-r,r),e.closePath()):e.rect(i,s,a,n)}_renderHalo(e,i,s,r,a){let n=this.renderedWidth,h=this.renderedHeight,o=P(mt,Math.max(n,ie),Math.max(h,ie)),l=o.getContext("2d");l.clearRect(0,0,n,h),this._parameters.setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;let d=this._renderedHaloSize<3;l.lineJoin=d?"miter":"round",d?this._renderHaloEmulated(l,r,a):this._renderHaloNative(l,r,a);let c=a;for(let g=0;g<this._lines.length;++g){let m=this._getLineXOffset(g);this._renderLineDecoration(l,r+m,c,this._textWidths[g],!0),c+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,n,h,this._toRenderUnit(i),this._toRenderUnit(s),n,h),e.globalAlpha=1}_renderHaloEmulated(e,i,s){for(let r=0;r<this._lines.length;++r){let a=this._lines[r],n=this._getLineXOffset(r);for(let[h,o]of pt)this._fillText(e,a,i+n+this._haloSize*h,s+this._haloSize*o);s+=this._lineSpacing}}_renderHaloNative(e,i,s){let r=2*this._haloSize;for(let a=0;a<this._lines.length;++a){let n=this._lines[a],h=this._getLineXOffset(a),o=5,l=.1;for(let d=0;d<o;d++){let c=1-(o-1)*l+d*l;e.lineWidth=this._toRenderUnit(c*r),this._strokeText(e,n,i+h,s)}s+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,i,s,r){e.fillText(i,this._toRenderUnit(s),this._toRenderUnit(r))}_strokeText(e,i,s,r){e.strokeText(i,this._toRenderUnit(s),this._toRenderUnit(r))}_drawLine(e,i,s){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.lineTo(this._toRoundedRenderUnit(s[0])+.5,this._toRoundedRenderUnit(s[1])+.5),e.stroke()}_drawBox(e,i,s){let r=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),n=this._toRenderUnit(s[0]),h=this._toRenderUnit(s[1]),o=Math.floor(r)+.5,l=Math.ceil(r+n)-.5,d=Math.floor(a)+.5,c=Math.ceil(a+h)-.5;e.beginPath(),e.moveTo(o,d),e.lineTo(l,d),e.lineTo(l,c),e.lineTo(o,c),e.lineTo(o,d),e.stroke()}},pt=[];for(let e=0;e<360;e+=360/16)pt.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var E;(function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"})(E||(E={}));var mt={canvas:null},vt=.2,ie=512,gt="rgb(255, 0, 255, 0.5)",Se=class{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,i,s,r,a){this.firstLineAscent=e,this.lastLineDescent=i,this.maxLineAscent=s,this.maxLineDescent=r,this.displayWidth=a}};var qt=Object.freeze({left:0,center:.5,right:1}),Yt=Object.freeze({"bottom-left":R(0,0),bottom:R(.5,0),"bottom-right":R(1,0),left:R(0,.5),center:R(.5,.5),right:R(1,.5),"top-left":R(0,1),top:R(.5,1),"top-right":R(1,1)});function Xt(t){switch(t){case"left":return E.Left;case"right":return E.Right;default:return E.Center}}function Jt(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function $t(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function Kt(t,e){switch(e){case"bottom":return t==="left"?"bottom-left":t==="right"?"bottom-right":"bottom";case"center":return t;case"top":return t==="left"?"top-left":t==="right"?"top-right":"top"}}function Zt(t){return t==="middle"?"center":t}function Qt(t,e){switch(t){case"top":return fe(e,0,se);case"bottom":return fe(e,0,-se);default:return Ge(e,Ye)}}var re=class{constructor(e,i,s){this._elementSize=i,this._buffer=ee.createVertex(e,Z.STATIC_DRAW),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,i,s,r=0){let a=new Uint8Array(this.array,e*this.elementSize,(i-e)*this.elementSize);new Uint8Array(s.array,r*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(e,i){let s=e*this._elementSize,r=i*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),s,s,r)}resize(e){let i=e*this._elementSize,s=new ArrayBuffer(i);this._array&&(e>=this._capacity?new Uint8Array(s).set(new Uint8Array(this._array)):new Uint8Array(s).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=s,this._buffer.setSize(i),this._capacity=e}};var Te=class{constructor(e){this.modelOriginHi=e.getField(u.INSTANCEMODELORIGINHI,ge),this.modelOriginLo=e.getField(u.INSTANCEMODELORIGINLO,ge),this.model=e.getField(u.INSTANCEMODEL,w),this.modelNormal=e.getField(u.INSTANCEMODELNORMAL,w),this.featureAttribute=e.getField(u.INSTANCEFEATUREATTRIBUTE,$),this.color=e.getField(u.INSTANCECOLOR,F),this.objectAndLayerIdColor=e.getField(u.INSTANCEOBJECTANDLAYERIDCOLOR,F)}},ae=class{constructor(e,i){this._rctx=e,this._instanceBufferLayout=i,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){let e=this._headIndex,i=this._tailIndex;return e>=i?e-i:e+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){p(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){p(this._updating,"not updating"),this.size<Ce*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){p(this._updating,"not updating"),this.isFull&&this._grow();let e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),p(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){p(this._updating,"not updating"),p(this.size>0,"invalid size");let e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){let e=Math.max(G,Math.floor(this._capacity*k));this._resize(e)}_shrink(){let e=Math.max(G,Math.floor(this._capacity*Ee));this._resize(e)}_resize(e){if(p(this._updating,"not updating"),e===this._capacity)return;let i=new re(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);let s=this.size,r=this._compactInstances(i);p(r===s,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=r,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=i,this._view=new Te(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){let i=this._headIndex,s=this._tailIndex;return s<i?(this._buffer.copyRange(s,i,e),i-s):s>i?(this._buffer.copyRange(s,this._capacity,e),i>0&&this._buffer.copyRange(0,i,e,this._capacity-s),i+(this._capacity-s)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,i){e<i?this._buffer.transferRange(e,i):e>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(e,this._capacity))}},G=64;var _;function Et(t){let e=K().mat4f64(u.LOCALTRANSFORM).mat4f64(u.GLOBALTRANSFORM).vec4f64(u.BOUNDINGSPHERE).vec3f64(u.MODELORIGIN).mat3f(u.INSTANCEMODEL).mat3f(u.INSTANCEMODELNORMAL).vec2f(u.MODELSCALEFACTORS);return t.includes(u.FEATUREATTRIBUTE)&&(e=e.vec4f(u.FEATUREATTRIBUTE)),t.includes(u.COLOR)&&(e=e.vec4u8(u.COLOR)),t.includes(u.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(u.OBJECTANDLAYERIDCOLOR)),e=e.u8(u.STATE).u8(u.LODLEVEL),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(_||(_={}));var ne=class{constructor(e){this.localTransform=e.getField(u.LOCALTRANSFORM,pe),this.globalTransform=e.getField(u.GLOBALTRANSFORM,pe),this.modelOrigin=e.getField(u.MODELORIGIN,je),this.model=e.getField(u.INSTANCEMODEL,w),this.modelNormal=e.getField(u.INSTANCEMODELNORMAL,w),this.modelScaleFactors=e.getField(u.MODELSCALEFACTORS,ke),this.boundingSphere=e.getField(u.BOUNDINGSPHERE,qe),this.featureAttribute=e.getField(u.FEATUREATTRIBUTE,$),this.color=e.getField(u.COLOR,F),this.objectAndLayerIdColor=e.getField(u.OBJECTANDLAYERIDCOLOR,F),this.state=e.getField(u.STATE,ye),this.lodLevel=e.getField(u.LODLEVEL,ye)}},O=class extends De{constructor(t,e){super(t),this.events=new we,this._capacity=0,this._size=0,this._next=0,this._highlightGroupMap=new Map,this._highlightGroupMapPrev=new Map,this._layout=Et(e),this._capacity=G,this._buffer=this._layout.createBuffer(this._capacity),this._view=new ne(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();let t=this._findSlot();return this._view.state.set(t,_.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){let e=this._view.state;p(t>=0&&t<this._capacity&&!!(e.get(t)&_.ALLOCATED),"invalid instance handle"),this._getStateFlag(t,_.ACTIVE)?this._setStateFlags(t,_.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){let e=this._view.state;p(t>=0&&t<this._capacity&&!!(e.get(t)&_.ALLOCATED),"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,i=!0){this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,i=!0){this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){let e=this._view,i=L,s=T;e.localTransform.getMat(t,yt),e.globalTransform.getMat(t,be);let r=He(be,be,yt);We(i,r[12],r[13],r[14]),e.modelOrigin.setVec(t,i),Xe(s,r),e.model.setMat(t,s);let a=tt(L,r);a.sort(),e.modelScaleFactors.set(t,0,a[1]),e.modelScaleFactors.set(t,1,a[2]),$e(s,s),Je(s,s),e.modelNormal.setMat(t,s),this._setStateFlags(t,_.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){let i=this._view;i.model.getMat(t,T),i.modelOrigin.getVec(t,L),e[0]=T[0],e[1]=T[1],e[2]=T[2],e[3]=0,e[4]=T[3],e[5]=T[4],e[6]=T[5],e[7]=0,e[8]=T[6],e[9]=T[7],e[10]=T[8],e[11]=0,e[12]=L[0],e[13]=L[1],e[14]=L[2],e[15]=1}applyShaderTransformation(t,e){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(L,this,t),e*=Math.max(L[0],L[1],L[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(L,this,t),e*=Ct(L[0],L[1],L[2])),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,_.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,_.VISIBLE)}setHighlight(t,e,i){let s=this._highlightGroupMap.get(t);e?(s||(s=new Set,this._highlightGroupMap.set(t,s)),s.add(i)&&(this._setStateFlag(t,_.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed"))):s?.delete(i)&&(s.size===0&&(this._highlightGroupMap.delete(t),this._setStateFlag(t,_.HIGHLIGHT,!1)),this.events.emit("instance-highlight-changed"))}getHighlight(t){return this._getStateFlag(t,_.HIGHLIGHT)}foreachHighlightGroupPrev(t,e){this._highlightGroupMapPrev.get(t)?.forEach(e),this._highlightGroupMapPrev.delete(t)}foreachHighlightGroup(t,e){let i=this._highlightGroupMap.get(t);i?.forEach(e),i?this._highlightGroupMapPrev.set(t,new Set(i)):this._highlightGroupMapPrev.delete(t)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let i=0;i<this._capacity;++i)this.getState(i)&t&&++e;return e}_setStateFlags(t,e){let i=this._view.state;e=i.get(t)|e,i.set(t,e)}_clearStateFlags(t,e){let i=this._view.state;e=i.get(t)&~e,i.set(t,e)}_setStateFlag(t,e,i){i?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(G,Math.floor(this._capacity*k)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new ne(this._buffer)}_findSlot(){let t=this._view.state,e=this._next;for(;t.get(e)&_.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};function Ct(t,e,i){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),i))}I([x({constructOnly:!0})],O.prototype,"shaderTransformation",void 0),I([x()],O.prototype,"_size",void 0),I([x({readOnly:!0})],O.prototype,"size",null),O=I([X("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],O);var L=v(),T=Ke(),yt=M(),be=M();var oe=class extends z{constructor(e,i){super(s=>this._instanceData.view.boundingSphere.getVec(s,this._tmpSphere),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=i,this._tmpSphere=it(),this._tmpMat4=M()}addInstance(e){let i=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);V(this._tmpSphere,this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*et(s),i.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}};var he=class{constructor(e,i){this._worldSpaceRadius=e,this._minScreenSpaceRadii=i}selectLevel(e,i,s){let r=s.computeScreenPixelSizeAt(e),a=this._worldSpaceRadius*i/r,n=0;for(let h=1;h<this._minScreenSpaceRadii.length;++h)a>=this._minScreenSpaceRadii[h]&&(n=h);return n}};function Mt(t,e,i,s=null){let r=t.createBufferWriter(),a=r.vertexBufferLayout,n=r.elementCount(e),h=a.createBuffer(n);return r.write(null,null,e,s,h,0),{material:t,vertexBufferLayout:a,buffer:h.buffer,elementCount:n,boundingInfo:i}}var le=class{constructor(e,i){let s=e.renderContext.rctx,r=i.geometry,a=null;a=r instanceof xe?Mt(r.material,r.attributes,r.boundingInfo):r;let n=a.material;this._materials=e.materials,n.setParameters({instancedDoublePrecision:!0}),this.geometry=r,this.material=n,this.glMaterials=new rt(n,this._materials),this.vertexBufferLayout=a.vertexBufferLayout,this.vbo=ee.createVertex(s,Z.STATIC_DRAW,a.buffer),this.vao=new ot(s,U,new Map([["geometry",Q(a.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=a.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,i,s,r,a,n,h,o){if(!(this.geometry instanceof xe))return;let l=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,s,r,(d,c,g,m,f)=>{if(d>=0){if(i!=null&&!i(e.rayBegin,e.rayEnd,d))return;let y=new ht(n.layerUid,n.graphicUid(a),l,g,h,o);if((e.results.min.drapedLayerOrder==null||f>=e.results.min.drapedLayerOrder)&&(e.results.min.dist==null||d<e.results.min.dist)&&e.results.min.set(N.LOD,y,d,c,e.transform.transform,f),e.options.store!==Ie.MIN&&(e.results.max.drapedLayerOrder==null||f>=e.results.max.drapedLayerOrder)&&(e.results.max.dist==null||d>e.results.max.dist)&&e.results.max.set(N.LOD,y,d,c,e.transform.transform,f),e.options.store===Ie.ALL){let S=nt(e.results.min.ray);S.set(N.LOD,y,d,c,e.transform.transform,f),e.results.all.push(S)}}})}};var ce=class t{static create(e,i,s){return W(this,null,function*(){let r=yield Promise.allSettled(i.components.map(n=>e.controller.schedule(()=>new le(e,n),s))),a=r.map(n=>n.status==="fulfilled"?n.value:null).filter(j);if(Y(s)||a.length!==r.length){a.forEach(n=>n.destroy()),q(s);for(let n of r)if(n.status==="rejected")throw n.reason}return new t(i.minScreenSpaceRadius,a)})}constructor(e,i){this.minScreenSpaceRadius=e,this.components=i}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,i,s,r,a,n,h){this.components.forEach(o=>o.intersect(e,i,s,r,a,n,this.boundingSphere,h))}get boundingBox(){if(this._boundingBox==null){let e=Ve();this.components.forEach(i=>{i.boundingInfo!=null&&(_e(e,i.boundingInfo.bbMin),_e(e,i.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){let e=this.boundingBox,i=v();Be(e,i),this._boundingSphere={center:i,radius:.5*Ne(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,i)=>e+i.triangleCount,0)}};var Ot=t=>{let e=t.baseBoundingSphere.radius,i=t.levels.map(s=>s.minScreenSpaceRadius);return new he(e,i)},b=class extends st{constructor(t,e){super(t),this.type=N.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new at,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[te.OPAQUE_MATERIAL,i=>this._produces(i)],[te.TRANSPARENT_MATERIAL,i=>!!this._hasTransparentLevels()&&this._produces(i)]]),this._instanceData=new O({shaderTransformation:t.shaderTransformation},t.optionalFields),this.addHandles(e.registerTask(Ue.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=wt(this.optionalFields),this._glInstanceBufferLayout=Q(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){let t=[this._defaultRenderInstanceData];for(let e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this.baseMaterial.hasEmissions}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((i,s)=>i+s.usedMemory,t),0)}get renderStats(){let t=this._instanceData.size,e=[];return this._levels.forEach((i,s)=>{let r=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,a=i.triangleCount;e.push({renderedInstances:r,renderedTriangles:r*a,trianglesPerInstance:a})}),{totalInstances:t,renderedInstances:e.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:e.reduce((i,s)=>i+s.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(t=[]){let{rctx:e}=this._context.renderContext;return this.symbol.levels.map(i=>{t.push(new ae(e,this._instanceBufferLayout))}),t}initializeRenderContext(t,e){return W(this,null,function*(){this._context=t,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);let i=yield Promise.allSettled(this.symbol.levels.map(r=>ce.create(t,r,e))),s=i.map(r=>r.status==="fulfilled"?r.value:null).filter(j);if(Y(e)||s.length!==i.length){s.forEach(r=>r.destroy()),q(e);for(let r of i)if(r.status==="rejected")throw r.reason}this._levels=s,this._levelSelector=Ot(this)})}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDataMap.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>e.material.produces.get(te.TRANSPARENT_MATERIAL)?.(C.Color)))}hasHighlights(){return Oe(this._highlightRenderInstanceDataMap,t=>t.some(e=>e.size>0))}_produces(t){return t!==C.Highlight&&t!==C.ShadowHighlight||this.hasHighlights()}prepareRender(t){if(!H.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){let e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Pe),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;let e=this._getInstanceDatas(t);if(!e)return null;let i=new Array,s=this.levels;return e.forEach(r=>s.forEach(({components:a},n)=>a.forEach(h=>i.push(this._beginComponent(t,r[n],h))))),i}render(t,e){let i=this._getInstanceDatas(t);if(!i||e==null)return;let s=0;t.rctx.bindVAO();let r=this.levels;i.forEach(a=>r.forEach(({components:n},h)=>n.forEach(o=>this._renderComponent(t,e[s++],a[h],o,h))))}_getInstanceDatas(t){let{output:e,bind:i}=t,s=e===C.Highlight,r=!s&&e!==C.ShadowHighlight,a=e!==C.ShadowExcludeHighlight;if(r)return a?this._allRenderInstanceData:[this._defaultRenderInstanceData];if(a){if(s){let{highlightGroupName:h}=i;if(!h)return null;let o=this._highlightRenderInstanceDataMap.get(h);return o?[o]:null}let n=[];for(let h of this._highlightRenderInstanceDataMap)n.push(h[1]);return n}return null}intersect(t,e,i,s){if(!this.baseMaterial.visible||this._octree==null)return;let r=v();J(r,s,i);let a=n=>{this._instanceData.getCombinedModelTransform(n,Lt),t.transform.set(Lt),V(St,i,t.transform.inverse),V(Tt,s,t.transform.inverse);let h=this._instanceData.getState(n),o=this._instanceData.getLodLevel(n),l=this._levels.length;p(!!(h&_.ACTIVE),"invalid instance state"),p(o>=0&&o<l,"invaid lod level"),this._levels[o].intersect(t,e,St,Tt,n,this.metadata,l)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(i,r,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){let t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new oe(t,this.baseBoundingSphere);for(let i=0;i<t.capacity;++i)e.get(i)&_.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Me(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return{near:1/0,far:-1/0};let e=t.viewForward,i=this._octree.findClosest(e,z.DepthOrder.FRONT_TO_BACK,t.frustum),s=this._octree.findClosest(e,z.DepthOrder.BACK_TO_FRONT,t.frustum);if(i==null||s==null)return{near:1/0,far:-1/0};let r=t.eye,a=this._instanceData.view;a.boundingSphere.getVec(i,A),J(A,A,r);let n=me(A,e)-A[3];a.boundingSphere.getVec(s,A),J(A,A,r);let h=me(A,e)+A[3];return{near:Math.max(t.near,n),far:Math.min(t.far,h)}}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){let{_enableLevelSelection:e,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.beginUpdate()));let r=this._instanceData,a=r.view,n=r.size,h=r.capacity,o=this._instanceIndex,l=Math.ceil(h/500);for(let d=0;d<n&&!t.done;++d){o===this._cycleStartIndex&&this._startUpdateCycle();let c=a.state.get(o),g=0;if(!(c&_.ALLOCATED)){o=o+1===h?0:o+1,n++;continue}let m=a.lodLevel.get(o);if(c&_.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail(),c&_.HIGHLIGHT_ACTIVE&&r.foreachHighlightGroupPrev(o,f=>{let y=this._highlightRenderInstanceDataMap.get(f);if(!y)throw new ue("Internal error in lodRenderer");y[m].freeTail()}),c&_.REMOVE)r.freeInstance(o);else if(c&_.VISIBLE){let f=0;e&&(a.modelOrigin.getVec(o,xt),f=s.selectLevel(xt,r.getCombinedMedianScaleFactor(o),i)),g=c&~(_.ACTIVE|_.TRANSFORM_CHANGED),f>=0&&(c&_.HIGHLIGHT?(r.foreachHighlightGroup(o,y=>{let S=this._highlightRenderInstanceDataMap.get(y);if(S||(S=this._createRenderInstanceDataArray(),S.forEach(de=>de.beginUpdate()),this._highlightRenderInstanceDataMap.set(y,S)),f>=S.length)throw new ue(`LodRenderer internal error - missing lodLevel ${f}`);It(S[f],a,o)}),g|=_.HIGHLIGHT_ACTIVE):(It(this._defaultRenderInstanceData[f],a,o),g|=_.DEFAULT_ACTIVE)),a.state.set(o,g),a.lodLevel.set(o,f)}else g=c&~(_.ACTIVE|_.TRANSFORM_CHANGED),a.state.set(o,g);if(this._octreeCached!=null){let f=!!(c&_.ACTIVE),y=!!(g&_.ACTIVE);!f&&y?this._octreeCached.addInstance(o):f&&!y?this._octreeCached.removeInstance(o):f&&y&&c&_.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(o),this._octreeCached.addInstance(o))}o=o+1===h?0:o+1,o%l==0&&t.madeProgress()}this._instanceIndex=o,this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,i){return e.size===0?null:i.glMaterials.load(t.rctx,t.bind.slot,t.output)?.beginSlot(t.bind)}_renderComponent(t,e,i,s,r){if(!e)return;let{bind:a,rctx:n}=t;n.runAppleAmdDriverHelper();let h=n.bindTechnique(e,a,s.material.parameters,Ft);n.bindVAO(s.vao),e.ensureAttributeLocations(s.vao),H.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===C.Color&&(h.setUniform4fv("externalColor",bt[Math.min(r,bt.length-1)]),h.setUniform1i("colorMixMode",lt.replace));let o=i.capacity,l=i.headIndex,d=i.tailIndex,c=i.firstIndex,g=this._glInstanceBufferLayout,m=(f,y)=>{Ze(n,U,i.buffer,g,f),n.drawArraysInstanced(e.primitiveType,0,s.vertexCount,y-f),Qe(n,U,i.buffer,g)};s.material.parameters.transparent&&c!=null?l>d?(p(c>=d&&c<=l,"invalid firstIndex"),m(c,l),m(d,c)):l<d&&(c<=l?(p(c>=0&&c<=l,"invalid firstIndex"),m(c,l),m(d,o),m(0,c)):(p(c>=d&&c<=o,"invalid firstIndex"),m(c,o),m(0,l),m(d,c))):l>d?m(d,l):l<d&&(m(0,l),m(d,o)),n.bindVAO(null)}};function It(t,e,i){let s=t.allocateHead();Dt(e,i,t.view,s)}function Dt(t,e,i,s){ct(t.modelOrigin,e,i.modelOriginHi,i.modelOriginLo,s),i.model.copyFrom(s,t.model,e),i.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&i.color&&i.color.copyFrom(s,t.color,e),t.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(s,t.objectAndLayerIdColor,e),t.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(s,t.featureAttribute,e)}function wt(t){let e=K().vec3f(u.INSTANCEMODELORIGINHI).vec3f(u.INSTANCEMODELORIGINLO).mat3f(u.INSTANCEMODEL).mat3f(u.INSTANCEMODELNORMAL);return t!=null&&t.includes("featureAttribute")&&(e=e.vec4f(u.INSTANCEFEATUREATTRIBUTE)),t!=null&&t.includes("color")&&(e=e.vec4u8(u.INSTANCECOLOR)),t!=null&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(u.INSTANCEOBJECTANDLAYERIDCOLOR)),e}I([x({constructOnly:!0})],b.prototype,"symbol",void 0),I([x({constructOnly:!0})],b.prototype,"optionalFields",void 0),I([x({constructOnly:!0})],b.prototype,"metadata",void 0),I([x({constructOnly:!0})],b.prototype,"shaderTransformation",void 0),I([x()],b.prototype,"_instanceData",void 0),I([x()],b.prototype,"_cycleStartIndex",void 0),I([x({readOnly:!0})],b.prototype,"_enableLevelSelection",null),I([x()],b.prototype,"_updateCyclesWithStaticCamera",void 0),I([x({readOnly:!0})],b.prototype,"running",null),b=I([X("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],b);var xt=v(),A=ze(),Lt=M(),St=v(),Tt=v(),bt=[D(1,0,1,1),D(0,0,1,1),D(0,1,0,1),D(1,1,0,1),D(1,0,0,1)],Ft=new dt;export{P as a,_t as b,se as c,ft as d,qt as e,Yt as f,Xt as g,Jt as h,$t as i,Kt as j,Zt as k,Qt as l,b as m};
