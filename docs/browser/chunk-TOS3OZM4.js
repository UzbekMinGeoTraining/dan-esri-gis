import{a as x}from"./chunk-I5AI5WEQ.js";import{a as V}from"./chunk-D4SBRLEM.js";import{b as O}from"./chunk-4FRQLB6H.js";import"./chunk-6VWB6ZLL.js";import"./chunk-TOUCHIYC.js";import{d as _}from"./chunk-AB4CTIUZ.js";import"./chunk-2HYJESCC.js";import"./chunk-VJX4SEWU.js";import"./chunk-OZ5LGYCJ.js";import{a as I}from"./chunk-6GII4ES2.js";import"./chunk-5BLGZI6B.js";import"./chunk-NR6RKORG.js";import"./chunk-TOCNTYZ2.js";import"./chunk-7ZBDS6BA.js";import"./chunk-F7R3VTP4.js";import"./chunk-MNU4KXU7.js";import"./chunk-AJSXTGZB.js";import"./chunk-3KFX3FFC.js";import"./chunk-2WNCPIJC.js";import{h as E}from"./chunk-7ISKCG7U.js";import"./chunk-OFGHVREP.js";import"./chunk-FKKNYWR6.js";import"./chunk-FIUHDVVO.js";import"./chunk-3HX6VT75.js";import"./chunk-25T3ULWN.js";import"./chunk-X7XJWAFC.js";import"./chunk-CYCLIMTY.js";import"./chunk-NH3JQE75.js";import"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import"./chunk-HVNRUZWJ.js";import{a as L}from"./chunk-AYOI2Y26.js";import"./chunk-ZGDQY5ZD.js";import"./chunk-QH2MD2O2.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import"./chunk-7XLHE26H.js";import"./chunk-EN6CTWVM.js";import"./chunk-LVPMJTA6.js";import"./chunk-6GGK7PRJ.js";import"./chunk-NNETCWLJ.js";import"./chunk-TWW3KW7Z.js";import"./chunk-7KH77MT4.js";import"./chunk-I6LCIPDY.js";import"./chunk-Y6H3NTW7.js";import"./chunk-4RLJMQW4.js";import"./chunk-J6ZRC6RI.js";import"./chunk-EBGO44EK.js";import"./chunk-THY6AAMN.js";import"./chunk-7W6RATG7.js";import"./chunk-45SNVLPM.js";import"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-B4JAL745.js";import"./chunk-XTES2GPX.js";import"./chunk-2HUIJUS4.js";import"./chunk-MBJHSEMD.js";import"./chunk-2R4SNL6O.js";import"./chunk-TSNWBMBA.js";import"./chunk-OFZ6SV37.js";import"./chunk-5MNDZ6BX.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{a as S}from"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as i,S as u}from"./chunk-GGZQ5GCM.js";import{U as l}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as o}from"./chunk-BMVJCP2M.js";import{f,l as H,n as C}from"./chunk-GMC3I5VG.js";import{d as b,e as k}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import"./chunk-3IBUFXWY.js";import{u as v}from"./chunk-BP73DJTS.js";import{g as s}from"./chunk-JEGVIFEP.js";var c=class extends u{constructor(e){super(e),this.availability=0,this._ids=new Set}destroy(){this._workerHandle.destroy(),this._workerHandle=null}initialize(){this._workerHandle=new w(this.schedule,{fetchAllEdgeLocations:(e,r)=>this._fetchAllEdgeLocations(e,r)})}fetchCandidates(e,r){return s(this,null,function*(){let t=e.coordinateHelper,{point:a}=e,n=A;this.renderCoordsHelper.toRenderCoords(a,t.spatialReference,n);let m=e.distance,p=typeof m=="number"?m:m.distance,y=yield this._workerHandle.invoke({bounds:E(n[0],n[1],n[2],p),returnEdge:e.returnEdge,returnVertex:e.vertexMode!=="none"},r);return y.candidates.sort((g,W)=>g.distance-W.distance),y.candidates.map(g=>this._convertCandidate(t,g))})}add(e,r){return s(this,null,function*(){this._ids.add(e.id),yield this._workerHandle.invokeMethod("add",e,r)})}remove(e,r){return s(this,null,function*(){this._ids.delete(e.id),yield this._workerHandle.invokeMethod("remove",e,r)})}_convertCandidate(e,r){switch(r.type){case"edge":return new O({objectId:r.objectId,targetPoint:_(this._convertRenderCoordinate(e,r.target)),edgeStart:this._convertRenderCoordinate(e,r.start),edgeEnd:this._convertRenderCoordinate(e,r.end),isDraped:!1});case"vertex":return new V({objectId:r.objectId,targetPoint:_(this._convertRenderCoordinate(e,r.target)),isDraped:!1})}}_convertRenderCoordinate({spatialReference:e},r){let t=S();return this.renderCoordsHelper.fromRenderCoords(r,t,e),t}_fetchAllEdgeLocations(e,r){return s(this,null,function*(){let t=[],a=[];for(let{id:n,uid:m}of e.components)this._ids.has(n)&&t.push(s(this,null,function*(){let p=yield this.fetchEdgeLocations(n,r.signal),y=p.locations.buffer;return a.push(y),{id:n,uid:m,objectIds:p.objectIds,locations:y,origin:p.origin,type:p.type}}));return{result:{components:(yield Promise.all(t)).filter(({id:n})=>this._ids.has(n))},transferList:a}})}};o([i({constructOnly:!0})],c.prototype,"renderCoordsHelper",void 0),o([i({constructOnly:!0})],c.prototype,"fetchEdgeLocations",void 0),o([i({constructOnly:!0})],c.prototype,"schedule",void 0),o([i({readOnly:!0})],c.prototype,"availability",void 0),c=o([l("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorkerHandle")],c);var w=class extends I{constructor(r,t){super("SceneLayerSnappingSourceWorker","fetchCandidates",{},r,{strategy:"dedicated",client:t})}},A=S();var d=class extends u{get updating(){return this._updatingHandles.updating}constructor(e){super(e),this.availability=1,this._updatingHandles=new L,this._abortController=new AbortController}destroy(){this._tracker=b(this._tracker),this._abortController=k(this._abortController),this._updatingHandles.destroy()}initialize(){let{view:e}=this,r=e.resourceController;this._edgeWorker=new x(R(r)),this._workerHandle=new c({renderCoordsHelper:this.view.renderCoordsHelper,schedule:R(r),fetchEdgeLocations:(t,a)=>s(this,null,function*(){if(this._tracker==null)throw new Error("tracker-not-initialized");return this._tracker.fetchEdgeLocations(t,this._edgeWorker,a)})}),this._updatingHandles.addPromise(this._setupLayerView()),this.addHandles([f(this._workerHandle),f(this._edgeWorker)])}fetchCandidates(e,r){return s(this,null,function*(){return this._workerHandle.fetchCandidates(e,r)})}refresh(){}_setupLayerView(){return s(this,null,function*(){if(this.destroyed)return;let e=this._abortController?.signal,r=yield this.getLayerView();r==null||C(e)||(this._tracker=r.trackSnappingSources({add:(t,a)=>{this._updatingHandles.addPromise(this._workerHandle.add({id:t,bounds:a},e))},remove:t=>{this._updatingHandles.addPromise(this._workerHandle.remove({id:t},e))}}))})}};function R(e){return r=>e.immediate.schedule(r)}o([i({constructOnly:!0})],d.prototype,"getLayerView",void 0),o([i({constructOnly:!0})],d.prototype,"view",void 0),o([i({readOnly:!0})],d.prototype,"updating",null),o([i({readOnly:!0})],d.prototype,"availability",void 0),d=o([l("esri.views.interactive.snapping.featureSources.I3SSnappingSource")],d);var h=class extends u{get updating(){return this._i3sSources.some(e=>e.updating)}constructor(e){super(e),this.availability=1,this._i3sSources=[]}destroy(){this._i3sSources.forEach(e=>e.destroy()),this._i3sSources.length=0}initialize(){let{view:e}=this,r=this.layerSource.layer;this._i3sSources=r.type==="building-scene"?this._getBuildingSceneI3SSources(e,r):[this._getSceneLayerI3SSource(e,r)]}fetchCandidates(e,r){return s(this,null,function*(){let t=yield Promise.all(this._i3sSources.map(a=>a.fetchCandidates(e,r)));return H(r),t.flat()})}refresh(){this._i3sSources.forEach(e=>e.refresh())}_getBuildingSceneI3SSources(e,r){return r.allSublayers.toArray().map(t=>t.type==="building-component"?new d({getLayerView:()=>s(this,null,function*(){return(yield e.whenLayerView(r)).whenSublayerView(t)}),view:e}):null).filter(v)}_getSceneLayerI3SSource(e,r){return new d({getLayerView:()=>s(this,null,function*(){let t=yield e.whenLayerView(r);return t.type==="scene-layer-graphics-3d"?void 0:t}),view:e})}};o([i({constructOnly:!0})],h.prototype,"layerSource",void 0),o([i({constructOnly:!0})],h.prototype,"view",void 0),o([i({readOnly:!0})],h.prototype,"updating",null),o([i({readOnly:!0})],h.prototype,"availability",void 0),h=o([l("esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource")],h);export{h as SceneLayerSnappingSource};
