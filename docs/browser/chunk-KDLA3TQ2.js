import{c as J,d as Q}from"./chunk-RPMDOAYZ.js";import{a as $}from"./chunk-3PK63SMD.js";import{a as j,b as q}from"./chunk-TCQTMUK4.js";import{b as W,d as c}from"./chunk-OC7V2CEX.js";import{j as z}from"./chunk-VTCODMOL.js";import{h as A}from"./chunk-4OZVVJHM.js";import{a as k}from"./chunk-EBGO44EK.js";import{k as d,l as G,n as u,z as m}from"./chunk-BDF7KEUQ.js";import{a as X}from"./chunk-VWF5VUO3.js";import{b as K}from"./chunk-IZVEJCCI.js";import{i as O}from"./chunk-TEY6TKJV.js";import{A as b,z as S}from"./chunk-4M6XQSBA.js";import{k as V,l as w,q as v}from"./chunk-GMC3I5VG.js";import{c as H,d as L}from"./chunk-WGF2T2BG.js";import{r as N,t as U}from"./chunk-3IBUFXWY.js";import{B as R,D as C}from"./chunk-BP73DJTS.js";import{a as I,g as h}from"./chunk-JEGVIFEP.js";function Z(){return Y??=h(this,null,function*(){let e=yield import("./chunk-6DCNXEAI.js"),t=yield e.default({locateFile:r=>K(`esri/libs/basisu/${r}`)});return t.initializeBasis(),t}),Y}var Y;var T;(function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"})(T||(T={}));var _=null,M=null;function tt(){return h(this,null,function*(){return M==null&&(M=Z(),_=yield M),M})}function et(e,t){if(_==null)return e.byteLength;let r=new _.BasisFile(new Uint8Array(e)),a=st(r)?at(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),a}function rt(e,t){if(_==null)return e.byteLength;let r=new _.KTX2File(new Uint8Array(e)),a=it(r)?at(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),a}function at(e,t,r,a,s){let i=z(t?m.COMPRESSED_RGBA8_ETC2_EAC:m.COMPRESSED_RGB8_ETC2),o=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*a*i*o)}function st(e){return e.getNumImages()>=1&&!e.isUASTC()}function it(e){return e.getFaces()>=1&&e.isETC1S()}function ot(e,t,r){return h(this,null,function*(){_==null&&(_=yield tt());let a=new _.BasisFile(new Uint8Array(r));if(!st(a))return null;a.startTranscoding();let s=lt(e,t,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(i,o)=>a.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>a.transcodeImage(n,0,i,o,0,0));return a.close(),a.delete(),s})}function nt(e,t,r){return h(this,null,function*(){_==null&&(_=yield tt());let a=new _.KTX2File(new Uint8Array(r));if(!it(a))return null;a.startTranscoding();let s=lt(e,t,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(i,o)=>a.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>a.transcodeImage(n,i,0,0,o,0,-1,-1));return a.close(),a.delete(),s})}function lt(e,t,r,a,s,i,o,n){let{compressedTextureETC:l,compressedTextureS3TC:f}=e.capabilities,[E,x]=l?a?[T.ETC2_RGBA,m.COMPRESSED_RGBA8_ETC2_EAC]:[T.ETC1_RGB,m.COMPRESSED_RGB8_ETC2]:f?a?[T.BC3_RGBA,m.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[T.BC1_RGB,m.COMPRESSED_RGB_S3TC_DXT1_EXT]:[T.RGBA32,u.RGBA],B=t.hasMipmap?r:Math.min(1,r),g=[];for(let p=0;p<B;p++)g.push(new Uint8Array(o(p,E))),n(p,E,g[p]);return t.internalFormat=x,t.hasMipmap=g.length>1,t.samplingMode=t.hasMipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,t.width=s,t.height=i,new c(e,t,{type:"compressed",levels:g})}var y=()=>N.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),dt=542327876,pt=131072,ut=4;function F(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function ct(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}var Tt=F("DXT1"),gt=F("DXT3"),At=F("DXT5"),Et=31,Rt=0,Ct=1,ft=2,Bt=3,Dt=4,xt=7,Gt=20,Mt=21;function mt(e,t,r){let a=yt(r,t.hasMipmap??!1);if(a==null)throw new Error("DDS texture data is null");let{textureData:s,internalFormat:i,width:o,height:n}=a;return t.samplingMode=s.levels.length>1?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=i,t.width=o,t.height=n,new c(e,t,s)}function yt(e,t){let r=new Int32Array(e.buffer,e.byteOffset,Et);if(r[Rt]!==dt)return y().error("Invalid magic number in DDS header"),null;if(!(r[Gt]&ut))return y().error("Unsupported format, must contain a FourCC code"),null;let a=r[Mt],s,i;switch(a){case Tt:s=8,i=m.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case gt:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case At:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return y().error("Unsupported FourCC code:",ct(a)),null}let o=1,n=r[Dt],l=r[Bt];(3&n||3&l)&&(y().warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,l=l+3&-4);let f=n,E=l,x,B;r[ft]&pt&&t!==!1&&(o=Math.max(1,r[xt]));let g=e.byteOffset+r[Ct]+4,p=[];for(let P=0;P<o;++P)B=(n+3>>2)*(l+3>>2)*s,x=new Uint8Array(e.buffer,g,B),p.push(x),g+=B,n=Math.max(1,n>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:p},internalFormat:i,width:f,height:E}}var _t=class extends j{get parameters(){return this._parameters}constructor(t,r){super(),this._data=t,this.type=q.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new X,this._parameters=I(I({},wt),r),this._startPreload(t)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(t){t!=null&&(t instanceof HTMLVideoElement?(this.frameUpdate=r=>this._frameUpdate(t,r),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){if(!(S(t.src)||t.preload==="auto"&&t.crossOrigin)){t.preload="auto",t.crossOrigin="anonymous";let r=!t.paused;if(t.src=t.src,r&&t.autoplay){let a=()=>{t.removeEventListener("canplay",a),t.play()};t.addEventListener("canplay",a)}}}_startPreloadImageElement(t){b(t.src)||S(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){let r=new W;return r.wrapMode=this._parameters.wrap??G.REPEAT,r.flipped=!this._parameters.noUnpackFlip,r.samplingMode=this._parameters.mipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,r.hasMipmap=!!this._parameters.mipmap,r.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,r.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),r}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||It(this._data,this._parameters)}load(t){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let r=this._data;return r==null?(this._glTexture=new c(t,this._createDescriptor(t),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof r=="string"?this._loadFromURL(t,r):r instanceof Image?this._loadFromImageElement(t,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(t,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(t,r):C(r)&&this._parameters.encoding===A.DDS_ENCODING?this._loadFromDDSData(t,r):R(r)&&this._parameters.encoding===A.DDS_ENCODING?this._loadFromDDSData(t,new Uint8Array(r)):(R(r)||C(r))&&this._parameters.encoding===A.KTX2_ENCODING?this._loadFromKTX2(t,r):(R(r)||C(r))&&this._parameters.encoding===A.BASIS_ENCODING?this._loadFromBasis(t,r):C(r)?this._loadFromPixelData(t,r):R(r)?this._loadFromPixelData(t,new Uint8Array(r)):null)}_frameUpdate(t,r){return this._glTexture==null||t.readyState<D.HAVE_CURRENT_DATA||r===t.currentTime?r:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,r){return this._glTexture=mt(t,this._createDescriptor(t),r),this._glTexture}_loadFromKTX2(t,r){return this._loadAsync(()=>nt(t,this._createDescriptor(t),r).then(a=>(this._glTexture=a,a)))}_loadFromBasis(t,r){return this._loadAsync(()=>ot(t,this._createDescriptor(t),r).then(a=>(this._glTexture=a,a)))}_loadFromPixelData(t,r){k(this._parameters.width>0&&this._parameters.height>0);let a=this._createDescriptor(t);return a.pixelFormat=this._parameters.components===1?u.LUMINANCE:this._parameters.components===3?u.RGB:u.RGBA,a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._glTexture=new c(t,a,r),this._glTexture}_loadFromURL(t,r){return this._loadAsync(a=>h(this,null,function*(){let s=yield $(r,{signal:a});return w(a),this._loadFromImage(t,s)}))}_loadFromImageElement(t,r){return r.complete?this._loadFromImage(t,r):this._loadAsync(a=>h(this,null,function*(){let s=yield O(r,r.src,!1,a);return w(a),this._loadFromImage(t,s)}))}_loadFromVideoElement(t,r){return r.readyState>=D.HAVE_CURRENT_DATA?this._loadFromImage(t,r):this._loadFromVideoElementAsync(t,r)}_loadFromVideoElementAsync(t,r){return this._loadAsync(a=>new Promise((s,i)=>{let o=()=>{r.removeEventListener("loadeddata",n),r.removeEventListener("error",l),L(f)},n=()=>{r.readyState>=D.HAVE_CURRENT_DATA&&(o(),s(this._loadFromImage(t,r)))},l=E=>{o(),i(E||new U("Failed to load video"))};r.addEventListener("loadeddata",n),r.addEventListener("error",l);let f=v(a,()=>l(V()))}))}_loadFromImage(t,r){let a=r;if(!(a instanceof HTMLVideoElement)){let{maxTextureSize:o}=t.parameters;a=this._parameters.downsampleUncompressed?J(a,o):Q(a,o)}let s=ht(a);this._parameters.width=s.width,this._parameters.height=s.height;let i=this._createDescriptor(t);return i.pixelFormat=this._parameters.components===3?u.RGB:u.RGBA,i.width=s.width,i.height=s.height,this._glTexture=new c(t,i,a),this._glTexture}_loadAsync(t){let r=new AbortController;this._loadingController=r;let a=t(r.signal);this._loadingPromise=a;let s=()=>{this._loadingController===r&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null)};return a.then(s,s),a}unload(){if(this._glTexture=H(this._glTexture),this._loadingController!=null){let t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}};function It(e,t){if(e==null)return 0;if(R(e)||C(e))return t.encoding===A.KTX2_ENCODING?rt(e,!!t.mipmap):t.encoding===A.BASIS_ENCODING?et(e,!!t.mipmap):e.byteLength;let{width:r,height:a}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?ht(e):t;return(t.mipmap?4/3:1)*r*a*(t.components||4)||0}function ht(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}var D;(function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(D||(D={}));var wt={wrap:{s:G.REPEAT,t:G.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1};export{tt as a,_t as b};
