import{a as N,b as $,c as K,d as k,e as Re,f as ue,g as _e,h as Ae,i as A,j as pe,k as ve,l as Se,m as Ge,n as Pe,o as Fe,p as He,q as Ue,r as Be,u as ze,v as z}from"./chunk-AKAFLY54.js";import"./chunk-EIHMNF7R.js";import{l as Oe}from"./chunk-XHUVNHST.js";import"./chunk-MCSHFXJF.js";import"./chunk-XH4ROB5J.js";import"./chunk-BEXNUKSP.js";import"./chunk-7I5SNEJE.js";import"./chunk-Z7HQSEFF.js";import"./chunk-NPSROKUX.js";import"./chunk-RI2HJFLU.js";import"./chunk-7YHK56KB.js";import"./chunk-PHK5IJNU.js";import"./chunk-OH475TQV.js";import"./chunk-S2YELA2I.js";import"./chunk-KAOR3JAH.js";import"./chunk-ACVF7Z7X.js";import"./chunk-LCRAHT7B.js";import"./chunk-QMGVGOIN.js";import"./chunk-M7Q5ICON.js";import"./chunk-DSHXH3B4.js";import"./chunk-2LC7VTRT.js";import"./chunk-A2IYJOJO.js";import"./chunk-EFOMVUIX.js";import"./chunk-42DKYLC7.js";import"./chunk-LB3WSIYI.js";import"./chunk-B7ZDEOLU.js";import"./chunk-22JBWFHY.js";import"./chunk-6YHOGO6F.js";import"./chunk-VY6QN6EN.js";import"./chunk-VZPIZOOE.js";import"./chunk-R7X3CKFH.js";import"./chunk-64FW22PO.js";import"./chunk-3EB3OCOV.js";import"./chunk-7Z3Y27UA.js";import"./chunk-3A66AUSD.js";import"./chunk-UUKQEAQR.js";import"./chunk-6UUMJQNV.js";import"./chunk-GNKF5TIB.js";import{c as Ee}from"./chunk-X4XHTJSF.js";import"./chunk-YIBWVOPM.js";import"./chunk-PY5WUUCV.js";import{a as Ie}from"./chunk-R3XRMWAK.js";import{a as xe}from"./chunk-PL6CVK2A.js";import"./chunk-J2R7NR2E.js";import"./chunk-VPH54J3G.js";import{a as Ne}from"./chunk-OD6TX477.js";import{a as We}from"./chunk-ISUG5L3D.js";import"./chunk-FKKNYWR6.js";import"./chunk-M4PATAW3.js";import"./chunk-BNQ5VRNF.js";import"./chunk-NOFXYDQS.js";import"./chunk-4BLMEKFL.js";import"./chunk-RPIA54UY.js";import"./chunk-WRN6YTSB.js";import"./chunk-BQ7BWYEG.js";import"./chunk-CA2IXN6Q.js";import"./chunk-AXPRNSO3.js";import"./chunk-FIUHDVVO.js";import"./chunk-3HX6VT75.js";import"./chunk-U4Y7WABQ.js";import"./chunk-WYOOSF42.js";import"./chunk-R6S6A5GA.js";import"./chunk-25T3ULWN.js";import"./chunk-C3YONAAM.js";import"./chunk-2GSAHDXY.js";import"./chunk-OL24FY3J.js";import"./chunk-QBRYULPI.js";import"./chunk-GPQLPPA5.js";import"./chunk-OXRGERMH.js";import"./chunk-LHH3AZP2.js";import"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-63EK7JRZ.js";import"./chunk-HVNRUZWJ.js";import"./chunk-ZGDQY5ZD.js";import"./chunk-QH2MD2O2.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import"./chunk-7XLHE26H.js";import"./chunk-EN6CTWVM.js";import"./chunk-IRJNWXGT.js";import"./chunk-LVPMJTA6.js";import"./chunk-7NYR66Q3.js";import"./chunk-WDFAQFJ4.js";import"./chunk-7LUQF6AI.js";import"./chunk-O4AQRVFI.js";import"./chunk-NDPAZKBG.js";import"./chunk-7AZ5UVCG.js";import"./chunk-6GGK7PRJ.js";import"./chunk-G3PA3VVF.js";import"./chunk-AO7UDTUI.js";import"./chunk-Q7O5PY54.js";import"./chunk-PFIMJ2UL.js";import"./chunk-CY477QBZ.js";import"./chunk-EJO53FLN.js";import"./chunk-XXR5OT24.js";import"./chunk-4XIZVPNF.js";import"./chunk-F7VAE37R.js";import{m as B}from"./chunk-PM4ZR7W6.js";import"./chunk-ENLR2WBX.js";import"./chunk-RI3FIROF.js";import{a as De}from"./chunk-PJX4LNSV.js";import"./chunk-NNETCWLJ.js";import"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-VDNXTMSC.js";import{a as ke,g as Te}from"./chunk-MBJHSEMD.js";import"./chunk-K72LO6P2.js";import"./chunk-R7Q3STHM.js";import"./chunk-G4PDP3HY.js";import"./chunk-EKU2FJZS.js";import"./chunk-NHN544WL.js";import"./chunk-WZ5A3YGX.js";import"./chunk-NKMODNM6.js";import"./chunk-SEKMXZL5.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-LAJXTVEO.js";import"./chunk-5MNDZ6BX.js";import"./chunk-RDHMB7M5.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import{p as de}from"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import{c as Q}from"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-EUZMXXZJ.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import{l as X,y as he}from"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as b,m as re}from"./chunk-GGZQ5GCM.js";import{U as be,u as le}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as M}from"./chunk-BMVJCP2M.js";import{l as we}from"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{r as R,t as j}from"./chunk-3IBUFXWY.js";import"./chunk-BP73DJTS.js";import{a as se,g as T}from"./chunk-JEGVIFEP.js";var V;(function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absoluteValue"})(V||(V={}));var C=class extends xe(Ee(Ie(Ne(We)))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(Q.ofType(z)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new he({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(Q.ofType(z)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e?.inclusionModeDefinition,e?.dataPreloadedInLocalCache&&!e?.inclusionModeDefinition)throw new j("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles(ke(()=>this.layers.concat(this.tables),(t,i)=>this._handleSublayersChange(t,i),Te))}normalizeCtorArgs(e){if(!e)return{};let{url:t,title:i,dataPreloadedInLocalCache:n,defaultLinkChartConfig:a}=e;return{url:t,title:i,dataPreloadedInLocalCache:n,defaultLinkChartConfig:a}}_initializeLayerProperties(e){if(!this.title&&this.url){let r=this.url.split("/");this.title=r[r.length-2]}let t=new Set,i=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new j("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((r,h)=>{let y=this._graphTypeLookup.get(h);if(!y)return R.getLogger(this).warn(`A named type, ${h}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(h);y.type==="relationship"?t.has(h)||(t.add(h),n.push(y)):y.type==="entity"?t.has(h)||(t.add(h),i.push(y)):(R.getLogger(this).warn(`A named type, ${h}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(h))}):(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);let a=new ze({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=n,this.dataManager=a}load(e){let t=()=>T(this,null,function*(){let i=[],n=[];this.loadLayerAssumingLocalCache(),yield ue(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(a=>{a.useAllData=!1}),yield this._initializeDiagram(),this.layers.forEach(a=>{n.push(a.refreshCachedQueryEngine()),i.push(new Promise(r=>{a.on("layerview-create",()=>{r(null)})}))}),this.tables.forEach(a=>{n.push(a.refreshCachedQueryEngine())}),yield Promise.all(n)});return this.addResolvingPromise(new Promise(i=>{Oe(this.url).then(n=>T(this,null,function*(){if(this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(a.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(a.name,{useAllData:!0})})),this.dataPreloadedInLocalCache){let a=_e.getInstance();for(let[r,h]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(let y of h.members?.values()??[]){let f=a.readFromStoreById(`${r}__${y.id}`);f&&le(this.dataManager.sublayerCaches,r,()=>new Map).set(y.id,f)}yield t()}else{let a=this.defaultLinkChartConfig?.layoutMode==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,a,!0).then(()=>T(this,null,function*(){we(e),yield t()})))}i(null)}))})),Promise.resolve(this)}set inclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("inclusionModeDefinition",e):R.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}addRecords(e,t){return T(this,null,function*(){let i=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=yield Be(e,this.dataManager.knowledgeGraph));let n=e.concat(i).filter(a=>!this.sublayerIdsCache.get(a.typeName)?.has(a.id));yield this._handleNewRecords(n)})}removeRecords(n){return T(this,arguments,function*(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let a=[];for(let h of e)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(h.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(h.typeName)?.members?.has(h.id)&&a.push(h);if(t){let h=new Set,y=[];for(let f of a)if(this.dataManager.nodeConnectionsLookup.has(f.id))for(let m of this.dataManager.nodeConnectionsLookup.get(f.id))h.add(m);for(let f of h)if(this.dataManager.memberIdTypeLookup.has(f))for(let m of this.dataManager.memberIdTypeLookup.get(f))this.dataManager.relationshipTypeNames.has(m)&&y.push({id:f,typeName:m});a=a.concat(y)}this.dataManager.removeFromLayer(a);for(let h of a)this.sublayerIdsCache.get(h.typeName)?.delete(h.id),this.dataManager.relationshipTypeNames.has(h.typeName)?this.relationshipLinkChartDiagramLookup.delete(h.id):this.entityLinkChartDiagramLookup.delete(h.id);i&&(yield this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,this._currentLinkChartConfig.layoutOptions));let r=[];return this.layers.forEach(h=>{r.push(h.refreshCachedQueryEngine())}),yield Promise.all(r),this._refreshNamedTypes(),a})}expand(e,t){return T(this,null,function*(){let i=yield this.dataManager.getConnectedRecordIds(e,t),n=i.filter(a=>!this.sublayerIdsCache.get(a.typeName)?.has(a.id));return yield this._handleNewRecords(i),{records:n}})}loadLayerAssumingLocalCache(){let e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.originIdOf("layers")===re.DEFAULTS?this._createSublayers(e,this.layers,t=>!!t.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===re.DEFAULTS?this._createSublayers(e,this.tables,t=>!t.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,i)=>{let n=le(this.sublayerIdsCache,i,()=>new Set);t.members?.forEach(({id:a,linkChartLocation:r})=>{if(n.add(a),r){let h=r instanceof De?r:B(r);this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(a,h):this.entityLinkChartDiagramLookup.set(a,h)}})})}calculateLinkChartLayout(e="RADIAL_TREE",t){return T(this,null,function*(){let i=[],n=[],a=[];this.dataManager.sublayerCaches.forEach((o,l)=>{this.dataManager.entityTypeNames.has(l)?o.forEach(s=>{i.push({typeName:l,feature:s})}):this.dataManager.relationshipTypeNames.has(l)&&o.forEach(s=>{n.push({typeName:l,feature:s})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;let r=new Map,h=new Map,y=new Map,f=new Map,m=new Uint8Array(i.length),c=new Float64Array(i.length),g=new Float64Array(i.length),L=new Float64Array(i.length),ye=new Float64Array(i.length),Z=new Uint32Array(n.length),ee=new Uint32Array(n.length),ce=new Float64Array(n.length),ge=new Float64Array(n.length),p=[],je="FORCE_DIRECTED",x=new he({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),F,me="FORCE_DIRECTED",u=0,E=0,Qe=Ue.apply;switch(me=e==="GEOGRAPHIC"?je:e,me){case"FORCE_DIRECTED":F=ve.apply;break;case"COMMUNITY":F=Se.apply;break;case"HIERARCHICAL":F=Pe.apply;break;case"RADIAL_TREE":F=Fe.apply;break;case"SMART_TREE":F=He.apply;break;default:F=Ge.apply}let te=!1;i.forEach(({typeName:o,feature:l})=>{if(e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"&&t?.lockedNodeLocations?.has(l.attributes[N])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(o)?m[u]=A.IsGeographic:m[u]=A.None;let s=t.lockedNodeLocations.get(l.attributes[N]);c[u]=s.x,g[u]=s.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(o)){m[u]=A.IsGeographic;let s=null,D=l.attributes[this.dataManager.geographicLookup.get(o).name];switch(this.dataManager.geographicLookup.get(o)?.geometryType){case"esriGeometryPoint":c[u]=D?.x,g[u]=D?.y;break;case"esriGeometryPolygon":s=D?.centroid,s?.x!=null&&s?.y!=null?(c[u]=s.x,g[u]=s.y):m[u]=A.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":s=D?.extent?.center,s?.x!=null&&s?.y!=null?(c[u]=s.x,g[u]=s.y):m[u]=A.IsMovable;break;default:m[u]=A.IsMovable}(c[u]==null||g[u]==null||Number.isNaN(c[u])||Number.isNaN(g[u]))&&(m[u]=A.IsMovable,c[u]=0,g[u]=0)}else if(e==="CHRONOLOGICAL_SINGLE"||e==="CHRONOLOGICAL_MULTIPLE"){!te&&t?.lockedNodeLocations?.has(l.attributes[N])&&(te=!0);let s=t?.timeInfoByTypeName?.get(o),D=s?.startField,v=D&&s?.startField?l.attributes[D]:null;L[u]=v?new Date(v).getTime():NaN;let w=s?.endField,O=w&&s?.endField?l.attributes[w]:null;ye[u]=O?new Date(O).getTime():NaN,c[u]=0,g[u]=0,m[u]=A.IsMovable}else m[u]=A.IsMovable,c[u]=0,g[u]=0;f.set(l.attributes[N],u),p[u]={feature:l,typeName:o},u++}),te&&R.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let fe=!1,ae=new Map;n.forEach(o=>{let l=o.feature.attributes[$],s=o.feature.attributes[K],D=f.get(l),v=f.get(s),w=t?.timeInfoByTypeName?.get(o.typeName),O=t?.timeInfoByTypeName?w?.startField:null,S=O?o.feature.attributes[O]:null,J=w?.endField,H=J?o.feature.attributes[J]:null;if(D!==void 0&&v!==void 0){let G=l+"-"+s;e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"||(G=G+"-"+S+"-"+H);let W=ae.get(G);W?.has(o.typeName)||(Z[E]=D,ee[E]=v,e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"||(ce[E]=S?new Date(S).getTime():NaN,ge[E]=H?new Date(H).getTime():NaN),W===void 0?ae.set(G,new Map([[o.typeName,E]])):W.set(o.typeName,E),E++),a.push(o)}else fe=!0,this.relationshipLinkChartDiagramLookup.set(l,null)}),fe&&R.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");let Le=this._validateLayoutSettings(e,t),ie=this._convertLayoutSettingsToCalculationSettings(Le);yield Ae();let Y=!1,I=null;if(e==="CHRONOLOGICAL_SINGLE"||e==="CHRONOLOGICAL_MULTIPLE"){let o;({success:Y,links:I,graphics:o}=Qe(m,c,g,L,ye,Z.subarray(0,E),ee.subarray(0,E),ce.subarray(0,E),ge.subarray(0,E),e==="CHRONOLOGICAL_MULTIPLE",t?.chronologicalLayoutSettings??{})),Y&&(this.chronologicalAuxiliaryGraphics=o)}else({success:Y,links:I}=F(m,c,g,Z.subarray(0,E),ee.subarray(0,E),ie.computationBudgetTime,ie.idealEdgeLengthMultiplier,ie.repulsionRadiusMultiplier));if(!Y)throw new j("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let o=0;o<p.length;o++){if(g[o]>84.9999?g[o]=84.9999:g[o]<-84.9999&&(g[o]=-84.9999),c[o]>179.9999?c[o]=179.9999:c[o]<-179.9999&&(c[o]=-179.9999),p[o].feature.attributes[k]=new X(c[o],g[o]),r.has(p[o].typeName))r.get(p[o].typeName)?.set(p[o].feature.attributes[N],p[o].feature);else{let s=new Map;s.set(p[o].feature.attributes[N],p[o].feature),r.set(p[o].typeName,s)}y.set(p[o].feature.attributes[N],p[o].feature);let l=B(p[o].feature.attributes[k]);this.entityLinkChartDiagramLookup.set(p[o].feature.attributes[N],p[o].feature.attributes[k]?l:null),p[o].feature.attributes[k].x<x.xmin&&(x.xmin=p[o].feature.attributes[k].x),p[o].feature.attributes[k].x>x.xmax&&(x.xmax=p[o].feature.attributes[k].x),p[o].feature.attributes[k].y<x.ymin&&(x.ymin=p[o].feature.attributes[k].y),p[o].feature.attributes[k].y>x.ymax&&(x.ymax=p[o].feature.attributes[k].y)}if(this.linkChartExtent.xmin=x.xmin,this.linkChartExtent.xmax=x.xmax,this.linkChartExtent.ymin=x.ymin,this.linkChartExtent.ymax=x.ymax,!I)throw new j("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");let q=new Map,ne=new Map,oe=new Map,Ce=new Set;for(let o=0;o<a.length;o++){let l=[],s=a[o],D=s.feature.attributes[$],v=s.feature.attributes[K],w=D+"-"+v;if(e==="CHRONOLOGICAL_SINGLE"||e==="CHRONOLOGICAL_MULTIPLE"){let d=t?.timeInfoByTypeName?.get(s.typeName),_=t?.timeInfoByTypeName?d?.startField:null,P=_?s.feature.attributes[_]:null,U=d?.endField;w+="-"+P+"-"+(U?s.feature.attributes[U]:null)}let O=ae.get(w).get(s.typeName),S=O===0?0:I?.vertexEndIndex[O-1];if(!Ce.has(O)){if(Ce.add(O),I.types[O]===pe.Recursive){let d=[I.vertices[2*S],I.vertices[2*S+1]],_=[I.vertices[2*(S+1)],I.vertices[2*(S+1)+1]],P=[.5*(d[0]+_[0]),.5*(d[1]+_[1])],U=[P[0]-d[0],P[1]-d[1]],Ke=[P[0]+U[1],P[1]-U[0]],Ve=[P[0]-U[1],P[1]+U[0]];l.push(d),l.push(Ke),l.push(_),l.push(Ve),l.push(d)}else{if(I.types[O]!==pe.Regular){R.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let d=S;d<I.vertexEndIndex[O];d++)l.push([I.vertices[2*d],I.vertices[2*d+1]])}if(e!=="CHRONOLOGICAL_SINGLE"&&e!=="CHRONOLOGICAL_MULTIPLE"){let d=p[f.get(D)]?.feature.attributes[k],_=p[f.get(v)]?.feature.attributes[k];l[0][0]===d.x&&l[0][1]===d.y||(l[0]=[d.x,d.y]),l[l.length-1][0]===_.x&&l[l.length-1][1]===_.y||(l[l.length-1]=[_.x,_.y])}for(let d=1;d<l.length-1;d++)l[d][1]>85.5?l[d][1]=85.5:l[d][1]<-85.5&&(l[d][1]=-85.5),l[d][0]>179.9999?l[d][0]=179.9999:l[d][0]<-179.9999&&(l[d][0]=-179.9999);q.has(w)?q.get(w).push(l):q.set(w,[l])}let J=q.get(w);ne.has(w)||(ne.set(w,new Map),oe.set(w,new Map));let H=ne.get(w),G=oe.get(w);H.has(s.typeName)||(H.set(s.typeName,J.shift()),G.set(s.typeName,0));let W=H.get(s.typeName);G.set(s.typeName,G.get(s.typeName)+1);let Me=new de({paths:[W]});if(s.feature.attributes[k]=Me,h.has(s.typeName))h.get(s.typeName)?.set(s.feature.attributes[N],s.feature);else{let d=new Map;d.set(s.feature.attributes[N],s.feature),h.set(s.typeName,d)}y.set(s.feature.attributes[N],s.feature);let $e=B(s.feature.attributes[k]);this.relationshipLinkChartDiagramLookup.set(s.feature.attributes[N],s.feature.attributes[k]?$e:null)}for(let o of a)o.feature.attributes[Re]=oe.get(o.feature.attributes[$]+"-"+o.feature.attributes[K])?.get(o.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutOptions:Le},{nodes:r,links:h,idMap:y}})}applyNewLinkChartLayout(e="RADIAL_TREE",t){return T(this,null,function*(){let i=[];yield this._calculateLayoutWithSublayerTimeInfo(e,t),this.layers.forEach(n=>{i.push(n.refreshCachedQueryEngine())}),yield Promise.all(i),this._refreshNamedTypes()})}getCurrentNodeLocations(){let e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(t=>{t?.members?.forEach(i=>{let n=i.linkChartLocation,a,r=i.id;n&&(a="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(r,new X({x:a.x,y:a.y})))})}),e}synchronizeInclusionListWithCache(){return T(this,null,function*(){return new Promise(e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((t,i)=>{if(t.useAllData=!1,t.members&&t.members.size>0){if(!this.dataManager.sublayerCaches.get(i))return;let n=new Set(Array.from(this.dataManager.sublayerCaches.get(i).keys()));Array.from(t.members.keys()).filter(a=>!n.has(a)).forEach(a=>{t.members?.delete(a)})}}),e()})})}refreshLinkChartCache(e){return T(this,null,function*(){yield this.dataManager.refreshCacheContent(e);let t=[];this.layers.forEach(i=>{t.push(i.refreshCachedQueryEngine())}),yield Promise.all(t),this._refreshNamedTypes()})}connectBetweenEntities(e){return T(this,null,function*(){let t=[];for(let n of this.dataManager.relationshipTypeNames){let a=this.sublayerIdsCache.get(n);a&&(t=t.concat(Array.from(a.keys())))}let i=yield this.dataManager.getRelationshipsBetweenNodes(e,t);return yield this._handleNewRecords(i),{records:i}})}connectFromEntities(e){return T(this,null,function*(){let t=[];for(let a of this.dataManager.relationshipTypeNames){let r=this.sublayerIdsCache.get(a);r&&(t=t.concat(Array.from(r.keys())))}let i=[];for(let a of this.dataManager.entityTypeNames){let r=this.sublayerIdsCache.get(a);r&&(i=i.concat(Array.from(r)))}let n=yield this.dataManager.getRelationshipsFromNodes(e,i,t);return yield this._handleNewRecords(n),{records:n}})}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}_calculateLayoutWithSublayerTimeInfo(e="RADIAL_TREE",t){return T(this,null,function*(){let i=new Map;this.layers.forEach(n=>{i.set(n.objectType.name,n.timeInfo)}),yield this.calculateLinkChartLayout(e,se({timeInfoByTypeName:i},t))})}_handleNewRecords(e){return T(this,null,function*(){let t=[];this.dataManager.addToLayer(e);for(let n of e)this.sublayerIdsCache.has(n.typeName)||(this.sublayerIdsCache.set(n.typeName,new Set),t.push(n.typeName)),this.sublayerIdsCache.get(n.typeName).add(n.id);for(let n of t){let a=this._graphTypeLookup.get(n);if(a){let r=this._createSublayer(a);a.type==="entity"?this.dataManager.entityTypeNames.add(n):this.dataManager.relationshipTypeNames.add(n),r.geometryType?this.layers.push(r):this.tables.push(r),this.dataManager.sublayerCaches.set(n,new Map)}}yield ue(this,t),yield this.dataManager.refreshCacheContent(e.map(n=>n.id));let i=Object.assign({},this._currentLinkChartConfig.layoutOptions);i.lockedNodeLocations=new Map;for(let[n,a]of this.entityLinkChartDiagramLookup.entries())a&&i.lockedNodeLocations.set(n,new X(a.coords[0],a.coords[1]));yield this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,i)})}_createSublayers(e,t,i){e.forEach(n=>{let a=this._createSublayer(n);i(a)&&t.push(a),this._updateSublayerCaches(n)})}_updateSublayers(e,t){t.forEach(i=>{i.parentCompositeLayer=this;let n=e.find(a=>a.type===i.graphType&&a.name===i.graphTypeName);n&&(i.objectType=n,i.read({title:n.name},{origin:"service"}),this._updateSublayerCaches(n))})}_updateSublayerCaches(e){let t=this.dataManager.sublayerCaches;t.has(e.name)||t.set(e.name,new Map)}_initializeDiagram(){return T(this,null,function*(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e?.members?.forEach(i=>{let n=i.linkChartLocation,a,r=i.id;if(!n)return;a="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]};let h=B(a);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(r,h):this.entityLinkChartDiagramLookup.set(r,h),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(t=>{let i=this.relationshipLinkChartDiagramLookup.get(t.attributes[$]),n=this.relationshipLinkChartDiagramLookup.get(t.attributes[K]);if(i&&n){let a=B(new de({paths:[[[i.coords[0],i.coords[1]],[n.coords[0],n.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(t.attributes[N],a)}else this.relationshipLinkChartDiagramLookup.set(t.attributes[N],null)})})):yield this._calculateLayoutWithSublayerTimeInfo(this.defaultLinkChartConfig.layoutMode,se({lockedNodeLocations:this.getCurrentNodeLocations()},this.defaultLinkChartConfig.layoutOptions||{})):yield this._calculateLayoutWithSublayerTimeInfo("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})})}_refreshNamedTypes(){for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateLayoutSettings(e,t){let i=L=>typeof L=="number"&&!isNaN(L),n=L=>i(L)&&L>=1,a=L=>i(L)&&L>=1,r=L=>Object.values(V).includes(L),h=L=>i(L)&&L>=0,y={organicLayoutSettings:{},chronologicalLayoutSettings:{}};if(!new Set(["FORCE_DIRECTED","COMMUNITY","GEOGRAPHIC","CHRONOLOGICAL_MULTIPLE","CHRONOLOGICAL_SINGLE"]).has(e)||!t)return y;t.organicLayoutSettings??={};let{computationBudgetTime:f,repulsionRadiusMultiplier:m,idealEdgeLength:c,idealEdgeLengthType:g}=t.organicLayoutSettings;if(a(f)?y.organicLayoutSettings.computationBudgetTime=f:f!==void 0&&R.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),n(m)?y.organicLayoutSettings.repulsionRadiusMultiplier=m:m!==void 0&&R.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting"),e==="GEOGRAPHIC"&&(c!==void 0||g!==void 0)&&(r(g)?y.organicLayoutSettings.idealEdgeLengthType=g:g!==void 0&&R.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),h(c)?y.organicLayoutSettings.idealEdgeLength=c:c!==void 0&&R.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),(e==="CHRONOLOGICAL_MULTIPLE"||e==="CHRONOLOGICAL_SINGLE")&&t.chronologicalLayoutSettings){let L=t.chronologicalLayoutSettings;L.durationLineWidth&&L.durationLineWidth<0&&R.getLogger(this).warn("Invalid layout durationLineWidth setting, will revert to default setting")}return y}_convertLayoutSettingsToCalculationSettings(e){e.organicLayoutSettings??={};let t=e.organicLayoutSettings.idealEdgeLength;return e.organicLayoutSettings.idealEdgeLengthType===V.ABSOLUTE&&(t===void 0?t=-1:t*=-1),{computationBudgetTime:e.organicLayoutSettings.computationBudgetTime,repulsionRadiusMultiplier:e.organicLayoutSettings.repulsionRadiusMultiplier,idealEdgeLengthMultiplier:t}}_createSublayer(e){return new z({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,t){t&&(t.forEach(i=>{i.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(i=>{i.parent=this}),this.addHandles([e.on("after-add",({item:i})=>{i.parent=this}),e.on("after-remove",({item:i})=>{i.parent=null})],"sublayers-owner"))}};M([b()],C.prototype,"dataPreloadedInLocalCache",void 0),M([b()],C.prototype,"defaultLinkChartConfig",void 0),M([b()],C.prototype,"dataManager",void 0),M([b()],C.prototype,"inclusionModeDefinition",null),M([b()],C.prototype,"knowledgeGraph",void 0),M([b({type:Q.ofType(z),json:{write:{ignoreOrigin:!0}}})],C.prototype,"layers",void 0),M([b()],C.prototype,"entityLinkChartDiagramLookup",void 0),M([b()],C.prototype,"relationshipLinkChartDiagramLookup",void 0),M([b()],C.prototype,"linkChartExtent",void 0),M([b()],C.prototype,"memberEntityTypes",void 0),M([b()],C.prototype,"memberRelationshipTypes",void 0),M([b({type:["LinkChartLayer"]})],C.prototype,"operationalLayerType",void 0),M([b()],C.prototype,"sublayerIdsCache",void 0),M([b({type:Q.ofType(z),json:{write:{ignoreOrigin:!0}}})],C.prototype,"tables",void 0),M([b({json:{read:!1}})],C.prototype,"type",void 0),M([b({json:{read:!1}})],C.prototype,"chronologicalAuxiliaryGraphics",void 0),C=M([be("esri.layers.LinkChartLayer")],C);var It=C;export{It as default};
