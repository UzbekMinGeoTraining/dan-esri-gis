import{c as Pe}from"./chunk-4R4NQEX3.js";import"./chunk-T7FSW5ND.js";import"./chunk-IAUHHGQO.js";import{b as Ge,c as je}from"./chunk-WFTM6S3C.js";import{a as Ne}from"./chunk-OQCRUS7J.js";import{a as Fe}from"./chunk-NPSROKUX.js";import"./chunk-RI2HJFLU.js";import"./chunk-7YHK56KB.js";import{a as Oe}from"./chunk-PHK5IJNU.js";import"./chunk-OH475TQV.js";import{a as Ee,b as U}from"./chunk-S2YELA2I.js";import"./chunk-KAOR3JAH.js";import"./chunk-ACVF7Z7X.js";import"./chunk-LCRAHT7B.js";import"./chunk-QMGVGOIN.js";import"./chunk-M7Q5ICON.js";import"./chunk-DSHXH3B4.js";import{d as Xe}from"./chunk-GSK5DBW5.js";import{b as Ve}from"./chunk-Q5HG4NWF.js";import"./chunk-T6V6CYCJ.js";import"./chunk-U45ID7OR.js";import"./chunk-IW2AVHBW.js";import{f as Je}from"./chunk-SDHCGQUI.js";import"./chunk-VSPQNL6A.js";import"./chunk-7H32J6FD.js";import"./chunk-XNAAMINV.js";import"./chunk-NPF6KTZO.js";import"./chunk-WNU76WNW.js";import"./chunk-H4XRNT5U.js";import"./chunk-WIJFCRLT.js";import"./chunk-6ISQQD7M.js";import"./chunk-VHVYC3RW.js";import{i as He}from"./chunk-ZBOVC36T.js";import"./chunk-BUWHOOA3.js";import"./chunk-RLQK45UV.js";import"./chunk-SDC4SION.js";import"./chunk-6VHG3ZEH.js";import"./chunk-N3AGC3JB.js";import{b as Ue}from"./chunk-KHTVZWEX.js";import"./chunk-IGNHVSQC.js";import{a as Ye,b as qe}from"./chunk-B3W5V2XP.js";import"./chunk-NP35J4DQ.js";import"./chunk-JBGML6IF.js";import"./chunk-S2HMCZNZ.js";import"./chunk-WUAC4CFP.js";import"./chunk-ONDKJR4V.js";import"./chunk-QB4KDO4M.js";import"./chunk-NNNTRPDR.js";import"./chunk-KDLA3TQ2.js";import"./chunk-RPMDOAYZ.js";import"./chunk-J7UK2QPE.js";import"./chunk-6DXGZQQN.js";import"./chunk-3PK63SMD.js";import"./chunk-2DN2BYDF.js";import"./chunk-GQ2SPTYG.js";import"./chunk-RBWI4VLW.js";import"./chunk-MEA3RU4I.js";import"./chunk-3QNHUVFJ.js";import"./chunk-7OTZECLS.js";import"./chunk-XBFBZZXW.js";import"./chunk-LWUJWBPJ.js";import"./chunk-V7QAQAGA.js";import"./chunk-K5V3S3K3.js";import"./chunk-HCCGI45Q.js";import"./chunk-Q6D44QVW.js";import"./chunk-C3EWQ5V5.js";import"./chunk-3UBXEUOT.js";import"./chunk-6WV5YJL7.js";import"./chunk-3AMG6HG6.js";import"./chunk-I6ETUG5Q.js";import"./chunk-4MZSW4Z6.js";import"./chunk-BERIM72F.js";import"./chunk-YOBNM4T6.js";import"./chunk-MEBZWNWT.js";import"./chunk-XZ52TEBV.js";import"./chunk-WAPQB6I3.js";import"./chunk-L3GHXHDP.js";import"./chunk-N6PITG7Q.js";import"./chunk-XC4LDHG5.js";import"./chunk-S3ASAZCA.js";import"./chunk-ZUUCQTSR.js";import"./chunk-GKUBZAEG.js";import"./chunk-UW734WOQ.js";import"./chunk-BIZV3H6H.js";import"./chunk-UCYGH5UZ.js";import"./chunk-ATV5GTE5.js";import"./chunk-X7WNJQZZ.js";import"./chunk-PQPFAB53.js";import"./chunk-QPPQKNYU.js";import"./chunk-MJXFSFCY.js";import"./chunk-6N46AY7Z.js";import"./chunk-TCQTMUK4.js";import"./chunk-AY3YVZUY.js";import"./chunk-7DCEI345.js";import"./chunk-ZG3FCPXY.js";import"./chunk-RIUAG34V.js";import"./chunk-G5SIQY64.js";import"./chunk-WW7S4V24.js";import"./chunk-UGAMS6PU.js";import"./chunk-EHDNZUTT.js";import"./chunk-ECBUS54L.js";import"./chunk-NH7OOX2I.js";import"./chunk-B72PB7U4.js";import"./chunk-644SLL4Y.js";import"./chunk-A54VD7GL.js";import"./chunk-K55ZDM2S.js";import"./chunk-UHYNS4LH.js";import"./chunk-Z3USGHSR.js";import"./chunk-SLEIRDN7.js";import"./chunk-W3OGU5I2.js";import"./chunk-OO4IIGVK.js";import"./chunk-KQHYII76.js";import"./chunk-6I6DPRXI.js";import"./chunk-RNN6GAXL.js";import"./chunk-4IVMQ5PX.js";import"./chunk-CQUOQXLP.js";import"./chunk-VMYCUJRH.js";import"./chunk-PTVRFY4B.js";import"./chunk-3ZOLHUAU.js";import{a as We}from"./chunk-M2F4B74F.js";import"./chunk-2WNCPIJC.js";import"./chunk-GDB2EJGA.js";import"./chunk-RDGFIF46.js";import"./chunk-C2ONI6UP.js";import"./chunk-H6LJ2DCJ.js";import"./chunk-IMNO5TXZ.js";import"./chunk-LCDA6FHZ.js";import"./chunk-RZPELDHM.js";import"./chunk-S3J33BKD.js";import"./chunk-NPIYHDQ7.js";import"./chunk-BL63T6AU.js";import"./chunk-AOTWUAUY.js";import"./chunk-VI4TDFI5.js";import"./chunk-GXSLPADW.js";import"./chunk-2HN33SWB.js";import"./chunk-523X5JOP.js";import"./chunk-BXR2KKYP.js";import"./chunk-7ISKCG7U.js";import"./chunk-OFGHVREP.js";import"./chunk-YJ3RZNO6.js";import"./chunk-26R336GJ.js";import{a as Le}from"./chunk-FPZYH52G.js";import"./chunk-OC7V2CEX.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-R7P6RQXJ.js";import"./chunk-4I7LQWUX.js";import{b as R}from"./chunk-JLNQ6WQT.js";import{a as ze}from"./chunk-GB5RQL32.js";import"./chunk-4OZVVJHM.js";import"./chunk-X7XJWAFC.js";import"./chunk-ILCAH2F6.js";import"./chunk-CYCLIMTY.js";import"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import{a as ke,b as Qe}from"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-7X2HMUNN.js";import"./chunk-LW2464MZ.js";import"./chunk-WJDHM47L.js";import"./chunk-LWJTIQQT.js";import{b as Be}from"./chunk-IHBD2IWR.js";import"./chunk-NH3JQE75.js";import{a as x}from"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import{b as ce}from"./chunk-ZGDQY5ZD.js";import"./chunk-QH2MD2O2.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import"./chunk-7XLHE26H.js";import"./chunk-EN6CTWVM.js";import"./chunk-IRJNWXGT.js";import"./chunk-LVPMJTA6.js";import"./chunk-O4AQRVFI.js";import"./chunk-NDPAZKBG.js";import"./chunk-7AZ5UVCG.js";import"./chunk-6GGK7PRJ.js";import"./chunk-G3PA3VVF.js";import"./chunk-AO7UDTUI.js";import"./chunk-Q7O5PY54.js";import{a as ve}from"./chunk-PFIMJ2UL.js";import"./chunk-CY477QBZ.js";import"./chunk-EJO53FLN.js";import"./chunk-XXR5OT24.js";import"./chunk-4XIZVPNF.js";import"./chunk-F7VAE37R.js";import"./chunk-PM4ZR7W6.js";import"./chunk-ENLR2WBX.js";import"./chunk-RI3FIROF.js";import{a as N}from"./chunk-PJX4LNSV.js";import"./chunk-NNETCWLJ.js";import{d as Re,e as Te,u as Ce}from"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import{p as Se}from"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-I6LCIPDY.js";import{a as De,d as Me}from"./chunk-Y6H3NTW7.js";import"./chunk-4RLJMQW4.js";import"./chunk-J6ZRC6RI.js";import"./chunk-EBGO44EK.js";import"./chunk-THY6AAMN.js";import{a as _}from"./chunk-7W6RATG7.js";import"./chunk-45SNVLPM.js";import"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-B4JAL745.js";import"./chunk-XTES2GPX.js";import"./chunk-2HUIJUS4.js";import{a as he,h as pe}from"./chunk-MBJHSEMD.js";import"./chunk-K72LO6P2.js";import"./chunk-R7Q3STHM.js";import"./chunk-G4PDP3HY.js";import"./chunk-EKU2FJZS.js";import"./chunk-NHN544WL.js";import"./chunk-WZ5A3YGX.js";import"./chunk-NKMODNM6.js";import"./chunk-SEKMXZL5.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-LAJXTVEO.js";import{a as ye,c as we,d as be,f as Ie,i as xe}from"./chunk-5MNDZ6BX.js";import{b as Ae}from"./chunk-RDHMB7M5.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import{f as _e,o as ge}from"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{a as A,e as de}from"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import"./chunk-VQHENXDQ.js";import{a as W}from"./chunk-VWF5VUO3.js";import{f as fe}from"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-EUZMXXZJ.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import{a as ae}from"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as v,S as F}from"./chunk-GGZQ5GCM.js";import{U as I}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as g}from"./chunk-BMVJCP2M.js";import{l as C}from"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{t as me}from"./chunk-3IBUFXWY.js";import"./chunk-BP73DJTS.js";import{a as Q,b as z,g as l}from"./chunk-JEGVIFEP.js";var T=class extends F{constructor(r){super(r),this._removing=0,this._tiles=new Le}destroy(){for(let r of this._tiles.values())r.remove();this._tiles.clear()}get updating(){if(this._removing>0)return!0;for(let r of this._tiles.values())if(!r.finished)return!0;return!1}onTileTreeChange(r){return l(this,null,function*(){let{added:e,removed:t}=r,i=this._tiles,s=[];for(let o of t){let n=i.get(o);n!=null&&(n.abort(),i.delete(o),s.push({tileId:o}))}for(let o of e)i.has(o.id)||i.set(o.id,fe(n=>this._addTile(o,n)));yield this._removeTiles(s)})}_addTile(r,e){return l(this,null,function*(){let t=yield this.addTile(r,e);return C(e),t})}_removeTiles(r){return l(this,null,function*(){this._removing++,yield this.removeTiles(r),this._removing--})}};g([v()],T.prototype,"updating",null),g([v({constructOnly:!0})],T.prototype,"addTile",void 0),g([v({constructOnly:!0})],T.prototype,"removeTiles",void 0),g([v()],T.prototype,"_removing",void 0),T=g([I("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],T);var j=class{constructor(e,t){this._index=e,this._view=t}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new le(this._index,this._view,e)}},le=class extends j{constructor(e,t,i){super(e,t),this._geometryOverride=i}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return Oe(new N,this._geometryOverride,e.hasZ,e.hasM)}},V=class{constructor(){this._storedTiles=new Map,this._pageBounds=new Map,this.events=new W,this.featureAdapter=P.shared}addTile(e){this._storedTiles.set(e.descriptor.id,e);for(let t of e.pages)this._addPage(t)}removeTile(e){let t=this._storedTiles,i=t.get(e);if(i!=null){t.delete(e);for(let s of i.pages)this._removePage(s)}}_addPage(e){let{featureCount:t}=e;if(t===0)return;let i=new Ee(9,o=>e.getBounds(o)),s=new Array;for(let o=0;o<t;++o)s[o]=o;i.load(s),this._pageBounds.set(e,i),this.events.emit("changed")}_removePage(e){this._pageBounds.delete(e),this.events.emit("changed")}clear(){this._storedTiles.clear(),this._pageBounds.clear(),this.events.emit("changed")}forEach(e){for(let[t,i]of this._pageBounds)i.all(s=>e(new j(s,t)))}forEachInBounds(e,t){G.minX=e[0],G.minY=e[1],G.maxX=e[2],G.maxY=e[3];for(let[i,s]of this._pageBounds)s.search(G,o=>t(new j(o,i)))}forEachBounds(e,t){for(let i of e)t(i.getBoundingBox())}getFullExtent(e){let t=1/0,i=1/0,s=-1/0,o=-1/0;for(let n of this._pageBounds.values()){let{minX:d,minY:c,maxX:f,maxY:u}=n.toJSON();t=Math.min(t,d),i=Math.min(i,c),s=Math.min(s,f),o=Math.min(o,u)}return{xmin:t,ymin:i,xmax:s,ymax:o,spatialReference:e}}},P=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};P.shared=new P;var G=new U;var Y=class{constructor(e,t){this.descriptor=e,this.pages=t}};var J=class{constructor(e){let t=new Ne(new Uint8Array(e),new DataView(e));this._reader=t,this._index=at(t)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){let{_index:{fieldsIndex:i,attributeIndices:s}}=this,o=i.get(t)?.index;if(o==null)return;let n=s[e*i.fields.length+o],d=this._reader;return d.move(n),ue(d)}getAttributeAsTimestamp(e,t){let i=this.getAttribute(e,t);return typeof i=="string"?new Date(i).getTime():typeof i=="number"||i==null?i:null}getAttributes(e){let{_index:{fieldsIndex:t,attributeIndices:i}}=this,s=e*t.fields.length,o=this._reader,n={};for(let d of t.fields){let c=i[s+d.index];o.move(c),n[d.name]=ue(o)}return n}getCoordinates(e,t,i=0){let s=this._reader,{transform:o,featureIndices:n}=this._index,{scale:d,translate:c}=o;s.move(n[e]),this._readCoordinates(d,c,t,i)}getOptimizedGeometry(e){let t=A();return this.getCoordinates(e,t),new N([],t)}getCentroid(e,{hasZ:t,hasM:i}){this.getCoordinates(e,D);let[s,o,n]=D,d=[s,o];return t&&(d[3]=n),i&&(d[t?4:3]=0),new N([],d)}getBounds(e){this.getCoordinates(e,D);let[t,i]=D,s=new U;return s.minX=t,s.minY=i,s.maxX=t,s.maxY=i,s}getBoundingBox(e){this.getCoordinates(e,D);let[t,i,s]=D;return Te(t,i,s,t,i,s)}readAllObjectIds(e,t=0){let i=this._reader,{_index:s,featureCount:o}=this,{objectIdFieldName:n,attributeIndices:d,fieldsIndex:c}=s,f=c.get(n).index,u=c.fields.length;for(let a=0;a<o;++a){let m=d[a*u+f];i.move(m),e[t++]=ue(i)}return t}readAllCoordinates(e,t=0){let i=this._reader,{transform:s,featureIndices:o}=this._index,{scale:n,translate:d}=s;for(let c of o)i.move(c),t=this._readCoordinates(n,d,e,t);return t}_readCoordinates([e,t,i],[s,o,n],d,c){let a=this._reader,m=a.getLength(),h=a.pos()+m;for(;a.pos()<h&&a.next();)switch(a.tag()){case 2:{let w=a.getLength(),y=a.pos()+w;for(;a.pos()<y&&a.next();)a.tag()===3?(a.getUInt32(),d[c++]=s+e*a.getSInt64(),d[c++]=o+t*a.getSInt64(),d[c++]=n+i*a.getSInt64()):a.skip();break}default:a.skip()}return c}};function at(r){for(;r.next();){if(r.tag()===2)return dt(r.getMessage());r.skip()}q()}function dt(r){for(;r.next();){if(r.tag()===1)return ct(r.getMessage());r.skip()}q()}function ct(r){let u,a,m=!1,h=!1,w=0,y=new Array,S=new Array,E=new Array;for(;r.next();)switch(r.tag()){case 1:a=r.getString();break;case 7:r.getEnum()!==0&&q();break;case 9:m=r.getBool()??!1;break;case 12:u=Ae(r.processMessage(je));break;case 13:{let O=r.processMessage(Ge);O.index=w++,y.push(O);break}case 15:{S.push(r.pos());let O=r.getUInt32(),ne=r.pos()+O;for(;r.pos()<ne&&r.next();)r.tag()===1&&E.push(r.pos()),r.skip();break}case 10:h=r.getBool()??!1;break;default:r.skip()}let k=new ve(y);return u!=null&&h&&a!=null&&k.has(a)||q(),{transform:u,exceededTransferLimit:m,fieldsIndex:k,objectIdFieldName:a,featureIndices:S,attributeIndices:E}}function q(){let r=new me("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(r),r}function ue(r){let u=r.getLength(),a=r.pos()+u;for(;r.pos()<a&&r.next();)switch(r.tag()){case 1:return r.getString();case 2:return r.getFloat();case 3:return r.getDouble();case 4:return r.getSInt32();case 5:return r.getUInt32();case 6:return r.getInt64();case 7:return r.getUInt64();case 8:return r.getSInt64();case 9:return r.getBool();default:return r.skip(),null}return null}var D=A();var Ze=8e3,lt=4,ut=4,H=class{constructor(e,t,i,s,o){this.spatialReference=e,this.url=i,this.objectIdField=s,this.capabilities=o;let{supportsMaxRecordCountFactor:n,maxRecordCount:d}=this.capabilities.query,c=n?lt:1,f=(d??Ze)*c;this._pageSize=Math.min(Ze,f);let u=t.clone();u.cacheHint=!0,u.resultType="tile",u.outSpatialReference=e,u.returnGeometry=!0,u.returnZ=!0,u.maxRecordCountFactor=c,u.num=this._pageSize,u.outFields=[s],this._baseQuery=u}fetch(e,t){return l(this,null,function*(){let{spatialReference:i}=this,s=_e(e.extent,i),o=this._baseQuery.clone();o.geometry=s;let n=new Array,d=0,c=!1,f=1;for(;!c;){let u=[];for(let m=0;m<f;++m)u.push(this._fetchPage(o,d++,t));let a=yield Promise.all(u);C(t);for(let m of a){let h=m.featureCount!==0;c||=!m.exceededTransferLimit||!h,h&&n.push(m)}f=Math.min(f+1,ut)}return new Y(e,n)})}_fetchPage(e,t,i){return l(this,null,function*(){let s=e.clone();s.start=t*this._pageSize;let o=(yield Pe(this.url,s,{signal:i})).data;return C(i),new J(o)})}};var L=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){let i=this._bufferWriter,s=null;if(e.transformation&&t)ye(M,e.transformation),M[12]-=t[0],M[13]-=t[1],M[14]-=t[2],s=M;else{if(t)throw new Error("not implemented");e.transformation&&(s=e.transformation)}let o=null;s&&(Ie(X,M),be(X,X),o=X);let n=e.attributes,d=i.elementCount(n),c=i.vertexBufferLayout.stride/4;d>Math.floor(mt/c)&&console.warn("geometry with very large number of elements encountered");let f=i.vertexBufferLayout.createBuffer(d);return i.write(s,o,n,e.objectAndLayerIdColor,f,0),{data:f.buffer,elementCount:d}}},M=x(),X=x(),mt=16777216/4;var Z=class{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){let t=this._context,i=t.generateId("material");switch(e){case"default":{let s=new Ue({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),o=new L(s);t.registerRenderGeometryBufferWriter(i,o)}break;case"hud":{let s=Ve(null,this._context.globalViewingMode)[0],o=new L(s);t.registerRenderGeometryBufferWriter(i,o)}}return this._commands.push({id:"create-material",type:e,materialId:i}),i}createDirectRenderer(e){let t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,i){let s=t.materialId,o=this._context.getRenderGeometryBufferWriter(s);if(o==null)throw new Error(`no bufferwriter found for material ${s}`);let n=o.createBuffer(t,i);this._transferables.add(n.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:s,renderGeometryBuffer:n,localOrigin:i})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){let t=this._context.generateId("lod-renderer"),i={levels:e.levels.map(s=>({components:s.components.map(o=>{let n=o.attributes.get(_.POSITION);if(!n||n.indices.length===0)throw new Error("positions attribute expected");let d=3,c=Me(n.indices.length/d),f=new Ye(c,d,n),u=this._context.getRenderGeometryBufferWriter(o.materialId);if(u==null)throw new Error("writer not found");let a=u.createBuffer(o,null);return this._transferables.add(a.data),{materialId:o.materialId,renderGeometryBuffer:a,boundingInfo:{bbMax:f.bbMax,bbMin:f.bbMin}}}),minScreenSpaceRadius:s.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:i}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}dispatch(){return l(this,null,function*(){let e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),this._context.dispatchRenderCommands(e,t)})}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};var $=class{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=()=>l(this,null,function*(){}),this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===ze.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new Z(this)}dispatchRenderCommands(e,t){return l(this,null,function*(){this._dispatchRenderCommandsCallback(e,t)})}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}};var p;(function(r){r[r.OBJECT_ID=0]="OBJECT_ID",r[r.PARTITION_ID=1]="PARTITION_ID",r[r.GEOMETRY_MAP_COORDINATES=2]="GEOMETRY_MAP_COORDINATES",r[r.GEOMETRY_RENDER_COORDINATES=3]="GEOMETRY_RENDER_COORDINATES",r[r.TILE_CENTER_RENDER_COORDINATES=4]="TILE_CENTER_RENDER_COORDINATES"})(p||(p={}));function $e(r,e){return l(this,null,function*(){let{numFeatures:t,tile:i,partitionInfo:s}=r,{pages:o}=i;if(o.length===0||t===0)return new Uint32Array;let n=new Uint32Array(t);if(s){let d=o.reduce((a,{featureCount:m})=>a+m,0),c=new Uint32Array(d),f=0;for(let a of o)f=a.readAllObjectIds(c,f);let u=s.tileIndices;for(let a=0;a<t;++a){let m=c[u[a]];n[a]=m}}else{let d=0;for(let c of o)d=c.readAllObjectIds(n,d)}return n})}function Ke(r,e){return l(this,null,function*(){let{numFeatures:t,tile:i,partitionInfo:s}=r,{pages:o}=i;if(o.length===0||t===0)return new Float64Array;let n=new Float64Array(3*t);if(s){let d=o.reduce((a,{featureCount:m})=>a+m,0),c=new Float64Array(3*d),f=0;for(let a of o)f=a.readAllCoordinates(c,f);let u=s.tileIndices;for(let a=0;a<t;++a){let m=u[a],h=c[3*m+0],w=c[3*m+1],y=c[3*m+2];n[3*a+0]=h,n[3*a+1]=w,n[3*a+2]=y}}else{let d=0;for(let c of o)d=c.readAllCoordinates(n,d)}return n})}function et(r,e){return l(this,null,function*(){yield r.provision([p.GEOMETRY_MAP_COORDINATES],e);let{numFeatures:t,tile:i,mapCoordinates:s}=r,{pages:o}=i;if(o.length===0||t===0)return new Float64Array;let n=e.viewSpatialReference,d=e.renderSpatialReference,c=new Float64Array(3*t);if(!Se(s,n,0,c,d,0,t))throw new Error("Failed to project coordinates");return c})}function tt(r,e){return l(this,null,function*(){let t=e.viewSpatialReference,i=e.renderSpatialReference,s=r.tile.descriptor.extent,o=ge(s),n=A();return We([o[0],o[1],0],t,n,i),n})}var B=class{constructor(e,t,i=null){this._tile=e,this._numFeatures=t,this._partitionInfo=i}get partitionInfo(){return this._partitionInfo}get tile(){return this._tile}get numFeatures(){return this._numFeatures}get tileId(){return this._tile.descriptor.id}get objectIds(){if(this._objectIds==null)throw new Error("objectIds haven't been provisioned yet");return this._objectIds}get partitionIds(){if(this._partitionIds==null)throw new Error("partitionIds haven't been provisioned yet");return this._partitionIds}get mapCoordinates(){if(this._mapCoordinates==null)throw new Error("mapCoordinates haven't been provisioned yet");return this._mapCoordinates}get renderCoordinates(){if(this._renderCoordinates==null)throw new Error("renderCoordinates haven't been provisioned yet");return this._renderCoordinates}get tileCenterRenderCoordinates(){if(this._tileCenterRenderCoordinates==null)throw new Error("tileCenterRenderCoordinates hasn't been provisioned yet");return this._tileCenterRenderCoordinates}provision(e,t){return l(this,null,function*(){for(let i of e)switch(i){case p.OBJECT_ID:if(this._objectIds)return;this._objectIds=yield $e(this);break;case p.PARTITION_ID:if(this._partitionIds)return;this._partitionIds=new Uint32Array(this._numFeatures);break;case p.GEOMETRY_MAP_COORDINATES:if(this._mapCoordinates)return;this._mapCoordinates=yield Ke(this);break;case p.GEOMETRY_RENDER_COORDINATES:if(this._renderCoordinates)return;this._renderCoordinates=yield et(this,t);break;case p.TILE_CENTER_RENDER_COORDINATES:if(this._tileCenterRenderCoordinates)return;this._tileCenterRenderCoordinates=yield tt(this,t);break;default:throw new Error("not implemented")}})}dispose(){if(this.partitions){for(let e of this.partitions)e.dispose();this.partitions=void 0}}};function K(r){let e=new Map;for(let[t,i]of r)e.set(t,z(Q({},i),{indices:De(i.indices)}));return e}function it(r,e){let t=(i,s,o=!1)=>({levels:i.map(n=>{let d=K(s(n.tesselation));return o&&ft(d),{components:[{attributes:d,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:n.minScreenSpaceRadius}})});switch(r){case"cone":return t(ht,i=>He(1,.5,i,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function ft(r){let e=r,t=e.get(_.POSITION).data,i=e.get(_.NORMAL).data;if(i){let s=rt(r,_.NORMAL).data;for(let o=0;o<i.length;o+=3){let n=i[o+1];s[o+1]=-i[o+2],s[o+2]=n}}if(t){let s=rt(r,_.POSITION).data;for(let o=0;o<t.length;o+=3){let n=t[o+1];s[o+1]=-t[o+2],s[o+2]=n}}}function rt(r,e){let t=r.get(e);return t&&!t.exclusive&&(t=z(Q({},t),{exclusive:!0,data:qe(t.data)}),r.set(e,t)),t}var ht=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];var te=class extends F{constructor(r){super(),this._context=r,this.lodRendererId=null,this._loaded=!1}get loaded(){return this._loaded}load(r){return l(this,null,function*(){let e=r.createMaterial("default"),t=it("cone",e);this.lodRendererId=r.createLodRenderer(t),this._loaded=!0})}add(r,e){return l(this,null,function*(){if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");yield this._provisionFeatureData(r);let t=r.numFeatures,i=!0,s=Re(Qe("cone")),o=de(Ce(s)),n=de(ke(o,{isPrimitive:i,width:100,depth:null,height:null})),d=new Float64Array(16*t),c=new Float64Array(16*t),f=r.mapCoordinates;for(let a=0;a<t;++a){let m=a,h=f[3*a+0],w=f[3*a+1],y=f[3*a+2],S=this._computeGlobalTransform(h,w,y,this._context.viewSpatialReference,_t),E=this._computeLocalTransform(n,o,pt);this._writeMatrixToTypedBuffer(d,m,E),this._writeMatrixToTypedBuffer(c,m,S)}let u={featureIds:new Uint32Array(r.objectIds),localTransforms:d,globalTransforms:c};e.addLodInstances(this.lodRendererId,u)})}remove(r,e){return l(this,null,function*(){if(this.lodRendererId==null)return;let t=new Uint32Array(r.objectIds);e.removeLodInstances(this.lodRendererId,t)})}_provisionFeatureData(r){return l(this,null,function*(){yield r.provision([p.GEOMETRY_MAP_COORDINATES,p.OBJECT_ID],this._context)})}_writeMatrixToTypedBuffer(r,e,t){let i=16*e;for(let s=0;s<16;s++)r[i++]=t[s]}_computeGlobalTransform(r,e,t,i,s){return ee[0]=r,ee[1]=e,ee[2]=t,Be(i,ee,s,this._context.renderSpatialReference),s}_computeLocalTransform(r,e,t){return we(t),this._applyObjectScale(r,e,t),t}_applyObjectScale(r,e,t){let i=Je(r,r,e,this._context.renderCoordsHelper.unitInMeters);i[0]===1&&i[1]===1&&i[2]===1||xe(t,t,i)}};te=g([I("esri.views.3d.layers.graphics.pipeline.symbolization.TestObjectSymbol")],te);var ee=A(),pt=x(),_t=x();var re=class extends F{constructor(r){super(),this._context=r,this.materialId=null,this._loaded=!1}get loaded(){return this._loaded}load(r){return l(this,null,function*(){this.materialId=r.createMaterial("hud"),r.createDirectRenderer(this.materialId),this._loaded=!0})}add(r,e){return l(this,null,function*(){if(this.materialId==null)throw new Error("expected material not to be null");yield this._provisionFeatureData(r);let{numFeatures:t,tileId:i,renderCoordinates:s,tileCenterRenderCoordinates:o}=r,n=new Float64Array([0,0,1]),d=new Float64Array([255,255,255,255]),c=new Float64Array([24,24]),f=new Float64Array([0,0,0,1]),u=new Float64Array([0,0]),a=new Float64Array([0]),m=new Uint32Array(t);for(let b=0;b<t;++b)m[b]=b;let h=new Uint32Array(t);for(let b=0;b<t;++b)h[b]=0;let w=new R(s,m,3,!0),y=new R(n,h,3,!0),S=new R(u,h,2,!0),E=new R(d,h,4,!0),k=new R(a,h,1,!0),O=new R(c,h,2,!0),ne=new R(f,h,4,!0),st=[[_.POSITION,w],[_.NORMAL,y],[_.UV0,S],[_.COLOR,E],[_.ROTATION,k],[_.SIZE,O],[_.CENTEROFFSETANDDISTANCE,ne]],nt={attributes:K(st),objectAndLayerIdColor:void 0,transformation:x(),materialId:this.materialId};e.addDirectRendererGeometry(i,nt,o)})}remove(r,e){return l(this,null,function*(){e.removeDirectRendererGeometry(r.tileId)})}_provisionFeatureData(r){return l(this,null,function*(){yield r.provision([p.GEOMETRY_RENDER_COORDINATES,p.TILE_CENTER_RENDER_COORDINATES],this._context)})}};re=g([I("esri.views.3d.layers.graphics.pipeline.symbolization.TestSymbol")],re);var ie=class{constructor(e){this._symbols=new Map,this._context=e}load(){return l(this,null,function*(){this._symbols.set(0,new re(this._context)),this._symbols.set(1,new te(this._context))})}add(e,t){return l(this,null,function*(){yield this._provisionFeatureData(e,this._context);let i=this._partition(e);yield Promise.all(i.map(s=>l(this,null,function*(){let o=yield this._provisionSymbol(s.partitionInfo?.index,t);o&&(yield o.add(s,t))})))})}remove(e,t){return l(this,null,function*(){let i=e.partitions;if(!i)throw new Error("partitioned featureset expected");yield Promise.all(i.map(s=>l(this,null,function*(){let o=yield this._provisionSymbol(s.partitionInfo?.index,t);o&&(yield o.remove(s,t))})))})}_provisionFeatureData(e,t){return l(this,null,function*(){yield e.provision([p.PARTITION_ID,p.OBJECT_ID],t)})}_provisionSymbol(e,t){return l(this,null,function*(){if(e==null)return null;let i=this._symbols.get(e);return i?(i.loaded||(yield i.load(t)),i):null})}_partition(e){let{numFeatures:t,objectIds:i,partitionIds:s}=e,o=[[],[]];for(let n=0;n<t;++n){let d=i[n]%2;o[d].push(n),s[n]=d}return e.partitions=o.filter(n=>n.length>0).map((n,d)=>{let c=n.length,f={index:d,tileIndices:new Uint32Array(n)};return new B(e.tile,c,f)}),e.partitions}};var oe=class{constructor(e){this._tileFeatureData=new Map,this._context={viewSpatialReference:e.viewSpatialReference,renderSpatialReference:e.renderSpatialReference,renderCoordsHelper:Xe.create(e.viewingMode,e.renderSpatialReference)}}add(e,t){return l(this,null,function*(){this._featureRenderer||(this._featureRenderer=new ie(this._context),yield this._featureRenderer.load());let i=this._addTileFeatureData(e);yield this._featureRenderer.add(i,t)})}remove(e,t){return l(this,null,function*(){let i=this._getFeatureSetFromTileId(e);i&&(this._featureRenderer&&this._featureRenderer.remove(i,t),this._removeTileFeatureData(e))})}_getFeatureSetFromTileId(e){return this._tileFeatureData.get(e)}_addTileFeatureData(e){let t=e.descriptor.id,i=e.pages.reduce((o,{featureCount:n})=>o+n,0),s=new B(e,i);return this._tileFeatureData.set(t,s),s}_removeTileFeatureData(e){let t=this._tileFeatureData.get(e);t&&(t.dispose(),this._tileFeatureData.delete(e))}};var se=class extends W.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new V,this._tileManager=new T({addTile:(r,e)=>this._addTile(r,e),removeTiles:r=>this._removeTiles(r)}),this._renderCommandContext=null,this._fetcher=null,this._symbolizer=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager.destroy()}setup(f){return l(this,arguments,function*({viewSpatialReference:r,renderSpatialReference:e,viewingMode:t,baseQuery:i,url:s,objectIdField:o,capabilities:n,fieldsIndex:d,timeInfo:c}){this._renderCommandContext=new $({viewingMode:t,dispatchRenderCommandsCallback:(m,h)=>this.remoteClient.invoke("dispatchRenderCommands",m,{transferList:h})});let u=ae.fromJSON(r),a=ae.fromJSON(e);return this._fetcher=new H(u,ce.fromJSON(i),s,o,n),this._symbolizer=new oe({viewSpatialReference:u,renderSpatialReference:a,viewingMode:t}),this._queryEngine=new Fe({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:o,fieldsIndex:d,availableFields:[o],spatialReference:r,featureStore:this._featureStore,timeInfo:c}),this._defaultQueryJSON=new ce({outSpatialReference:u}).toJSON(),this.addHandles(he(()=>this.updating,m=>l(this,null,function*(){this.emit("notify-updating",{updating:m})})),pe),ot})}executeQuery(r,e){return l(this,null,function*(){return{result:yield this._queryEngine.executeQuery(this._ensureQuery(r),e)}})}executeQueryForIds(r,e){return l(this,null,function*(){let t=yield this._queryEngine.executeQueryForIdSet(this._ensureQuery(r),e);return{result:Array.from(t)}})}executeQueryForCount(r,e){return l(this,null,function*(){return{result:yield this._queryEngine.executeQueryForCount(this._ensureQuery(r),e)}})}executeQueryForExtent(r,e){return l(this,null,function*(){return{result:yield this._queryEngine.executeQueryForExtent(this._ensureQuery(r),e)}})}executeQueryForLatestObservations(r,e){return l(this,null,function*(){return{result:yield this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(r),e)}})}onTileTreeChange(r){return l(this,null,function*(){return yield this._tileManager.onTileTreeChange(r),ot})}_addTile(r,e){return l(this,null,function*(){let t=yield this._fetcher.fetch(r,e);C(e),this._featureStore.addTile(t);let i=this._renderCommandContext.createEncoder();return yield this._symbolizer.add(t,i),yield i.dispatch(),t})}_removeTiles(r){return l(this,null,function*(){let e=this._renderCommandContext.createEncoder(),t=this._featureStore,i=this._symbolizer;for(let s of r)t.removeTile(s.tileId),yield i.remove(s.tileId,e);yield e.dispatch()})}_ensureQuery(r){return r??this._defaultQueryJSON}};g([v()],se.prototype,"updating",null),se=g([I("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],se);var Ui=se,ot={result:void 0};export{Ui as default};
