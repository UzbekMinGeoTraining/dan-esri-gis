import{a as oe,b as ae,c as ne,d as ie,e as ce,f as le,g as pe,h as N,i as ue,l as me}from"./chunk-KZM53NFX.js";import{a as re,b as te}from"./chunk-VFQ7QZ34.js";import{a as x,b as j,d as Z,f as ee,g as se}from"./chunk-JGPFCHHF.js";import"./chunk-VQ5WF3XI.js";import{c as K,d as V,g as Q,j as X,k as Y}from"./chunk-DGD6TNOG.js";import"./chunk-IZRBPB5G.js";import"./chunk-ILCAH2F6.js";import"./chunk-CYCLIMTY.js";import"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import{f as J}from"./chunk-MBVOWLUI.js";import"./chunk-2HUIJUS4.js";import{b as G}from"./chunk-VDNXTMSC.js";import"./chunk-OFZ6SV37.js";import"./chunk-5MNDZ6BX.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import"./chunk-PYQRTZNZ.js";import"./chunk-3M7VXIQH.js";import"./chunk-5PTS4JDF.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import{a as W}from"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import{k as f}from"./chunk-TEY6TKJV.js";import{V as H,w as g}from"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import"./chunk-GGZQ5GCM.js";import{u as $}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import"./chunk-BMVJCP2M.js";import{a as q,l as p,o as z,z as L}from"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import{a as E}from"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{r as B}from"./chunk-3IBUFXWY.js";import{a as b}from"./chunk-BP73DJTS.js";import{a as P,b as T,g as c}from"./chunk-JEGVIFEP.js";var I={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};function y(r,e=t=>{},s){return new U(r,e,s)}var U=class{constructor(e,s=o=>{},t){if(this.onProgress=s,this.taskName=t,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,typeof e=="number"){this._weights={};for(let o=0;o<e;o++){let a=o,n=1/e;this._weights[a]=n,this._progressMap.set(a,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(let[s,t]of this._progressMap.entries())e+=t*this._weights[s];if(e===1&&b("enable-feature:esri-3dofl-upload-timings")){let s=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${s} sec`);for(let[t,o]of this._timingsMap){let a=Math.round(o.end-o.start)/1e3,n=Math.round(a/s*100);console.log(this.taskName??"Task",{stepKey:t,stepTime:a,relativeTime:n})}}this.onProgress(e)}setProgress(e,s){if(this._progressMap.set(e,s),b("enable-feature:esri-3dofl-upload-timings")){let t=performance.now();this._startTime??=t;let o=$(this._timingsMap,e,()=>({start:t,end:0}));s===1&&(o.end=t)}this.emitProgress()}simulate(e,s){return D(t=>this.setProgress(e,t),s)}makeOnProgress(e){return s=>this.setProgress(e,s)}};function D(r=s=>{},e=Re){let s=performance.now();r(0);let t=setInterval(()=>{let o=performance.now()-s,a=1-Math.exp(-o/e);r(a)},Ce);return q(()=>{clearInterval(t),r(1)})}function fe(r,e=De){return E(r*ge/e)}function de(r,e=ke){return E(r*ge/e)}var De=10,ke=10,ge=8e-6,Ce=50,Re=1e3;var we=1e6,he=20*we,Oe=2e9,_e=3;function ye(a,n,i){return c(this,arguments,function*({data:r,name:e,description:s},t,o){let l=null;try{let u=g(t,"uploads"),h=g(u,"info"),{data:w}=yield f(h,{query:{f:"json"},responseType:"json"});p(o);let m=J(t),k=w.maxUploadFileSize*we,Fe=m?Oe:k,S=m?Math.min(he,k):he;if(r.size>Fe)throw new Error("Data too large");let Me=g(u,"register"),{data:C}=yield f(Me,{query:{f:"json",itemName:Be(e),description:s},responseType:"json",method:"post"});if(p(o),!C.success)throw new Error("Registration failed");let{itemID:ve}=C.item;l=g(u,ve);let Ie=g(l,"uploadPart"),R=Math.ceil(r.size/S),A=new Array;for(let d=0;d<R;++d)A.push(r.slice(d*S,Math.min((d+1)*S,r.size)));let F=A.slice().reverse(),O=new Array,Se=y(R,o?.onProgress,"uploadItem"),Ee=()=>c(this,null,function*(){for(;F.length!==0;){let d=A.length-F.length,M=F.pop(),v=new FormData,je=Se.simulate(d,fe(M.size));try{v.append("f","json"),v.append("file",M),v.append("partId",`${d}`);let{data:Ne}=yield f(Ie,{timeout:0,body:v,responseType:"json",method:"post"});if(p(o),!Ne.success)throw new Error("Part upload failed")}finally{je.remove()}}});for(let d=0;d<_e&&F.length!==0;++d)O.push(Ee());yield Promise.all(O);let xe=g(l,"commit"),{data:_}=yield f(xe,{query:{f:"json",parts:A.map((d,M)=>M).join(",")},responseType:"json",method:"post"});if(p(o),!_.success)throw new Error("Commit failed");return _.item}catch(u){if(l!=null){let h=g(l,"delete");yield f(h,{query:{f:"json"},responseType:"json",method:"post"})}throw u}})}function Be(r){return r.replaceAll("/","_").replaceAll("\\","_")}function _s(r,e,s){return c(this,null,function*(){let t=r.length;if(!t)return s?.onProgress?.(1),[];let o=y(t,s?.onProgress,"uploadAssets");return Promise.all(r.map((a,n)=>qe(a,e,T(P({},s),{onProgress:o.makeOnProgress(n)}))))})}function qe(o,a,n){return c(this,arguments,function*(r,{layer:e,ongoingUploads:s},t){let i=s.get(r);if(i)return i;if(!os(e))throw new oe;if(ze(r,e))return t?.onProgress?.(1),r;let l=Le(r,e,t);s.set(r,l);try{yield l}finally{s.delete(r)}return r})}function ze(r,e){let{parsedUrl:s}=e;return s!=null&&r.metadata.externalSources.some(t=>Z(t,s))}function Le(r,e,s){return c(this,null,function*(){let{metadata:t}=r,{displaySource:o}=t,a=Pe(o?.source,e,{checkForConversionRequired:b("enable-feature:georeferenced-uploads")}),n=a!=null?$e(a,e,s):t.externalSources.length>0?He(r,e,s):Ge(r,e,s),i=yield n;return p(s),r.addExternalSources([i]),r})}function $e(r,e,s){return c(this,null,function*(){return{source:yield Te(r,e,s),original:!0,unitConversionDisabled:!0}})}function He(r,e,s){return c(this,null,function*(){let t=Ae(e),{externalSources:o}=r.metadata,a=Je(o,e);if(!a)throw new ne;let n=y(I.uploadConvertibleSource,s?.onProgress,"uploadConvertibleSource"),i=yield Te(a,e,{onProgress:n.makeOnProgress("uploadEditSource")});r.addExternalSources([{source:i,original:!0}]);let l=a.reduce((h,{asset:w})=>w instanceof File?h+w.size:h,0),u=n.simulate("serviceAssetsToGlb",de(l));try{let{source:h,transform:w,origin:m}=yield es(i,e,t);return r.transform=w,m&&(r.metadata.georeferenced=!0,s?.useAssetOrigin&&(r.vertexSpace.origin=[m.x,m.y,m.z??0],r.spatialReference=m.spatialReference)),{source:h,unitConversionDisabled:!0}}finally{u.remove()}})}function Ge(r,e,s){return c(this,null,function*(){let t=y(I.uploadLocalMesh,s?.onProgress,"uploadLocalMesh"),o=We(r,e,T(P({},s),{onProgress:t.makeOnProgress("meshToAssetBlob")}));return{source:yield be([o],e,T(P({},s),{onProgress:t.makeOnProgress("uploadAssetBlobs")})),extent:r.extent.clone(),original:!0}})}function We(r,e,s){return c(this,null,function*(){let t=Ae(e),o=yield r.load(s),a=yield o.toBinaryGLTF({origin:o.origin,signal:s?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return p(s),{blob:new Blob([a],{type:"model/gltf-binary"}),assetName:`${G()}.glb`,assetType:t}})}function Je(r,e){for(let s of r){let t=Pe(s.source,e);if(t)return t}return null}function Pe(r,{infoFor3D:e},s={}){if(!r)return null;let{supportedFormats:t,editFormats:o}=e,a=se(r),n=new Array,i=Y(e),l=X(e),u=!1;for(let h of a){let w=Ke(h,t);if(!w)return null;let{assetType:m}=w;if(s.checkForConversionRequired&&(m===i||m===l))return null;o.includes(m)&&(u=!0),n.push(w)}return u?n:null}function Ke(r,e){let s=ee(r,e);return s?{asset:r,assetType:s}:null}function Te(r,e,s){return c(this,null,function*(){return be(r.map(t=>Ve(t,s)),e,s)})}function be(r,e,s){return c(this,null,function*(){let t=y(I.uploadAssetBlobs,s?.onProgress,"uploadAssetBlobs"),o=yield Xe(r,e,T(P({},s),{onProgress:t.makeOnProgress("prepareAssetItems")}));p(s);let a=o.map(({item:i})=>i),{uploadResults:n}=yield Ye(a,e,T(P({},s),{onProgress:t.makeOnProgress("uploadAssetItems")}));return p(s),r.map((i,l)=>Ze(o[l],n[l],e))})}function Ve(r,e){return c(this,null,function*(){let{asset:s,assetType:t}=r;if(s instanceof File)return{blob:s,assetName:s.name,assetType:t};let o=yield s.toBlob(e);return p(e),{blob:o,assetName:s.assetName,assetType:t}})}function Qe(r,e,s){return c(this,null,function*(){let{blob:t,assetType:o,assetName:a}=r,n=null;try{let i=yield ye({data:t,name:a},e.url,s);p(s),n={assetType:o,assetUploadId:i.itemID}}catch(i){z(i),as().warnOnce(`Service ${e.url} does not support the REST Uploads API.`)}if(!n){let i=yield H(t);if(p(s),!i.isBase64)throw new ie;n={assetType:o,assetData:i.data}}if(!n)throw new ce;return{item:n,assetName:a}})}function Xe(r,e,s){let t=y(r.length,s?.onProgress,"prepareAssetItems");return Promise.all(r.map((o,a)=>c(this,null,function*(){let n=Qe(yield o,e,T(P({},s),{onProgress:t.makeOnProgress(a)}));return p(s),n})))}function Ye(r,e,s){return c(this,null,function*(){let t=D(s?.onProgress);try{let o=yield f(g(e.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(r)},method:"post",responseType:"json"});if(p(s),o.data.uploadResults.length!==r.length)throw new le(r.length,o.data.uploadResults.length);return o.data}finally{t.remove()}})}function Ze(r,e,s){let{success:t}=e;if(!t){let{error:u}=e;throw new pe(r.assetName,u)}let{assetHash:o}=e,{assetName:a,item:{assetType:n}}=r,{infoFor3D:{supportedFormats:i}}=s,l=V(n,i);if(!l)throw new N(n);return new x(a,l,[new j(`${s.parsedUrl.path}/assets/${o}`,o)])}function es(r,e,s){return c(this,null,function*(){let t=r.map(({assetName:a,parts:n})=>({assetName:a,assetHash:n[0].partHash})),o;try{let a=g(e.parsedUrl.path,"convert3D"),n=e.capabilities?.operations.supportsAsyncConvert3D;o=(yield(n?ts:rs)(a,{query:{f:"json",assets:JSON.stringify(t),transportType:"esriTransportTypeUrl",targetFormat:s,async:n},responseType:"json",timeout:0})).data}catch{throw new ue}return ss(e,o)})}function ss(r,e){let s={source:e.assets.map(t=>{let o=K(t.contentType,r.infoFor3D.supportedFormats);if(!o)throw new N(o);return new x(t.assetName,t.contentType,[new j(t.assetURL,t.assetHash)])}),origin:void 0,transform:void 0};if(b("enable-feature:georeferenced-uploads")&&e.transform){if(s.transform=te(e.transform),e.spatialReference){let t=W.fromJSON(e.spatialReference);s.origin=re(e.transform,t)}}else s.transform=me(r.spatialReference);return s}function rs(r,e){return f(r,e)}function ts(r,e){return c(this,null,function*(){let s=(yield f(r,e)).data.statusUrl;for(;;){let t=(yield f(s,{query:{f:"json"},responseType:"json"})).data;switch(t.status){case"Completed":return f(t.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(t.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}yield L(ns)}})}function os(r){return!!r.infoFor3D&&!!r.url}function Ae({infoFor3D:r}){let e=Q(r);if(!e)throw new ae;return e}function as(){return B.getLogger("esri.layers.graphics.sources.support.uploadAssets")}var ns=1e3;export{_s as uploadAssets};
