import{b as Xt}from"./chunk-4EBEFT6T.js";import{a as p,g as Q}from"./chunk-W4FJ4A5Q.js";import{a as Lt,c as Yt}from"./chunk-X7CRJ427.js";import{e as Ht}from"./chunk-KS6SWJU3.js";import{b as Ut}from"./chunk-GWDYH5GG.js";import{b as zt}from"./chunk-XCZY4IUQ.js";import{b as Bt}from"./chunk-DZBIKPHA.js";import{a as kt,c as jt}from"./chunk-C6VBL32Q.js";import{a as Vt,c as J,f as Nt}from"./chunk-3DR4YGRI.js";import{a as Wt,c as Ft}from"./chunk-FTNMSGGI.js";import{a as Zt,c as Qt}from"./chunk-4DJFVMMN.js";import{a as Z,b as Le,c as Et}from"./chunk-DQVRRO4N.js";import{a as It}from"./chunk-MM6IP4FS.js";import{a as V}from"./chunk-DYNH5H2C.js";import{g as qt,k as O}from"./chunk-2F2E6NNR.js";import{b as Gt}from"./chunk-H7LSTWKZ.js";import{c as Rt}from"./chunk-XNAAMINV.js";import{c as ft,e as yt}from"./chunk-NPF6KTZO.js";import{a as Tt,d as wt,e as W}from"./chunk-WNU76WNW.js";import{a as bt}from"./chunk-H4XRNT5U.js";import{c as St}from"./chunk-6ISQQD7M.js";import{a as Ee,b as Re}from"./chunk-BUWHOOA3.js";import{a as Ct,b as Ie}from"./chunk-N3AGC3JB.js";import{a as x}from"./chunk-S2HMCZNZ.js";import{a as Dt,b as At}from"./chunk-J7UK2QPE.js";import{a as xt}from"./chunk-2DN2BYDF.js";import{a as Mt}from"./chunk-MEA3RU4I.js";import{a as Pt,e as ve}from"./chunk-3UBXEUOT.js";import{a as b}from"./chunk-6WV5YJL7.js";import{b as we,c as Ot}from"./chunk-3AMG6HG6.js";import{a as f,b as y}from"./chunk-N6PITG7Q.js";import{g as F,l as R,m as T}from"./chunk-ATV5GTE5.js";import{j as A}from"./chunk-MJXFSFCY.js";import{a as xe}from"./chunk-6N46AY7Z.js";import{a as vt}from"./chunk-AY3YVZUY.js";import{a as Te}from"./chunk-G5SIQY64.js";import{a as _t}from"./chunk-RDGFIF46.js";import{a as m}from"./chunk-NPIYHDQ7.js";import{a as gt}from"./chunk-BXR2KKYP.js";import{a as qe}from"./chunk-26R336GJ.js";import{b as fe,d as ye}from"./chunk-OC7V2CEX.js";import{c as X}from"./chunk-4OZVVJHM.js";import{a as mt}from"./chunk-XXOIKNT6.js";import{d as nt,e as ht}from"./chunk-O4AQRVFI.js";import{a as dt}from"./chunk-EBGO44EK.js";import{a as j}from"./chunk-THY6AAMN.js";import{a as Y}from"./chunk-7W6RATG7.js";import{a as E,b as ct,h as I,k as _e,m as ut,n as pt,r as Ge}from"./chunk-BDF7KEUQ.js";import{a as k}from"./chunk-HWN5REN7.js";import{b as B}from"./chunk-XTES2GPX.js";import{c as lt}from"./chunk-2HUIJUS4.js";import{a as q,c as et,h as tt,i as ge}from"./chunk-MBJHSEMD.js";import{A as ot,n as st}from"./chunk-5MNDZ6BX.js";import{a as z,c as rt,z as Me}from"./chunk-6WKJD7BM.js";import{f as at}from"./chunk-YRTBL7EE.js";import{g as it}from"./chunk-PYQRTZNZ.js";import{a as $e}from"./chunk-VWF5VUO3.js";import{A as me,Q as u,S as Ke}from"./chunk-GGZQ5GCM.js";import{U as H,s as D}from"./chunk-TFUPB3ZG.js";import{a as d}from"./chunk-BMVJCP2M.js";import{c as P,f as U}from"./chunk-WGF2T2BG.js";import{a as pe}from"./chunk-VEDIBGHD.js";import{r as Je}from"./chunk-3IBUFXWY.js";import{a as Qe}from"./chunk-BP73DJTS.js";import{a as Xe,b as Ze}from"./chunk-JEGVIFEP.js";var K=class{constructor(){this._extent=z(),this.resolution=0,this.renderLocalOrigin=Lt(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new He}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryView();let r=.001*e.range;if(this._extent[0]-r<=e.min){let i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Me(this._extent,e.range,0,i)}if(this._extent[2]+r>=e.max){let i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Me(this._extent,-e.range,0,i)}}setupGeometryView(){this.canvasGeometries.numViews=1,rt(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},He=class{constructor(){this.extents=[z(),z(),z()],this.numViews=0}};var Ce=class{constructor(e,r,i){this._fbos=e,this._format=r,this._name=i}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=U(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,r,i){this._handle&&this._handle.fbo?.width===r&&this._handle.fbo?.height===i||(this._handle?.release(),this._handle=this._fbos.acquire(r,i,this._name,this._format)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}};var M=class{constructor(e,r,i,s,o=b.RGBA_MIPMAP){this.output=i,this.content=s,this.fbo=new Ce(e,o,r)}get valid(){return this.fbo.valid}},Se=class{constructor(e){this.targets=[new M(e,"overlay color",m.Color,p.Color),new M(e,"overlay IM color",m.Color,p.ColorNoRasterImage),new M(e,"overlay highlight",m.Highlight,p.Highlight,b.RG),new M(e,"overlay water",m.Normal,p.WaterNormal),new M(e,"overlay occluded",m.Color,p.Occluded)],_t()&&this.targets.push(new M(e,"overlay olid",m.ObjectAndLayerIdColor,p.ObjectAndLayerIdColor,b.RGBA))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(let e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,r,i)=>r.valid?e|=1<<i:e,0)}};var $=class extends y{constructor(e,r,i){super(e,r,new f(Ut,()=>import("./chunk-HLSH6NIU.js")),i)}initializePipeline(){return T({blending:F,colorWrite:R})}};var ee=class extends y{constructor(e,r,i){super(e,r,new f(Nt,()=>import("./chunk-2CCQ4XB7.js")),i)}initializePipeline(){return T({colorWrite:R})}};var be=class extends gt{constructor(){super(...arguments),this.occludedFactor=qt,this.maxHighlightLevel=1,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};var te=class extends y{constructor(e,r,i){super(e,r,new f(zt,()=>import("./chunk-TI6AGRIQ.js")),i)}initializePipeline(){return T({colorWrite:R})}};var re=class extends y{constructor(e,r,i){super(e,r,new f(Bt,()=>import("./chunk-NM3OU6IW.js")),i)}initializePipeline(){return T({blending:F,colorWrite:R})}};var ie=class extends y{constructor(e,r,i){super(e,r,new f(jt,()=>import("./chunk-UTUVNT6S.js")),i)}initializePipeline(){return T({colorWrite:R})}};var Jt=[],ei=[new j(Y.POSITION,3,I.FLOAT,0,12)],ti=[new j(Y.POSITION,2,I.FLOAT,0,8)],ri=[new j(Y.POSITION,2,I.FLOAT,0,16),new j(Y.UV0,2,I.FLOAT,8,16)];var se=class extends Ot{constructor(t){super(t),this.produces=we.HIGHLIGHTS,this.consumes={required:[we.HIGHLIGHTS,"highlights"]},this.useMultipleHighlights=!!Qe("enable-feature:multiple-highlights"),this._optionsTexture=null,this._downsampleDrawParameters=new Vt,this._passParameters=new be,this._singleHighlightBlurDrawParameters=new kt,this._grid=new We,t.techniques.precompile(ee),this.useMultipleHighlights?t.techniques.precompile($):(t.techniques.precompile(te),t.techniques.precompile(ie),t.techniques.precompile(re))}initialize(){this.addHandles([q(()=>Fe(this.view.highlights),()=>{this._optionsTexture=P(this._optionsTexture),this.requestRender(X.UPDATE)},tt)])}destroy(){this._passParameters&&(this._passParameters.highlightOptionsTexture=null),this._grid.coverage=U(this._grid.coverage),this._grid.vao=P(this._grid.vao),this._optionsTexture=U(this._optionsTexture)}_updateOptionsTexture(t){let e=this.renderingContext,r=this._optionsTexture;if(r==null){let i=new fe(16,2);i.internalFormat=pt.RGBA,i.samplingMode=_e.NEAREST,r=new ye(e,i,null),this._optionsTexture=r}r.setData(t),this._passParameters.highlightOptionsTexture=r}render(t){let e=t.find(({name:c})=>c===we.HIGHLIGHTS),{techniques:r,bindParameters:i,_passParameters:s,renderingContext:o}=this;if(!i.decorations)return e;let a=r.acquire(ee);if(!a.compiled)return a.release(),this.requestRender(X.UPDATE),e;let h=t.find(({name:c})=>c==="highlights").getTexture(),n=()=>{let{highlights:c}=this.view;this._optionsTexture||this._updateOptionsTexture(nr(c)),s.highlightOptionsTexture=this._optionsTexture,this._gridUpdateResources(h);let C=this._gridComputeCoverage(a,h,i);a.release();let{horizontalCellCount:v,verticalCellCount:L}=C;return s.horizontalCellCount=v,s.verticalCellCount=L,s.coverageTexture=C.coverage?.getTexture(),C},l=c=>{let C=c.verticalCellCount*c.horizontalCellCount;o.bindVAO(c.vao),o.drawElementsInstanced(ct.TRIANGLES,6,I.UNSIGNED_BYTE,0,C)},{camera:g}=i,_=()=>{o.bindFramebuffer(e.fbo),o.setViewport4fv(g.fullViewport)};return this.useMultipleHighlights?this._renderMultiple(h,n,l,_):this._renderSingle(h,n,l,_),s.highlightTexture=null,s.coverageTexture=null,e}_renderMultiple(t,e,r,i){let{techniques:s,bindParameters:o,_passParameters:a,renderingContext:h}=this,n=s.acquire($);if(!n.compiled)return n.release(),void this.requestRender(X.UPDATE);let l=e();a.highlightTexture=t,a.pixelRatio=o.camera.pixelRatio,a.maxHighlightLevel=er(this.view.highlights)-1,h.bindTechnique(n,o,a),i(),r(l),n.release()}_renderSingle(t,e,r,i){let{fboCache:s,techniques:o,bindParameters:a,_passParameters:h,renderingContext:n}=this,l=o.acquire(te),g=o.acquire(ie),_=o.acquire(re);if(!_.compiled||!g.compiled||!l.compiled)return _.release(),g.release(),l.release(),void this.requestRender(X.UPDATE);let c=e(),{width:C,height:v}=t.descriptor;h.maxHighlightLevel=er(this.view.highlights)-1,h.highlightTexture=t;let{camera:L}=a,{fullWidth:or,fullHeight:ar,pixelRatio:Ye}=L,de=Math.ceil(or/Ye),De=Math.ceil(ar/Ye),{_singleHighlightBlurDrawParameters:G}=this;for(let Ae=0;Ae<=h.maxHighlightLevel;++Ae){h.highlightLevel=Ae,n.setClearColor(0,0,0,0);let ce=s.acquire(C,v,"single highlight",b.RG);n.bindFramebuffer(ce.fbo),n.setViewport(0,0,C,v),n.clear(E.COLOR),n.bindTechnique(l,a,h),r(c),G.blurInput=ce.getTexture(),B(G.blurSize,1/de,0);let ue=s.acquire(de,De,"single highlight blur h",b.RG);n.unbindTexture(ue.fbo?.colorTexture),n.bindFramebuffer(ue.fbo),n.setViewport(0,0,de,De),n.clear(E.COLOR),G.blurInput=ce.getTexture(),B(G.blurSize,1/de,0),n.bindTechnique(g,a,h,G),r(c),ce.release(),B(G.blurSize,0,1/De),h.singleHighlightBlurTexture=ue.getTexture(),i(),n.bindTechnique(_,a,h,G),r(c),ue.release()}l.release(),g.release(),_.release()}_gridUpdateResources(t){let e=this.renderingContext,r=this._grid,{width:i,height:s}=t.descriptor;if(r.horizontalCellCount=Math.ceil(i/J),r.verticalCellCount=Math.ceil(s/J),r.vao)return;let o=qe.createIndex(e,Ge.STATIC_DRAW,lr);r.vao=new bt(e,vt,new Map([["geometry",Jt]]),new Map([["geometry",qe.createVertex(e,Ge.STATIC_DRAW)]]),o)}_gridComputeCoverage(t,e,r){let i=this.renderingContext,s=this._grid,o=e.descriptor,a=Math.ceil(o.width/J),h=Math.ceil(o.height/J);this._downsampleDrawParameters.input=e,s.coverage?.release();let n=this.fboCache.acquire(a,h,"highlight coverage",b.RG);return s.coverage=n,i.bindFramebuffer(n.fbo),i.bindTechnique(t,r,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,a,h),i.screen.draw(),s}get test(){}};d([u()],se.prototype,"produces",void 0),d([u()],se.prototype,"consumes",void 0),d([u({constructOnly:!0})],se.prototype,"techniques",void 0),se=d([H("esri.views.3d.webgl-engine.effects.highlight.Highlight")],se);var We=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function nr(t){let e=new Uint8Array(128),r=(s,o)=>{e[s]=o},i=(s,o)=>{let a=4*s,h=4*s+64,{color:n}=o,l=o.haloColor??n;r(a+0,n.r),r(a+1,n.g),r(a+2,n.b),r(a+3,o.fillOpacity*n.a*255),r(h+0,l.r),r(h+1,l.g),r(h+2,l.b),r(h+3,o.haloOpacity*l.a*255)};return tr(t,(s,o)=>{i(o,s.options)}),e}var Kt=new Array(O),$t=new Array(O);function tr(t,e){let r=Math.min(t.length,O),i=O;for(let o=r-1;o>=0;--o){let a=t.at(o);if(a){let h=a.name;Kt.includes(h,i)||(--i,Kt[i]=h,$t[i]=o)}}let s=O-i;for(let o=0;o<s;++o){let a=$t[O-s+o];e(t.at(a),o)}}var hr=0;function Fe(t){let e=0,r=Math.min(O,t.length);for(let i=0;i<r;++i){let s=t.at(i);if(s){let{name:o,options:a}=s;e+=o.length;let{color:h,fillOpacity:n,haloColor:l,haloOpacity:g}=a;e+=h.r+(l?.r??1)+n+g}}{let i=t.at(0);if(i){let{shadowOpacity:s,shadowDifference:o,shadowColor:a}=i.options;e+=s+o+a.r}}return hr+++(e>=0?0:1)}var lr=new Uint8Array([0,1,2,2,1,3]);function rr(t,e,r,i,s,o,a=0,h){let{highlightGroupIndices:n}=s;n.clear();let l=[];tr(i,v=>{let{name:L}=v;n.set(L,l.length),l.push(L)});let g=n.size,{gl:_}=t;B(s.highlightMixOrigin,a,0);let c=null;g>1&&(c=e.acquire(r.width,r.height,"highlight mix",b.RG),t.bindFramebuffer(c.fbo),t.clearFramebuffer(at));let C=c?.getTexture()??null;s.highlightMixTexture=C,h();for(let v=0;v<g;++v)v>0&&(t.bindTexture(C,0),_.copyTexSubImage2D(ut.TEXTURE_2D,0,0,0,a,0,r.width,r.height),t.bindTexture(null,0)),t.clear(E.DEPTH),s.highlightLevel=v,s.highlightGroupName=l[v],o();c?.release()}function er(t){let e=new Set;for(let r=0;r<O;++r){let i=t.at(r)?.name;i&&e.add(i)}return e.size}var Oe=class{constructor(e,r,i,s){this._textures=e,this._techniques=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new xt}dispose(){this._textures.destroy()}acquire(e,r,i){if(this._ownMaterial(e),!e.produces.get(r)?.(i))return null;let o=this._id2glMaterialRef.get(i,e.id);if(o==null){let a=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:i});o=new Ve(a),this._id2glMaterialRef.set(i,e.id,o)}return o.ref(),o.glMaterial}release(e,r){let i=this._id2glMaterialRef.get(r,e.id);i!=null&&(i.unref(),i.referenced||(P(i.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Je.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Ve=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,dt(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var N;(function(t){t[t.Immediate=0]="Immediate",t[t.FadeWithWeather=1]="FadeWithWeather"})(N||(N={}));var ir=class{constructor(e,r){this.width=e,this.height=r}},Pe=class{constructor(e){this.shadowMap=e,this.slot=x.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=Te.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new W,this._inverseViewport=k(),this._oldLighting=new ve,this._newLighting=new ve,this._fadedLighting=new ve,this._lighting=this._newLighting,this.ssr=new Ne,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlightMixTexture=null,this.highlightGroupName=null,this.highlightGroupIndices=new Map,this.highlightLevel=0,this.highlightMixOrigin=k(),this.hudRenderStyle=Mt.Occluded,this.clouds=new Ht,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,r,i,s){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=r,this._newLighting.globalFactor=i,this._newLighting.set(e),s===N.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}},Ne=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=mt()}};var oe=class{constructor(e,r){this.rctx=e,this.lastFrameCamera=new W,this.output=m.Color,this.renderOccludedMask=ae,this.bind=new Pe(r),this.bind.alignPixelEnabled=!0}},sr=class extends oe{constructor(e,r,i){super(e,r),this.techniques=i,this.time=0}},ae=A.Occlude|A.OccludeAndTransparent|A.OccludeAndTransparentStencil;var w=class extends Ke{constructor(t){super(t),this._pending=new ze,this._changes=new Tt,this._renderers=new Map,this._sortedRenderers=new pe,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(let t of this._renderers.values())if(t.numGeometries!==0&&!t.queryRenderOccludedState(A.Occlude))return!0;return!1}get isEmpty(){return!this.updating&&this._renderers.size===0&&this._geometries.size===0}getMaterialRenderer(t){return this._renderers.get(t)}get sortedRenderers(){return this._sortedRenderers}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();let t=wt(this._changes),e=!1;return t.forEach((r,i)=>{let s=this._renderers.get(i);!s&&r.adds.length>0&&(s=new Rt({material:i}),s.initializeRenderContext(this.rendererContext.pluginContext,this._materials),this._renderers.set(i,s),e=!0),s&&(s.modify(r),s.numGeometries===0&&(this._renderers.delete(i),s.destroy(),e=!0))}),this._changes.clear(),e&&this._updateSortedMaterialRenderers(),this._hasHighlights=D(this._renderers,r=>{let i=r.produces.get(x.DRAPED_MATERIAL);return!!i&&i(m.Highlight)}),this._hasWater=D(this._renderers,r=>{let i=r.produces.get(x.DRAPED_WATER);return!!i&&i(m.Normal)}),this.notifyChange("updating"),!0}addGeometries(t,e){if(t.length===0)return;let r=this._validateRenderGeometries(t);for(let s of r)this._geometries.set(s.id,s);let i=this._pending.empty;for(let s of r)this._pending.adds.add(s);i&&this.notifyChange("updating"),e===Ee.UPDATE&&this._notifyGraphicGeometryChanged(t)}removeGeometries(t,e){let r=this._pending.empty,i=this._pending.adds;for(let s of t)i.has(s)?(this._pending.removed.add(s),i.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);r&&!this._pending.empty&&this.notifyChange("updating"),e===Ee.UPDATE&&this._notifyGraphicGeometryChanged(t)}modifyGeometries(t,e){let r=this._changes.updates.length===0;for(let i of t){let s=this._changes.updates.pushNew();s.renderGeometry=this._validateRenderGeometry(i),s.updateType=e}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),e){case Re.TRANSFORMATION:case Re.GEOMETRY:return this._notifyGraphicGeometryChanged(t);case Re.VISIBILITY:return this._notifyGraphicVisibilityChanged(t)}}updateAnimation(t){let e=!1;return this._sortedRenderers.forAll(r=>e=!!r.updateAnimation&&r.updateAnimation(t)||e),e}precompile(t){return this._sortedRenderers.reduce((e,r)=>r.precompile(t)||e,!1)}render(t){this._sortedRenderers.forAll(e=>{let r=e.acquireTechniques(t);r&&(e.render(t,r),yt(r))})}intersect(t,e,r,i,s){for(let o of this._geometries.values()){if(!i(o))continue;this._intersectRenderGeometry(o,r,e,0,t,s);let a=this.rendererContext.longitudeCyclical;a&&(o.boundingSphere[0]-o.boundingSphere[3]<a.min&&this._intersectRenderGeometry(o,r,e,a.range,t,s),o.boundingSphere[0]+o.boundingSphere[3]>a.max&&this._intersectRenderGeometry(o,r,e,-a.range,t,s)),s++}return s}_updateSortedMaterialRenderers(){this._sortedRenderers.clear();let t=0;for(let e of this._renderers.values())e.drapedPriority=t++,this._sortedRenderers.push(e);this._sortedRenderers.sort((e,r)=>r.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-r.drapedPriority:(r.material?.renderPriority||0)-(e.material?.renderPriority||0))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace(({renderGeometry:t})=>!this._pending.has(t)),this._pending.clear()}_intersectRenderGeometry(t,e,r,i,s,o){if(!t.visible||!t.material.visible)return;let a=0;i+=t.transformation[12],a=t.transformation[13],Ue[0]=r[0]-i,Ue[1]=r[1]-a,t.screenToWorldRatio=this.rendererContext.screenToWorldRatio,t.material.intersectDraped(t,null,s,Ue,(h,n,l)=>{dr(e,l,o,t.material.renderPriority,s,t.layerUid,t.graphicUid)},e)}_notifyGraphicGeometryChanged(t){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let e;for(let{graphicUid:r}of t)r!=null&&r!==e&&(this.drapeSource.notifyGraphicGeometryChanged(r),e=r)}_notifyGraphicVisibilityChanged(t){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let e;for(let{graphicUid:r}of t)r!=null&&r!==e&&(this.drapeSource.notifyGraphicVisibilityChanged(r),e=r)}_validateRenderGeometries(t){for(let e of t)this._validateRenderGeometry(e);return t}_validateRenderGeometry(t){return t.localOrigin==null&&(t.localOrigin=this._localOriginFactory.getOrigin(t.boundingSphere)),t}get test(){}};d([u()],w.prototype,"drapeSource",void 0),d([u()],w.prototype,"updating",null),d([u()],w.prototype,"rctx",null),d([u({constructOnly:!0})],w.prototype,"rendererContext",void 0),d([u()],w.prototype,"_materials",null),d([u()],w.prototype,"_localOriginFactory",null),d([u({readOnly:!0})],w.prototype,"isEmpty",null),d([u()],w.prototype,"_renderers",void 0),d([u()],w.prototype,"_geometries",void 0),w=d([H("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],w);var ze=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function dr(t,e,r,i,s,o,a){let h=new Gt(o,a,e),n=l=>{l.set(Ct.OVERLAY,h,t.dist,t.normal,t.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&n(s.results.min),s.options.store!==Ie.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&n(s.results.max),s.options.store===Ie.ALL){let l=St(s.ray);n(l),s.results.all.push(l)}}var Ue=k();var ne=class extends y{constructor(e,r,i){super(e,r,new f(Ft,()=>import("./chunk-KQVRTHVG.js")),i)}initializePipeline(e){return e.hasAlpha?T({blending:F,colorWrite:R}):T({colorWrite:R})}};var he=class extends Dt{constructor(){super(...arguments),this.hasAlpha=!1}};d([At()],he.prototype,"hasAlpha",void 0);var le=class extends y{constructor(e,r,i){super(e,r,new f(Qt,()=>import("./chunk-ND5P2Q5N.js")),i)}};var S=class extends ft{constructor(t){super(t),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Zt,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new pe,this._passParameters=new Wt,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new W,this.worldToPCSRatio=1,this.events=new $e,this.longitudeCyclical=null,this.produces=new Map([[x.DRAPED_MATERIAL,e=>e!==m.Highlight||this.hasHighlights],[x.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){let{view:t}=this,{_stage:e}=t,r=e.renderer.fboCache,i=e.renderView,{waterTextures:s,textures:o}=i;this._renderContext=new oe(this._rctx,new Xt(r,t.state.viewingMode)),this.addHandles([q(()=>s.updating,()=>this.events.emit("content-changed"),ge),q(()=>this.spatialReference,n=>this._localOriginFactory=new Yt(n),ge),et(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),q(()=>Fe(this.view.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,ge)]),this._materials=new Oe(o,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));let{_bindParameters:a,_camera:h}=this;a.slot=x.DRAPED_MATERIAL,a.mainDepth=null,h.near=1,h.far=1e4,h.relativeElevation=null,a.camera=this._camera,a.oitPass=Te.NONE,a.updateLighting([new Pt(it())],0,0,N.Immediate),this.addHandles(this.view.resourceController.scheduler.registerTask(nt.STAGE,this))}destroy(){this._renderers.forEach(t=>t.destroy()),this._renderers.clear(),this._passParameters.texture=P(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this.view._stage.renderView.renderingContext}get _techniques(){return this.view._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(t){this._pluginContext=t,this._techniques.precompile(le)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||D(this._renderers,t=>t.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(t){for(let e of this._renderers.values()){let r=e.getMaterialRenderer(t);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(t=>t.drapeSource.layer).filter(t=>!!t)}createGeometryDrapeSourceRenderer(t){return this.createDrapeSourceRenderer(t,w)}createDrapeSourceRenderer(t,e,r){let i=this._renderers.get(t);i?.destroy();let s=new e(Ze(Xe({},r),{rendererContext:this,drapeSource:t}));return this._renderers.set(t,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in t&&this.addHandles(q(()=>t.fullOpacity,()=>this.events.emit("content-changed")),t),s}removeDrapeSourceRenderer(t){if(t==null)return;let e=this._renderers.get(t);e!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(t),this.removeHandles(t),e.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(t){this._hasTargetWithoutRasterImage=!!this._overlays&&me(t,e=>e.drapeTargetType===Et.WithoutRasterImage)}ensureDrapeSources(t){this._overlays?(this._hasDrapedFeatureSource=me(t,e=>e.drapeSourceType===Z.Features),this._hasDrapedRasterSource=me(t,e=>e.drapeSourceType===Z.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(t,e,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new Se(this.view._stage.renderer.fboCache),this._overlays=[new K,new K]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=P(this._renderTargets),this.events.emit("textures-disposed")}getTexture(t){if(t!=null)return t===p.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(p.Color):this._renderTargets?.getTexture(t)}get running(){return this.updating}runTask(t){this._processDrapeSources(t,()=>!0)}_processDrapeSources(t,e){let r=!1;for(let[i,s]of this._renderers){if(t.done)break;(i.destroyed||e(i))&&s.commitChanges()&&(r=!0,t.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=D(this._renderers,i=>i.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(ht,t=>t.updatePolicy===It.SYNC)}get isEmpty(){return!xe.OVERLAY_DRAW_DEBUG_TEXTURE&&!D(this._renderers,t=>!t.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){let t=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Be,++this._techniques.precompiling;let e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=t,e}renders(t){if(xe.OVERLAY_DRAW_DEBUG_TEXTURE&&t!==p.Occluded&&t!==p.Highlight)return!0;++this._techniques.precompiling;let e=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,e}get mode(){return this.isEmpty?Q.Disabled:this._renderTargets?.getTexture(p.WaterNormal)?Q.EnabledWithWater:this._renderTargets?.getTexture(p.Color)?Q.Enabled:Q.Disabled}updateAnimation(t){let e=!1;return this._renderers.forEach(r=>e=r.updateAnimation(t)||e),e}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(t){if(this._renderTargets){this._bindParameters.alignPixelEnabled=t.alignPixelEnabled,this._bindParameters.highlightGroupName=null,++this._techniques.precompiling;for(let e of this._renderTargets.targets){if(e.content===p.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=e.output;this._renderContext.output=r,this._bindParameters.slot=r===m.Normal?x.DRAPED_WATER:x.DRAPED_MATERIAL,e.content===p.Occluded&&(this._renderContext.renderOccludedMask=Be),this._sortedRenderers.forAll(({drapeSource:i,renderer:s})=>{e.content===p.ColorNoRasterImage&&i.drapeSourceType===Z.RasterImage||s.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=ae}--this._techniques.precompiling}}drawOverlays(t){if(this._overlays&&this._renderTargets){for(let e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryView();this._bindParameters.alignPixelEnabled=t.alignPixelEnabled;for(let e of this._renderTargets.targets){if(e.content===p.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;let r=this._drawTarget(V.INNER,e,t),i=this._drawTarget(V.OUTER,e,t);(r||i)&&e.fbo.generateMipMap()}}}_drawTarget(t,e,r){let i=this._overlays[t],s=i.canvasGeometries;if(s.numViews===0)return!1;let{contentPixelRatio:o}=r;this._screenToWorldRatio=o*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;let a=e.output;if(this.isEmpty||a===m.Normal&&!this.hasWater||!i.hasSomeSizedView())return!1;let{_rctx:h,_bindParameters:n}=this;if(this._camera.pixelRatio=i.pixelRatio*o,this._renderContext.output=a,n.screenToWorldRatio=this._screenToWorldRatio,n.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,n.slot=a===m.Normal?x.DRAPED_WATER:x.DRAPED_MATERIAL,e.content===p.Occluded&&(this._renderContext.renderOccludedMask=Be),n.highlightGroupName=null,!this.renders(e.content))return this._renderContext.renderOccludedMask=ae,!1;let{resolution:l}=i,g=t===V.INNER?0:l;if(h.setViewport(g,0,l,l),this._bindTargetFBO(e),t===V.INNER&&(h.setClearColor(0,0,0,0),h.clear(E.COLOR)),xe.OVERLAY_DRAW_DEBUG_TEXTURE&&e.content!==p.Occluded&&e.content!==p.Highlight){this._techniques.precompile(ne,je);let _=this._techniques.acquire(ne,je);for(let c=0;c<s.numViews;c++)this._setViewParameters(s.extents[c],i),this._ensureDebugPatternResources(i.resolution,cr[t]),h.bindTechnique(_,n,this._passParameters),h.screen.draw();_.release()}if(e.output===m.Highlight){let{fboCache:_}=this.view._stage.renderer,c=this._resolution;rr(h,_,{width:c,height:c},this.view.highlights,n,()=>this._renderAllGeometry(t,e),g,()=>this._bindTargetFBO(e))}else this._renderAllGeometry(t,e);return h.bindFramebuffer(null),this._renderContext.renderOccludedMask=ae,!0}_renderAllGeometry(t,e){let r=this._overlays[t],i=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:s,renderer:o})=>{if(e.content===p.ColorNoRasterImage&&s.drapeSourceType===Z.RasterImage)return;let{fullOpacity:a}=s,h=a!=null&&a<1&&e.output===m.Color&&this._bindTemporaryFBO();for(let n=0;n<i.numViews;n++)this._setViewParameters(i.extents[n],r),o.render(this._renderContext);if(h){this._bindTargetFBO(e),this._overlayParameters.texture=h.getTexture(),this._overlayParameters.opacity=a,this._overlayParameters.overlayIndex=t;let n=this._techniques.acquire(le);this._rctx.bindTechnique(n,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),n.release(),h.release()}})}_bindTargetFBO(t){let e=this._resolution,r=2*e;t.fbo.bind(this._rctx,r,e)}_bindTemporaryFBO(){let t=this._resolution,e=2*t,r=this.view._stage.renderer.fboCache,i=r.acquire(e,t,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(E.COLOR),i}get _resolution(){return this._overlays?.[V.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(t,e,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(let{renderer:o}of this._sortedRenderers)s=o.intersect?.(t,e,r,i,s)??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let t=this.view.map.allLayers,e=t.length;this._renderers.forEach((r,i)=>{let s=t.indexOf(i.layer),o=s>=0,a=i.renderGroup??(o?Le.MapLayer:Le.ViewLayer),h=e*a+(o?s:0);this._sortedRenderers.push(new ke(i,r,h))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(t,e){let r=this._camera;r.viewport=[0,0,e.resolution,e.resolution],ot(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),st(r.viewMatrix,[-t[0],-t[1],0])}_updateHasWater(){let t=D(this._renderers,e=>e.hasWater);t!==this._hasWater&&(this._hasWater=t,this.events.emit("has-water"))}_ensureDebugPatternResources(t,e){if(lt(this._passParameters.color,e[0],e[1],e[2]),this._passParameters.texture)return;let r=new Uint8Array(t*t*4),i=0;for(let o=0;o<t;o++)for(let a=0;a<t;a++){let h=Math.floor(a/10),n=Math.floor(o/10);h<2||n<2||10*h>t-20||10*n>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&h&&1&n?1&a^1&o?0:255:1&h^1&n?0:128)}let s=new fe(t);s.samplingMode=_e.NEAREST,this._passParameters.texture=new ye(this._rctx,s,r)}get test(){}};d([u()],S.prototype,"hasHighlights",void 0),d([u()],S.prototype,"_sortedDrapeSourceRenderersDirty",void 0),d([u({constructOnly:!0})],S.prototype,"view",void 0),d([u({readOnly:!0})],S.prototype,"_techniques",null),d([u()],S.prototype,"worldToPCSRatio",void 0),d([u()],S.prototype,"spatialReference",void 0),d([u({type:Boolean,readOnly:!0})],S.prototype,"updating",null),d([u()],S.prototype,"isEmpty",null),d([u({readOnly:!0})],S.prototype,"rendersOccludedDraped",null),S=d([H("esri.views.3d.terrain.OverlayRenderer")],S);var ke=class{constructor(e,r,i){this.drapeSource=e,this.renderer=r,this.index=i}},cr=[[1,.5,.5],[.5,.5,1]],Io=-2,Be=A.OccludeAndTransparent,je=new he;je.hasAlpha=!0;export{ei as a,ti as b,ri as c,se as d,rr as e,Oe as f,N as g,ir as h,Pe as i,sr as j,ae as k,w as l,ne as m,he as n,S as o,Io as p,Be as q};
