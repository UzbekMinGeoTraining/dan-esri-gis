import{a as ra}from"./chunk-ZBUUWISZ.js";import{b as Yi}from"./chunk-E43YKIMQ.js";import{$ as Us,$a as Zs,A as H,B as Xe,Ba as Hs,C as re,Ca as Se,D as As,Da as Ns,E as Z,Ea as de,F as Ye,Fa as Ve,Ga as $,Ha as K,I as Rs,Ia as it,J as Os,Ja as Le,K as se,Ka as Gs,L as Gt,La as st,M as Ls,Ma as at,N as be,Na as He,O as jt,Oa as Qt,P as Qe,Pa as Jt,Qa as ei,R as Ae,Ra as js,S as Re,Sa as ti,T as Wt,Ta as Ee,U as Tt,Ua as Ws,V as Es,Va as rt,W as $i,Wa as ot,X as $t,Xa as nt,Y as he,Ya as lt,Z as zt,Za as $s,_ as ze,_a as Ks,a as L,ab as ii,b as me,ba as Oe,bb as Xs,c as Vt,ca as Kt,cb as Ys,d as Gi,da as qs,db as Qs,e as Bt,ea as X,f as Ht,fa as W,g as ji,ga as ks,gb as Js,h as Wi,ha as w,ia as k,j as Ms,ja as z,ka as G,la as ve,lb as ea,m as Ps,ma as Zt,mb as ta,n as _s,na as Je,o as Ds,oa as Bs,p as Is,pa as et,qa as ae,r as ce,ra as Xt,s as Q,sa as Ki,t as n,u as y,ua as J,v as M,va as Yt,w as T,wa as tt,x as wt,xa as Zi,y as Nt,z as Cs}from"./chunk-AN522XY4.js";import{y as Fs}from"./chunk-4HNIM6ZU.js";import{b as ue,c as Mt,g as oe,h as sa,i as aa,j as C,k as N,l as O,m as A,n as E,o as Ue}from"./chunk-JLO7PPGZ.js";import{a as Xi}from"./chunk-YNYZNNM2.js";import{a as Ft}from"./chunk-JU3UMX5L.js";import{a as ia}from"./chunk-SDC4SION.js";import{a as Ut,b as Ts,c as kt}from"./chunk-243IQYOZ.js";import{a as vs}from"./chunk-UJ2T4QLZ.js";import{a as Ni}from"./chunk-26R336GJ.js";import{b as Ze,d as qt}from"./chunk-OC7V2CEX.js";import{L as Hi,e as Ss,s as Bi,t as Vs}from"./chunk-PXLEIVAM.js";import{a as zs}from"./chunk-AXPRNSO3.js";import{c as ws}from"./chunk-U4Y7WABQ.js";import{e as gs,g as xs}from"./chunk-NH3JQE75.js";import{a as bs}from"./chunk-3IK5VXZ3.js";import{a as ys}from"./chunk-THY6AAMN.js";import{a as bt,b as Rt,h as ee,i as hs,j as Ot,k as vt,l as St,p as Lt,q as Et,r as ki}from"./chunk-BDF7KEUQ.js";import{a as Te,c as qi}from"./chunk-YFBPRKIN.js";import{da as fs}from"./chunk-4DLSYLKE.js";import{a as u,b as q}from"./chunk-BMVJCP2M.js";import{u as ds}from"./chunk-GMC3I5VG.js";import{c as Ui}from"./chunk-WGF2T2BG.js";import{n as ms,r as At,t as cs}from"./chunk-3IBUFXWY.js";import{a as Ke,b as us,u as ps}from"./chunk-BP73DJTS.js";import{a as m,b as h,g as xt}from"./chunk-JEGVIFEP.js";var Pt={[ee.BYTE]:1,[ee.UNSIGNED_BYTE]:1,[ee.SHORT]:2,[ee.UNSIGNED_SHORT]:2,[ee.HALF_FLOAT]:2,[ee.INT]:4,[ee.UNSIGNED_INT]:4,[ee.FLOAT]:4};var si=class{constructor(e,t){this._boundPart=null,this.vertexBuffers=new Map;for(let[a,r]of Object.entries(t.vertex)){let o=Ni.createVertex(e,ki.STATIC_DRAW,r);this.vertexBuffers.set(a,o)}let i=new Map;for(let[a,r]of Object.entries(t.index??{})){let o=Ni.createIndex(e,ki.STATIC_DRAW,r);i.set(a,o)}this.groups=[];for(let a of t.groups){let r;if(a.index!=null){if(!t.index?.[a.index])throw new Error("No index data.");let{BYTES_PER_ELEMENT:c}=t.index[a.index];c===2?r=ee.UNSIGNED_SHORT:c===4&&(r=ee.UNSIGNED_INT)}let o=a.index!=null?i.get(a.index):null,l=new Map,p=new Map;for(let c of a.attributes){let{name:d,count:g,type:b,offset:x,normalized:v,divisor:S,stride:V,vertex:D,location:B}=c,j=p.get(D);j||(j=[],p.set(D,j));let P=new ys(d,g,b,x,V,v,S);j.push(P),l.set(d,B)}let f=new ia(e,l,p,this.vertexBuffers,o);this.groups.push(h(m({},a),{vertexArray:f,locations:l,layout:p,indexing:r}))}this.parts=t.parts}bind(e,t){this._boundPart=t;let{group:i}=this.parts[this._boundPart],{vertexArray:a}=this.groups[i];e.bindVAO(a)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");let{start:t,count:i}=this.parts[this._boundPart],{group:a}=this.parts[this._boundPart],{indexing:r,primitive:o}=this.groups[a];r?e.drawElements(o,i,r,t*Pt[r]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(let{vertexArray:e}of this.groups)e.dispose()}};var va={position:{type:ee.SHORT,count:2}},ai=class s extends si{static create(e,t,i){let a=[],{stride:r}=t;if(r==null){r=0;for(let[d,{count:g,type:b,offset:x}]of Object.entries(t.layout)){if(x!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=g*Pt[b]}}let o=0;for(let[d,{count:g,offset:b,type:x,normalized:v}]of Object.entries(t.layout)){b!=null&&(o=b);let S=i.get(d);if(S==null)throw new Error("Locations must be specified at mesh initialization.");let V={name:d,location:S,vertex:"vertexData",count:g,type:x,offset:o,stride:r,divisor:0,normalized:v!=null&&v};a.push(V),o+=g*Pt[x]}let l={attributes:a,primitive:t.primitive};t.index!=null&&(l.index="indexData");let{count:p}=t;if(p==null&&(p=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(p)!==p))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);let f={start:0,count:p,group:0,primitive:t.primitive},c={vertex:{vertexData:t.vertex},parts:[f],groups:[l]};return t.index!=null&&(c.index={indexData:t.index}),new s(e,c,t.layout)}static fromVertexStream(e,t){return s.create(e,{primitive:Rt.TRIANGLE_STRIP,vertex:new Uint16Array(t),layout:va},new Map([["position",0]]))}constructor(e,t,i){super(e,t),this._spec=i}bind(e,t=0){super.bind(e,t)}};var Qi=class{get forceStaticPath(){return Ke("esri-cim-animations-enable-status")==="disabled"}get forceAnimatedPath(){return Ke("esri-cim-animations-enable-status")==="forced"}get freezeGlobalTime(){return Ke("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!Ke("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return Ke("esri-cim-animations-freeze-time")!==!1}},ut=new Qi;var ye=class extends ae{};u([z(n)],ye.prototype,"globalTime",void 0),u([z(y)],ye.prototype,"animationTextureSize",void 0),u([z(Q)],ye.prototype,"animationTexture",void 0),u([z(H)],ye.prototype,"toScreen",void 0),u([z(H)],ye.prototype,"toNdc",void 0),u([z(n)],ye.prototype,"mapRotation",void 0),u([z(n)],ye.prototype,"pixelRatio",void 0);var Fe=class extends ae{getVVRotationMat4(e){return Z(Ki(e),Xe.identity(),()=>{let t=this.getNormalizedAngle(e).multiply(Gi),i=Oe(t),a=Re(t);return new Xe(a,i,0,0,i.multiply(new n(-1)),a,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return Z(Ki(e),H.identity(),()=>{let t=this.getNormalizedAngle(e).multiply(Gi),i=Oe(t),a=Re(t);return new H(a,i,0,i.multiply(new n(-1)),a,0,0,0,1)})}getNormalizedAngle(e){let t=se(this.rotationType,new n(Vt.Arithmatic));return Z(t,new n(90).subtract(e),e)}};u([z(n)],Fe.prototype,"rotationType",void 0);var pt=class extends Se{};u([w(3,T)],pt.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),u([w(4,y)],pt.prototype,"zoomRange",void 0);var ri=class extends de{},pe=class extends Ve{_getScreenPosition(e){let{pos:t,translation:i,rotation:a,scale:r,offset:o,id:l,vvScale:p}=e,f=js(this,l).multiply(Math.PI/180),c=i.x.multiply(4/3),d=i.y.multiply(-1).multiply(4/3),g=Oe(a.subtract(f)),b=Re(a.subtract(f)),x=new n(0),v=new n(1),{pixelRatio:S}=this.animationInfo,V=new H(v,x,x,x,v,x,c.multiply(S),d.multiply(S),v),D=new H(b,g.multiply(-1),x,g,b,x,0,0,v),B=r.multiply(p).multiply(S).multiply(4/3),j=D.multiply(B),P=this.animationInfo.toScreen.multiply(new M(t,1)),_=V.multiply(P).xy,I=j.multiply(new M(o,0)).xy;return _.add(I)}_clip(e,t){let i=super.clip(e,t),a=Ls(this._getLocalTimeOrigin(e),new n(0));return ut.forceGlobalTimeOrigin||(i=i.add(Ye([a,()=>new n(2)],[!0,()=>new n(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new M(e,1)).xy}_getEvalParams(e,t){let{globalTime:i,animationTextureSize:a,animationTexture:r}=this.animationInfo;return{globalTime:i,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:a,animationTexture:r,pixelDimensions:t}}_getColor(e,t){return Z(se(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return W(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=W(this.mosaicInfo.texture,e),a=new n(.5).subtract(tt(i)).multiply(t.distanceToPx).multiply(Ht),r=Ae(new n(.5).subtract(a),new n(0),new n(1)),o=t.color.multiply(r),l=t.outlineSize.multiply(.5),p=Qe(a).subtract(l),f=Ae(new n(.5).subtract(p),new n(0),new n(1)),c=t.outlineColor.multiply(f);return new n(1).subtract(c.a).multiply(o).add(c)}};function Ne(s,e,t){let i=s.add(new y(e,0)),a=W(t.animationTexture,i.add(.5).divide(t.animationTextureSize)).xy;return s=s.add(a),As(m({animationPointer:s},t),T,null,r=>{let{out:o}=r;if(!o)throw new Error("out is null");return ea(h(m({},r),{out:o}))})}u([z(Ee)],pe.prototype,"mosaicInfo",void 0),u([z(ye)],pe.prototype,"animationInfo",void 0),u([G(st)],pe.prototype,"visualVariableColor",void 0),u([G(at)],pe.prototype,"visualVariableOpacity",void 0),u([G(rt)],pe.prototype,"visualVariableSizeMinMaxValue",void 0),u([G(ot)],pe.prototype,"visualVariableSizeScaleStops",void 0),u([G(nt)],pe.prototype,"visualVariableSizeStops",void 0),u([G(lt)],pe.prototype,"visualVariableSizeUnitValue",void 0),u([G(Fe)],pe.prototype,"visualVariableRotation",void 0);var Me;(function(s){s[s.transform=0]="transform",s[s.fromColor=1]="fromColor",s[s.toColor=2]="toColor",s[s.colorMix=3]="colorMix",s[s.toOpacity=4]="toOpacity",s[s.opacityMix=5]="opacityMix"})(Me||(Me={}));var Ge=class extends pt{};u([w(5,y)],Ge.prototype,"offset",void 0),u([w(6,y)],Ge.prototype,"uv",void 0),u([w(7,T)],Ge.prototype,"sizing",void 0),u([w(8,n)],Ge.prototype,"angle",void 0);var je=class extends Je{};u([w(12,y)],je.prototype,"offsetNextVertex1",void 0),u([w(13,y)],je.prototype,"offsetNextVertex2",void 0),u([w(14,y)],je.prototype,"textureUVNextVertex1",void 0),u([w(15,y)],je.prototype,"textureUVNextVertex2",void 0);var Ji=class extends ri{};function Pe(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}var mt=class extends pe{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}_vertexPreamble(e){let{id:t,pos:i,offset:a,animationPointerAndBaseSizeAndReferenceSize:r,uv:o,sizing:l,angle:p}=e,f=r.xy,c=r.z,d=r.w,g=l.xy,b=l.z,x=J(e.bitset,me.bitset.isStroke),v=l.w,S=J(e.bitset,me.bitset.scaleSymbolsProportionally),V=this._getEvalParams(e,g),D=Ne(f,Me.transform,V),B=Ye([se(J(e.bitset,me.bitset.isMapAligned),new n(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new n(0)]),j=new Cs(Re(B),Oe(B.multiply(-1)),Oe(B),Re(B)).multiply(D.xy),P=D.z.subtract(B).subtract(p.multiply(Bt)),_=D.w,I=J(e.bitset,me.bitset.isSDF),U=He(this,t,new n(d)).divide(new n(d));return{baseSize:c,animationPointer:f,strokeWidth:b,isOutline:x,unscaledDistanceToPx:v,scaleSymbolsProportionally:S,isSDF:I,position:this._getScreenPosition({id:t,pos:i,offset:a,referenceSize:d,translation:j,rotation:P,scale:_,vvScale:U}),uv:o,evalParams:V,vvScale:U,scale:_}}vertex(e,t){let{position:i,animationPointer:a,evalParams:r,isOutline:o,unscaledDistanceToPx:l,vvScale:p,uv:f,strokeWidth:c,scaleSymbolsProportionally:d,scale:g,isSDF:b,baseSize:x}=this._vertexPreamble(e),v=this._toNdc(i),S=Ne(a,Me.fromColor,r);S=new T(S.rgb.multiply(S.a),S.a);let V=Ne(a,Me.toColor,r);V=new T(V.rgb.multiply(V.a),V.a);let D=Ne(a,Me.colorMix,r);D=new T(D.rgb.multiply(D.a),D.a);let B=Ne(a,Me.toOpacity,r).a,j=Ne(a,Me.opacityMix,r).a,P=Qt(this,e.id,S,jt(Yt(e.bitset,me.bitset.colorLocked),new wt(o))),_=ze(P,V,D),I=Jt(this,e.id),U=ze(I,B,j),F=_.multiply(U),gt=this.clip(e.id,e.zoomRange),$e=l.multiply(p);return m({glPosition:new T(v,gt,1),uv:f.divide(this.mosaicInfo.size),color:F.multiply(new n(1).subtract(o)),outlineColor:F.multiply(o),distanceToPx:$e,strokeWidth:c.multiply(ze(new n(1),g,d)),isOutline:o,isSDF:b},this.maybeRunHittest(e,t,{pos:e.pos,size:x,sizeCorrection:new n(1),isMapAligned:new n(1),vvRotationMat3:new H(1,0,0,0,1,0,0,0,1),placementMat3:new H(1,0,0,0,1,0,0,0,1),outlineSize:new n(1),distanceToPx:$e,isSDF:b}))}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return ut.spotlightAnimatedSymbols&&(t=t.add(new T(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return Z(Gt(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){let{position:a,distance:r,smallSymbolDistance:o}=this.hittestRequest,l=r.subtract(o),{viewMat3:p,tileMat3:f}=this.view,c=p.multiply(f).multiply(new M(i.pos,1)).xy,d=i.size.multiply(.5);return Wt(c,a).subtract(d).add(l)}_hittestMarker(e,t,i){let a=this._vertexPreamble(m({},e)).position,r=this._vertexPreamble(h(m({},e),{offset:t.offsetNextVertex1,uv:t.textureUVNextVertex1})).position,o=this._vertexPreamble(h(m({},e),{offset:t.offsetNextVertex2,uv:t.textureUVNextVertex2})).position,l=this.hittestRequest.position,p=this.hittestRequest.distance,f=it(l,a,r,o);return Z(be(f,p),f,this._hittestSamples(a,r,o,e,t,i))}_hittestSamples(e,t,i,a,r,o){let{outlineSize:l,isSDF:p,distanceToPx:f}=o,c=this.hittestRequest.position,d=this.hittestRequest.distance,g=K(c.add(new y(re(d),re(d))),e,t,i),b=K(c.add(new y(0,re(d))),e,t,i),x=K(c.add(new y(d,re(d))),e,t,i),v=K(c.add(new y(re(d),0)),e,t,i),S=K(c,e,t,i),V=K(c.add(new y(d,0)),e,t,i),D=K(c.add(new y(re(d),d)),e,t,i),B=K(c.add(new y(0,d)),e,t,i),j=K(c.add(new y(d,d)),e,t,i),P=a.uv.divide(this.mosaicInfo.size),_=r.textureUVNextVertex1.divide(this.mosaicInfo.size),I=r.textureUVNextVertex2.divide(this.mosaicInfo.size),U={color:new T(1,1,1,1),outlineSize:l,outlineColor:new T(1,1,1,1),isSDF:p,distanceToPx:f},F=new n(0);return F=F.add($(g).multiply(this._getColor(Pe(g,P,_,I),U).a)),F=F.add($(b).multiply(this._getColor(Pe(b,P,_,I),U).a)),F=F.add($(x).multiply(this._getColor(Pe(x,P,_,I),U).a)),F=F.add($(v).multiply(this._getColor(Pe(v,P,_,I),U).a)),F=F.add($(S).multiply(this._getColor(Pe(S,P,_,I),U).a)),F=F.add($(V).multiply(this._getColor(Pe(V,P,_,I),U).a)),F=F.add($(D).multiply(this._getColor(Pe(D,P,_,I),U).a)),F=F.add($(B).multiply(this._getColor(Pe(B,P,_,I),U).a)),F=F.add($(j).multiply(this._getColor(Pe(j,P,_,I),U).a)),X(F,new n(.05)).multiply(Le(this.hittestRequest))}};u([q(0,k(Ge)),q(1,k(je))],mt.prototype,"vertex",null),u([q(0,k(Ji))],mt.prototype,"fragment",null);var oi=class{constructor(){this.drawPhase=ue.MAP|ue.HITTEST|ue.HIGHLIGHT|ue.DEBUG}startup(){}shutdown(e){}};var R=class extends oi{constructor(){super(...arguments),this.symbologyPlane=oe.FILL,this._input=null}};var ni=class extends R{render(e,t){let{context:i,painter:a}=e,{target:r}=t,{freezeGlobalTime:o}=ut,l=0,p=a.textureManager.animationStore.getTexture(i,l),f=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],c=Array.from(gs(Xi(),f)),d=Array.from(xs(Xi(),c,r.transforms.displayViewScreenMat3)),g=t.instance.getInput();a.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,g.uniforms)),O(e,t.target)),{mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey,!0),animationInfo:{globalTime:o===!1?e.time/1e3:o,animationTextureSize:[p.descriptor.width,p.descriptor.height],animationTexture:{unit:6,texture:p},toScreen:d,toNdc:f,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio}}),defines:m({},A(e)),optionalAttributes:{zoomRange:!0},useComputeBuffer:!0}),a.setPipelineState(m({},E(e))),a.submitDraw(e,t),o===!1&&r.requestRender()}};var li=class extends ni{constructor(){super(...arguments),this.type=L.AnimatedMarker,this.shaders={geometry:new mt}}};function oa(s){return s.locationsMap}var Uo={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};var ui=class extends Zt{};u([w(0,y)],ui.prototype,"pos",void 0);var es=class extends de{},pi=class extends ae{};u([z(n)],pi.prototype,"dotSize",void 0);var ct=class extends ae{};u([z(Q)],ct.prototype,"locations",void 0),u([z(n)],ct.prototype,"pixelRatio",void 0),u([z(n)],ct.prototype,"tileZoomFactor",void 0);var Sa=1e-6,_e=class extends Xt{vertex(e){let t=new H(1,0,0,0,-1,0,0,1,1).multiply(new M(e.pos.xy.divide(512),1)),i=W(this.draw.locations,t.xy),a=he(this.instance.dotSize.divide(2),new n(1)),r=new n(0);r=r.add(X(i.a,new n(Sa)).multiply(2));let o=a.add(this.instance.dotSize),l=this.view.displayViewScreenMat3.multiply(new M(e.pos.add(.5),1)),p=new T(l.xy,r,1),f=this.instance.dotSize.divide(o),c=new n(-1).divide(a.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:p,glPointSize:o,color:i,ratio:f,invEdgeRatio:c}}fragment(e){let t=$t(e.glPointCoord.subtract(.5)).multiply(2),i=Kt(new n(0),new n(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),a=new et;return a.glFragColor=e.color.multiply(i),a}};u([z(pi)],_e.prototype,"instance",void 0),u([z(ct)],_e.prototype,"draw",void 0),u([z(Hs)],_e.prototype,"view",void 0),u([q(0,k(ui))],_e.prototype,"vertex",null),u([q(0,k(es))],_e.prototype,"fragment",null);var mi=class extends Se{};u([w(3,n)],mi.prototype,"inverseArea",void 0);var dt=class extends ae{};u([z(ce.ofType(T,2))],dt.prototype,"isActive",void 0),u([z(ce.ofType(T,8))],dt.prototype,"colors",void 0),u([z(n)],dt.prototype,"dotValue",void 0);var qe=class extends ae{};u([z(Q)],qe.prototype,"dotTexture0",void 0),u([z(Q)],qe.prototype,"dotTexture1",void 0),u([z(n)],qe.prototype,"tileZoomFactor",void 0),u([z(n)],qe.prototype,"pixelRatio",void 0),u([z(n)],qe.prototype,"tileDotsOverArea",void 0);var De=class extends Ve{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){let t=new H(2/512,0,0,0,-2/512,0,-1,1,1).multiply(new M(e.pos,1)),i=this.clip(e.id),a=new T(t.xy,i,1),r=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(512).divide(this.draw.pixelRatio),p=this._dotThreshold(r,this.instance.dotValue,this.draw.tileDotsOverArea),f=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),c=e.pos.add(.5).divide(l);return{glPosition:a,color:new T(0,0,0,0),textureCoords:c,thresholds0:p,thresholds1:f}}fragment(e){let t=new et,i=W(this.draw.dotTexture0,e.textureCoords),a=W(this.draw.dotTexture1,e.textureCoords),r=e.thresholds0.subtract(i),o=e.thresholds1.subtract(a),l,p=Xe.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),f=Xe.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){let c=X(new n(0),r),d=X(new n(0),o),g=Tt(c,r).add(Tt(d,o)),b=X(g,new n(0)),x=new n(1).subtract(b),v=g.add(b),S=r.multiply(c).divide(v),V=o.multiply(d).divide(v),D=p.multiply(S).add(f.multiply(V));l=x.multiply(D)}else{let c=he(Zi(r),Zi(o)),d=X(c,new n(0)),g=new n(1).subtract(d),b=X(c,r),x=X(c,o),v=p.multiply(b).add(f.multiply(x));l=g.multiply(v)}return t.glFragColor=l,t}hittest(e){return Le(this.hittestRequest)}};u([ve],De.prototype,"blending",void 0),u([z(dt)],De.prototype,"instance",void 0),u([z(qe)],De.prototype,"draw",void 0),u([q(0,k(mi))],De.prototype,"vertex",null),u([q(0,k(de))],De.prototype,"fragment",null);var Va={pos:{count:2,type:ee.UNSIGNED_SHORT}},ci=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){let t=512,i=512,a=new Ze(t,i);a.samplingMode=vt.NEAREST,a.wrapMode=St.CLAMP_TO_EDGE;let r=new Ts(e,new Ut(Et.DEPTH_STENCIL,t,i));this._dotFBO=new kt(e,a,r)}return this._dotFBO}getDotDensityMesh(e,t){if(this._dotMesh==null){let i=512,a=i*i,r=2,o=new Int16Array(a*r);for(let l=0;l<i;l++)for(let p=0;p<i;p++)o[r*(p+l*i)]=p,o[r*(p+l*i)+1]=l;this._dotMesh=ai.create(e,{primitive:Rt.POINTS,vertex:o,count:a,layout:Va},t)}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){let a=new us(i);this._dotTextures=[this._allocDotDensityTexture(e,t,a),this._allocDotDensityTexture(e,t,a)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){let a=new Float32Array(t*t*4);for(let o=0;o<a.length;o++)a[o]=i.getFloat();let r=new Ze;return r.dataType=Lt.FLOAT,r.samplingMode=vt.NEAREST,r.width=t,r.height=t,new qt(e,r,a)}};var di=class extends R{constructor(){super(...arguments),this.type=L.DotDensity,this.shaders={polygon:new De,point:new _e,fill:new ti},this._resources=new Map}render(e,t){aa(e)||C(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){let{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:h(m({},O(e,t.target)),{visualVariableColor:null,visualVariableOpacity:null}),defines:m({},A(e)),optionalAttributes:{zoomRange:!1},useComputeBuffer:C(e)}),i.setPipelineState(E(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){let{context:i,painter:a,requiredLevel:r}=e,o=t.instance.getInput().uniforms,l=this._getOrCreateResourcesRecord(i),p=l.getDotDensityTextures(i,512,o.seed),f=1/2**(r-t.target.key.level),c=512,d=c*window.devicePixelRatio*c*window.devicePixelRatio,g=1/f*(1/f),b=o.dotScale?e.state.scale/o.dotScale:1,x=o.dotValue*b*g;a.setShader({shader:this.shaders.polygon,uniforms:h(m({},O(e,t.target)),{instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,x)},draw:{dotTexture0:{unit:Bi,texture:p[0]},dotTexture1:{unit:Vs,texture:p[1]},tileZoomFactor:f,pixelRatio:window.devicePixelRatio,tileDotsOverArea:d/(512*window.devicePixelRatio*512*window.devicePixelRatio)}}),defines:h(m({},A(e)),{blending:o.blending}),optionalAttributes:{},useComputeBuffer:!1});let v=i.getViewport();i.setViewport(0,0,512,512);let S=i.getBoundFramebufferObject(),V=l.getFBO(i);i.bindFramebuffer(V),i.setClearColor(0,0,0,0),i.clear(bt.COLOR),a.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),a.updatePipelineState(i),a.submitDraw(e,t),i.bindFramebuffer(S),i.setViewport(v.x,v.y,v.width,v.height);let D=l.getFBO(i).colorTexture,B={shader:this.shaders.point,uniforms:{view:sa(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:Bi,texture:D},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:m({},A(e)),optionalAttributes:{},useComputeBuffer:!1};a.setPipelineState(E(e)),a.submitDrawMesh(i,B,l.getDotDensityMesh(i,oa(this.shaders.point)))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new ci,this._resources.set(e,t)),t}};var fi=class extends R{constructor(){super(...arguments),this.type=L.ComplexFill,this.shaders={geometry:new Ws}}render(e,t){let{context:i,painter:a}=e,r=t.instance.getInput();a.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,r.uniforms)),O(e,t.target)),{mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ue(t.target)}),defines:m({},A(e)),optionalAttributes:r.optionalAttributes,useComputeBuffer:C(e)}),a.setPipelineState(E(e)),a.submitDraw(e,t)}};function we(s){let e=1/s;return{antialiasing:e,blur:0+e}}var hi=class extends R{constructor(){super(...arguments),this.type=L.ComplexOutlineFill,this.shaders={geometry:new Js}}render(e,t){let{context:i,painter:a,pixelRatio:r}=e,o=t.instance.getInput();a.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,o.uniforms)),O(e,t.target)),{antialiasingControls:we(r),mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ue(t.target)}),defines:m({},A(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:C(e)}),a.setPipelineState(E(e)),a.submitDraw(e,t)}};var yi=class extends R{constructor(){super(...arguments),this.type=L.Fill,this.shaders={geometry:new ti}}render(e,t){let{painter:i}=e,a=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:m(m({},N(e,t.target,a.uniforms)),O(e,t.target)),defines:A(e),optionalAttributes:a.optionalAttributes,useComputeBuffer:C(e)}),i.setPipelineState(E(e)),i.submitDraw(e,t)}};var gi=class extends R{constructor(){super(...arguments),this.type=L.OutlineFill,this.shaders={geometry:new Xs}}render(e,t){let{painter:i,pixelRatio:a}=e,r=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,r.uniforms)),O(e,t.target)),{antialiasingControls:we(a)}),defines:m({},A(e)),optionalAttributes:r.optionalAttributes,useComputeBuffer:C(e)}),i.setPipelineState(E(e)),i.submitDraw(e,t)}};var xi=class extends R{constructor(){super(...arguments),this.type=L.PatternFill,this.shaders={geometry:new Ys}}render(e,t){let{context:i,painter:a}=e,r=t.instance.getInput();a.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,r.uniforms)),O(e,t.target)),{mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ue(t.target)}),defines:m({},A(e)),optionalAttributes:r.optionalAttributes,useComputeBuffer:C(e)}),a.setPipelineState(E(e)),a.submitDraw(e,t)}};var bi=class extends R{constructor(){super(...arguments),this.type=L.PatternOutlineFill,this.shaders={geometry:new Qs}}render(e,t){let{context:i,painter:a,pixelRatio:r}=e,o=t.instance.getInput();a.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,o.uniforms)),O(e,t.target)),{antialiasingControls:we(r),mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ue(t.target)}),defines:m({},A(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:C(e)}),a.setPipelineState(E(e)),a.submitDraw(e,t)}};var wa=()=>At.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"),vi=class{destroy(){this._accumulateFramebuffer=Ui(this._accumulateFramebuffer),this._resolveGradientTexture=Ui(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){let t=ra(e,wa());this._qualityProfile=h(m({},t),{defines:{usesHalfFloatPrecision:t.dataType!==Lt.FLOAT}})}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){let{dataType:a,samplingMode:r,pixelFormat:o,internalFormat:l}=this.loadQualityProfile(e),p=new Ze(t,i);p.pixelFormat=o,p.internalFormat=l,p.dataType=a,p.samplingMode=r,p.wrapMode=St.CLAMP_TO_EDGE;let f=new Ut(Et.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new kt(e,p,f)}else{let{width:a,height:r}=this._accumulateFramebuffer;a===t&&r===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){let a=new Ze;a.wrapMode=St.CLAMP_TO_EDGE,this._resolveGradientTexture=new qt(e,a)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}};function Si(s){return s?.25:1}var Vi=class extends Se{};u([w(5,y)],Vi.prototype,"offset",void 0);var ts=class extends de{},_t=class extends ae{};u([z(n)],_t.prototype,"radius",void 0),u([z(n)],_t.prototype,"isFieldActive",void 0);var ke=class extends Ve{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){let{radius:t,isFieldActive:i}=this.kernelControls,a=e.offset,r=i.multiply(this.storage.getVVData(e.id).x).add(new n(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new M(e.pos,1)).add(this.view.displayViewMat3.multiply(new M(a,0)).multiply(t)),l=this.clip(e.id);return m({glPosition:new T(o.xy,l,1),offset:a,fieldValue:r,color:new T(0)},this.maybeRunHittest(e,{},null))}fragment(e){let{offset:t,fieldValue:i}=e,a=$t(t),r=X(a,new n(1)),o=new n(1).subtract(a.multiply(a)),l=o.multiply(o),p=r.multiply(l).multiply(i).multiply(new n(Si(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new T(p),e)}hittest(e){let{viewMat3:t,tileMat3:i}=this.view,a=t.multiply(i).multiply(new M(e.pos,1));return Gs(a.xy,this.kernelControls.radius,this.hittestRequest.position)}};u([ve],ke.prototype,"usesHalfFloatPrecision",void 0),u([z(_t)],ke.prototype,"kernelControls",void 0),u([q(0,k(Vi))],ke.prototype,"vertex",null),u([q(0,k(ts))],ke.prototype,"fragment",null);var wi=class extends Zt{};u([w(0,y)],wi.prototype,"position",void 0);var is=class extends Bs{},ft=class extends ae{};u([z(Q)],ft.prototype,"texture",void 0),u([z(y)],ft.prototype,"minAndInvRange",void 0),u([z(n)],ft.prototype,"normalization",void 0);var Ti=class extends ae{};u([z(Q)],Ti.prototype,"texture",void 0);var Ie=class extends Xt{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new T(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){let{accumulatedDensity:t,gradient:i}=this,a=W(t.texture,e.uv).r.divide(new n(Si(this.usesHalfFloatPrecision)));a=a.multiply(t.normalization),a=a.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);let r=W(i.texture,new y(a,.5)),o=new et;return o.glFragColor=new T(r.rgb.multiply(r.a),r.a),o}};u([ve],Ie.prototype,"usesHalfFloatPrecision",void 0),u([z(ft)],Ie.prototype,"accumulatedDensity",void 0),u([z(Ti)],Ie.prototype,"gradient",void 0),u([q(0,k(wi))],Ie.prototype,"vertex",null),u([q(0,k(is))],Ie.prototype,"fragment",null);var zi=class extends R{constructor(){super(...arguments),this.type=L.Heatmap,this.drawPhase=ue.MAP|ue.HITTEST|ue.DEBUG,this.shaders={accumulate:new ke,resolve:new Ie},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){let{context:i,painter:a,state:r}=e,o=t.instance.getInput(),{isFieldActive:l}=o.uniforms,p=this._getOrCreateResourcesRecord(i),f=p.loadQualityProfile(i);C(e)||this._bind(e,p,o),a.setShader({shader:this.shaders.accumulate,uniforms:h(m({},O(e,t.target)),{kernelControls:{radius:na(o,r),isFieldActive:l?1:0}}),defines:m(m({},A(e)),f.defines),optionalAttributes:{},useComputeBuffer:C(e)});let c=C(e)?za:ua;a.setPipelineState(c),a.submitDraw(e,t)}getStencilReference(e){return la(e)}renderResolvePass(e,t){if(C(e))return;let{context:i,painter:a}=e,r=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!r?.initialized)return;let{defines:o}=r.loadQualityProfile(i),{minDensity:l,maxDensity:p,radius:f}=t.getInput().uniforms,c=8,d=9,g=r.accumulateFramebuffer,b=r.resolveGradientTexture,x={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:c,texture:g.colorTexture},minAndInvRange:[l,1/(p-l)],normalization:3/(f*f*Math.PI)},gradient:{texture:{unit:d,texture:b}}},defines:o,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(g.colorTexture,c),i.bindTexture(b,d),a.setPipelineState(Fa),a.submitDrawMesh(i,x,a.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new vi,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;let{context:a,state:r,pixelRatio:o}=e,l=a.getBoundFramebufferObject(),p=a.getViewport();this._prevFBO=l,this._prevViewport=p;let{gradient:f,gradientHash:c}=i.uniforms;t.ensureResolveGradientTexture(a,c,f);let{width:d,height:g}=p,b=Ta(na(i,r),o),x=d*b,v=g*b,S=t.ensureAccumulateFBO(a,x,v);a.blitFramebuffer(l,S,0,0,l.width,l.height,0,0,S.width,S.height,bt.STENCIL,vt.NEAREST),a.bindFramebuffer(S),a.setViewport(0,0,S.width,S.height),a.setColorMask(!0,!0,!0,!0),a.setClearColor(0,0,0,0),a.clear(bt.COLOR),this._isBound=!0}};function Ta(s,e){let t=e>1.5?.25:.5;return s<1/(2*t)?1:t}function la(s){return s.key.level+1}var ua={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:la,compare:hs.GEQUAL,mask:255,op:{fail:Ot.KEEP,zFail:Ot.KEEP,zPass:Ot.REPLACE}}}},za=h(m({},ua),{stencil:!1}),Fa={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function na(s,e){let{referenceScale:t,radius:i}=s.uniforms;return i*(t!==0?t/e.scale:1)}var Ma=360/254,ie;(function(s){s[s.Color=0]="Color",s[s.Outline=1]="Outline",s[s.Halo=2]="Halo"})(ie||(ie={}));var ne=class extends Se{};u([w(3,T)],ne.prototype,"color",void 0),u([w(4,y)],ne.prototype,"offset",void 0),u([w(5,y)],ne.prototype,"textureUV",void 0),u([w(6,n)],ne.prototype,"fontSize",void 0),u([w(7,n)],ne.prototype,"referenceSize",void 0),u([w(8,T)],ne.prototype,"outlineColor",void 0),u([w(9,T)],ne.prototype,"haloColor",void 0),u([w(10,y)],ne.prototype,"outlineAndHaloSize",void 0),u([w(11,y)],ne.prototype,"zoomRange",void 0),u([w(12,n)],ne.prototype,"clipAngle",void 0),u([w(13,T)],ne.prototype,"referenceSymbol",void 0);var Dt=class extends Je{};u([w(14,y)],Dt.prototype,"offsetNextVertex1",void 0),u([w(15,y)],Dt.prototype,"offsetNextVertex2",void 0);var ss=class extends de{},Y=class extends Ve{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=ie.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){let a=t.multiply(Ma),r=Qe(this.view.rotation.subtract(a)),o=zt(new n(360).subtract(r),r),l=new n(0),p=Es(this.view.currentZoom.multiply(Hi)).divide(Hi),f=e.x,c=e.y,d=new n(1).subtract(X(f,p)).multiply(2),g=X(new n(90),o).multiply(2),b=new n(2).multiply(new n(1).subtract(X(p,c)));return l=l.add(i.multiply(d)),l=l.add(i.multiply(g)),l=l.add(b),l}vertex(e,t){let i=J(e.bitset,Ds),a=new n(1).subtract(i),r=e.fontSize,o=r.divide(ji),l=this.textRenderPassType===ie.Outline?e.outlineColor:this.textRenderPassType===ie.Halo?e.haloColor:this._getVertexColor(e),p=this.isLabel?this.storage.getLabelVisibility(e.id):new n(1),f=this.isLabel?l.multiply(p):l,c=this.view.displayViewScreenMat3.multiply(new M(e.pos,1)),d=e.offset,g=new n(1),b=H.identity(),x=new y(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");let _=e.referenceSymbol,I=_.xy,U=_.z,F=this._unpackDirection(_.w),gt=He(this,e.id,U).divide(2),$e=F.multiply(gt.add(Ss));x=I.add($e),d=d.add(x)}else g=He(this,e.id,e.referenceSize).divide(e.referenceSize),r=r.multiply(g),o=o.multiply(g),d=d.multiply(g),b=ei(this,e.id),d=b.multiply(new M(d,0)).xy;let v=J(e.bitset,Is),S=this._getViewRotationMatrix(v).multiply(new M(d,0)),V=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,v):this.clip(e.id,e.zoomRange);V=this.isBackgroundPass?V.add(a.multiply(2)):V.add(i.multiply(2));let D=this.isLabel?jt(be(V,new n(1)),se(p,new n(0))):new wt(!1),B=new T(c.xy.add(S.xy),V,1),j=e.textureUV.divide(this.mosaicInfo.size),P=new n(0);if(this.textRenderPassType===ie.Outline&&(se(e.outlineAndHaloSize.x,new n(0))&&(V=V.add(new n(2))),P=new n(e.outlineAndHaloSize.x).divide(o).divide(Wi)),this.textRenderPassType===ie.Halo){let _=e.outlineAndHaloSize.x,I=new n(e.outlineAndHaloSize.y);se(I,new n(0))&&(V=V.add(new n(2))),P=I.add(_).divide(o).divide(Wi)}return m({glPosition:B,color:f,size:o,textureUV:j,antialiasingWidth:new n(.105*ji).divide(r).divide(this.view.pixelRatio),outlineDistanceOffset:P},this.maybeRunHittest(e,t,{vvSizeAdjustment:g,vvRotation:b,labelOffset:x,labelClipped:D}))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,a=new n(1).subtract(e);return t.multiply(e).add(i.multiply(a))}fragment(e){let t=new n(.25),i=new n(1).subtract(t),a=W(this.mosaicInfo.texture,e.textureUV).a,r=i.subtract(e.outlineDistanceOffset);this.highlight&&(r=r.divide(2));let o=e.antialiasingWidth,l=Kt(r.subtract(o),r.add(o),a);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:a,labelOffset:r,labelClipped:o}){let l,p,f;this.isLabel?(l=new M(e.offset.add(r),0),p=new M(t.offsetNextVertex1.add(r),0),f=new M(t.offsetNextVertex2.add(r),0)):(l=a.multiply(new M(e.offset.multiply(i),0)),p=a.multiply(new M(t.offsetNextVertex1.multiply(i),0)),f=a.multiply(new M(t.offsetNextVertex2.multiply(i),0)));let{viewMat3:c,tileMat3:d}=this.view,g=c.multiply(d).multiply(new M(e.pos,1)),b=g.add(d.multiply(l)).xy,x=g.add(d.multiply(p)).xy,v=g.add(d.multiply(f)).xy,S=it(this.hittestRequest.position,b.xy,x.xy,v.xy);return this.isLabel?Z(o,Le(this.hittestRequest),S):S}_unpackDirection(e){let t=new Nt(e),i=Rs(t,new Nt(2)),a=Os(t,new Nt(3));return new y(new n(i).subtract(1),new n(a).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){let i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new wt(!1))}if(this.visualVariableOpacity){let i=this.storage.getOpacityValue(e.id),a=this.visualVariableOpacity.getOpacity(i);t=t.multiply(a)}return t}};u([G(st)],Y.prototype,"visualVariableColor",void 0),u([G(at)],Y.prototype,"visualVariableOpacity",void 0),u([G(Fe)],Y.prototype,"visualVariableRotation",void 0),u([G(rt)],Y.prototype,"visualVariableSizeMinMaxValue",void 0),u([G(ot)],Y.prototype,"visualVariableSizeScaleStops",void 0),u([G(nt)],Y.prototype,"visualVariableSizeStops",void 0),u([G(lt)],Y.prototype,"visualVariableSizeUnitValue",void 0),u([z(Ee)],Y.prototype,"mosaicInfo",void 0),u([ve],Y.prototype,"textRenderPassType",void 0),u([ve],Y.prototype,"isBackgroundPass",void 0),u([ve],Y.prototype,"isLabel",void 0),u([q(0,k(ne)),q(1,k(Dt))],Y.prototype,"vertex",null),u([q(0,k(ss))],Y.prototype,"fragment",null);var Fi=class extends R{constructor(){super(...arguments),this.type=L.Label,this.shaders={geometry:new Y},this.drawPhase=ue.LABEL|ue.LABEL_ALPHA|ue.HITTEST,this.symbologyPlane=oe.TEXT}render(e,t){let{context:i,painter:a}=e,r=A(e),o=m({},E(e)),l=t.instance.getInput(),p={shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,l.uniforms)),O(e,t.target)),{mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey)}),defines:h(m({},r),{textRenderPassType:ie.Color,isBackgroundPass:!0,isLabel:!0}),optionalAttributes:l.optionalAttributes,useComputeBuffer:C(e)};a.setShader(p),a.setPipelineState(o),a.submitDraw(e,t),a.setShader(h(m({},p),{defines:h(m({},r),{textRenderPassType:ie.Halo,isBackgroundPass:!1,isLabel:!0})})),a.setPipelineState(o),a.submitDraw(e,t),a.setShader(h(m({},p),{defines:h(m({},r),{textRenderPassType:ie.Color,isBackgroundPass:!1,isLabel:!0})})),a.setPipelineState(o),a.submitDraw(e,t)}};var Mi=class extends R{constructor(){super(...arguments),this.type=L.Line,this.shaders={geometry:new ii},this.symbologyPlane=oe.LINE}render(e,t){let{painter:i,pixelRatio:a}=e,r=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,r.uniforms)),O(e,t.target)),{antialiasingControls:we(a)}),defines:m({},A(e)),optionalAttributes:r.optionalAttributes,useComputeBuffer:C(e)}),i.setPipelineState(E(e)),i.submitDraw(e,t)}};var Be=class extends $s{};u([w(9,n)],Be.prototype,"accumulatedDistance",void 0),u([w(10,y)],Be.prototype,"segmentDirection",void 0),u([w(11,n)],Be.prototype,"offsetAlongLine",void 0),u([w(12,n)],Be.prototype,"capType",void 0),u([w(13,T)],Be.prototype,"tlbr",void 0);var ht=class extends ii{_getDistanceRatio(e,t){let i=J(e.bitset,Ps);return i.multiply(he(t,new n(.25)).multiply(new n(2))).add(new n(1).subtract(i).multiply(Te(1)))}_getSDFAlpha(e){let{halfWidth:t,normal:i,tlbr:a,patternSize:r,accumulatedDistance:o,offsetAlongLine:l,dashToPx:p,capType:f}=e,c=r.x.divide(4).multiply(p),d=$i(o.add(l).divide(c)),g=ze(a.xy,a.zw,new y(d,.5)),b=tt(W(this.mosaicInfo.texture,g)).multiply(2).subtract(1).multiply(64).multiply(p),x=i.y.multiply(t),v=Ye([se(f,new n(1)),b.subtract(t)],[se(f,new n(2)),qs(Us(he(b,new n(0)),new n(2)).add(x.multiply(x))).subtract(t)],[!0,b]),S=Ae(new n(.25).subtract(v),new n(0),new n(1));return new T(S)}_getPatternColor(e){let{halfWidth:t,normal:i,color:a,accumulatedDistance:r,patternSize:o,sampleAlphaOnly:l,tlbr:p}=e,f=o.y.multiply(new n(2).multiply(t).divide(o.x)),c=$i(r.divide(f)),d=new n(.5).multiply(i.y).add(new n(.5)),g=ze(p.xy,p.zw,new y(d,c)),b=W(this.mosaicInfo.texture,g);return this.visualVariableColor!=null&&(b=Z(be(l,new n(.5)),new T(a.a),a)),b}vertex(e,t){let{segmentDirection:i,tlbr:a,bitset:r}=e,o=Zs(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Tt(i,o.scaledOffset)),p=new y(a.z.subtract(a.x),a.w.subtract(a.y)),f=a.divide(this.mosaicInfo.size.xyxy),c=J(r,_s),d=J(r,Ms),g=Z(be(c,new n(.5)),this._getDistanceRatio(e,o.scaledHalfWidth),new n(1));return m(h(m({},o),{tlbr:f,patternSize:p,accumulatedDistance:l,isSDF:c,sampleAlphaOnly:d,dashToPx:g,offsetAlongLine:e.offsetAlongLine,capType:e.capType}),this.maybeRunHittest(e,t,o.halfWidth))}fragment(e){let{color:t,opacity:i,isSDF:a}=e,r=Ks(e,this.antialiasingControls.blur),o=Z(be(a,new n(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),l=t.multiply(i).multiply(r).multiply(o);return this.getFragmentOutput(l,e)}};u([z(Ee)],ht.prototype,"mosaicInfo",void 0),u([q(0,k(Be)),q(1,k(Ns))],ht.prototype,"vertex",null);var Pi=class extends R{constructor(){super(...arguments),this.type=L.TexturedLine,this.shaders={geometry:new ht},this.symbologyPlane=oe.LINE}render(e,t){let{context:i,painter:a,pixelRatio:r}=e,o=t.instance.getInput();a.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,o.uniforms)),O(e,t.target)),{antialiasingControls:we(r),mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey)}),defines:m({},A(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:C(e)}),a.setPipelineState(E(e)),a.submitDraw(e,t)}};var ge=class extends Se{};u([w(3,T)],ge.prototype,"color",void 0),u([w(4,T)],ge.prototype,"outlineColor",void 0),u([w(5,y)],ge.prototype,"offset",void 0),u([w(6,y)],ge.prototype,"textureUV",void 0),u([w(7,T)],ge.prototype,"sizing",void 0),u([w(8,n)],ge.prototype,"placementAngle",void 0),u([w(9,n)],ge.prototype,"sdfDecodeCoeff",void 0),u([w(10,y)],ge.prototype,"zoomRange",void 0);var We=class extends Je{};u([w(12,y)],We.prototype,"offsetNextVertex1",void 0),u([w(13,y)],We.prototype,"offsetNextVertex2",void 0),u([w(14,y)],We.prototype,"textureUVNextVertex1",void 0),u([w(15,y)],We.prototype,"textureUVNextVertex2",void 0);var rs=class extends de{};function Ce(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}function as(s){return s.multiply(s).divide(128)}var le=class extends Ve{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){let i=as(e.sizing.x),a=as(e.sizing.y),r=as(e.sizing.z),o=e.placementAngle,l=J(e.bitset,me.bitset.isSDF),p=J(e.bitset,me.bitset.isMapAligned),f=J(e.bitset,me.bitset.scaleSymbolsProportionally),c=Yt(e.bitset,me.bitset.colorLocked),d=Jt(this,e.id),g=Qt(this,e.id,e.color,c).multiply(d),b=this.view.displayViewScreenMat3.multiply(new M(e.pos.xy,1)),x=He(this,e.id,r).divide(r),v=i.multiply(x),S=e.offset.xy.multiply(x),V=a.multiply(f.multiply(x.subtract(1)).add(1));V=zt(V,he(v.subtract(.99),new n(0)));let D=he(V,new n(1)),B=zt(V,new n(1)),j=H.fromRotation(o.multiply(Bt)),P=ei(this,e.id),_=this._getViewRotationMatrix(p).multiply(P).multiply(j).multiply(new M(S.xy,0)),I=this.clip(e.id,e.zoomRange),U=new T(b.xy.add(_.xy),I,1),F=e.textureUV.divide(this.mosaicInfo.size),gt=e.outlineColor.multiply(B),$e=J(e.bitset,me.bitset.overrideOutlineColor),ls=e.sdfDecodeCoeff.multiply(v);return m({glPosition:U,color:g,textureUV:F,outlineColor:gt,outlineSize:D,distanceToPx:ls,isSDF:l,overrideOutlineColor:$e},this.maybeRunHittest(e,t,{pos:e.pos,size:v,sizeCorrection:x,isMapAligned:p,vvRotationMat3:P,placementMat3:j,outlineSize:D,distanceToPx:ls,isSDF:l}))}fragment(e){let t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return Z(Gt(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,a=new n(1).subtract(e);return t.multiply(e).add(i.multiply(a))}_getViewScreenMatrix(e){let t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,a=new n(1).subtract(e);return t.multiply(e).add(i.multiply(a))}_getColor(e,t){return Z(se(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return W(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=W(this.mosaicInfo.texture,e),a=new n(.5).subtract(tt(i)).multiply(t.distanceToPx).multiply(Ht),r=Ae(new n(.5).subtract(a),new n(0),new n(1)),o=t.color.multiply(r),l=t.outlineSize;this.highlight&&(l=he(l,t.overrideOutlineColor.multiply(4)));let p=l.multiply(.5),f=Qe(a).subtract(p),c=Ae(new n(.5).subtract(f),new n(0),new n(1)),d=ze(t.outlineColor,t.color,t.overrideOutlineColor).multiply(c);return new n(1).subtract(d.a).multiply(o).add(d)}_hittestSmallMarker(e,t,i){let{position:a,distance:r,smallSymbolDistance:o}=this.hittestRequest,l=r.subtract(o),{viewMat3:p,tileMat3:f}=this.view,c=p.multiply(f).multiply(new M(i.pos,1)).xy,d=i.size.multiply(.5);return Wt(c,a).subtract(d).add(l)}_hittestMarker(e,t,i){let{pos:a,sizeCorrection:r,isMapAligned:o}=i,l=new M(e.offset.multiply(r),0),p=new M(t.offsetNextVertex1.multiply(r),0),f=new M(t.offsetNextVertex2.multiply(r),0),{viewMat3:c,tileMat3:d}=this.view,g=c.multiply(d).multiply(new M(a,1)),b=this._getViewScreenMatrix(o).multiply(i.vvRotationMat3).multiply(i.placementMat3),x=g.add(b.multiply(l)).xy,v=g.add(b.multiply(p)).xy,S=g.add(b.multiply(f)).xy,V=this.hittestRequest.position,D=this.hittestRequest.distance,B=it(V,x,v,S);return Z(be(B,D),B,this._hittestSamples(x,v,S,e,t,i))}_hittestSamples(e,t,i,a,r,o){let{outlineSize:l,isSDF:p,distanceToPx:f}=o,c=this.hittestRequest.position,d=this.hittestRequest.distance,g=K(c.add(new y(re(d),re(d))),e,t,i),b=K(c.add(new y(0,re(d))),e,t,i),x=K(c.add(new y(d,re(d))),e,t,i),v=K(c.add(new y(re(d),0)),e,t,i),S=K(c,e,t,i),V=K(c.add(new y(d,0)),e,t,i),D=K(c.add(new y(re(d),d)),e,t,i),B=K(c.add(new y(0,d)),e,t,i),j=K(c.add(new y(d,d)),e,t,i),P=a.textureUV.divide(this.mosaicInfo.size),_=r.textureUVNextVertex1.divide(this.mosaicInfo.size),I=r.textureUVNextVertex2.divide(this.mosaicInfo.size),U={color:new T(1),outlineColor:new T(1),overrideOutlineColor:new n(1),outlineSize:l,distanceToPx:f,isSDF:p},F=new n(0);return F=F.add($(g).multiply(this._getColor(Ce(g,P,_,I),U).a)),F=F.add($(b).multiply(this._getColor(Ce(b,P,_,I),U).a)),F=F.add($(x).multiply(this._getColor(Ce(x,P,_,I),U).a)),F=F.add($(v).multiply(this._getColor(Ce(v,P,_,I),U).a)),F=F.add($(S).multiply(this._getColor(Ce(S,P,_,I),U).a)),F=F.add($(V).multiply(this._getColor(Ce(V,P,_,I),U).a)),F=F.add($(D).multiply(this._getColor(Ce(D,P,_,I),U).a)),F=F.add($(B).multiply(this._getColor(Ce(B,P,_,I),U).a)),F=F.add($(j).multiply(this._getColor(Ce(j,P,_,I),U).a)),X(F,new n(.05)).multiply(Le(this.hittestRequest))}};u([G(st)],le.prototype,"visualVariableColor",void 0),u([G(at)],le.prototype,"visualVariableOpacity",void 0),u([G(Fe)],le.prototype,"visualVariableRotation",void 0),u([G(rt)],le.prototype,"visualVariableSizeMinMaxValue",void 0),u([G(ot)],le.prototype,"visualVariableSizeScaleStops",void 0),u([G(nt)],le.prototype,"visualVariableSizeStops",void 0),u([G(lt)],le.prototype,"visualVariableSizeUnitValue",void 0),u([z(Ee)],le.prototype,"mosaicInfo",void 0),u([q(0,k(ge)),q(1,k(We))],le.prototype,"vertex",null),u([q(0,k(rs))],le.prototype,"fragment",null);var _i=class extends R{constructor(){super(...arguments),this.type=L.Marker,this.shaders={geometry:new le},this.symbologyPlane=oe.MARKER}render(e,t){let{context:i,painter:a}=e,r=t.instance.getInput();a.setShader({shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,r.uniforms)),O(e,t.target)),{mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey,!0)}),defines:m({},A(e)),optionalAttributes:r.optionalAttributes,useComputeBuffer:C(e)}),a.setPipelineState(E(e)),a.submitDraw(e,t)}};var Di=class{constructor(){this.computeAttributes={}}get locationsMap(){let e=new Map;for(let t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){let e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){let e=this.locationsMap,t=Array.from(e.entries()).map(([a,r])=>`${a}.${r}`).join("."),i=ms(t);this._locationInfo={hash:i,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){let e=new Map;for(let[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map(a=>`${a}.${e[a]}`).join(".")}.${Object.keys(i).filter(a=>i[a]).map(a=>`${a}_${i[a].toString()}`).join(".")}.${Object.keys(t).filter(a=>this.optionPropertyKeys.has(a)).join(".")}`}getProgram(e,t,i,a){let r="",o="";for(let l in i)if(i[l]){let p=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;r+=p,o+=p}return r+=this.vertexShader,o+=this.fragmentShader,new ks(r,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){let t=[];for(let i in this.required){let a=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:a.type,uniformArrayElementType:pa(a),uniformArrayLength:ma(a)})}for(let i in e){let a=this.options[i];if(e[i])for(let r in a){let o=a[r];t.push({uniformHydrated:null,shaderModulePath:`${i}.${r}`,uniformName:r,uniformType:o.type,uniformArrayElementType:pa(o),uniformArrayLength:ma(o)})}}return t}},pa=s=>s.type==="array"?s.elementType?.type:void 0,ma=s=>s.type==="array"?s.size:void 0;var Da={hittestDist:n,hittestPos:y},Ia={filterFlags:Q,animation:Q,visualVariableData:Q,dataDriven0:Q,dataDriven1:Q,dataDriven2:Q,gpgpu:Q,size:n},Ca={displayViewScreenMat3:H,displayViewMat3:H,displayMat3:H,viewMat3:H,tileMat3:H,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:y,currentScale:n,currentZoom:n,metersPerSRUnit:n},Ii=class extends Di{constructor(){super(...arguments),this.vertexShader=Yi("materials/pie/pie.vert"),this.fragmentShader=Yi("materials/pie/pie.frag"),this.required=h(m(m({},Ia),Ca),{outlineWidth:n,colors:ce,defaultColor:T,othersColor:T,outlineColor:T,donutRatio:n,sectorThreshold:n}),this.options={hittestUniforms:Da,visualVariableSizeMinMaxValue:{minMaxValueAndSize:T},visualVariableSizeScaleStops:{sizes:h(m({},ce.ofType(n,8)),{type:"array",elementType:n,size:8}),values:h(m({},ce.ofType(n,8)),{type:"array",elementType:n,size:8})},visualVariableSizeStops:{sizes:h(m({},ce.ofType(n,8)),{type:"array",elementType:n,size:8}),values:h(m({},ce.ofType(n,8)),{type:"array",elementType:n,size:8})},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:h(m({},ce.ofType(n,8)),{type:"array",elementType:n,size:8}),opacityValues:h(m({},ce.ofType(n,8)),{type:"array",elementType:n,size:8})}},this.locations={pos:{index:0,type:y},id:{index:1,type:M},bitset:{index:2,type:n},offset:{index:3,type:y},texCoords:{index:4,type:y},size:{index:5,type:y},referenceSize:{index:6,type:n},zoomRange:{index:7,type:y}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors=h(m({},ce.ofType(T,e)),{type:"array",elementType:T,size:e})}};var Ci=class extends R{constructor(){super(...arguments),this.type=L.PieChart,this.shaders={geometry:new Ii},this.symbologyPlane=oe.MARKER}render(e,t){let{painter:i}=e,{instance:a,target:r}=t,o=this.shaders.geometry,l=a.getInput(),p=l.uniforms.numberOfFields,f=C(e),c=O(e,r),d=A(e);o.setNumberOfFields(p),i.setShader({shader:o,uniforms:h(m(m(m({},N(e,t.target,l.uniforms.shader)),c.storage),c.view),{hittestUniforms:c.hittestRequest?{hittestDist:c.hittestRequest?.distance,hittestPos:c.hittestRequest?.position}:null}),defines:h(m({VV_SIZE_MIN_MAX_VALUE:!!l.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!l.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!l.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!l.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!l.uniforms.shader.visualVariableOpacity,HITTEST:f,highlight:c.highlight?1:0},d),{numberOfFields:p}),optionalAttributes:{},useComputeBuffer:f}),i.setPipelineState(E(e)),i.submitDraw(e,t)}};var Ai=class extends R{constructor(){super(...arguments),this.type=L.Text,this.shaders={geometry:new Y},this.symbologyPlane=oe.TEXT}render(e,t){let{context:i,painter:a}=e,r=A(e),o=t.instance.getInput(),l={shader:this.shaders.geometry,uniforms:h(m(m({},N(e,t.target,o.uniforms)),O(e,t.target)),{mosaicInfo:a.textureManager.getMosaicInfo(i,t.textureKey)}),defines:h(m({},r),{isBackgroundPass:!0,isLabel:!1,textRenderPassType:ie.Color}),optionalAttributes:o.optionalAttributes,useComputeBuffer:C(e)};a.setShader(l),a.setPipelineState(E(e)),a.submitDraw(e,t),a.setShader(h(m({},l),{defines:h(m({},r),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:ie.Halo})})),a.submitDraw(e,t),a.setShader(h(m({},l),{defines:h(m({},r),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:ie.Outline})})),a.submitDraw(e,t),a.setShader(h(m({},l),{defines:h(m({},r),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:ie.Color})})),a.submitDraw(e,t)}};var fe={fill:new yi,patternFill:new xi,complexFill:new fi,outlineFill:new gi,patternOutlineFill:new bi,complexOutlineFill:new hi,marker:new _i,pieChart:new Ci,line:new Mi,texturedLine:new Pi,text:new Ai,label:new Fi,heatmap:new zi,dotDensity:new di,animatedMarker:new li};function em(){for(let s in fe)fe[s].startup()}function tm(s){for(let e in fe)fe[e].shutdown(s)}function It(s,e){let t=s.slice(0,e),i=e-t.length;for(let a=0;a<i;a++){let r=t[t.length-1];t.push(r)}return t}function ca(s){if(!s)return[0,0,0,0];let{r:e,g:t,b:i,a}=s;return[e*(a/255),t*(a/255),i*(a/255),a]}var Ri=8,da=Ri-2,fa=()=>At.getLogger("esri.views.2d.layers.features.support.rendererUtils");function Oi(s){return s.map(e=>Aa(e)?Ra(e.clone()):e)}function Aa(s){return(s.type==="size"||s.type==="color"||s.type==="opacity")&&s.stops!=null}function Ra(s){return s.stops=Ea(s.type,s.stops??[]),s}function yt(s,e,t){return(1-t)*s+t*e}function Oa(s,e){let[t,...i]=e,a=i.pop(),r=i[0].value,o=i[i.length-1].value,l=(o-r)/da,p=[];for(let f=r;f<o;f+=l){let c=0;for(;f>=i[c].value;)c++;let d=i[c],g=e[c-1],b=f-g.value,x=d.value===g.value?1:b/(d.value-g.value);if(s==="color"){let v=i[c],S=e[c-1],V=v.color.clone();V.r=yt(S.color.r,V.r,x),V.g=yt(S.color.g,V.g,x),V.b=yt(S.color.b,V.b,x),V.a=yt(S.color.a,V.a,x),p.push({value:f,color:V,label:v.label})}else if(s==="size"){let v=i[c],S=e[c-1],V=qi(v.size),D=yt(qi(S.size),V,x);p.push({value:f,size:D,label:v.label})}else{let v=i[c],S=yt(e[c-1].opacity,v.opacity,x);p.push({value:f,opacity:S,label:v.label})}}return[t,...p,a]}function La(s){let[e,...t]=s,i=t.pop();for(;t.length>da;){let a=0,r=0;for(let o=1;o<t.length;o++){let l=t[o-1],p=t[o],f=Math.abs(p.value-l.value);f>r&&(r=f,a=o)}t.splice(a,1)}return[e,...t,i]}function Ea(s,e){return e.length<=Ri?e:(fa().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${Ri}. Displayed stops will be simplified.`),e.length>2*Ri?Oa(s,e):La(e))}function Ua(){let{supportsColorBufferFloat:s,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=Ft();return s&&e||t}function lm(s){if(!s)return!0;switch(s.type){case"dot-density":break;case"heatmap":if(!Ua()){let e=Ft(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return fa().errorOnce(new cs("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}var ka=1.25,Li=128,Ba=128;function Ha(s){if(!s.stops?.length)return null;let e=s.stops.sort((r,o)=>r.value-o.value),t=It(e,8),i=t.map(({value:r})=>r),a=t.map(({color:r})=>ca(r));return{values:i,colors:a}}function Na(s){if(!s.stops?.length)return null;let e=s.stops.sort((i,a)=>i.value-a.value),t=It(e,8);return{opacityValues:t.map(({value:i})=>i),opacities:t.map(({opacity:i})=>i)}}function Ga(s){return{rotationType:s.rotationType==="geographic"?Vt.Geographic:Vt.Arithmatic}}function os(s){if(!s.stops?.length)return null;if(s.stops.some(i=>i.useMaxValue||i.useMinValue))return(i,a)=>{let r=i.statisticsByLevel.get(a.key.level),o=s.stops.map(p=>({value:p.useMaxValue?r?.get(s.field)?.maxValue??0:p.useMinValue?r?.get(s.field)?.minValue??0:p.value,size:p.size?Te(p.size):1e-30})).sort((p,f)=>p.value-f.value),l=It(o,8);return{values:l.map(({value:p})=>p),sizes:l.map(({size:p})=>p)}};let e=s.stops.sort((i,a)=>i.value-a.value),t=It(e,8);return{values:t.map(({value:i})=>i),sizes:t.map(({size:i})=>Te(i))}}function ja(s){return e=>{let{state:t}=e;return{unitValueToPixelsRatio:fs(t.spatialReference)/bs[s.valueUnit??"meters"]/t.resolution}}}function ha(s,e){let t=e.length;if(s<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(s<e[i].value){let a=(s-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+a*(e[i].size-e[i-1].size)}return e[t-1].size}function Wa(s){let{minDataValue:e,maxDataValue:t,minSize:i,maxSize:a}=s;if(typeof i=="object"&&typeof a=="object")return(r,o)=>{let l=r.state.scale,p=Te(ha(l,i.stops)),f=Te(ha(l,a.stops));return{minMaxValueAndSize:[e,t,p,f]}};if(typeof i=="object"||typeof a=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,Te(i),Te(a)]}}var Ct={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function ns(s,e=Ba,t=ka){if(s.visualVariableSizeMinMaxValue)return s.visualVariableSizeMinMaxValue instanceof Function?Li:Math.max(s.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(s.visualVariableSizeScaleStops){if(s.visualVariableSizeScaleStops instanceof Function)return Li;let i=s.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(s.visualVariableSizeStops){if(s.visualVariableSizeStops instanceof Function)return Li;let i=s.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return s.visualVariableSizeUnitValue?2*Li:0}function xm(s){let e=m({},Ct);if(!s||!("visualVariables"in s)||!s.visualVariables)return e;for(let t of Oi(s.visualVariables))switch(t.type){case"color":e.visualVariableColor=Ha(t);break;case"opacity":e.visualVariableOpacity=Na(t);break;case"rotation":e.visualVariableRotation=Ga(t);break;case"size":switch($a(t)){case"field-stops":e.visualVariableSizeStops=os(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=os(t):e.visualVariableSizeScaleStops=os(t);break;case"min-max":e.visualVariableSizeMinMaxValue=Wa(t);break;case"unit-value":e.visualVariableSizeUnitValue=ja(t)}break}return e}function $a(s){return typeof s.minDataValue=="number"&&typeof s.maxDataValue=="number"&&s.minSize!=null&&s.maxSize!=null?"min-max":s?.valueExpression==="$view.scale"&&Array.isArray(s.stops)?"scale-stops":s.field==null&&s?.valueExpression==="$view.scale"||!(Array.isArray(s.stops)||"levels"in s&&s.levels)?s.field!=null||s?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function ya(s){return!!(s.visualVariableSizeMinMaxValue||s.visualVariableSizeScaleStops||s.visualVariableSizeStops||s.visualVariableSizeUnitValue||s.visualVariableSizeOutlineScaleStops)}function Sm(s){return!!s.visualVariableRotation}function Ka(s){return s.minScale||s.maxScale?{minScale:s.minScale??0,maxScale:s.maxScale??0}:null}function xe(s){if(s==null)return null;if(Array.isArray(s)){let[e,t,i,a]=s;return[e,t,i,255*a]}return typeof s=="string"?s:h(m({},s),{defaultValue:xe(s?.defaultValue)})}function _m(s,e){return xt(this,null,function*(){let{cimResourceManager:t,cimAnalyzer:i,scaleExpression:a}=e.schemaOptions;yield Promise.all(Fs.fetchResources(s.symbol,t,[]));let r=i.analyzeSymbolReference(s,!1),o={scaleInfo:Ka(s),scaleExpression:a},l=[];for(let p of r)switch(p.type){case"marker":l.push(...Za(p,e,o));break;case"fill":l.push(...er(p,e,o));break;case"line":l.push(...ir(p,e,o));break;case"text":l.push(...rr(p,e,o))}return l})}function Za(s,e,t){let{uniforms:i,schemaOptions:a}=e,{store:r}=a,o=s.isOutline?h(m({},Ct),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return s.animationParams?Xa(r.ensureInstance(fe.animatedMarker,{uniforms:o,optionalAttributes:{zoomRange:!0}}),s,Ct,t):Ya(r.ensureInstance(fe.marker,{uniforms:o,optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,i,t)}function Xa(s,e,t,i){return e.animationParams?[s.createMeshInfo({pixelDimensions:e.pixelDimensions,texelDimensions:e.texelDimensions,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:e.spriteRasterizationParam,animations:e.animationParams,scaleInfo:i.scaleInfo,scaleSymbolsProportionally:e.scaleSymbolsProportionally,strokeWidth:e.outlineWidth,isMapAligned:e.alignment===ws.MAP,colorLocked:e.colorLocked,isStroke:e.isStroke,baseSize:e.baseSize,referenceSize:e.referenceSize,angleToLine:!!e.markerPlacement&&e.markerPlacement.placement&&"angleToLine"in e.markerPlacement.placement&&e.markerPlacement.placement.angleToLine,sizeRatio:e.sizeRatio})]:[]}function Ya(s,e,t,{scaleInfo:i,scaleExpression:a}){let r=ya(t);return[s.createMeshInfo({size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:xe(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:xe(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||zs.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:a??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:r,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:ns(t)})]}function Qa(s,e,t){let{uniforms:i,schemaOptions:a}=e,{store:r}=a;return Ja(r.ensureInstance(fe.fill,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,t)}function Ja(s,e,{scaleInfo:t}){return[s.createMeshInfo({color:xe(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function er(s,e,t){if(!s.spriteRasterizationParam)return Qa(s,e,t);let{uniforms:i,schemaOptions:a}=e,{store:r}=a;return tr(r.ensureInstance(fe.complexFill,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,i.visualVariableColor!=null,t)}function tr(s,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let a=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),r=e.sampleAlphaOnly&&!a,o=e.spriteRasterizationParam;return[s.createMeshInfo({color:xe(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:r,scaleProportionally:o.resource.type==="CIMHatchFill",sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function ir(s,e,t){let{uniforms:i,schemaOptions:a}=e,{store:r}=a,o=s.isOutline?h(m({},Ct),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={uniforms:o,optionalAttributes:{zoomRange:!!t.scaleInfo}},p=!!(o.visualVariableSizeMinMaxValue||o.visualVariableSizeScaleStops||o.visualVariableSizeStops||o.visualVariableSizeUnitValue);return s.spriteRasterizationParam?ar(r.ensureInstance(fe.texturedLine,l),s,p,t):sr(r.ensureInstance(fe.line,l),s,p,t)}function ga(s,e,{scaleInfo:t}){return{color:xe(s.color)??[0,0,0,0],width:s.width,referenceWidth:s.referenceWidth,capType:s.cap,joinType:s.join,miterLimit:s.miterLimit,scaleInfo:t,hasSizeVV:e,effects:s.effects?{type:"cim-effect-infos",effectInfos:s.effects}:null}}function sr(s,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");let a=ga(e,t,i);return[s.createMeshInfo(a)]}function ar(s,e,t,i){let{spriteRasterizationParam:a,scaleDash:r,sampleAlphaOnly:o}=e;if(!a)throw new Error("InternalError: Sprite should be defined");return[s.createMeshInfo(h(m({},ga(e,t,i)),{offsetAlongLine:e.offsetAlongLine??0,shouldScaleDash:r??!1,shouldSampleAlphaOnly:o,isSDF:a.resource.type!=="CIMPictureStroke",sprite:a}))]}function rr(s,e,t){let{uniforms:i,schemaOptions:a}=e,{store:r}=a;return or(r.ensureInstance(fe.text,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),s,i,t)}function or(s,e,t,{scaleInfo:i,scaleExpression:a}){return[s.createMeshInfo({boxBackgroundColor:xe(e.backgroundColor),boxBorderLineColor:xe(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:xe(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:xe(e.haloColor)??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:xe(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:a??1,minPixelBuffer:ns(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}var xa=class{constructor(e){this.updateTracking=new ta({debugName:"FeatureCommandQueue"}),this._queueProcessor=new vs({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}push(e){return xt(this,null,function*(){return ds(this.updateTracking.addPromise(this._doPush(e)))})}_doPush(e){return xt(this,null,function*(){let t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":return i?.type===e.type?void 0:t.push(e);case"edit-by-id":case"edit-by-feature":return t.push(e)}})}};function Bm(s,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:Ft().maxTextureSize},bindings:nr(s)}}function Ei(s){switch(s){case"opacity":return Mt.OPACITY;case"color":return Mt.COLOR;case"rotation":return Mt.ROTATION;case"size":return Mt.SIZE;default:return null}}function nr(s){if(!s)return[];switch(s.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return ba(s);case"dot-density":return lr(s);case"pie-chart":return ur(s);case"heatmap":return pr(s)}}function lr(s){let e=[];for(let t of s.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function ur(s){let e=ba(s),t=4;for(let i of s.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function pr({valueExpression:s,field:e}){return s||e?[{binding:0,expression:s,field:e}]:[]}function ba(s){return!("visualVariables"in s)||!s.visualVariables?.length?[]:Oi(s.visualVariables).map(e=>hr(e)).filter(ps)}function mr(s){return s.valueExpression==="$view.scale"?null:{binding:Ei(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression,valueRepresentation:s.valueRepresentation}}function cr(s){return{binding:Ei(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function dr(s){return{binding:Ei(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function fr(s){return{binding:Ei(s.type),expression:s.valueExpression,field:s.field}}function hr(s){switch(s.type){case"size":return mr(s);case"color":return cr(s);case"opacity":return dr(s);case"rotation":return fr(s)}}export{ut as a,Uo as b,oi as c,si as d,ai as e,fe as f,em as g,tm as h,ca as i,lm as j,Ct as k,ns as l,xm as m,ya as n,Sm as o,Ka as p,_m as q,Xa as r,Ya as s,Ja as t,tr as u,sr as v,ar as w,or as x,Bm as y,ba as z,xa as A};
