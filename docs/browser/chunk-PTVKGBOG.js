import{b as B,c as wt,d as _t}from"./chunk-SK2WDIND.js";import{h as Mt}from"./chunk-E43YKIMQ.js";import{A as dt,U as lt,a as rt,fa as ht,ha as C,ia as L,ja as n,ma as ct,oa as ut,pa as mt,qa as U,ra as ft,s as at,t as R,u as x,v as nt,w as pt}from"./chunk-AN522XY4.js";import{n as yt}from"./chunk-FVIAJTXY.js";import{b as gt}from"./chunk-JLO7PPGZ.js";import{a as xt}from"./chunk-YNYZNNM2.js";import{b as it}from"./chunk-H7Y5XCPW.js";import{c as vt}from"./chunk-R7P6RQXJ.js";import{c as $,g as tt,h as et,i as ot,j as st}from"./chunk-NH3JQE75.js";import{e as J}from"./chunk-CY477QBZ.js";import{b as Y,h as V,i as Z,j as O}from"./chunk-BDF7KEUQ.js";import{c as W}from"./chunk-QNZSBADV.js";import{n as X}from"./chunk-4DLSYLKE.js";import{a as r,b as F}from"./chunk-BMVJCP2M.js";import{b as Q}from"./chunk-WGF2T2BG.js";import{a as G,b as z}from"./chunk-JEGVIFEP.js";var w=class extends ct{};r([C(0,x)],w.prototype,"pos",void 0),r([C(1,x)],w.prototype,"uv",void 0);var N=class extends ut{},T=class extends U{};r([n(dt)],T.prototype,"dvs",void 0);var p=class extends U{};r([n(x)],p.prototype,"perspective",void 0),r([n(x)],p.prototype,"texSize",void 0),r([n(R)],p.prototype,"wrapAroundShift",void 0),r([n(R)],p.prototype,"opacity",void 0),r([n(at)],p.prototype,"texture",void 0);var d=class extends ft{vertex(e){let t=e.uv.divide(this.config.texSize),o=new R(1).add(lt(t,this.config.perspective)),s=new nt(e.pos.add(new x(this.config.wrapAroundShift,0)),1),i=this.transform.dvs.multiply(s);return{uv:t,glPosition:new pt(i.xy.multiply(o),0,o)}}fragment(e){let t=ht(this.config.texture,e.uv).multiply(this.config.opacity),o=new mt;return o.glFragColor=t,o}};r([n(T)],d.prototype,"transform",void 0),r([n(p)],d.prototype,"config",void 0),r([F(0,L(w))],d.prototype,"vertex",null),r([F(0,L(N))],d.prototype,"fragment",null);var b=class extends wt{constructor(){super(...arguments),this.type=rt.Overlay,this._mesh=null,this.shaders={overlay:new d}}render(e,t){let{context:o,painter:s}=e,i=this._getMesh(e,t);s.setPipelineState(B);let{isWrapAround:l,wrapAroundShift:m}=t.config,f=z(G({},t.config),{wrapAroundShift:0}),v={shader:this.shaders.overlay,uniforms:{transform:t.transform,config:f},defines:null,optionalAttributes:null,useComputeBuffer:!1};s.setPipelineState(z(G({},B),{stencil:{write:!1,test:{compare:Z.EQUAL,op:{fail:O.KEEP,zFail:O.KEEP,zPass:O.REPLACE},ref:0,mask:255}}})),s.submitDrawMeshUntyped(o,v,i),l&&(f.wrapAroundShift=m,s.submitDrawMeshUntyped(o,v,i))}shutdown(){Q(this._mesh)}_getMesh(e,t){let{context:o}=e;if(this._mesh){let s=this._mesh.vertexBuffers.get("positions");if(!s)throw new Error("Buffer not found");s.setData(t.position)}else{let s=t.index!=null?t.index.length:t.position.length/2;this._mesh=new _t(o,{vertex:{positions:t.position,uvs:t.tex},index:t.index!=null?{index:t.index}:void 0,groups:[{attributes:[{name:"pos",count:2,type:V.FLOAT,location:0,vertex:"positions",stride:8,offset:0},{name:"tex",count:2,type:V.UNSIGNED_SHORT,location:1,vertex:"uvs",stride:4,offset:0}],index:t.index!=null?"index":void 0,primitive:Y.TRIANGLE_STRIP}],parts:[{group:0,start:0,count:s}]})}return this._mesh}};var St=class extends Mt{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=xt(),this._overlayTechnique=new b}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(let t of this.children)t.beforeRender(e)}doRender(e){if(e.drawPhase!==gt.MAP||!this.visible)return;super.doRender(e);let t=this._overlayTechnique;for(let o of this.children)o.draw(e,t)}onDetach(){this._overlayTechnique.shutdown()}_updateMatrices(e){let{state:t}=e,{id:o,size:s,pixelRatio:i,resolution:l,rotation:m,viewpoint:f,displayMat3:v}=t;if(this._viewStateId===o)return;let _=W(m),h=i*s[0],y=i*s[1];this._localOrigin=f.targetGeometry.clone();let{x:g,y:P}=this._localOrigin,M=J(g,t.spatialReference);this._localOrigin.x=M,this._localOrigin.y=P;let A=l*h,D=l*y,a=$(this._dvsMat3);tt(a,a,v),et(a,a,it(h/2,y/2)),st(a,a,vt(h/A,-y/D,1)),ot(a,a,-_),this._viewStateId=o}_updateOverlays(e,t){let{state:o}=e,{rotation:s,spatialReference:i,worldScreenWidth:l,size:m,viewpoint:f}=o,v=this._localOrigin,_,h=0,y=X(i);if(y&&i.isWrappable){let g=m[0],P=m[1],M=W(s),A=Math.abs(Math.cos(M)),D=Math.abs(Math.sin(M)),a=Math.round(g*A+P*D),[K,j]=y.valid,c=yt(i),{x:k,y:Ot}=f.targetGeometry,Rt=[k,Ot],E=[0,0];o.toScreen(E,Rt);let S=[0,0],I;I=a>l?.5*l:.5*a;let H=Math.floor((k+.5*c)/c),Tt=K+H*c,bt=j+H*c,q=[E[0]+I,0];o.toMap(S,q),S[0]>bt&&(h=c),q[0]=E[0]-I,o.toMap(S,q),S[0]<Tt&&(h=-c),_={worldWidth:c,xBounds:[K,j]}}for(let g of t)g.updateDrawCoords(v,h,i,_)}};export{St as a};
