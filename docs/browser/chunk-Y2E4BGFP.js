import{a as ut,d as Ur,e as pt,f as ft,g as $r}from"./chunk-NLLYXGRW.js";import{a as Yr}from"./chunk-QWGL5236.js";import{a as kr,b as Pr,c as Or,d as Mr,g as Be,i as Nr,j as Dr,k as Lr,l as lt,n as Hr,o as zr,p as ct,q as Wr,r as mt,s as Gr,t as jr,v as Vr,w as qr}from"./chunk-65IPPNEP.js";import{a as Re,b as Er,c as Br,d as Jr,f as at,g as ot,h as Ke,i as Ar,j as Qe}from"./chunk-NDJPWABE.js";import{a as Me,b as hr,c as Ir,d as Ye,f as vr,g as be}from"./chunk-LWNDFTA5.js";import{b as Ne,d as dr,e as st,f as xe,g as De,h as Ee,i as $e,j as yr,k as gr,l as xr,m as nt}from"./chunk-GT4Y5PVV.js";import{R as we,S as wr,T as Ie,X as Tr,a as it,b as Oe,c as er,d as tr,e as rr,f as ir,g as sr,h as nr,i as ar,j as or,k as lr,l as cr,m as ne,n as ae}from"./chunk-4XQATWKL.js";import{A as Rr,B as Sr,H as _r,b as ge,r as qe,s as mr,t as ur,u as pr,v as fr,w as Ue,z as br}from"./chunk-CAC75TDU.js";import{a as Ut}from"./chunk-A74W4U2J.js";import{a as Pe}from"./chunk-MAZHSYWX.js";import"./chunk-M7Q5ICON.js";import"./chunk-YRE2G4RX.js";import"./chunk-4QRGVGHK.js";import"./chunk-VWT6NXFZ.js";import{b as Qt,f as Zt}from"./chunk-F5CPBNZH.js";import{b as Xt}from"./chunk-64FW22PO.js";import"./chunk-3EB3OCOV.js";import{a as Kt}from"./chunk-7Z3Y27UA.js";import{a as $t}from"./chunk-HFXUZM7A.js";import"./chunk-6UUMJQNV.js";import{a as Yt}from"./chunk-Y63DBETK.js";import{b as Lt}from"./chunk-GNKF5TIB.js";import{c as At}from"./chunk-X4XHTJSF.js";import"./chunk-YIBWVOPM.js";import"./chunk-PY5WUUCV.js";import{a as Ht}from"./chunk-R3XRMWAK.js";import{a as Cr}from"./chunk-PL6CVK2A.js";import{e as Xe,f as Fr}from"./chunk-J2R7NR2E.js";import"./chunk-VPH54J3G.js";import{a as Bt}from"./chunk-OD6TX477.js";import{a as Xr}from"./chunk-ISUG5L3D.js";import"./chunk-FKKNYWR6.js";import"./chunk-M4PATAW3.js";import"./chunk-RPIA54UY.js";import"./chunk-WRN6YTSB.js";import"./chunk-BQ7BWYEG.js";import{a as jt}from"./chunk-UJ2T4QLZ.js";import"./chunk-FPZYH52G.js";import"./chunk-AXPRNSO3.js";import"./chunk-FIUHDVVO.js";import"./chunk-3HX6VT75.js";import"./chunk-U4Y7WABQ.js";import"./chunk-WYOOSF42.js";import"./chunk-R6S6A5GA.js";import{a as ye}from"./chunk-C3YONAAM.js";import"./chunk-2GSAHDXY.js";import"./chunk-OL24FY3J.js";import"./chunk-QBRYULPI.js";import"./chunk-GPQLPPA5.js";import"./chunk-OXRGERMH.js";import"./chunk-HVNUIUKO.js";import{n as qt}from"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import{a as Vt}from"./chunk-RRDM7P6F.js";import"./chunk-EYI3QUAE.js";import"./chunk-55A6ZSIC.js";import"./chunk-63EK7JRZ.js";import"./chunk-HVNRUZWJ.js";import{a as zt,b as te}from"./chunk-IH2TDIRR.js";import"./chunk-3FCM74ZB.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import{g as Ve}from"./chunk-MBVOWLUI.js";import{a as Gt}from"./chunk-EN6CTWVM.js";import"./chunk-IRJNWXGT.js";import{e as ue}from"./chunk-LVPMJTA6.js";import"./chunk-7LUQF6AI.js";import"./chunk-6GGK7PRJ.js";import"./chunk-AO7UDTUI.js";import"./chunk-Q7O5PY54.js";import"./chunk-CY477QBZ.js";import"./chunk-EJO53FLN.js";import"./chunk-XXR5OT24.js";import"./chunk-4XIZVPNF.js";import"./chunk-NNETCWLJ.js";import"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import{a as Mt}from"./chunk-MBJHSEMD.js";import"./chunk-SEKMXZL5.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-LAJXTVEO.js";import"./chunk-5MNDZ6BX.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import{a as Wt}from"./chunk-DPZGANVI.js";import{o as Jt}from"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-EUZMXXZJ.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import{l as L,y as H}from"./chunk-N27U3N2T.js";import{a as Et}from"./chunk-4R5NBZMW.js";import{a as J}from"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import{n as Nt,s as Dt}from"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import{b as Ot}from"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import{k as je}from"./chunk-TEY6TKJV.js";import{h as Pt}from"./chunk-4M6XQSBA.js";import{h as kt}from"./chunk-2JF6YUJG.js";import{Q as R,b as Rt}from"./chunk-GGZQ5GCM.js";import{A as de,J as Ct,U as z}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as I}from"./chunk-BMVJCP2M.js";import{D as Ft,k as vt,o as Tt,q as _t,w as Ge}from"./chunk-GMC3I5VG.js";import{a as St}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{r as ee,t as C}from"./chunk-3IBUFXWY.js";import{a as bt,u as ke}from"./chunk-BP73DJTS.js";import{a as P,b as B,g as S}from"./chunk-JEGVIFEP.js";var Kr=8,oi=256,li=0,V=class extends kt{constructor(){super(...arguments),this._tileFetchQueue=new jt({concurrency:32,process:(r,e)=>this._fetchRawTile(r.pyramidLevel,r.row,r.col,B(P({},r.options),{signal:e}))}),this.datasetName=null,this.datasetFormat=null,this.hasUniqueSourceStorageInfo=!0,this.rasterInfo=null,this.ioConfig={sampling:"closest"}}normalizeCtorArgs(r){return r?.ioConfig&&(r=B(P({},r),{ioConfig:P({resolution:null,bandIds:null,sampling:"closest",tileInfo:te.create()},r.ioConfig)})),r}get _isGlobalWrappableSource(){let{rasterInfo:r}=this,e=Ee(r.spatialReference);return e!=null&&r.extent.width>=e/2}get _hasNoneOrGCSShiftTransform(){let{transform:r}=this.rasterInfo;return r==null||r.type==="gcs-shift"}set rasterJobHandler(r){this._set("rasterJobHandler",r),this.datasetFormat==="Function"&&this.primaryRasters?.rasters?.forEach(e=>e.rasterJobHandler=r)}get rasterId(){return this.url||"rasterId-"+li++}set url(r){this._set("url",Ve(r,ee.getLogger(this)))}open(r){return S(this,null,function*(){return this._openPromise??=Ne().then(()=>this._open(r)),this._openPromise})}fetchTile(s,a,n){return S(this,arguments,function*(r,e,i,t={}){let l=t.tileInfo||this.rasterInfo.storageInfo.tileInfo,o=this.getTileExtentFromTileInfo(r,e,i,l);return t=P({noClip:!0},t),this.fetchPixels(o,l.size[0],l.size[1],t)})}identify(i){return S(this,arguments,function*(r,e={}){r=de(L,r).clone().normalize();let{multidimensionalDefinition:t,timeExtent:s}=e,{rasterInfo:a}=this,{hasMultidimensionalTranspose:n,multidimensionalInfo:l}=a,{transposedVariableName:o}=e,c=l!=null&&n&&(s!=null||Ke(t));c&&!o&&(o=t!=null&&t.length>0?t[0].variableName??void 0:l.variables[0].name,e=B(P({},e),{transposedVariableName:o})),e=this._getRequestOptionsWithSliceId(e);let{spatialReference:m,extent:f}=a,{datumTransformation:p}=e,u=st(r,m,p);if(!f.intersects(u))return{location:u,value:null};if(a.transform!=null){let O=a.transform.inverseTransform(u);if(!a.nativeExtent.intersects(O))return{location:O,value:null};u=O}let h=0,y=o!=null&&l!=null&&a.hasMultidimensionalTranspose;if(this.datasetFormat==="Function"){let O=this.primaryRasters.rasters[0];if(y)return O.identify(u,e);let{pixelSize:D}=a,M=3,A=D.x*M/2,K=D.y*M/2,G=new H({xmin:u.x-A,xmax:u.x+A,ymin:u.y-K,ymax:u.y+K,spatialReference:m}),$={interpolation:"nearest",multidimensionalDefinition:t,sliceId:e.sliceId},{pixelBlock:j}=yield O.fetchPixels(G,M,M,$),{pixelBlock:q}=yield this.fetchPixels(G,M,M,$);if(j==null)return{location:u,value:null};let Q=Math.floor(M*M*.5),ce=!j.mask||j.mask[Q]?j.pixels.map(se=>se[Q]):null,ie;return q!=null&&(ie=!q.mask||q.mask[Q]?q.pixels.map(se=>se[Q]):void 0),{location:u,value:ce,processedValue:ie,pyramidLevel:0}}if(!y){if(e.srcResolution)h=nt(e.srcResolution,a,this.ioConfig.sampling).pyramidLevel;else if(h=yield this.computeBestPyramidLevelForLocation(r,e),h==null)return{location:u,value:null}}let g=this.identifyPixelLocation(u,h,null,y);if(g===null)return{location:u,value:null};let{row:d,col:x,rowOffset:w,colOffset:b,blockWidth:T}=g,v=o??e.sliceId,_=ut(this.rasterId,v),k=`${h}/${d}/${x}`,E=pt(_,null,k);E==null&&(E=this.fetchRawTile(h,d,x,e),ft(_,null,k,E));let F=yield E;if(!F?.pixels?.length)return{location:u,value:null};let N=w*T+b;return this._processIdentifyResult(F,{srcLocation:u,position:N,pyramidLevel:h,useTransposedTile:!!y,requestSomeSlices:c,identifyOptions:e})})}fetchPixels(s,a,n){return S(this,arguments,function*(r,e,i,t={}){r=xr(r),t=this._getRequestOptionsWithSliceId(t);let{_hasNoneOrGCSShiftTransform:l}=this;if(t.requestRawData&&l)return this._fetchPixels(r,e,i,t);let o=Ee(r.spatialReference),c=$e(r);if(o==null||c===0||c===1&&this._isGlobalWrappableSource&&l)return this._fetchPixels(r,e,i,t);if(c>=3)return{extent:r,pixelBlock:null};let m=[],{xmin:f,xmax:p}=r,u=Math.round(o/(p-f)*e),h=u-Math.round((o/2-f)/(p-f)*e),y=0,g=[];for(let b=0;b<=c;b++){let T=new H({xmin:b===0?f:-o/2,xmax:b===c?p-o*b:o/2,ymin:r.ymin,ymax:r.ymax,spatialReference:r.spatialReference}),v=b===0?u-h:b===c?e-y:u;y+=v,g.push(v);let _=t.disableWrapAround&&b>0?null:this._fetchPixels(T,v,i,t);m.push(_)}let d=(yield Promise.all(m)).map(b=>b?.pixelBlock),x=null,w={width:e,height:i};return this.rasterJobHandler?x=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:d,srcMosaicSize:w,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:g},t)).pixelBlock:x=qe(d,w,{blockWidths:g}),{extent:r,srcExtent:xe(r,this.rasterInfo.spatialReference,t.datumTransformation),pixelBlock:x}})}fetchRawPixels(s,a,n){return S(this,arguments,function*(r,e,i,t={}){e={x:Math.floor(e.x),y:Math.floor(e.y)};let l=yield this._fetchRawTiles(r,e,i,t),{nativeExtent:o,nativePixelSize:c,storageInfo:m}=this.rasterInfo,f=2**r,p=c.x*f,u=c.y*f,h=new H({xmin:o.xmin+p*e.x,xmax:o.xmin+p*(e.x+i.width-1),ymin:o.ymax-u*(e.y+i.height-1),ymax:o.ymax-u*e.y,spatialReference:o.spatialReference});if(!l)return{extent:h,srcExtent:h,pixelBlock:null};let{pixelBlocks:y,mosaicSize:g}=l;if(y.length===1&&y[0]!=null&&y[0].width===i.width&&y[0].height===i.height)return{extent:h,srcExtent:h,pixelBlock:l.pixelBlocks[0]};let d=r>0?m.pyramidBlockWidth:m.blockWidth,x=r>0?m.pyramidBlockHeight:m.blockHeight,w={x:e.x%d,y:e.y%x},b;return this.rasterJobHandler?b=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:y,srcMosaicSize:g,destDimension:i,clipOffset:w,clipSize:i,coefs:null,sampleSpacing:null,interpolation:t.interpolation,alignmentInfo:null,blockWidths:null},t)).pixelBlock:b=qe(y,g,{clipOffset:w,clipSize:i}),{extent:h,srcExtent:h,pixelBlock:b}})}fetchRawTile(r,e,i,t){throw new C("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}computeExtent(r){return xe(this.rasterInfo.extent,r)}decodePixelBlock(r,e){return!this.rasterJobHandler||e.useCanvas?cr(r,e):this.rasterJobHandler.decode({data:r,options:e})}request(r,e,i=0){return S(this,null,function*(){let{customFetchParameters:t}=this.ioConfig,{range:s,query:a,headers:n}=e;i=i??e.retryCount??this.ioConfig.retryCount;let l=s?{Range:`bytes=${s.from}-${s.to}`}:null;try{return yield je(r,B(P({},e),{query:P(P({},a),t),headers:P(P({},n),l)}))}catch(o){if(i>0)return i--,this.request(r,e,i);throw o}})}getSliceIndex(r){let{multidimensionalInfo:e}=this.rasterInfo;return e==null||r==null||r.length===0?null:Qe(r,e)}getTileExtentFromTileInfo(r,e,i,t){let s=t.lodAt(r);return this.getTileExtent({x:s.resolution,y:s.resolution},e,i,t.origin,t.spatialReference,t.size)}updateTileInfo(){let{storageInfo:r,spatialReference:e,extent:i,pixelSize:t}=this.rasterInfo,{pyramidResolutions:s}=r;if(!r.tileInfo){let a=[],n=r.maximumPyramidLevel||0,l=(t.x+t.y)/2,o=1/.0254*96*l;for(let m=0;m<=n&&(a.unshift(new zt({level:n-m,resolution:l,scale:o})),m!==n);m++)if(s){let f=(s[m].x+s[m].y)/2;o*=f/l,l=f}else l*=2,o*=2;let c=new L({x:i.xmin,y:i.ymax,spatialReference:e});r.tileInfo=new te({origin:c,size:[r.blockWidth,r.blockHeight],spatialReference:e,lods:a}),r.isVirtualTileInfo=!0}}createRemoteDatasetStorageInfo(r,e=512,i=512,t){let{width:s,height:a,nativeExtent:n,pixelSize:l,spatialReference:o}=r,c=new L({x:n.xmin,y:n.ymax,spatialReference:o});t==null&&(t=Math.max(0,Math.round(Math.log(Math.max(s,a))/Math.LN2-8)));let m=this.computeBlockBoundary(n,512,512,{x:n.xmin,y:n.ymax},[l],t);r.storageInfo=new ne({blockWidth:e,blockHeight:i,pyramidBlockWidth:e,pyramidBlockHeight:i,origin:c,firstPyramidLevel:1,maximumPyramidLevel:t,blockBoundary:m})}computeBestPyramidLevelForLocation(i){return S(this,arguments,function*(r,e={}){return 0})}computeBlockBoundary(r,e,i,t,s,a=0,n=2){if(s.length===1&&a>0){s=[...s];let{x:m,y:f}=s[0];for(let p=0;p<a;p++)m*=n,f*=n,s.push({x:m,y:f})}let l=[],{x:o,y:c}=t;for(let m=0;m<s.length;m++){let{x:f,y:p}=s[m];l.push({minCol:Math.floor((r.xmin-o+.1*f)/e/f),maxCol:Math.floor((r.xmax-o-.1*f)/e/f),minRow:Math.floor((c-r.ymax+.1*p)/i/p),maxRow:Math.floor((c-r.ymin-.1*p)/i/p)})}return l}getPyramidPixelSize(r){let{nativePixelSize:e}=this.rasterInfo,{pyramidResolutions:i,pyramidScalingFactor:t}=this.rasterInfo.storageInfo;if(r===0)return e;if(i!=null&&i.length)return i[r-1];let s=t**r;return{x:e.x*s,y:e.y*s}}identifyPixelLocation(r,e,i,t){let{spatialReference:s,nativeExtent:a,storageInfo:n}=this.rasterInfo,{maximumPyramidLevel:l,origin:o,transposeInfo:c}=n,m=t&&c!=null?c.tileSize[0]:n.blockWidth,f=t&&c!=null?c.tileSize[1]:n.blockHeight,p=st(r,s,i);if(!a.intersects(p)||e<0||e>l)return null;let u=this.getPyramidPixelSize(e),{x:h,y}=u,g=(o.y-p.y)/y/f,d=(p.x-o.x)/h/m,x=Math.min(f-1,Math.floor((g-Math.floor(g))*f)),w=Math.min(m-1,Math.floor((d-Math.floor(d))*m));return{pyramidLevel:e,row:Math.floor(g),col:Math.floor(d),rowOffset:x,colOffset:w,blockWidth:m,srcLocation:p}}getTileExtent(r,e,i,t,s,a){let[n,l]=a,o=t.x+i*n*r.x,c=o+n*r.x,m=t.y-e*l*r.y,f=m-l*r.y;return new H({xmin:o,xmax:c,ymin:f,ymax:m,spatialReference:s})}getBlockWidthHeight(r){return{blockWidth:r>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:r>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}isBlockOutside(r,e,i){let t=this.rasterInfo.storageInfo.blockBoundary[r];return!t||t.maxRow<e||t.maxCol<i||t.minRow>e||t.minCol>i}updateImageSpaceRasterInfo(r){let{pixelSize:e}=r,{width:i,height:t}=r,s=J.WebMercator;r.spatialReference=s,r.extent=r.nativeExtent=new H({xmin:-.5,ymax:.5,xmax:i-.5,ymin:.5-t,spatialReference:s}),r.isPseudoSpatialReference=!0,r.transform=null,r.pixelSize=new L({x:1,y:1,spatialReference:s});let{extent:a,storageInfo:n}=r;if(n){n.origin=new L({x:a.xmin,y:a.ymax,spatialReference:s});let{pyramidResolutions:l,tileInfo:o}=n;if(l&&l.forEach(c=>{c.x/=e.x,c.y/=e.y}),o){o.origin=n.origin;let c=(r.nativePixelSize.x+r.nativePixelSize.y)/2;o.lods.forEach((m,f)=>{m.resolution=c*2**f,m.scale=96*m.resolution/.0254})}}}_fetchPixels(s,a,n){return S(this,arguments,function*(r,e,i,t={}){let l=$e(r);if(l>=2)return{extent:r,pixelBlock:null};let o=this._getSourceDataInfo(r,e,i,t),{pyramidLevel:c,srcResolution:m,srcExtent:f,srcWidth:p,srcHeight:u,ul:h}=o;if(p===0||u===0)return{extent:r,srcExtent:f,pixelBlock:null};let{rasterInfo:y}=this,g=y.transform,d=g?.type==="gcs-shift",x=Ee(r.spatialReference)!=null;!d&&x||(l=$e(o.srcExtent,d));let w=yield this._fetchRawTiles(c,h,{width:p,height:u,wrapCount:l},t);if(!w)return{extent:r,srcExtent:f,pixelBlock:null};let b=y.storageInfo,T=c>0?b.pyramidBlockWidth:b.blockWidth,v=c>0?b.pyramidBlockHeight:b.blockHeight,{x:_,y:k}=y.pixelSize;if(c>0){let{pyramidResolutions:me,pyramidScalingFactor:ai}=b;if(me!=null&&me[c-1])({x:_,y:k}=me[c-1]);else{let It=ai**c;_*=It,k*=It}}let E=y.spatialReference,F=new L({x:_,y:k,spatialReference:E}),N=T===p&&v===u&&h.x%T==0&&h.y%v==0,O=new L({x:(r.xmax-r.xmin)/e,y:(r.ymax-r.ymin)/i,spatialReference:r.spatialReference}),D=!r.spatialReference.equals(E),M=E.isGeographic?1e-9:1e-4,{datumTransformation:A}=t;if(!D&&N&&w.pixelBlocks.length===1&&T===e&&v===i&&ci(m,O,M))return{extent:r,srcExtent:f,srcTilePixelSize:F,pixelBlock:w.pixelBlocks[0]};let K=x&&Ee(f.spatialReference)!=null&&this._hasNoneOrGCSShiftTransform,G=t.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector");G&&!this.rasterJobHandler&&(yield Ne());let $=this.rasterJobHandler?yield this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:r,srcBufferExtent:w.extent,pixelSize:O.toJSON(),datumTransformation:A,rasterTransform:g,hasWrapAround:l>0||K,isAdaptive:this.ioConfig.optimizeProjectionAccuracy!==!1,includeGCSGrid:G},t):gr({projectedExtent:r,srcBufferExtent:w.extent,pixelSize:O,datumTransformation:A,rasterTransform:g,hasWrapAround:l>0||K,isAdaptive:!1,includeGCSGrid:G}),j,q=!t.requestRawData,Q={rows:$.spacing[0],cols:$.spacing[1]},ce=this._hasNoneOrGCSShiftTransform?this._getRasterTileAlignmentInfo(c,w.extent.xmin):void 0,{pixelBlocks:ie,mosaicSize:se,isPartiallyFilled:ni}=w,We=null;if(this.rasterJobHandler)({pixelBlock:j,localNorthDirections:We}=yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:ie,srcMosaicSize:se,destDimension:q?{width:e,height:i}:null,coefs:q?$.coefficients:null,sampleSpacing:q?Q:null,projectDirections:G,gcsGrid:G?$.gcsGrid:null,isUV:this.rasterInfo.dataType==="vector-uv",interpolation:t.interpolation,alignmentInfo:ce,blockWidths:null},t));else{let me=qe(ie,se,{alignmentInfo:ce});j=q?Ue(me,{width:e,height:i},$.coefficients,Q,t.interpolation):me,G&&$.gcsGrid&&(We=fr({width:e,height:i},$.gcsGrid),j=Rr(j,this.rasterInfo.dataType,We))}return t.requestRawData||G?{extent:r,srcExtent:f,srcTilePixelSize:F,pixelBlock:j,transformGrid:$,localNorthDirections:We,isPartiallyFilled:ni}:{extent:r,srcExtent:f,srcTilePixelSize:F,pixelBlock:j}})}_fetchRawTiles(r,e,i,t){return S(this,null,function*(){let{origin:s,blockBoundary:a}=this.rasterInfo.storageInfo,{blockWidth:n,blockHeight:l}=this.getBlockWidthHeight(r),{x:o,y:c}=e,{width:m,height:f,wrapCount:p}=i,u=this._getRasterTileAlignmentInfo(r,0);t.buffer&&(o-=t.buffer.cols,c-=t.buffer.rows,m+=2*t.buffer.cols,f+=2*t.buffer.rows);let h=0,y=0,g=0;p&&u!=null&&({worldColumnCountFromOrigin:y,originColumnOffset:g,rightPadding:h}=u,y*u.blockWidth-h>=o+m&&(h=0));let d=Math.floor(o/n),x=Math.floor(c/l),w=Math.floor((o+m+h-1)/n),b=Math.floor((c+f+h-1)/l),T=a[r];if(!T)return null;let{minRow:v,minCol:_,maxCol:k,maxRow:E}=T;if(p===0&&(b<v||w<_||x>E||d>k))return null;let F=new Array,N=!1,O=this.ioConfig.allowPartialFill==null?t.allowPartialFill:this.ioConfig.allowPartialFill;for(let j=x;j<=b;j++)for(let q=d;q<=w;q++){let Q=q;if(!t.disableWrapAround&&p&&u!=null&&y<=q&&(Q=q-y-g),j>=v&&Q>=_&&E>=j&&k>=Q){let ce=this._tileFetchQueue.push({pyramidLevel:r,row:j,col:Q,options:t},{signal:t.signal});O?F.push(new Promise(ie=>{ce.then(se=>ie(se)).catch(()=>{N=!0,ie(null)})})):F.push(ce)}else F.push(Promise.resolve(null))}if(F.length===0)return null;let D=yield Promise.all(F),M={height:(b-x+1)*l,width:(w-d+1)*n},{spatialReference:A}=this.rasterInfo,K=this.getPyramidPixelSize(r),{x:G,y:$}=K;return{extent:new H({xmin:s.x+d*n*G,xmax:s.x+(w+1)*n*G,ymin:s.y-(b+1)*l*$,ymax:s.y-x*l*$,spatialReference:A}),pixelBlocks:D,mosaicSize:M,isPartiallyFilled:N}})}_fetchRawTile(r,e,i,t){let s=this.rasterInfo.storageInfo.blockBoundary[r];if(!s)return Promise.resolve(null);let{minRow:a,minCol:n,maxCol:l,maxRow:o}=s;if(e<a||i<n||e>o||i>l)return Promise.resolve(null);let c=ut(this.rasterId,t.sliceId),m=`${r}/${e}/${i}`,f=pt(c,t.registryId,m);if(f==null){let p=new AbortController;f=this.fetchRawTile(r,e,i,B(P({},t),{signal:p.signal})),ft(c,t.registryId,m,f,p),f.catch(()=>$r(c,t.registryId,m))}return t.signal&&_t(t,()=>{Ur(c,t.registryId,m)}),f}_computeMagDirValues(r){let{bandCount:e,dataType:i}=this.rasterInfo;if(!(e===2&&i==="vector-magdir"||i==="vector-uv")||r?.length!==2||!r[0]?.length)return null;let t=r[0].length;if(i==="vector-magdir"){let o=r[1].map(c=>(c+360)%360);return[r[0],o]}let[s,a]=r,n=[],l=[];for(let o=0;o<t;o++){let[c,m]=br([s[o],a[o]]);n.push(c),l.push(m)}return[n,l]}_getRasterTileAlignmentInfo(r,e){return this._rasterTileAlignmentInfo==null&&(this._rasterTileAlignmentInfo=yr(this.rasterInfo)),this._rasterTileAlignmentInfo.pyramidsInfo==null?null:P({startX:e,halfWorldWidth:this._rasterTileAlignmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlignmentInfo.hasGCSSShiftTransform},this._rasterTileAlignmentInfo.pyramidsInfo[r])}_getSourceDataInfo(r,e,i,t={}){let s={datumTransformation:t.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};t.srcResolution&&(s.srcResolution=t.srcResolution,this._updateSourceDataInfo(r,s));let a=this.rasterInfo.storageInfo.maximumPyramidLevel||0,{srcWidth:n,srcHeight:l,pyramidLevel:o}=s,c=n/e,m=l/i,f=o<a&&c*m>=16,p=o===a&&this._requireTooManySrcTiles(n,l,e,i);if(f||p||n===0||l===0){let u=new L({x:(r.xmax-r.xmin)/e,y:(r.ymax-r.ymin)/i,spatialReference:r.spatialReference}),h=dr(u,this.rasterInfo.spatialReference,r,s.datumTransformation),y=!h||t.srcResolution&&h.x+h.y<t.srcResolution.x+t.srcResolution.y;if(f&&t.srcResolution&&y){let g=Math.round(Math.log(Math.max(c,m))/Math.LN2)-1;if(a-o+3>=g){let d=2**g;h={x:t.srcResolution.x*d,y:t.srcResolution.y*d}}}h&&(s.srcResolution=h,this._updateSourceDataInfo(r,s))}return this._requireTooManySrcTiles(s.srcWidth,s.srcHeight,e,i)&&(s.srcWidth=0,s.srcHeight=0),s}_requireTooManySrcTiles(r,e,i,t){let{tileInfo:s}=this.rasterInfo.storageInfo,a=Math.ceil(r/s.size[0])*Math.ceil(e/s.size[1]),n=r/i,l=e/t,o=Math.max(1,(i+t)/1024);return a>=oi*o||n>Kr||l>Kr}_updateSourceDataInfo(r,e){e.srcWidth=0,e.srcHeight=0;let{rasterInfo:i}=this,t=i.spatialReference,{srcResolution:s,datumTransformation:a}=e,{pyramidLevel:n,pyramidResolution:l,excessiveReading:o}=nt(s,i,this.ioConfig.sampling);if(o)return;let c=e.srcExtent||xe(r,t,a);if(c==null)return;let m=i.transform;m&&(c=m.inverseTransform(c)),e.srcExtent=c;let{x:f,y:p}=i.storageInfo.origin,u=Math.floor((c.xmin-f)/l.x+.1),h=Math.floor((p-c.ymax)/l.y+.1),y=Math.floor((c.xmax-f)/l.x-.1),g=Math.floor((p-c.ymin)/l.y-.1),d=c.width<.1*l.x?0:y-u+1,x=c.height<.1*l.y?0:g-h+1;e.pyramidLevel=n,e.pyramidResolution=l,e.srcWidth=d,e.srcHeight=x,e.ul={x:u,y:h}}_getRequestOptionsWithSliceId(r){return this.rasterInfo.multidimensionalInfo!=null&&r.sliceId==null&&(r=B(P({},r),{sliceId:this.getSliceIndex(r.multidimensionalDefinition)})),r}_processIdentifyResult(r,e){let{srcLocation:i,position:t,pyramidLevel:s,useTransposedTile:a}=e,n=r.pixels[0].length/r.width/r.height;if(!(!r.mask||r.mask[t]))return{location:i,value:null};let{multidimensionalInfo:l}=this.rasterInfo;if(l==null||!a){let g=r.pixels.map(w=>w[t]),d={location:i,value:g,pyramidLevel:s},x=this._computeMagDirValues(g.map(w=>[w]));return x?.length&&(d.magdirValue=x.map(w=>w[0])),d}let o=r.pixels.map(g=>g.slice(t*n,t*n+n)),c=this._computeMagDirValues(o),{requestSomeSlices:m,identifyOptions:f}=e,p=Er(l,f.transposedVariableName);if(m){let g=Br(p,f.multidimensionalDefinition,f.timeExtent);o=o.map(d=>g.map(x=>d[x])),c=c?.map(d=>g.map(x=>d[x])),p=g.map(d=>p[d])}let u=r.noDataValues||this.rasterInfo.noDataValue,h={pixels:o,pixelType:r.pixelType},y;return u!=null&&(Zt(h,u),y=h.mask),{location:i,value:null,dataSeries:p.map((g,d)=>{let x={value:y?.[d]===0?null:o.map(w=>w[d]),multidimensionalDefinition:g.multidimensionalDefinition.map(w=>new Re(B(P({},w),{isSlice:!0})))};return c?.length&&(x.magdirValue=[c[0][d],c[1][d]]),x}),pyramidLevel:s}}};function ci(r,e,i){return Math.abs(r.x-e.x)<i&&Math.abs(r.y-e.y)<i}I([R()],V.prototype,"_rasterTileAlignmentInfo",void 0),I([R()],V.prototype,"_tileFetchQueue",void 0),I([R({readOnly:!0})],V.prototype,"_isGlobalWrappableSource",null),I([R({readOnly:!0})],V.prototype,"_hasNoneOrGCSShiftTransform",null),I([R()],V.prototype,"_openPromise",void 0),I([R()],V.prototype,"rasterJobHandler",null),I([R({readOnly:!0})],V.prototype,"rasterId",null),I([R(Xe)],V.prototype,"url",null),I([R({type:String,json:{write:!0}})],V.prototype,"datasetName",void 0),I([R({type:String,json:{write:!0}})],V.prototype,"datasetFormat",void 0),I([R()],V.prototype,"hasUniqueSourceStorageInfo",void 0),I([R()],V.prototype,"rasterInfo",void 0),I([R()],V.prototype,"ioConfig",void 0),I([R()],V.prototype,"sourceJSON",void 0),V=I([z("esri.layers.support.rasterDatasets.BaseRaster")],V);var Y=V;var mi=40,pe=class extends Y{constructor(){super(...arguments),this.datasetFormat="Function",this.tileType="Raster",this.rasterFunction=null,this._clippingGeometry=new Map}fetchPixels(s,a,n){return S(this,arguments,function*(r,e,i,t={}){let{rasters:l,rasterIds:o}=this.primaryRasters,c=!1,{interpolation:m}=t,f=this.rasterFunction.flatWebGLFunctionChain?.hasFocalFunction;!t.requestRawData&&f&&(c=l.length===1&&!t.skipRasterFunction,t=B(P({},t),{interpolation:"bilinear",requestRawData:c}));let p=l.map(v=>v.fetchPixels(r,e,i,t)),u=yield Promise.all(p),h=u.map(v=>v.pixelBlock),y=c||t.requestRawData?u.map(v=>v.srcTilePixelSize):null;if(t.skipRasterFunction||h.every(v=>v==null))return u[0];let g=u.find(v=>v.pixelBlock!=null)?.extent??r,d=this.rasterJobHandler?yield this.rasterJobHandler.process({extent:g,primaryPixelBlocks:h,primaryPixelSizes:y,primaryRasterIds:o}):this.rasterFunction.process({extent:g,primaryPixelBlocks:h,primaryPixelSizes:y,primaryRasterIds:o}),{transformGrid:x}=u[0];if(!c||d==null||x==null){let v=t.noClip?null:this.getClippingGeometry(g.spatialReference);return t.noClip||t.requestRawData||d==null||!v||(d=yield Me(d,g,v)),B(P({},u[0]),{pixelBlock:d})}let w={rows:x.spacing[0],cols:x.spacing[1]},b;this.rasterJobHandler?b=(yield this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[d],srcMosaicSize:{width:d.width,height:d.height},destDimension:{width:e,height:i},coefs:x.coefficients,sampleSpacing:w,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:m,alignmentInfo:void 0,blockWidths:null},t)).pixelBlock:b=Ue(d,{width:e,height:i},x.coefficients,w,m);let T=t.noClip?null:this.getClippingGeometry(r.spatialReference);return t.noClip||t.requestRawData||b==null||T==null||(b=yield Me(b,r,T)),{extent:r,srcExtent:u[0].srcExtent,pixelBlock:b}})}getClippingGeometry(r){let e=this._clippingGeometry.get("0");if(!r||!e)return e;let i=pi(r),t=this._clippingGeometry.get(i);return t!=null||(t=r.equals(e.spatialReference)?e:De(e,r),this._clippingGeometry.set(i,t)),t}_open(r){return S(this,null,function*(){let{rasterFunction:e}=this;this.primaryRasters?.rasters?.length?e.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=e.getPrimaryRasters(),this.rasterJobHandler&&this.primaryRasters.rasters?.forEach(c=>c.rasterJobHandler=this.rasterJobHandler));let{rasters:i,rasterIds:t}=this.primaryRasters,s=i.map(c=>c.rasterInfo?void 0:c.open(r));yield Promise.all(s);let a=i.map(({rasterInfo:c})=>c),n=e.bind({rasterInfos:a,rasterIds:t});if(e.rawSourceRasterInfos=a,!n.success||a.length===0)throw new C("raster-function:open",`cannot bind the function: ${n.error??""}`);let l=e.functionName==="Table"?e:e.functionArguments?.raster;l?.functionName==="Table"&&(e.rasterInfo.attributeTable=ye.fromJSON(l.functionArguments.attributeTableAsRecordSet)),yield this.syncJobHandler();let o=a[0];this.hasUniqueSourceStorageInfo=a.length===1||a.slice(1).every(c=>ui(c,o)),this.set("sourceJSON",i[0].sourceJSON),this.set("rasterInfo",e.rasterInfo),yield this._updateClipGeometry()})}syncJobHandler(){return S(this,null,function*(){return this.rasterJobHandler?.updateRasterFunction(this.rasterFunction)})}_updateClipGeometry(){return S(this,null,function*(){let r=this.rasterFunction.getClippingGeometries()[0],e=r?.clippingGeometry;if(e&&r.clippingType==="inside"){let{extent:i}=this.rasterInfo,{difference:t,densify:s}=yield import("./chunk-RCUZLKRT.js"),a=s(Jt.fromExtent(i),2*(i.width+i.height)/mi);a=De(a,e.spatialReference),e=t(a,e)}this._clippingGeometry.clear(),e&&this._clippingGeometry.set("0",e)})}};I([R({type:String,json:{write:!0}})],pe.prototype,"datasetFormat",void 0),I([R()],pe.prototype,"tileType",void 0),I([R()],pe.prototype,"rasterFunction",void 0),I([R()],pe.prototype,"primaryRasters",void 0),pe=I([z("esri.layers.support.rasterDatasets.FunctionRaster")],pe);var Ze=pe;function ui(r,e){let{storageInfo:i,pixelSize:t,spatialReference:s,extent:a}=r,{storageInfo:n,pixelSize:l,spatialReference:o,extent:c}=e;return t.x===l.x&&t.y===l.y&&s.equals(o)&&a.equals(c)&&i.blockHeight===n.blockHeight&&i.blockWidth===n.blockWidth&&i.maximumPyramidLevel===n.maximumPyramidLevel}function pi(r){return String(r.wkid??r.wkt??r.wkt2)}var Qr=r=>{let e=class extends r{constructor(...t){super(...t),this._isConstructedFromFunctionRaster=!1,this._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},this.bandIds=null,this.copyright=null,this.interpolation=null,this.multidimensionalSubset=null,this.raster=null,this.serviceRasterInfo=null,this.sourceJSON=null,this.spatialReference=null,this.symbolizer=null,this._isConstructedFromFunctionRaster=t[0]?.raster?.datasetFormat==="Function"}get fullExtent(){return this.serviceRasterInfo?.extent}set multidimensionalDefinition(t){this._set("multidimensionalDefinition",t),this.updateRenderer()}set rasterFunction(t){t?.functionName?.toLowerCase()==="none"&&(t=void 0),this._set("rasterFunction",t),this.updateRasterFunction()}get rasterInfo(){return Rt(ee.getLogger(this),"rasterInfo",{replacement:"serviceRasterInfo",version:"4.29",warnOnce:!0}),this._get("serviceRasterInfo")}set url(t){this._set("url",Ve(t,ee.getLogger(this)))}get renderer(){if(this.type!=="imagery-tile")return this.internalRenderer;let{activePresetRendererName:t,presetRenderers:s}=this;return t?s?.find(({name:n})=>n===t)?.renderer.clone():this.internalRenderer}set renderer(t){this.type==="imagery-tile"&&(this.activePresetRendererName=null),this.internalRenderer=t}set internalRenderer(t){t==null&&this.rasterFunction==null?this._configDefaultRenderer("override"):(this._set("internalRenderer",t),this.updateRenderer())}readRenderer(t,s,a){let n=s?.layerDefinition?.drawingInfo?.renderer;return Or(n,a)||void 0}convertVectorFieldData(t,s){return S(this,null,function*(){let{serviceRasterInfo:a}=this;if(t==null||!a)return null;let n=this._rasterJobHandler.instance,l=a.dataType;return n?n.convertVectorFieldData({pixelBlock:t,dataType:l},s):Sr(t,l)})}computeStatisticsHistograms(t,s){return S(this,null,function*(){yield this.load(s),t=de(Gr,t).clone();let{serviceRasterInfo:a}=this;if(a==null)throw new C("imagery-tile-mixin:compute-statistics-histograms","serviceRasterInfo must be specified");let{geometry:n}=t;if(n==null)throw new C("imagery-tile-mixin:compute-statistics-histograms","geometry must be specified");let l=n,{spatialReference:o}=a;n.spatialReference.equals(o)||(yield Ne(),l=n.type==="extent"?xe(n,o):De(n,o));let c=t.pixelSize??new L({x:a.pixelSize.x,y:a.pixelSize.y,spatialReference:o}),{extent:m,width:f,height:p}=hr(a,l,c),u=yield this.fetchPixels(m,f,p,B(P({},s),{interpolation:"nearest"}));if(u.pixelBlock==null)throw new C("imagery-tile-mixin:compute-statistics-histograms","failed to fetch pixels");let h=yield Me(u.pixelBlock,m,l),y=this._rasterJobHandler.instance;return y?y.computeStatisticsHistograms({pixelBlock:h},s):we(h)})}createFlowMesh(t,s){return S(this,null,function*(){let a=this._rasterJobHandler.instance;return a?a.createFlowMesh(t,s):_r(t.meshType,t.simulationSettings,t.flowData,s.signal!=null?s.signal:new AbortController().signal)})}normalizeRasterFetchOptions(t){let{multidimensionalInfo:s}=this.serviceRasterInfo??{};if(s==null)return t;let a=t.multidimensionalDefinition||this.multidimensionalDefinition;a?.length||(a=ot(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));let n=t.timeExtent||this.timeExtent;if(a!=null&&n!=null&&(n.start!=null||n.end!=null)){a=a.map(y=>y.clone());let l=s.variables.find(({name:y})=>y===a[0].variableName)?.dimensions?.find(({name:y})=>y==="StdTime"),o=a.find(({dimensionName:y})=>y==="StdTime");if(!l||!o)return B(P({},t),{multidimensionalDefinition:null});let{start:c,end:m}=n,f=c==null?null:c.getTime(),p=m==null?null:m.getTime(),u=f??p,h=p??f;if(l.values!=null){let y=l.values.filter(g=>{if(Array.isArray(g)){if(u===h)return g[0]<=u&&g[1]>=u;let d=g[0]<=u&&g[1]>u||g[0]<h&&g[1]>=h,x=g[0]>=u&&g[1]<=h||g[0]<u&&g[1]>h;return d||x}return u===h?g===u:g>=u&&g<=h});if(y.length){let g=y.sort((d,x)=>{let w=Array.isArray(d)?d[0]:d,b=Array.isArray(d)?d[1]:d,T=Array.isArray(x)?x[0]:x,v=Array.isArray(x)?x[1]:x;return u===h?w-T:Math.abs(b-h)-Math.abs(v-h)})[0];o.values=[g]}else a=null}else if(l.hasRegularIntervals&&l.extent){let[y,g]=l.extent;u>g||h<y?a=null:o.values=u===h?[u]:[Math.max(y,u),Math.min(g,h)]}}return a!=null&&Jr(a,this.multidimensionalSubset)?B(P({},t),{multidimensionalDefinition:null}):B(P({},t),{multidimensionalDefinition:a})}updateRasterFunction(){return S(this,null,function*(){if(!this.loaded||this.type!=="imagery-tile"||!this.rasterFunction&&!this._cachedRasterFunctionJson||JSON.stringify(this.rasterFunction)===JSON.stringify(this._cachedRasterFunctionJson))return;if(this._isConstructedFromFunctionRaster&&this.raster.datasetFormat==="Function"){let m=this.raster.rasterFunction.toJSON();return!this.rasterFunction&&m&&this._set("rasterFunction",Be.fromJSON(m)),void(this._cachedRasterFunctionJson=this.rasterFunction?.toJSON())}let t,s=this.raster,a=!1;s.datasetFormat==="Function"?(t=s.primaryRasters.rasters,s=t[0],a=!0):t=[s];let{rasterFunction:n}=this;if(n){let m={raster:s};t.length>1&&t.forEach(u=>m[u.url]=u);let f=Ye(n.functionDefinition?.toJSON()??n.toJSON(),m),p=new Ze({rasterFunction:f});p.rasterJobHandler=this._rasterJobHandler.instance,yield p.open(),this._cachedRasterFunctionJson=this.rasterFunction?.toJSON(),this.raster=p}else this.raster=s,this._cachedRasterFunctionJson=null,yield s.open();if(this._cachedRendererJson=null,!a&&!n)return;let{bandIds:l}=this,{bandCount:o}=this.raster.rasterInfo,c=l?.length?l.some(m=>m>=o):o>=3;l&&(c||this.renderer&&this.renderer.type!=="raster-stretch")&&this._set("bandIds",null),this._configDefaultRenderer("auto")})}updateRenderer(){return S(this,null,function*(){let{loaded:t,symbolizer:s}=this;if(!t||!s||!this.renderer)return;let{rasterInfo:a}=this.raster,n=at(a,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),l=n?.name,o=mt(B(P({},this.renderer.toJSON()),{variableName:l}));if(JSON.stringify(this._cachedRendererJson)===JSON.stringify(o))return;let c=this._rasterJobHandler.instance;c&&(s.rasterInfo=ct(a,l),s.rendererJSON=o,s.bind(),yield c.updateSymbolizer(s),this._cachedRendererJson=o)})}applyRenderer(t,s){return S(this,null,function*(){let a=t?.pixelBlock;if(!(a!=null&&a.pixels&&a.pixels.length>0))return null;let n;yield this.updateRenderer();let l=this._rasterJobHandler.instance,o=this.bandIds??[];return n=l?yield l.symbolize(B(P({},t),{simpleStretchParams:s,bandIds:o})):this.symbolizer.symbolize(B(P({},t),{simpleStretchParams:s,bandIds:o})),n})}getTileUrl(t,s,a){return this.raster.datasetFormat==="RasterTileServer"?`${this.url}/tile/${t}/${s}/${a}`:""}getCompatibleTileInfo(t,s,a=!1){if(!this.loaded||s==null)return null;if(a&&t.equals(this.spatialReference))return this.tileInfo;let n=Nt(t);return te.create({size:256,spatialReference:t,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:s.xmin,y:s.ymax}})}getCompatibleFullExtent(t){return this.loaded?(this._compatibleFullExtent?.spatialReference.equals(t)||(this._compatibleFullExtent=this.raster.computeExtent(t)),this._compatibleFullExtent):null}fetchTile(l,o,c){return S(this,arguments,function*(t,s,a,n={}){if(i(this),n.requestAsImageElement){let f=this.getTileUrl(t,s,a);return je(f,{responseType:"image",query:P(P({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:n.signal}).then(p=>p.data)}let{serviceRasterInfo:m}=this;if(m.multidimensionalInfo!=null&&(n=this.normalizeRasterFetchOptions(n)).multidimensionalDefinition==null){let f=n.tileInfo||m.storageInfo.tileInfo;return{extent:this.raster.getTileExtentFromTileInfo(t,s,a,f),pixelBlock:null}}return yield this._initJobHandler(),yield this.updateRasterFunction(),this.renderer?.type==="raster-shaded-relief"&&(n=B(P({},n),{buffer:{cols:1,rows:1}})),this.raster.fetchTile(t,s,a,n)})}fetchPixels(l,o,c){return S(this,arguments,function*(t,s,a,n={}){return this.serviceRasterInfo.multidimensionalInfo!=null&&(n=this.normalizeRasterFetchOptions(n)).multidimensionalDefinition==null?{extent:t,pixelBlock:null}:(yield this._initJobHandler(),yield this.updateRasterFunction(),s=Math.round(s),a=Math.round(a),this.raster.fetchPixels(t,s,a,n))})}identify(a){return S(this,arguments,function*(t,s={}){yield this.load();let{raster:n,serviceRasterInfo:l}=this;if(l?.multidimensionalInfo!=null&&!(l.hasMultidimensionalTranspose&&(Ke(s.multidimensionalDefinition)||s.transposedVariableName||s.timeExtent))&&(s=this.normalizeRasterFetchOptions(s)).multidimensionalDefinition==null)return{location:t,value:null};let o=this.multidimensionalSubset?.areaOfInterest;if(o&&!o.contains(t))throw new C("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");return n.identify(t,s)})}increaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount++}decreaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}hasStandardTime(){let t=this.serviceRasterInfo?.multidimensionalInfo;if(t==null||this.serviceRasterInfo?.dataType!=="standard-time")return!1;let s=this.multidimensionalDefinition,a=s?.[0]?.variableName;return t.variables.some(n=>n.name===a&&(!s?.[0].dimensionName||n.dimensions.some(l=>l.name==="StdTime")))}getStandardTimeValue(t){return new Date(24*(t-25569)*3600*1e3).toString()}getMultidimensionalSubsetVariables(t){let s=t??this.serviceRasterInfo?.multidimensionalInfo;return Ar(this.multidimensionalSubset,s)}_configDefaultSettings(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=ot(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this.rasterFunction&&this.raster.datasetFormat==="Function"&&(this._cachedRasterFunctionJson=this.rasterFunction.toJSON()),this._configDefaultRenderer()}_initJobHandler(){if(this._rasterJobHandler.connectionPromise!=null)return this._rasterJobHandler.connectionPromise;let t=new Dr;return this._rasterJobHandler.connectionPromise=t.initialize().then(()=>S(this,null,function*(){i(this),this._rasterJobHandler.instance=t,this.raster.rasterJobHandler=t,this.raster.datasetFormat==="Function"&&this.raster.syncJobHandler(),this.rasterFunction&&(yield this.updateRasterFunction().catch(()=>{})),this.renderer&&this.updateRenderer()})).catch(()=>{}),this._rasterJobHandler.connectionPromise}_shutdownJobHandler(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}_configDefaultInterpolation(){if(this.interpolation==null){i(this);let{raster:t}=this,s=zr(t.rasterInfo,t.tileType,this.sourceJSON?.defaultResamplingMethod);this._set("interpolation",s)}}_configDefaultRenderer(t="no"){i(this);let{rasterInfo:s}=this.raster,a=at(s,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),n=a?.name,l=Lr({variableName:n,rasterFunctionName:this.rasterFunction?.functionName,presetRenderers:this.presetRenderers});if(!this.bandIds&&s.bandCount>1&&(this.bandIds=l?.bandIds??Wr(s)),!this.renderer||t==="override"){let f=Hr(this.raster),p=l?.renderer??lt(s,{bandIds:this.bandIds,variableName:n,rasterFunctionColorRamp:f}),u=s.statistics,h=u&&u.length>0?u[0]:null,y=h?.max??0,g=h?.min??0;this.raster.datasetFormat==="WCSServer"&&p.type==="raster-stretch"&&(y>1e24||g<-1e24)&&(p.dynamicRangeAdjustment=!0,p.customStatistics=null,p.stretchType==="none"&&(p.stretchType="min-max")),this.renderer=p}let o=mt(B(P({},this.renderer.toJSON()),{variableName:n})),c=ct(s,n);this.symbolizer?(this.symbolizer.rendererJSON=o,this.symbolizer.rasterInfo=c):this.symbolizer=new Tr({rendererJSON:o,rasterInfo:c});let m=this.symbolizer.bind();if(m.success){if(t==="auto"){let{colormap:f}=this.raster.rasterInfo,p=this.renderer;if(f!=null&&p.type==="raster-colormap"){let u=lt(this.raster.rasterInfo);JSON.stringify(u)!==JSON.stringify(p)&&this._configDefaultRenderer("override")}else if(p.type==="raster-stretch"){let u=this.bandIds?.length,h=p.customStatistics?.length;!p.dynamicRangeAdjustment&&h&&u&&h!==u&&this._configDefaultRenderer("override")}}}else ee.getLogger(this).warn("imagery-tile-mixin",m.error||"The given renderer is not supported by the layer."),t==="auto"&&this._configDefaultRenderer("override")}};function i(t){if(!t.raster||!t.serviceRasterInfo)throw new C("imagery-tile","no raster")}return I([R({clonable:!1})],e.prototype,"_cachedRendererJson",void 0),I([R({clonable:!1})],e.prototype,"_cachedRasterFunctionJson",void 0),I([R({clonable:!1})],e.prototype,"_compatibleFullExtent",void 0),I([R({clonable:!1})],e.prototype,"_isConstructedFromFunctionRaster",void 0),I([R({clonable:!1})],e.prototype,"_rasterJobHandler",void 0),I([R({type:[Ct],json:{write:{overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"||this.bandIds?.join(",")!=="0,1,2"}}}}})],e.prototype,"bandIds",void 0),I([R({json:{origins:{service:{read:{source:"copyrightText"}}}}})],e.prototype,"copyright",void 0),I([R({json:{read:!1}})],e.prototype,"fullExtent",null),I([R({json:{write:{overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"||this.interpolation!=="bilinear"}}}}}),Wt(Mr)],e.prototype,"interpolation",void 0),I([R()],e.prototype,"ioConfig",void 0),I([R({type:[Re],json:{write:!0}})],e.prototype,"multidimensionalDefinition",null),I([R({type:Nr,json:{write:!0}})],e.prototype,"multidimensionalSubset",void 0),I([R()],e.prototype,"raster",void 0),I([R({type:Be,json:{name:"renderingRule",write:!0}})],e.prototype,"rasterFunction",null),I([R({readOnly:!0})],e.prototype,"rasterInfo",null),I([R()],e.prototype,"serviceRasterInfo",void 0),I([R()],e.prototype,"sourceJSON",void 0),I([R({readOnly:!0,type:J,json:{read:!1}})],e.prototype,"spatialReference",void 0),I([R({type:te})],e.prototype,"tileInfo",void 0),I([R(Xe)],e.prototype,"url",null),I([R()],e.prototype,"renderer",null),I([R({types:kr,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy(){let t=this.renderer?.type==="raster-stretch"&&this.renderer.stretchType==="none"&&!this.renderer.useGamma;return{enabled:!this.loaded||this.raster.tileType==="Raster"||!t}}},origins:{"web-scene":{types:Pr,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:t=>({enabled:t&&t.type!=="vector-field"&&t.type!=="flow"})}}}}})],e.prototype,"internalRenderer",null),I([Et("internalRenderer")],e.prototype,"readRenderer",null),I([R({clonable:!1})],e.prototype,"symbolizer",void 0),e=I([z("esri.layers.mixins.ImageryTileMixin")],e),e};function yt(r){return["x","e","east","long","longitude"].includes(r.toLowerCase())}function gt(r){return["y","n","west","lat","latitude"].includes(r.toLowerCase())}function fi(r){let{axes:e}=r.domain,i=Object.keys(e),t=[],s=[],a=-1,n=-1,l=[];for(let x=0;x<i.length;x++){let w=i[x];yt(w)?a=x:gt(w)&&(n=x);let b=e[w],T=[];if("values"in b){b.values.forEach(_=>T.push(typeof _=="string"?new Date(_).getTime():_));let v=T[1]-T[0];t.push([T[0]-.5*v,T[T.length-1]+.5*v]),s.push(v)}else{let{start:v,stop:_,num:k}=b,E=(_-v)/(k-1);t.push([v-.5*E,_+.5*E]),s.push(E);for(let F=0;F<k;F++)T.push(v+E*F)}l.push({name:w,values:T,extent:[T[0],T[T.length-1]]})}a>-1&&n===-1?n=a===0?1:0:n>-1&&a===-1?a=n===0?1:0:n===-1&&a===-1&&(a=0,n=1),l=l.filter((x,w)=>!(w===a||w===n));let{referencing:o}=r.domain,c=o.find(x=>x.coordinates.includes(i[a])).system.id,m=c?.slice(c.lastIndexOf("/")+1),f=m==null||m==="CRS84"?4326:Number(m),p=new J({wkid:f}),[u,h]=t[a],[y,g]=t[n],d=new H({xmin:u,xmax:h,ymin:y,ymax:g,spatialReference:p});return{width:Math.round(d.width/s[a]),height:Math.round(d.height/s[n]),extent:d,dimensions:l}}function ht(r){let e=Ot();return e?r[e]??Object.values(r)[0]:Object.values(r)[0]}function dt(){return Math.round(255*Math.random())}function hi(r){let e={},{parameters:i}=r;if(!i)return e;for(let[t,s]of Object.entries(i)){let{type:a,description:n,unit:l,categoryEncoding:o,observedProperty:c}=s;if(a==="Parameter"&&(e[t]={},n&&(e[t].description=ht(n)),l&&(e[t].unit=l.label?ht(l.label):null,e[t].symbol=l.symbol?.value),o)){let m=Object.entries(o).map((u,h)=>({OID:h,Value:Number(u[1]),ClassName:u[0].slice(u[0].lastIndexOf("/")+1),Count:1})),f=!1;c?.categories?.length&&(c.categories.forEach(u=>{if(!u.id)return;let h=u.id.slice(u.id.lastIndexOf("/")+1),y=m.find(d=>d.ClassName===h);if(!y)return;let g=u.label?ht(u.label):null;if(y.Label=g,u.preferredColor){let d=Vt.fromHex(u.preferredColor);d&&(f=!0,y.Red=d.r,y.Green=d.g,y.Blue=d.b)}}),f&&m.forEach(u=>{u.Red==null&&(u.Red=dt(),u.Green=dt(),u.Blue=dt())}));let p={objectIdFieldName:"",fields:[{name:"OID",type:"esriFieldTypeOID",alias:"OID",domain:null},{name:"Value",type:"esriFieldTypeInteger",alias:"Value",domain:null},{name:"Count",type:"esriFieldTypeDouble",alias:"Count",domain:null},{name:"ClassName",type:"esriFieldTypeString",alias:"ClassName",domain:null,length:50},{name:"Label",type:"esriFieldTypeString",alias:"Label",domain:null,length:50}],features:m.map(u=>({attributes:u}))};f&&p.fields.push({name:"Red",type:"esriFieldTypeInteger",alias:"Red",domain:null},{name:"Green",type:"esriFieldTypeInteger",alias:"Green",domain:null},{name:"Blue",type:"esriFieldTypeInteger",alias:"Blue",domain:null}),e[t].attributeTable=p}}return e}function di(r){let e=Number.MAX_VALUE,i=-Number.MAX_VALUE;for(let t=0;t<r.length;t++){let s=r[t];s!=null&&(s<e&&(e=s),s>i&&(i=s))}return Qt(e,i)}function yi(r,e,i){let t=r.map((o,c)=>({name:o,count:e[c]})).sort((o,c)=>o.name>c.name?-1:1),s=(a=1,o=>a*=o.count);var a;let n=[...t.slice(1),{name:"",count:1}].reverse().map(s).reverse(),l=0;for(let o=r.length-1;o>=0;o--)l+=n[t.findIndex(({name:c})=>c===r[o])]*(i%e[o]),i=Math.floor(i/e[o]);return l}function Zr(r){let{width:e,height:i,extent:t,dimensions:s}=fi(r),{ranges:a}=r,n=Object.keys(a).sort((p,u)=>p<u?-1:1),l=[];for(let p=0;p<n.length;p++){let u=n[p];s?.length&&l.push({name:u,dimensions:s})}let o=hi(r);l.forEach(p=>o[p.name]&&Object.assign(p,o[p.name]));let c=l.length?{variables:l}:void 0,m=[];for(let p=0;p<n.length;p++){let u=n[p],{values:h,dataType:y,axisNames:g,shape:d}=a[u],x=d.length>2?p*d.slice(0,-2).reduce((k,E)=>k*E):0,w=g.slice(0,-2),b=d.slice(0,-2),T=y==="float"?"f32":di(h),v=e*i,_=h.length/v;for(let k=0;k<_;k++){let E=ge.createEmptyBand(T,v),F=new Uint8Array(v).fill(255),N=!1,O=k*v;for(let D=0;D<v;D++){let M=h[O+D];M==null?(F[D]=0,N=!0):E[D]=M}if(p===0||s?.length){let D=new ge({width:e,height:i,mask:N?F:null,pixels:[E],pixelType:T});D.updateStatistics(),s?.length?m[yi(w,b,k)+x]=D:m.push(D)}else{let D=m[k];D.pixels.push(E),N?D.mask&&(D.mask=ge.combineBandMasks([D.mask,F])):D.mask=N?F:null}}}let f=Object.values(o).find(p=>p.attributeTable)?.attributeTable;return{extent:t,pixelBlocks:m,multidimensionalInfo:c,attributeTable:f,bandNames:c?void 0:n}}var Se=class extends Y{constructor(){super(...arguments),this.datasetFormat="MEMORY",this.source=null}get url(){return""}fetchRawTile(r,e,i,t={}){if(!this._pixelBlockTiles){let{rasterInfo:a}=this,[n,l]=a.storageInfo.tileInfo.size,{sliceId:o}=t,{pixelBlocks:c}=this.source,m={pixelBlock:o==null?c[0]:c[o],useBilinear:a.dataType!=="thematic",tileSize:{width:n,height:l},level:r,row:e,col:i},f=this.rasterJobHandler?this.rasterJobHandler.clipTile(m,t):pr(m);return Promise.resolve(f)}let s=this._pixelBlockTiles.get(`${r}/${e}/${i}`);return Promise.resolve(s)}_open(r){return S(this,null,function*(){let e=this.source,{pixelBlocks:i,attributeTable:t,statistics:s,histograms:a,name:n,nativeExtent:l,transform:o}=e,c=i[0],{width:m,height:f,pixelType:p}=c,u=e.extent??new H({xmin:-.5,ymin:.5,xmax:m-.5,ymax:f-.5,spatialReference:new J({wkid:3857})}),h=e.isPseudoSpatialReference??!e.extent,y={x:u.width/m,y:u.height/f},g=P({},e.keyProperties);t&&(g.DataType="Thematic");let d=new ae({width:m,height:f,pixelType:p,extent:u,nativeExtent:l,attributeTable:t,transform:o,pixelSize:y,spatialReference:u.spatialReference,bandCount:c.pixels.length,keyProperties:g,multidimensionalInfo:e.multidimensionalInfo,statistics:s,isPseudoSpatialReference:h,histograms:a});this.ioConfig.skipMapInfo&&this.updateImageSpaceRasterInfo(d),this.createRemoteDatasetStorageInfo(d,512,512),this._set("rasterInfo",d),this.updateTileInfo(),d.multidimensionalInfo?yield this._buildMDimStats(e.pixelBlocks,d.multidimensionalInfo):yield this._buildInMemoryRaster(c,{width:512,height:512},r),d.multidimensionalInfo||(this.source=null),this.datasetName=n})}_buildInMemoryRaster(r,e,i){return S(this,null,function*(){let{rasterInfo:t}=this,s=t.storageInfo.maximumPyramidLevel??0,a=t.dataType!=="thematic",n=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:r,tileSize:e,maximumPyramidLevel:s,useBilinear:a},i):Promise.resolve(ur(r,e,s,a)),l=t.statistics!=null,o=t.histograms!=null,c=this.ioConfig.skipStatistics||l?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:r},i):Promise.resolve(wr(r)),m=yield Ge([n,c]);if(!m[0].value&&m[1].value)throw new C("inmemory-raster:open","failed to build in memory raster");this._pixelBlockTiles=m[0].value,l||(t.statistics=m[1].value?.statistics),o||(t.histograms=m[1].value?.histograms)})}_buildMDimStats(r,e,i){return S(this,null,function*(){for(let t=0;t<e.variables.length;t++){let s=e.variables[t];if(s.statistics)continue;let a=s.dimensions.map(c=>new Re({variableName:s.name,dimensionName:c.name,values:[c.values?.[0]??c.extent?.[0]],isSlice:!0})),n=Qe(a,e),l=n==null?null:r[n];if(l==null)continue;let o=this.rasterJobHandler?yield this.rasterJobHandler.computeStatisticsHistograms({pixelBlock:l},i):we(l);s.statistics=o.statistics,s.histograms||(s.histograms=o.histograms)}})}};I([R({type:String,json:{write:!0}})],Se.prototype,"datasetFormat",void 0),I([R()],Se.prototype,"source",void 0),I([R()],Se.prototype,"url",null),Se=I([z("esri.layers.support.rasterDatasets.InMemoryRaster")],Se);var ve=Se;var Je=class extends Y{constructor(){super(...arguments),this.datasetFormat="CovJSON"}fetchRawTile(r,e,i,t={}){return this._inMemoryRaster.fetchRawTile(r,e,i,t)}_open(r){return S(this,null,function*(){let{extent:e,pixelBlocks:i,multidimensionalInfo:t,attributeTable:s,bandNames:a}=yield this._fetchData(r),{statistics:n,histograms:l}=we(i[0]),o=a?.map(p=>({BandName:p})),c={DataType:s?"Thematic":t?"Scientific":"Generic",BandProperties:o},m=new ve({source:{extent:e,pixelBlocks:i,attributeTable:s?ye.fromJSON(s):null,multidimensionalInfo:t,statistics:n,histograms:l,keyProperties:c,isPseudoSpatialReference:!1}});yield m.open(),this._inMemoryRaster=m;let f=this.source?"":this.url.slice(this.url.lastIndexOf("/")+1);this._set("datasetName",f.slice(0,f.indexOf("."))),this._set("rasterInfo",m.rasterInfo)})}_fetchData(r){return S(this,null,function*(){let e=this.source??(yield this.request(this.url,{signal:r?.signal})).data,i="imagery-tile-layer:open-coverage-json";if(e.type?.toLowerCase()!=="coverage"||e.domain?.domainType?.toLowerCase()!=="grid")throw new C(i,"Only coverage with Grid domain type is supported");if(!e.ranges)throw new C(i,"Missing ranges in the grid coverage data");if(!e.domain.referencing?.length)throw new C(i,"Missing domain referencing in the grid coverage data");let t=Object.values(e.ranges);for(let s=0;s<t.length;s++){let{axisNames:a,shape:n,type:l,values:o}=t[s];if(!(l.toLowerCase()==="ndarray"&&o?.length&&a?.length&&n?.length))throw new C(i,"Only ranges with valid NdArray, axisNames, shape, and inline values are supported");if(!(yt(a[a.length-1])&&gt(a[a.length-2])))throw new C(i,"Only row-major ordered pixel values are supported. X axis must be the last axis.")}return Zr(e)})}};I([R({type:String,json:{write:!0}})],Je.prototype,"datasetFormat",void 0),I([R({constructOnly:!0})],Je.prototype,"source",void 0),Je=I([z("esri.layers.support.rasterDatasets.CovJSONRaster")],Je);var ei=Je;function fe(r,e){if(!r||!e)return[];let i=e;e.includes("/")?(i=e.slice(0,e.indexOf("/")),e=e.slice(e.indexOf("/")+1)):e="";let t=[];if(e){let a=fe(r,i);for(let n=0;n<a.length;n++)fe(a[n],e).forEach(l=>t.push(l));return t}let s=r.getElementsByTagNameNS("*",i);if(!s||s.length===0)return[];for(let a=0;a<s.length;a++)t.push(s[a]||s.item(a));return t}function X(r,e){if(!r||!e)return null;let i=e;e.includes("/")?(i=e.slice(0,e.indexOf("/")),e=e.slice(e.indexOf("/")+1)):e="";let t=fe(r,i);return t.length>0?e?X(t[0],e):t[0]:null}function Z(r,e=null){let i=e?X(r,e):r,t;return i?(t=i.textContent||i.nodeValue,t?t.trim():null):null}function gi(r,e){let i=fe(r,e),t=[],s;for(let a=0;a<i.length;a++)s=i[a].textContent||i[a].nodeValue,s&&(s=s.trim(),s!==""&&t.push(s));return t}function Ae(r,e){return gi(r,e).map(i=>Number(i))}function oe(r,e){let i=Z(r,e);return Number(i)}function et(r,e){let i=r?.nodeName?.toLowerCase(),t=e.toLowerCase();return i.slice(i.lastIndexOf(":")+1)===t}function ti(r,e){if(!r||!e)return null;let i=[];for(let t=0;t<r.length;t++)i.push(r[t]),i.push(e[t]);return i}function xi(r){let e=X(r,"GeodataXform"),i=Te(oe(e,"SpatialReference/WKID")||Z(e,"SpatialReference/WKT"));if(e.getAttribute("xsi:type")!=="typens:PolynomialXform")return{spatialReference:i,transform:null};let t=oe(e,"PolynomialOrder")??1,s=Ae(e,"CoeffX/Double"),a=Ae(e,"CoeffY/Double"),n=Ae(e,"InverseCoeffX/Double"),l=Ae(e,"InverseCoeffY/Double"),o=ti(s,a),c=ti(n,l);return{spatialReference:i,transform:o&&c&&o.length&&c.length?new be({spatialReference:i,polynomialOrder:t,forwardCoefficients:o,inverseCoefficients:c}):null}}function wi(r){let e=oe(r,"NoDataValue"),i=X(r,"Histograms/HistItem"),t=oe(i,"HistMin"),s=oe(i,"HistMax"),a=oe(i,"BucketCount"),n=Z(i,"HistCounts")?.split("|").map(p=>Number(p)),l,o,c,m;fe(r,"Metadata/MDI").forEach(p=>{let u=Number(p.textContent??p.nodeValue);switch(p.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":l=u;break;case"STATISTICS_MAXIMUM":o=u;break;case"STATISTICS_MEAN":c=u;break;case"STATISTICS_STDDEV":m=u}});let f=oe(r,"Metadata/SourceBandIndex");return{noDataValue:e,histogram:n?.length&&t!=null&&s!=null?{min:t,max:s,size:a||n.length,counts:n}:null,sourceBandIndex:f,statistics:l!=null&&o!=null?{min:l,max:o,avg:c,stddev:m}:null}}function Te(r){if(!r)return null;let e=Number(r);if(!isNaN(e)&&e!==0)return new J({wkid:e});if(r=String(r).trim(),Dt(r))return new J({wkt2:r});let i=r.toUpperCase();if(i.startsWith("COMPD_CS")){if(!i.includes("VERTCS")||!i.includes("GEOGCS")&&!i.startsWith("PROJCS"))return null;let t=i.indexOf("VERTCS"),s=i.indexOf("PROJCS"),a=s>-1?s:i.indexOf("GEOGCS");if(a===-1)return null;let n=r.slice(a,r.lastIndexOf("]",t)+1).trim(),l=r.slice(t,r.lastIndexOf("]")).trim();e=xt(n);let o=new J(e?{wkid:e}:{wkt:n}),c=xt(l);return c&&(o.vcsWkid=c),o}return i.startsWith("GEOGCS")||i.startsWith("PROJCS")?(e=xt(r),new J(e!==0?{wkid:e}:{wkt:r})):null}function xt(r){let e=r.replaceAll("]","[").replaceAll('"',"").split("[").map(s=>s.trim()).filter(s=>s!==""),i=e[e.length-1].split(","),t=i[0]?.toLowerCase();if((t==="epsg"||t==="esri")&&r.endsWith('"]]')){let s=Number(i[1]);if(!isNaN(s)&&s!==0)return s}return 0}function _e(r){if(r?.documentElement.tagName?.toLowerCase()!=="pamdataset")return{};let e={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};r.documentElement.childNodes.forEach(t=>{if(t.nodeType===1){if(et(t,"SRS")){if(!e.spatialReference){let s=Z(t);e.spatialReference=Te(s)}}else if(et(t,"Metadata"))if(t.getAttribute("domain")==="xml:ESRI"){let{spatialReference:s,transform:a}=xi(t);e.transform=a,e.spatialReference||(e.spatialReference=s)}else fe(t,"MDI").forEach(s=>e.metadata[s.getAttribute("key")]=Z(s));else if(et(t,"PAMRasterBand")){let s=wi(t);s.sourceBandIndex!=null&&e.rasterBands[s.sourceBandIndex]==null?e.rasterBands[s.sourceBandIndex]=s:e.rasterBands.push(s)}}});let i=e.rasterBands;if(i.length){let t=!!i[0].statistics;e.statistics=t?i.map(a=>a.statistics).filter(ke):null;let s=!!i[0].histogram;e.histograms=s?i.map(a=>a.histogram).filter(ke):null}return e}var tt=class extends Y{fetchRawTile(r,e,i,t={}){return this._inMemoryRaster.fetchRawTile(r,e,i,t)}_open(r){return S(this,null,function*(){let e=yield this._fetchData(r),{spatialReference:i,statistics:t,histograms:s,transform:a}=yield this._fetchAuxiliaryData(r),n=!i;n&&(i=new J({wkid:3857})),s?.length&&t==null&&(t=Ie(s));let{width:l,height:o}=e,c=new H({xmin:-.5,ymin:.5-o,xmax:l-.5,ymax:.5,spatialReference:i}),m=a?a.forwardTransform(c):c,f=!0;if(a){let u=a.forwardCoefficients;f=u&&u[1]===0&&u[2]===0,f&&(a=null,c=m)}let p=new ve({source:{extent:m,nativeExtent:c,transform:a,pixelBlocks:[e],statistics:t,histograms:s,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:n},ioConfig:{sampling:"closest",skipStatistics:!0}});this.ioConfig.skipMapInfo&&(p.ioConfig.skipMapInfo=!0),yield p.open(),p.source=null,this._set("rasterInfo",p.rasterInfo),this._inMemoryRaster=p})}_fetchData(r){return S(this,null,function*(){let{data:e}=yield this.request(this.url,{responseType:"array-buffer",signal:r?.signal}),i=lr(e).toUpperCase();if(i!=="JPG"&&i!=="PNG"&&i!=="GIF"&&i!=="BMP")throw new C("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",i);let t=i.toLowerCase(),s=t==="gif"||t==="bmp"||!bt("ios"),a=yield this.decodePixelBlock(e,{format:t,useCanvas:s,hasNoZlibMask:!0});if(a==null)throw new C("image-aux-raster:open","the data cannot be decoded");return a})}_fetchAuxiliaryData(r){return S(this,null,function*(){let e=r?.signal,{skipExtensions:i=[],skipMapInfo:t}=this.ioConfig,s=t||i.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:e}),a=this.datasetFormat,n=a==="JPG"?"jgw":a==="PNG"?"pgw":a==="BMP"?"bpw":null,l=n&&i.includes(n)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+n,{responseType:"text",signal:e}),o=yield Ge([s,l]);if(e?.aborted)throw vt();let c=_e(o[0].value?.data);if(!c.transform){let m=o[1].value?o[1].value.data.split(`
`).slice(0,6).map(f=>Number(f)):null;c.transform=m?.length===6?new be({forwardCoefficients:[m[4],m[5],m[0],-m[1],m[2],-m[3]]}):null}return c})}};I([R({type:String,json:{write:!0}})],tt.prototype,"datasetFormat",void 0),tt=I([z("esri.layers.support.rasterDatasets.ImageAuxRaster")],tt);var Le=tt;var He=class extends Y{constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat="RasterTileServer",this.tileType=null}fetchRawTile(s,a,n){return S(this,arguments,function*(r,e,i,t={}){let{storageInfo:l,extent:o}=this.rasterInfo,{transposeInfo:c}=l,m=c!=null&&!!t.transposedVariableName;if(this._slices&&!m&&t.sliceId==null)return null;let f=m?0:l.maximumPyramidLevel-r+this._levelOffset,p=`${this.url}/tile/${f}/${e}/${i}`,u=this._slices?m?{variable:t.transposedVariableName}:{sliceId:t.sliceId||0}:null,{data:h}=yield this.request(p,{query:u,responseType:"array-buffer",signal:t.signal});if(!h)return null;let y=m?c.tileSize:l.tileInfo.size,g=yield this.decodePixelBlock(h,{width:y[0],height:y[1],planes:null,pixelType:null,isPoint:this.tileType==="Elevation",returnInterleaved:m,noDataValue:this.rasterInfo.noDataValue});if(g==null)return null;let d=l.blockBoundary[r];if(l.compression!=="jpg"||i>d.minCol&&i<d.maxCol&&e>d.minRow&&e<d.maxRow)return g;let{origin:x,blockWidth:w,blockHeight:b}=l,{x:T,y:v}=this.getPyramidPixelSize(r),_=Math.round((o.xmin-x.x)/T)%w,k=Math.round((o.xmax-x.x)/T)%w||w,E=Math.round((x.y-o.ymax)/v)%b,F=Math.round((x.y-o.ymin)/v)%b||b,N=i===d.minCol?_:0,O=e===d.minRow?E:0,D=i===d.maxCol?k:w,M=e===d.maxRow?F:b;return mr(g,{x:N,y:O},{width:D-N,height:M-O}),g})}getSliceIndex(r){if(!this._slices||r==null||r.length===0)return null;let e=r;for(let i=0;i<this._slices.length;i++){let t=this._slices[i].multidimensionalDefinition;if(t.length===e.length&&!t.some(s=>{let a=e.find(n=>s.variableName===n.variableName&&n.dimensionName===s.dimensionName);return a?(Array.isArray(s.values[0])?`${s.values[0][0]}-${s.values[0][1]}`:s.values[0])!==(Array.isArray(a.values[0])?`${a.values[0][0]}-${a.values[0][1]}`:a.values[0]):!0}))return i}return null}fetchVariableStatisticsHistograms(r,e){return S(this,null,function*(){let i=this.request(this.url+"/statistics",{query:{variable:r,f:"json"},signal:e}).then(a=>a.data?.statistics),t=this.request(this.url+"/histograms",{query:{variable:r,f:"json"},signal:e}).then(a=>a.data?.histograms),s=yield Promise.all([i,t]);return s[0]&&s[0].forEach(a=>{a.avg=a.mean,a.stddev=a.standardDeviation}),s[1]?.[0]?.counts?.length||(s[1]=null),{statistics:s[0]||null,histograms:s[1]||null}})}computeBestPyramidLevelForLocation(i){return S(this,arguments,function*(r,e={}){if(!this._tilemapCache)return 0;let t=this.identifyPixelLocation(r,0,e.datumTransformation);if(t===null)return null;let s=0,{maximumPyramidLevel:a}=this.rasterInfo.storageInfo,n=a-s+this._levelOffset,l=t.srcLocation;for(;n>=0;){try{if((yield this._tilemapCache.fetchAvailability(n,t.row,t.col,e))==="available")break}catch{}if(n--,s++,t=this.identifyPixelLocation(l,s,e.datumTransformation),t===null)return null}return n===-1||t==null?null:s})}_open(r){return S(this,null,function*(){let e=r?.signal,i=this.sourceJSON?{data:this.sourceJSON}:yield this.request(this.url,{query:{f:"json"},signal:e});i.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));let t=i.data;if(this.sourceJSON=t,!t)throw new C("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!t.tileInfo)throw new C("imageserverraster:open","use ImageryLayer to open non-tiled image services");this._fixScaleInServiceInfo();let s=["jpg","jpeg","png","png8","png24","png32","mixed"];this.tileType=t.cacheType,this.tileType==null&&(s.includes(t.tileInfo.format.toLowerCase())?this.tileType="Map":t.tileInfo.format.toLowerCase()==="lerc"?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=t.name?.slice(t.name.indexOf("/")+1)??"";let a=yield this._fetchRasterInfo({signal:e});if(a==null)throw new C("image-server-raster:open","cannot initialize image service");Vr(a,t);let n=this.tileType==="Map"?Ii(t.tileInfo,t):te.fromJSON(t.tileInfo);St(n);let[l,o]=this._computeMinMaxLOD(a,n),{extent:c,pixelSize:m}=a,f=.5/a.width*m.x,p=Math.max(m.x,m.y),{lods:u}=n;(this.tileType!=="Map"&&t.maxScale!==0||Math.abs(m.x-m.y)>f||!u.some(_=>Math.abs(_.resolution-p)<f))&&(m.x=m.y=l.resolution,a.width=Math.ceil((c.xmax-c.xmin)/m.x-.1),a.height=Math.ceil((c.ymax-c.ymin)/m.y-.1));let h=l.level-o.level,[y,g]=n.size,d=[],x=[];u.forEach((_,k)=>{_.level>=o.level&&_.level<=l.level&&d.push({x:_.resolution,y:_.resolution}),k<u.length-1&&x.push(Math.round(10*_.resolution/u[k+1].resolution)/10)}),d.sort((_,k)=>_.x-k.x);let w=this.computeBlockBoundary(c,y,g,n.origin,d,h),b=d.length>1?d.slice(1):null,T;t.transposeInfo&&(T={tileSize:[t.transposeInfo.rows,t.transposeInfo.cols],packetSize:a.keyProperties?._yxs.PacketSize??0});let v=x.length<=1||x.length>=3&&x.slice(0,-1).every(_=>_===x[0])?x[0]??2:Math.round(10/(o.resolution/l.resolution)**(-1/h))/10;if(a.storageInfo=new ne({blockWidth:n.size[0],blockHeight:n.size[1],pyramidBlockWidth:n.size[0],pyramidBlockHeight:n.size[1],pyramidResolutions:b,pyramidScalingFactor:v,compression:n.format,origin:n.origin,firstPyramidLevel:1,maximumPyramidLevel:h,tileInfo:n,transposeInfo:T,blockBoundary:w}),bi(a),this._set("rasterInfo",a),t.capabilities.toLowerCase().includes("tilemap")){let _={tileInfo:a.storageInfo.tileInfo,parsedUrl:Pt(this.url),url:this.url,tileServers:[]};this._tilemapCache=new Yr({layer:_})}})}_fetchRasterInfo(r){return S(this,null,function*(){let e=this.sourceJSON;if(this.tileType==="Map"){let n=e.fullExtent||e.extent,l=Math.ceil((n.xmax-n.xmin)/e.pixelSizeX-.1),o=Math.ceil((n.ymax-n.ymin)/e.pixelSizeY-.1),c=J.fromJSON(e.spatialReference||n.spatialReference),m=new L({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:c});return new ae({width:l,height:o,bandCount:3,extent:H.fromJSON(n),spatialReference:c,pixelSize:m,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})}let{signal:i}=r,t=jr(this.url,this.sourceJSON,{signal:i,query:this.ioConfig.customFetchParameters}),s=e.hasMultidimensions?this.request(`${this.url}/slices`,{query:{f:"json"},signal:i}).then(n=>n.data?.slices).catch(()=>null):null,a=yield Promise.all([t,s]);return this._slices=a[1],a[0]})}_fixScaleInServiceInfo(){let{sourceJSON:r}=this;r.minScale&&r.minScale<0&&(r.minScale=0),r.maxScale&&r.maxScale<0&&(r.maxScale=0)}_computeMinMaxLOD(r,e){let{pixelSize:i}=r,t=.5/r.width*i.x,{lods:s}=e,a=e.lodAt(Math.max.apply(null,s.map(p=>p.level))),n=e.lodAt(Math.min.apply(null,s.map(p=>p.level))),{tileType:l}=this;if(l==="Map")return this._levelOffset=s[0].level,[a,n];if(l==="Raster")return[s.find(p=>p.resolution===i.x)??a,n];let{minScale:o,maxScale:c}=this.sourceJSON,m=a;c>0&&(m=s.find(p=>Math.abs(p.scale-c)<t),m||(m=s.filter(p=>p.scale>c).sort((p,u)=>p.scale>u.scale?1:-1)[0]??a));let f=n;return o>0&&(f=s.find(p=>Math.abs(p.scale-o)<t)??n,this._levelOffset=f.level-n.level),[m,f]}};function Ii(r,e){if(!r)return null;let{minScale:i,maxScale:t,minLOD:s,maxLOD:a}=e;if(s!=null&&a!=null)return te.fromJSON(B(P({},r),{lods:r.lods.filter(({level:n})=>n!=null&&n>=s&&n<=a)}));if(i!==0&&t!==0){let n=c=>Math.round(1e4*c)/1e4,l=i?n(i):1/0,o=t?n(t):-1/0;return te.fromJSON(B(P({},r),{lods:r.lods.filter(c=>{let m=n(c.scale);return m<=l&&m>=o})}))}return te.fromJSON(r)}function bi(r){let{extent:e,spatialReference:i}=r;e.xmin>-1&&e.xmax>181&&i?.wkid&&i.isGeographic&&(r.nativeExtent=r.extent,r.transform=new vr,r.extent=r.transform.forwardTransform(e))}I([R({type:String,json:{write:!0}})],He.prototype,"datasetFormat",void 0),I([R()],He.prototype,"tileType",void 0),He=I([z("esri.layers.support.rasterDatasets.ImageServerRaster")],He);var ri=He;var re=new Map;re.set("Int8","s8"),re.set("UInt8","u8"),re.set("Int16","s16"),re.set("UInt16","u16"),re.set("Int32","s32"),re.set("UInt32","u32"),re.set("Float32","f32"),re.set("Float64","f32"),re.set("Double64","f32");var le=new Map;le.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),le.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),le.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),le.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});var Fe=class extends Y{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}fetchRawTile(s,a,n){return S(this,arguments,function*(r,e,i,t={}){let{blockWidth:l,blockHeight:o,blockBoundary:c}=this.rasterInfo.storageInfo,m=c[r];if(!m||m.maxRow<e||m.maxCol<i||m.minRow>e||m.minCol>i)return null;let{bandCount:f,pixelType:p}=this.rasterInfo,{ranges:u,actualTileWidth:h,actualTileHeight:y}=this._getTileLocation(r,e,i);if(!u||u.length===0)return null;if(u[0].from===0&&u[0].to===0){let M=new Uint8Array(l*o);return new ge({width:l,height:o,pixels:void 0,mask:M,validPixelCount:0})}let{bandIds:g}=this.ioConfig,d=this._getBandSegmentCount(),x=[],w=0;for(w=0;w<d;w++)g&&!g.includes(w)||x.push(this.request(this._files.data,{range:{from:u[w].from,to:u[w].to},responseType:"array-buffer",signal:t.signal}));let b=yield Promise.all(x),T=b.map(M=>M.data.byteLength).reduce((M,A)=>M+A),v=new Uint8Array(T),_=[],k=0;for(w=0;w<d;w++)_.push(k),v.set(new Uint8Array(b[w].data),k),k+=b[w].data.byteLength;let E=le.get(this.rasterInfo.storageInfo.compression).decoderFormat,F=yield this.decodePixelBlock(v.buffer,{width:l,height:o,format:E,planes:g?.length||f,offsets:_,pixelType:p});if(F==null)return null;let{noDataValue:N}=this.rasterInfo;if(N!=null&&E!=="lerc"&&!F.mask&&(N=N[0],N!=null)){let M=F.width*F.height,A=new Uint8Array(M);if(Math.abs(N)>1e24)for(w=0;w<M;w++)Math.abs((F.pixels[0][w]-N)/N)>1e-6&&(A[w]=1);else for(w=0;w<M;w++)F.pixels[0][w]!==N&&(A[w]=1);F.mask=A}let O=0,D=0;if(h!==l||y!==o){let M=F.mask;if(M)for(w=0;w<o;w++)if(D=w*l,w<y)for(O=h;O<l;O++)M[D+O]=0;else for(O=0;O<l;O++)M[D+O]=0;else for(M=new Uint8Array(l*o),F.mask=M,w=0;w<y;w++)for(D=w*l,O=0;O<h;O++)M[D+O]=1}return F})}_open(r){return S(this,null,function*(){this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);let e=r?r.signal:null,i=yield this.request(this.url,{responseType:"xml",signal:e}),{rasterInfo:t,files:s}=this._parseHeader(i.data),{skipMapInfo:a,skipExtensions:n=[]}=this.ioConfig;if(!n.includes("aux.xml")&&!a){let d=yield this._fetchAuxiliaryData(r);d!=null&&(t.statistics=d.statistics??t.statistics,t.histograms=d.histograms,d.histograms&&t.statistics==null&&(t.statistics=Ie(d.histograms)))}a&&this.updateImageSpaceRasterInfo(t),this._set("rasterInfo",t),this._files=s;let l=yield this.request(s.index,{responseType:"array-buffer",signal:e});this._storageIndex=Ri(l.data);let{blockWidth:o,blockHeight:c}=this.rasterInfo.storageInfo,m=this.rasterInfo.storageInfo.pyramidScalingFactor,{width:f,height:p}=this.rasterInfo,u=[],h=this._getBandSegmentCount(),y=0,g=-1;for(;y<this._storageIndex.length;){g++;let d=Math.ceil(f/o/m**g)-1,x=Math.ceil(p/c/m**g)-1;y+=(d+1)*(x+1)*h*4,u.push({maxRow:x,maxCol:d,minCol:0,minRow:0})}this.rasterInfo.storageInfo.blockBoundary=u,g>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=g),this.updateTileInfo()})}_getBandSegmentCount(){return le.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(r,e,i){let{blockWidth:t,blockHeight:s,pyramidScalingFactor:a}=this.rasterInfo.storageInfo,{width:n,height:l}=this.rasterInfo,o=this._getBandSegmentCount(),c,m,f,p=0,u=0;for(f=0;f<r;f++)u=a**f,c=Math.ceil(n/t/u),m=Math.ceil(l/s/u),p+=c*m;u=a**r,c=Math.ceil(n/t/u),m=Math.ceil(l/s/u),p+=e*c+i,p*=4*o;let h=this._storageIndex.subarray(p,p+4*o),y=0,g=0,d=[];for(let x=0;x<o;x++)y=h[4*x]*2**32+h[4*x+1],g=y+h[4*x+2]*2**32+h[4*x+3],d.push({from:y,to:g});return{ranges:d,actualTileWidth:i<c-1?t:Math.ceil(n/u)-t*(c-1),actualTileHeight:e<m-1?s:Math.ceil(l/u)-s*(m-1)}}_parseHeader(r){let e=X(r,"MRF_META/Raster");if(!e)throw new C("mrf:open","not a valid MRF format");let i=X(e,"Size"),t=parseInt(i.getAttribute("x"),10),s=parseInt(i.getAttribute("y"),10),a=parseInt(i.getAttribute("c"),10),n=(Z(e,"Compression")||"none").toLowerCase();if(!le.has(n))throw new C("mrf:open","currently does not support compression "+n);let l=Z(e,"DataType")||"UInt8",o=re.get(l);if(o==null)throw new C("mrf:open","currently does not support pixel type "+l);let c=X(e,"PageSize"),m=parseInt(c.getAttribute("x"),10),f=parseInt(c.getAttribute("y"),10),p=X(e,"DataValues"),u,h;if(p&&(h=p.getAttribute("NoData"),h!=null&&(u=h.trim().split(" ").map(N=>parseFloat(N)))),X(r,"MRF_META/CachedSource"))throw new C("mrf:open","currently does not support MRF referencing other data files");let y=X(r,"MRF_META/GeoTags"),g=X(y,"BoundingBox"),d,x=!1;if(g!=null){let N=parseFloat(g.getAttribute("minx")),O=parseFloat(g.getAttribute("miny")),D=parseFloat(g.getAttribute("maxx")),M=parseFloat(g.getAttribute("maxy")),A=Z(y,"Projection")||"",K=J.WGS84;if(A!=="LOCAL_CS[]")if(A.toLowerCase().startsWith("epsg:")){let G=Number(A.slice(5));isNaN(G)||G===0||(K=new J({wkid:G}))}else K=Te(A)??J.WGS84;else x=!0,K=new J({wkid:3857});d=new H(N,O,D,M),d.spatialReference=K}else x=!0,d=new H({xmin:-.5,ymin:.5-s,xmax:t-.5,ymax:.5,spatialReference:new J({wkid:3857})});let w=X(r,"MRF_META/Rsets"),b=parseInt(w?.getAttribute("scale")||"2",10),T=d.spatialReference,v=new ne({origin:new L({x:d.xmin,y:d.ymax,spatialReference:T}),blockWidth:m,blockHeight:f,pyramidBlockWidth:m,pyramidBlockHeight:f,compression:n,pyramidScalingFactor:b}),_=new L({x:d.width/t,y:d.height/s,spatialReference:T}),k=new ae({width:t,height:s,extent:d,isPseudoSpatialReference:x,spatialReference:T,bandCount:a,pixelType:o,pixelSize:_,noDataValue:u,storageInfo:v}),E=Z(r,"datafile"),F=Z(r,"IndexFile");return{rasterInfo:k,files:{mrf:this.url,index:F||this.url.replace(".mrf",".idx"),data:E||this.url.replace(".mrf",le.get(n).blobExtension)}}}_fetchAuxiliaryData(r){return S(this,null,function*(){try{let{data:e}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:r?.signal});return _e(e)}catch{return null}})}};function Ri(r){if(r.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");let e,i,t,s,a,n;if(er){for(i=new Uint8Array(r),s=new ArrayBuffer(r.byteLength),t=new Uint8Array(s),a=0;a<r.byteLength/4;a++)for(n=0;n<4;n++)t[4*a+n]=i[4*a+3-n];e=new Uint32Array(s)}else e=new Uint32Array(r);return e}I([R()],Fe.prototype,"_files",void 0),I([R()],Fe.prototype,"_storageIndex",void 0),I([R({type:String,json:{write:!0}})],Fe.prototype,"datasetFormat",void 0),Fe=I([z("esri.layers.support.rasterDatasets.MRFRaster")],Fe);var ii=Fe;function Si(r){let e=r.fields,i=r.records,t=e.some(c=>c.name.toLowerCase()==="oid")?"OBJECTID":"OID",s=[{name:t,type:"esriFieldTypeOID",alias:"OID"}].concat(e.map(c=>({name:c.name,type:"esriFieldType"+c.typeName,alias:c.name}))),a=s.map(c=>c.name),n=[],l=0,o=0;return i.forEach(c=>{let m={};for(m[t]=l++,o=1;o<a.length;o++)m[a[o]]=c[o-1];n.push({attributes:m})}),{displayFieldName:"",fields:s,features:n}}var rt=class{static get supportedVersions(){return[5]}static parse(e){let i=new DataView(e),t=3&i.getUint8(0);if(t!==3)return{header:{version:t},recordSet:null};let s=i.getUint32(4,!0),a=i.getUint16(8,!0),n=i.getUint16(10,!0),l={version:t,recordCount:s,headerByteCount:a,recordByteCount:n},o=32,c=[],m=[],f;if(t===3){for(;i.getUint8(o)!==13;)f=String.fromCharCode(i.getUint8(o+11)).trim(),c.push({name:it(new Uint8Array(e,o,11)),type:f,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(f)],length:i.getUint8(o+16)}),o+=32;if(o+=1,c.length>0)for(;m.length<s&&e.byteLength-o>n;){let p=[];i.getUint8(o)===32?(o+=1,c.forEach(u=>{if(u.type==="C")p.push(it(new Uint8Array(e,o,u.length)).trim());else if(u.type==="N")p.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,o,u.length)).trim(),10));else if(u.type==="F")p.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,o,u.length)).trim()));else if(u.type==="D"){let h=String.fromCharCode.apply(null,new Uint8Array(e,o,u.length)).trim();p.push(new Date(parseInt(h.slice(0,4),10),parseInt(h.slice(4,6),10)-1,parseInt(h.slice(6,8),10)))}o+=u.length}),m.push(p)):o+=n}}return{header:l,fields:c,records:m,recordSet:Si({fields:c,records:m})}}};var wt=(r,e)=>r.get(e)?.values,ze=(r,e)=>r.get(e)?.values?.[0],he=class extends Y{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}fetchRawTile(s,a,n){return S(this,arguments,function*(r,e,i,t={}){if(!this._headerInfo?.isSupported||this.isBlockOutside(r,e,i))return null;let l=yield this._fetchRawTiffTile(r,e,i,!1,t);if(l!=null&&this._headerInfo.hasMaskBand){let o=yield this._fetchRawTiffTile(r,e,i,!0,t);o!=null&&o.pixels[0]instanceof Uint8Array&&(l.mask=o.pixels[0])}return l})}_open(r){return S(this,null,function*(){let e=r?r.signal:null,{data:i}=yield this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:e});if(!i)throw new C("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf("."));let{littleEndian:t,firstIFDPos:s,isBigTiff:a}=ar(i),n=[];yield this._readIFDs(n,i,t,s,0,a?8:4,e);let{imageInfo:l,rasterInfo:o}=vi(n),c=sr(n),m=nr(n);if(this._headerInfo=P({littleEndian:t,isBigTiff:a,ifds:n,pyramidIFDs:c,maskIFDs:m},l),this._set("rasterInfo",o),!l.isSupported)throw new C("tiffraster:open","this tiff is not supported: "+l.message);if(!l.tileWidth)throw new C("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");o.isPseudoSpatialReference&&ee.getLogger(this).warn("The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported.");let f=n[0].get("PREDICTOR")?.values?.[0];if(n[0].get("SAMPLEFORMAT")?.values?.[0]===3&&f===2)throw new C("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floating point data");let{skipMapInfo:u,skipExtensions:h=[]}=this.ioConfig;if(!h.includes("aux.xml")&&!u){let y=yield this._fetchAuxiliaryMetaData(r);y!=null&&Ti(y,o)}h.includes("vat.dbf")||o.bandCount!==1||o.pixelType!=="u8"||u||(o.attributeTable=yield this._fetchAuxiliaryTable(r),o.attributeTable!=null&&(o.keyProperties.DataType="thematic")),u&&this.updateImageSpaceRasterInfo(o),this.updateTileInfo()})}_readIFDs(r,e,i,t,s,a=4,n){return S(this,null,function*(){if(!t)return null;(t>=e.byteLength||t<0)&&(e=(yield this.request(this.url,{range:{from:t+s,to:t+s+this._bufferSize},responseType:"array-buffer",signal:n})).data,s=t+s,t=0);let l=yield this._readIFD(e,i,t,s,Oe.tiffTags,a,n);if(r.push(l.ifd),!l.nextIFD)return null;yield this._readIFDs(r,e,i,l.nextIFD-s,s,a,n)})}_readIFD(l,o,c,m){return S(this,arguments,function*(r,e,i,t,s=Oe.tiffTags,a=4,n){if(!r)return null;let f=or(r,e,i,t,s,a);if(f.success){let p=[];if(f.ifd?.forEach(u=>{u.values||p.push(u)}),p.length>0){let u=p.map(y=>y.offlineOffsetSize).filter(ke),h=Math.min.apply(null,u.map(y=>y[0]));if(Math.min.apply(null,u.map(y=>y[0]+y[1]))-h<=this._bufferSize){let{data:y}=yield this.request(this.url,{range:{from:h,to:h+this._bufferSize},responseType:"array-buffer",signal:n});r=y,t=h,p.forEach(g=>tr(r,e,g,t))}}if(f.ifd?.has("GEOKEYDIRECTORY")){let u=f.ifd.get("GEOKEYDIRECTORY"),h=u?.values;if(h&&h.length>4){let y=h[0]+"."+h[1]+"."+h[2],g=yield this._readIFD(r,e,u.valueOffset+6-t,t,Oe.geoKeys,2,n);u.data=g.ifd,u.data&&u.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[y]})}}return f}if(f.requiredBufferSize&&f.requiredBufferSize!==r.byteLength)return(r=(yield this.request(this.url,{range:{from:t,to:t+f.requiredBufferSize+4},responseType:"array-buffer",signal:n})).data).byteLength<f.requiredBufferSize?null:this._readIFD(r,e,0,t,Oe.tiffTags,4,n)})}_fetchRawTiffTile(a,n,l,o){return S(this,arguments,function*(r,e,i,t,s={}){let c=this._getTileLocation(r,e,i,t);if(!c)return null;let{ranges:m,actualTileWidth:f,actualTileHeight:p,ifd:u}=c,h=m.map(F=>this.request(this.url,{range:F,responseType:"array-buffer",signal:s.signal})),y=yield Promise.all(h),g=y.map(F=>F.data.byteLength).reduce((F,N)=>F+N),d=y.length===1?y[0].data:new ArrayBuffer(g),x=[0],w=[0];if(y.length>1){let F=new Uint8Array(d);for(let N=0,O=0;N<y.length;N++){let D=y[N].data;F.set(new Uint8Array(D),O),x[N]=O,O+=D.byteLength,w[N]=D.byteLength}}let{blockWidth:b,blockHeight:T}=this.getBlockWidthHeight(r),v=yield this.decodePixelBlock(d,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:u,offsets:x,sizes:w},width:b,height:T,planes:null,pixelType:null});if(v==null)return null;let _,k,E;if(f!==b||p!==T){let F=v.mask;if(F)for(_=0;_<T;_++)if(E=_*b,_<p)for(k=f;k<b;k++)F[E+k]=0;else for(k=0;k<b;k++)F[E+k]=0;else for(F=new Uint8Array(b*T),v.mask=F,_=0;_<p;_++)for(E=_*b,k=0;k<f;k++)F[E+k]=1}return v})}_getTileLocation(r,e,i,t=!1){let{firstPyramidLevel:s,blockBoundary:a}=this.rasterInfo.storageInfo,n=r===0?0:r-(s-1),{_headerInfo:l}=this;if(!l)return null;let o=t?l.maskIFDs[n]:n===0?l?.ifds[0]:l?.pyramidIFDs[n-1];if(!o)return null;let c=ir(o,l),m=wt(o,"TILEOFFSETS");if(m===void 0)return null;let f=wt(o,"TILEBYTECOUNTS"),{minRow:p,minCol:u,maxRow:h,maxCol:y}=a[n];if(e>h||i>y||e<p||i<u)return null;let g=ze(o,"IMAGEWIDTH"),d=ze(o,"IMAGELENGTH"),x=ze(o,"TILEWIDTH"),w=ze(o,"TILELENGTH"),b=[];if(c){let{bandCount:T}=this.rasterInfo;for(let v=0;v<T;v++){let _=v*(h+1)*(y+1)+e*(y+1)+i;b[v]={from:m[_],to:m[_]+f[_]-1}}}else{let T=e*(y+1)+i;b.push({from:m[T],to:m[T]+f[T]-1})}for(let T=0;T<b.length;T++)if(b[T].from==null||!b[T].to||b[T].to<0)return null;return{ranges:b,ifd:o,actualTileWidth:i===y&&g%x||x,actualTileHeight:e===h&&d%w||w}}_fetchAuxiliaryMetaData(r){return S(this,null,function*(){try{let{data:e}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:r?.signal});return _e(e)}catch{return null}})}_fetchAuxiliaryTable(r){return S(this,null,function*(){try{let{data:e}=yield this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:r?.signal}),i=rt.parse(e);return i?.recordSet?ye.fromJSON(i.recordSet):null}catch{return null}})}};function vi(r){let e=rr(r),{width:i,height:t,tileWidth:s,tileHeight:a,planes:n,pixelType:l,compression:o,firstPyramidLevel:c,maximumPyramidLevel:m,pyramidBlockWidth:f,pyramidBlockHeight:p,pyramidResolutions:u,tileBoundary:h,affine:y,metadata:g}=e,d=e.extent.spatialReference?.wkt||e.extent.spatialReference?.wkid,x=Te(d),w=!!e.isPseudoGeographic;x==null&&(w=!0,x=new J({wkid:3857}));let b=new H(B(P({},e.extent),{spatialReference:x})),T=new L(b?{x:b.xmin,y:b.ymax,spatialReference:x}:{x:0,y:0}),v=new ne({blockWidth:s,blockHeight:a,pyramidBlockWidth:f,pyramidBlockHeight:p,compression:o,origin:T,firstPyramidLevel:c,maximumPyramidLevel:m,pyramidResolutions:u,blockBoundary:h}),_=new L({x:(b.xmax-b.xmin)/i,y:(b.ymax-b.ymin)/t,spatialReference:x}),k=g?{BandProperties:g.bandProperties,DataType:g.dataType}:{},E=null,F=ze(r[0],"PHOTOMETRICINTERPRETATION"),N=wt(r[0],"COLORMAP");if(F<=3&&N?.length>3&&N.length%3==0){E=[];let D=N.length/3;for(let M=0;M<D;M++)E.push([M,N[M]>>>8,N[M+D]>>>8,N[M+2*D]>>>8])}let O=new ae({width:i,height:t,bandCount:n,pixelType:l,pixelSize:_,storageInfo:v,spatialReference:x,isPseudoSpatialReference:w,keyProperties:k,extent:b,colormap:E,statistics:g?g.statistics:null});if(y?.length&&(O.nativeExtent=new H({xmin:-.5,ymin:.5-t,xmax:i-.5,ymax:.5,spatialReference:x}),O.transform=new be({polynomialOrder:1,forwardCoefficients:[y[2]+y[0]/2,y[5]-y[3]/2,y[0],y[3],-y[1],-y[4]]}),O.extent=O.transform.forwardTransform(O.nativeExtent),O.pixelSize=new L({x:(b.xmax-b.xmin)/i,y:(b.ymax-b.ymin)/t,spatialReference:x}),v.origin.x=-.5,v.origin.y=.5),u){let{x:D,y:M}=O.pixelSize;u.forEach(A=>{A.x*=D,A.y*=M})}return{imageInfo:e,rasterInfo:O}}function Ti(r,e){if(e.statistics=r.statistics??e.statistics,e.histograms=r.histograms,r.histograms&&e.statistics==null&&(e.statistics=Ie(r.histograms)),r.transform&&e.transform==null){e.transform=r.transform,e.nativeExtent=e.extent;let i=e.transform.forwardTransform(e.nativeExtent);e.pixelSize=new L({x:(i.xmax-i.xmin)/e.width,y:(i.ymax-i.ymin)/e.height,spatialReference:e.spatialReference}),e.extent=i}e.isPseudoSpatialReference&&r.spatialReference&&(e.spatialReference=r.spatialReference,e.extent.spatialReference=e.nativeExtent.spatialReference=e.storageInfo.origin.spatialReference=e.spatialReference)}I([R()],he.prototype,"_files",void 0),I([R()],he.prototype,"_headerInfo",void 0),I([R()],he.prototype,"_bufferSize",void 0),I([R({type:String,json:{write:!0}})],he.prototype,"datasetFormat",void 0),he=I([z("esri.layers.support.rasterDatasets.TIFFRaster")],he);var si=he;var U=new Map;U.set("MRF",{desc:"Meta Raster Format",constructor:ii}),U.set("TIFF",{desc:"GeoTIFF",constructor:si}),U.set("RasterTileServer",{desc:"Raster Tile Server",constructor:ri}),U.set("JPG",{desc:"JPG Raster Format",constructor:Le}),U.set("PNG",{desc:"PNG Raster Format",constructor:Le}),U.set("GIF",{desc:"GIF Raster Format",constructor:Le}),U.set("BMP",{desc:"BMP Raster Format",constructor:Le}),U.set("CovJSON",{desc:"COVJSON Raster Format",constructor:ei}),U.set("MEMORY",{desc:"In Memory Raster Format",constructor:ve});var Ce=class{static get supportedFormats(){let e=new Set;return U.forEach((i,t)=>e.add(t)),e}static open(e){return S(this,null,function*(){let{url:i,ioConfig:t,source:s,sourceJSON:a}=e,n=e.datasetFormat??t?.datasetFormat;n==null&&(i.includes(".")?n=i.slice(i.lastIndexOf(".")+1).toUpperCase():s?.type?.toLowerCase()==="coverage"?n="CovJSON":s?.extent&&s.pixelblocks&&(n="MEMORY")),n==="OVR"||n==="TIF"?n="TIFF":n==="JPG"||n==="JPEG"||n==="JFIF"?n="JPG":n==="COVJSON"&&(n="CovJSON"),i.toLowerCase().includes("/imageserver")&&!i.toLowerCase().includes("/wcsserver")&&(n="RasterTileServer");let l={url:i,source:s,sourceJSON:a,datasetFormat:n,ioConfig:t??{bandIds:null,sampling:null}};if(Object.keys(l).forEach(f=>{l[f]==null&&delete l[f]}),n){if(!this.supportedFormats.has(n))throw new C("rasterfactory:open","not a supported format "+n);if(n==="CRF")throw new C("rasterfactory:open",`cannot open raster: ${i}`);let f=new(U.get(n)).constructor(l);return yield f.open({signal:e.signal}),f}let o=Array.from(U.keys()).filter(f=>f!=="CovJSON"&&f!=="Memory"),c=0,m=()=>{if(n=o[c++],!n||n==="CRF")return null;let f=new(U.get(n)).constructor(l);return f.open({signal:e.signal}).then(()=>f).catch(()=>m())};return m()})}static register(e,i,t){U.has(e.toUpperCase())||U.set(e.toUpperCase(),{desc:i,constructor:t})}};var W=class extends At(Ht(Cr(Yt(qr($t(Qr(Xt(Ut(Lt(Bt(Gt(Xr)))))))))))){constructor(...r){super(...r),this._primaryRasters=[],this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this.source=void 0,this._debouncedSaveOperations=Ft((e,i,t)=>S(this,null,function*(){let{save:s,saveAs:a}=yield import("./chunk-EG66KOOH.js");switch(e){case Pe.SAVE:return s(this,i);case Pe.SAVE_AS:return a(this,t,i)}}))}normalizeCtorArgs(r,e){return typeof r=="string"?P({url:r},e):r}load(r){let e=r!=null?r.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},r).catch(Tt).then(()=>this._openRaster(e))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){let r=[new ue({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"}),new ue({name:"Raster.ServicePixelValue.Raw",alias:"Raw Pixel Value",domain:null,editable:!1,length:50,type:"string"})],e=this.raster?.rasterInfo??this.serviceRasterInfo,i=e?.attributeTable,t=i!=null?i.fields:null,s="Raster.";if(t){let l=t.filter(o=>o.type!=="oid"&&o.name.toLowerCase()!=="value").map(o=>{let c=o.clone();return c.name=s+o.name,c});r.push(...l)}let a=e?.dataType,n=e?.multidimensionalInfo;if((a==="vector-magdir"||a==="vector-uv")&&n!=null){let l=n.variables[0].unit?.trim(),o="Magnitude"+(l?` (${l})`:"");r.push(new ue({name:"Raster.Magnitude",alias:o,domain:null,editable:!1,type:"double"})),r.push(new ue({name:"Raster.Direction",alias:"Direction (\xB0)",domain:null,editable:!1,type:"double"}))}return r}createPopupTemplate(r){let{rasterFields:e}=this,i=r?.visibleFieldNames??new Set(e.map(({name:a})=>a).filter(a=>a.toLowerCase()!=="raster.servicepixelvalue.raw")),t=Kt({fields:e,title:this.title},B(P({},r),{visibleFieldNames:i})),{rasterInfo:s}=this.raster;return t?.fieldInfos&&s?.pixelType.startsWith("f")&&t.fieldInfos.forEach(({format:a,fieldName:n})=>{a&&n&&/^raster\.(item|service)pixelvalue/i.test(n)&&(a.places=2)}),t}generateRasterInfo(r,e){return S(this,null,function*(){if(r=de(Be,r),yield this.load(),!r||r.functionName?.toLowerCase()==="none")return this.serviceRasterInfo;try{let{rasterInfo:i}=yield this._openFunctionRaster(r,e);return i}catch(i){throw i instanceof C?i:new C("imagery-tile-layer","the given raster function is not supported")}})}save(r){return S(this,null,function*(){return this._debouncedSaveOperations(Pe.SAVE,r)})}saveAs(r,e){return S(this,null,function*(){return this._debouncedSaveOperations(Pe.SAVE_AS,e,r)})}write(r,e){let i=this._primaryRasters[0]??this.raster;if(this.loaded?i.datasetFormat==="RasterTileServer"&&(i.tileType==="Raster"||i.tileType==="Map"):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return super.write(r,e);if(e?.messages){let t=`${e.origin}/${e.layerContainerType||"operational-layers"}`;e.messages.push(new C("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${t}'`,{layer:this}))}return null}_openRaster(r){return S(this,null,function*(){let e=!1;if(this.raster)yield this._openFromRaster(this.raster,r),e=this.raster.datasetFormat==="Function",!e&&this.rasterFunction&&(this._primaryRasters=[this.raster],yield this._initializeWithFunctionRaster(this.rasterFunction));else{let{url:t,rasterFunction:s,source:a}=this;if(!t&&!a)throw new C("imagery-tile-layer:open","missing url or source parameter");a?yield this._openFromSource(a,r):s?yield this._openFromUrlWithRasterFunction(t,s,r):yield this._openFromUrl(t,r)}let i=this.raster.rasterInfo;if(!i)throw new C("imagery-tile-layer:load","cannot load resources on "+this.url);if(this._set("serviceRasterInfo",e?i:this._primaryRasters[0].rasterInfo),this._set("spatialReference",i.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,this.sourceJSON!=null){let t=this.raster.tileType==="Map"&&this.sourceJSON.minLOD!=null&&this.sourceJSON.maxLOD!=null?this.sourceJSON:B(P({},this.sourceJSON),{minScale:0,maxScale:0});this.read(t,{origin:"service"})}else this.read({tileInfo:this.serviceRasterInfo?.storageInfo.tileInfo.toJSON()},{origin:"service"});this.title||(this.title=this.raster.datasetName),this.raster.tileType==="Map"&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles(Mt(()=>this.customParameters,t=>{this.raster&&(this.raster.ioConfig.customFetchParameters=t)}))})}_openFromRaster(r,e){return S(this,null,function*(){r.rasterInfo||(yield r.open({signal:e})),this._primaryRasters=r.datasetFormat==="Function"?r.primaryRasters.rasters:[r],this.url||(this.url=this._primaryRasters[0].url)})}_openFromUrlWithRasterFunction(r,e,i){return S(this,null,function*(){let t=[r];e&&Ir(e.toJSON(),t);let s=yield Promise.all(t.map(n=>Ce.open({url:n,sourceJSON:this.sourceJSON,ioConfig:B(P({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters}),signal:i}))),a=s.findIndex(n=>n==null);if(a>-1)throw new C("imagery-tile-layer:open",`cannot open raster: ${t[a]}`);return this._primaryRasters=s,this._initializeWithFunctionRaster(e)})}_openFromUrl(r,e){return S(this,null,function*(){let i=yield Ce.open({url:r,sourceJSON:this.sourceJSON,ioConfig:B(P({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters}),signal:e});if(i==null)throw new C("imagery-tile-layer:open",`cannot open raster: ${r}`);this._primaryRasters=[i],this.raster=i})}_openFromSource(r,e){return S(this,null,function*(){let i="the tiled imagery data source is not supported",t=r.type?.toLowerCase()==="coverage"?"CovJSON":r.extent&&r.pixelBlock?"MEMORY":null;if(!t)throw new C("imagery-tile-layer:open",i);t==="MEMORY"&&(r=B(P({},r),{pixelBlock:void 0,pixelBlocks:[r.pixelBlock]}));let s=yield Ce.open({url:"",source:r,datasetFormat:t,ioConfig:B(P({sampling:"closest"},this.ioConfig),{customFetchParameters:this.customParameters}),signal:e});if(s==null)throw new C("imagery-tile-layer:open",i);this._primaryRasters=[s],this.rasterFunction?yield this._initializeWithFunctionRaster(this.rasterFunction):this.raster=s})}_openFunctionRaster(r,e){return S(this,null,function*(){let i={raster:this._primaryRasters[0]};this._primaryRasters.length>1&&this._primaryRasters.forEach(a=>i[a.url]=a);let t=Ye(r.functionDefinition?.toJSON()??r.toJSON(),i),s=new Ze({rasterFunction:t});return yield s.open(e),s})}_initializeWithFunctionRaster(r,e){return S(this,null,function*(){try{this.raster=yield this._openFunctionRaster(r,e)}catch(i){i instanceof C&&ee.getLogger(this).error("imagery-tile-layer:open",i.message),ee.getLogger(this).warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),this._set("rasterFunction",null),this.raster=this._primaryRasters[0]}})}};I([R({clonable:!1})],W.prototype,"_primaryRasters",void 0),I([R(Fr)],W.prototype,"legendEnabled",void 0),I([R({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],W.prototype,"isReference",void 0),I([R({type:["show","hide"]})],W.prototype,"listMode",void 0),I([R({json:{read:!0,write:!0}})],W.prototype,"blendMode",void 0),I([R()],W.prototype,"sourceJSON",void 0),I([R({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],W.prototype,"version",void 0),I([R({readOnly:!0,json:{read:!1}})],W.prototype,"type",void 0),I([R({type:["ArcGISTiledImageServiceLayer"]})],W.prototype,"operationalLayerType",void 0),I([R({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(r,e)=>!e.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"}},writer(r,e,i){e[i]=!r}}}})],W.prototype,"popupEnabled",void 0),I([R({type:qt,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||this.raster.tileType==="Raster"}}}}})],W.prototype,"popupTemplate",void 0),I([R({readOnly:!0})],W.prototype,"defaultPopupTemplate",null),I([R({readOnly:!0,type:[ue]})],W.prototype,"fields",void 0),I([R({readOnly:!0,type:[ue]})],W.prototype,"rasterFields",null),I([R({constructOnly:!0})],W.prototype,"source",void 0),W=I([z("esri.layers.ImageryTileLayer")],W);var kl=W;export{kl as default};
