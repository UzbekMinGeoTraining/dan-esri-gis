import{a as m}from"./chunk-QPKFNEIN.js";import{b as L}from"./chunk-ND55TYOY.js";import{a as d,b as f,c as v,d as y,e as F,f as w,g as M,h as D,i as P}from"./chunk-O2X6AQXT.js";import"./chunk-GEZWIVEL.js";import{a as g}from"./chunk-YB6FP3Z6.js";import{a as T}from"./chunk-V5Q4ZJF2.js";import{a as S}from"./chunk-TJH2I4RU.js";import{a as G}from"./chunk-CJTT5UF4.js";import{b}from"./chunk-EYI3QUAE.js";import{b as I}from"./chunk-MBVOWLUI.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-LAJXTVEO.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-PYQRTZNZ.js";import"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-EUZMXXZJ.js";import{c as x}from"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import"./chunk-GGZQ5GCM.js";import"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import"./chunk-BMVJCP2M.js";import"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{t as p}from"./chunk-3IBUFXWY.js";import"./chunk-BP73DJTS.js";import{g as u}from"./chunk-JEGVIFEP.js";function oe(t,a){return u(this,null,function*(){let r=t.instance.portalItem;if(r?.id)return yield r.load(a),R(t),t.validateItem&&t.validateItem(r),E(t,a)})}function R(t){let a=t.instance.portalItem;if(!a?.type||!t.supportedTypes.includes(a.type))throw new p("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:t.supportedTypes.join(", ")})}function E(t,a){return u(this,null,function*(){let r=t.instance,e=r.portalItem;if(!e)return;let{url:o,title:s}=e,n=m(e,"portal-item");if(r.type==="group")return N(r,n,t);o&&r.type!=="media"&&r.read({url:o},n);let l=new d,i=yield A(t,l,a);return i&&r.read(i,n),r.resourceReferences={portalItem:e,paths:n.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},n),g(r,n)})}function N(t,a,r){return u(this,null,function*(){let e=t.portalItem;if(!t.sourceIsPortalItem)return;let{title:o,type:s}=e;if(s==="Group Layer"){if(!b(e,"Map"))throw new p("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return j(t)}return t.read({title:o},a),J(t,r)})}function j(t){return u(this,null,function*(){let a=t.portalItem,r=yield a.fetchData("json");if(!r)return;let e=m(a,"web-map");t.read(r,e),yield L(t,r,{context:e}),t.resourceReferences={portalItem:a,paths:e.readResourcePaths??[]}})}function J(t,a){return u(this,null,function*(){let r,{portalItem:e}=t;if(!e)return;let o=e.type,s=a.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new p("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let n=new d,[l,i]=yield Promise.all([r(),A(a,n)]),c=()=>l;if(o==="Feature Service"){let C=y(i)?.customParameters;i=e.url?yield v(i,e.url,n):{},c=(yield Q(i,s))||c;let O=yield H(e.url,{customParameters:C,loadContext:n});return yield h(t,c,i,O)}return o==="Scene Service"&&e.url&&(i=yield P(e,i,n)),w(i)>0?yield h(t,c,i):yield $(t,c)})}function $(t,a){return u(this,null,function*(){let{portalItem:r}=t;if(!r?.url)return;let e=yield S(r.url);e&&h(t,a,{layers:e.layers?.map(f),tables:e.tables?.map(f)})})}function h(t,a,r,e){return u(this,null,function*(){let o=r.layers||[],s=r.tables||[];if(t.portalItem?.type==="Feature Collection"?(o.forEach((n,l)=>{n.id=l,n?.layerDefinition?.type==="Table"&&s.push(n)}),o=o.filter(n=>n?.layerDefinition?.type!=="Table")):(o.reverse(),s.reverse()),o.forEach(n=>{let l=e?.(n);if(l||!e){let i=k(t,a(n),r,n,l);t.add(i)}}),s.length){let n=yield G.FeatureLayer();s.forEach(l=>{let i=e?.(l);if(i||!e){let c=k(t,n,r,l,i);t.tables.add(c)}})}})}function k(t,a,r,e,o){let s=t.portalItem,n={portalItem:s.clone(),layerId:e.id};e.url!=null&&(n.url=e.url);let l=new a(n);if("sourceJSON"in l&&(l.sourceJSON=o),l.type!=="subtype-group"&&l.type!=="catalog"&&(l.sublayerTitleMode="service-name"),s.type==="Feature Collection"){let i={origin:"portal-item",portal:s.portal||x.getDefault()};l.read(e,i);let c=r.showLegend;c!=null&&l.read({showLegend:c},i)}return l}function A(t,a,r){return u(this,null,function*(){if(t.supportsData===!1)return;let e=t.instance,o=e.portalItem;if(!o)return;let s=null;try{s=yield o.fetchData("json",r)}catch{}if(q(e)){let n=null,l=yield B(o,s,a);if((s?.layers||s?.tables)&&l>0){if(e.layerId==null){let i=M(e.type),c=i?F(s,i)[0]:y(s);c&&(e.layerId=c.id)}n=K(s,e),n?.layerType==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),n&&s.showLegend!=null&&(n.showLegend=s.showLegend)}return l>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),n}return s})}function B(t,a,r){return u(this,null,function*(){if(a?.layers&&a?.tables)return w(a);let e=I(t.url);if(!e)return 1;let o=yield r.fetchServiceMetadata(e.url.path,{customParameters:y(a)?.customParameters}).catch(()=>null);return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)})}function K(t,a){let{layerId:r}=a,e=t.layers?.find(o=>o.id===r)||t.tables?.find(o=>o.id===r);return e&&z(e,a)?e:null}function q(t){return t.type!=="stream"&&"layerId"in t}function z(t,a){let r="layerType"in t&&t.layerType,{type:e}=a;return!(e==="feature"&&r&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!r||e==="oriented-imagery"&&!r||e==="subtype-group"&&!r)}function H(t,a){return u(this,null,function*(){let{layersJSON:r}=yield T(t,a);if(!r)return null;let e=[...r.layers,...r.tables];return o=>e.find(s=>s.id===o.id)})}function Q(t,a){return u(this,null,function*(){let{layers:r}=t;if(!r?.length)return;let e=new Set,o=[];for(let{layerType:l}of r){let i=l??"ArcGISFeatureLayer";if(e.has(i))continue;e.add(i);let c=a[D(i)];o.push(c())}let s=yield Promise.all(o),n=new Map;return Array.from(e).forEach((l,i)=>{n.set(l,s[i])}),({layerType:l})=>{let i=l??"ArcGISFeatureLayer";return n.get(i)}})}export{oe as load};
