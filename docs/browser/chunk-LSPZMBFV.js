import{d as c,e as M}from"./chunk-Q7O5PY54.js";import{Q as a,S as _,v as n}from"./chunk-GGZQ5GCM.js";import{U as u}from"./chunk-TFUPB3ZG.js";import{a as i}from"./chunk-BMVJCP2M.js";import{r as l}from"./chunk-3IBUFXWY.js";function p(t){return"usedMemory"in t&&"unloadedMemory"in t&&"ignoresMemoryFactor"in t}function k(t){return new e({view:t})}var g=.1,h=1,m=1,C=.75,x=.6,w=1.3,e=class extends _{constructor(t){super(t),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new M,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(n({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(t){t==null||t<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(h),this._maxMemory=t)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(t){t!=null&&(this._additionalCacheMemory=t)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(t,s){return new c(t,this._cacheStorage,s)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();this._memoryPredicted<x&&this._canFastRecover?(this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(h)):t?(this._memoryPredicted>1.1*m||this._usedMemory>m)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>g&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/w),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)):(this._downscaleMemoryUsed=0,this._usedMemory>m?(this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/w),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(this._usedMemory<C&&this._quality<h?(this._stableQuality=this._quality,t=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0))),this._updating=t}_updateQuality(t){return(t=Math.min(Math.max(t,g),h))!==this._quality&&(this._quality=t,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(t=>!!t.updating)}_updateMemory(){if(!this.view)return;this.view._stage?.renderer?.tick();let t=this.view._stage?.renderer?.usedMemory,s=(this.view.basemapTerrain?.usedMemory??0)+(t?t.fbos+t.edges+t.plugins:0),d=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(r=>{if(p(r)){let y=r.ignoresMemoryFactor?this._quality:1;s+=r.usedMemory*y,d+=r.unloadedMemory*y}});let v=this._warnMemoryUsage==null||Math.round(10*s)!==Math.round(10*this._warnMemoryUsage),o=1048576*this.maxMemory;if(s>o&&v){this._warnMemoryUsage=s;let r=f=>(f/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",y=Math.round(100*this._quality);l.getLogger(this).warn(`Memory Limit exceeded! Limit: ${r(o)} Current: ${r(s)} Projected: ${r(s+d)} Quality: ${y}%`)}this._usedMemory=s/o,this._memoryPredicted=(s+d)/o;let Q=o-s;this._cacheStorage.maxSize=Math.max(0,Q+1048576*this.additionalCacheMemory)}get test(){}};i([a({constructOnly:!0})],e.prototype,"view",void 0),i([a()],e.prototype,"maxMemory",null),i([a()],e.prototype,"additionalCacheMemory",null),i([a({readOnly:!0})],e.prototype,"memoryFactor",null),i([a({readOnly:!0})],e.prototype,"updating",null),i([a({readOnly:!0})],e.prototype,"usedMemory",null),i([a({readOnly:!0})],e.prototype,"usedCacheMemory",null),i([a()],e.prototype,"_quality",void 0),i([a()],e.prototype,"_usedMemory",void 0),i([a()],e.prototype,"_updating",void 0),i([a()],e.prototype,"_stableQuality",void 0),i([a()],e.prototype,"_maxMemory",void 0),i([a()],e.prototype,"_additionalCacheMemory",void 0),e=i([u("esri.views.3d.support.MemoryController")],e);export{k as a,g as b};
