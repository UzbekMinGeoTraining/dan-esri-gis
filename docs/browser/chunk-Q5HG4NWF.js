import{f as E,m as U}from"./chunk-U45ID7OR.js";import{b as J}from"./chunk-IW2AVHBW.js";import{a as k,b as V,c as z,d as q,e as N}from"./chunk-7H32J6FD.js";import{a as F,b as B,d as H}from"./chunk-XNAAMINV.js";import{c as A}from"./chunk-NPF6KTZO.js";import{b as f,c as W,d as $}from"./chunk-VHVYC3RW.js";import{b as j}from"./chunk-KHTVZWEX.js";import{a as w}from"./chunk-S2HMCZNZ.js";import{d as O}from"./chunk-XZ52TEBV.js";import{a as p}from"./chunk-NPIYHDQ7.js";import{a as C}from"./chunk-GB5RQL32.js";import{a as R}from"./chunk-4OZVVJHM.js";import{a as P}from"./chunk-4RLJMQW4.js";import{a as T}from"./chunk-7W6RATG7.js";import{g as S}from"./chunk-YRTBL7EE.js";import{j as y}from"./chunk-PYQRTZNZ.js";import{Q as G,S as D}from"./chunk-GGZQ5GCM.js";import{U as h}from"./chunk-TFUPB3ZG.js";import{a as c}from"./chunk-BMVJCP2M.js";import{a as M,l as L}from"./chunk-GMC3I5VG.js";import{f as x}from"./chunk-WGF2T2BG.js";import{a as I}from"./chunk-BP73DJTS.js";import{g as l}from"./chunk-JEGVIFEP.js";var _=class extends A{constructor(e){super(e),this._hasHighlights=!1,this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new B,this._bufferWriter=null}get produces(){return this._produces}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,r)=>{this._produces.set(r,t=>!!(t!==p.Highlight&&t!==p.ShadowHighlight||this._hasHighlights)&&e(t))})}destroy(){this._glMaterials.dispose();let e=this._renderGeometries.keys();for(let r of e)this.removeRenderGeometry(r)}acquireTechniques(e){let r=this.material;if(!r.shouldRender(e))return null;let{output:t,bind:s}=e;return!r.produces.get(s.slot)?.(t)||(t===p.Highlight||t===p.ShadowHighlight)&&!this._hasHighlights?null:this._glMaterials.load(e.rctx,s.slot,t)?.beginSlot(s)}render(e,r){let t=this._renderGeometries;if(t.size===0)return;let{bind:s}=e,i=s.slot===w.OCCLUDER_MATERIAL||s.slot===w.TRANSPARENT_OCCLUDER_MATERIAL?s.slot:null,a=e.rctx;a.runAppleAmdDriverHelper(),a.bindTechnique(r,s,this.material.parameters);let n=r.program;for(let[d,o]of t)this._drawParameters.origin=o.localOrigin,n.bindDraw(s,this.material.parameters,this._drawParameters),r.ensureAttributeLocations(o.vao),a.bindVAO(o.vao),a.setPipelineState(r.getPipeline(!1,i)),a.drawArrays(r.primitiveType,0,o.numElements)}initializeRenderContext(e,r){this._glMaterials=new F(this.material,e.materials);let t=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,P(this._bufferWriter.vertexBufferLayout));this._vaoCache=t}uninitializeRenderContext(){}addRenderGeometry(e,r,t){this.removeRenderGeometry(e);let s=this._bufferWriter.vertexBufferLayout.stride,i=this._vaoCache.newVao(H(r.data.byteLength));i.vertexBuffers.get("geometry").setSubData(new Uint8Array(r.data),0,0,r.elementCount*s);let a={localOrigin:t,vao:i,numElements:r.elementCount};return this._renderGeometries.set(e,a),a}removeRenderGeometry(e){let r=this._renderGeometries.get(e);r!=null&&(this._vaoCache.deleteVao(r.vao),this._renderGeometries.delete(e))}};c([G({constructOnly:!0})],_.prototype,"material",void 0),_=c([h("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],_);var g=class{constructor(e){this._optionalFields=new Array,this._instanceIndexToFeatureId=new Map,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}doLoad(e,r,t){return l(this,null,function*(){I("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(T.OBJECTANDLAYERIDCOLOR);let s=K(o=>r(o),e),i=this.view._stage,a=q(s);i.addMany(a),this._addDisposeResource(()=>i.removeMany(a));let n=N(s);i.addMany(n),this._addDisposeResource(()=>{n.forEach(o=>o.unload()),i.removeMany(n)}),yield Promise.all(n.map(o=>this.view._stage.schedule(()=>o.load(i.renderView.renderingContext),t))),L(t);let d=yield this._createLodRenderer(s,t);this._lodRendererResources={lodRenderer:d,materials:a,textures:n}})}addInstances(e){let r=this._lodRendererResources;if(r==null)return;let{featureIds:t,localTransforms:s,globalTransforms:i}=e,a=r.lodRenderer;if(a==null)return;let n=a.instanceData,d=t.length;for(let o=0;o<d;++o){let m=t[o],u=n.addInstance(),v=n.view,b=16*o;v.localTransform.copyFromTypedBuffer(u,s,b),v.globalTransform.copyFromTypedBuffer(u,i,b),n.updateModelTransform(u),n.setVisible(u,!0),this._instanceIndexToFeatureId.set(u,m),this._featureIdToInstanceIndex.set(m,u)}}removeInstances(e){let r=this._lodRendererResources;if(r==null)return;let t=r?.lodRenderer,s=t.instanceData,i=this._instanceIndexToFeatureId,a=this._featureIdToInstanceIndex,n=e.length;for(let d=0;d<n;++d){let o=e[d],m=a.get(o);m!=null&&(s.removeInstance(m),i.delete(m),a.delete(o))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}_createLodRenderer(e,r){return l(this,null,function*(){let t=this.view._stage,s={layerUid:this.layerUid,graphicUid:a=>1,notifyGraphicGeometryChanged:a=>1,notifyGraphicVisibilityChanged:a=>1},i=new U({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:null},this.scheduler);return i.slicePlaneEnabled=!1,this._addDisposeResource(()=>{t.removeRenderPlugin(i),i.destroy()}),yield t.addRenderPlugin(i,r),i})}};function K(e,r){let t=r.levels.map(s=>{let i=s.components.map(a=>{let n=e(a.materialId);if(!Q(n))throw new Error("LodRenderer only supports DefaultMaterial");let d=n.createBufferWriter(),o={material:n,vertexBufferLayout:d.vertexBufferLayout,buffer:a.renderGeometryBuffer.data,elementCount:a.renderGeometryBuffer.elementCount,boundingInfo:a.boundingInfo};return new k(o)});return new V(i,s.minScreenSpaceRadius)});return new z(t)}function Q(e){return e!=null&&"materialType"in e&&e.materialType==="default"}g=c([h("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],g);var Y=class extends D{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){}executeRenderCommands(e){return l(this,null,function*(){for(let r of e)switch(r.id){case"create-material":yield this._createMaterial(r);break;case"create-direct-renderer":yield this._createDirectRenderer(r);break;case"add-direct-renderer-geometry":yield this._addDirectRendererGeometry(r);break;case"remove-direct-renderer-geometry":yield this._removeDirectRendererGeometry(r);break;case"create-lod-renderer":yield this._createLodRenderer(r);break;case"add-lod-instances":yield this._addLodInstances(r);break;case"remove-lod-instances":yield this._removeLodInstances(r)}})}_createMaterial(e){return l(this,null,function*(){let{view:r}=this,{sharedSymbolResources:t}=r;if(t==null)throw new Error("No shared symbol resources found!");let{textures:s}=t,i=r.state.viewingMode===C.Global,a=null;switch(e.type){case"default":a=Z(t,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:r._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},i);break;case"hud":{let[n,d]=X(s,i);this.addHandles([M(()=>x(d))]),a=n}break;default:throw new Error(`unable to create unknown material type ${e.type}`)}this._materials.set(e.materialId,a)})}_getMaterial(e){return this._materials.get(e)}_createDirectRenderer(e){return l(this,null,function*(){let r=e.materialId,t=this._getMaterial(r);if(t==null)throw new Error(`material not found ${r}`);let{view:s}=this,i=new _({material:t});this._directRenderers.set(r,i),s._stage.addRenderPlugin(i),s._stage.renderView.renderer.updateHasFlags()})}_addDirectRendererGeometry(e){return l(this,null,function*(){let r=e.renderGeometryId,t=e.materialId;this._renderGeometries.get(r)!=null&&(yield this._removeDirectRendererGeometry({renderGeometryId:r}));let s=this._directRenderers.get(t);if(s==null)return void console.error("no renderer assigned to provided material");let i=s.addRenderGeometry(r,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(r,{renderGeometry:i,materialId:t}),this.view._stage.renderView.requestRender()})}_removeDirectRendererGeometry(e){return l(this,null,function*(){let r=e.renderGeometryId,t=this._renderGeometries.get(r);if(t==null)return;let s=t.materialId,i=this._directRenderers.get(s);i!=null?i.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")})}_createLodRenderer(e){return l(this,null,function*(){let r=new g({view:this.view,layerUid:this.layerUid}),t=new AbortController,s=i=>this._getMaterial(i);yield r.doLoad(e.lodRenderGeometry,s,t.signal),this._lodRenderers.set(e.lodRendererId,r)})}_addLodInstances(e){return l(this,null,function*(){let r=this._lodRenderers.get(e.lodRendererId);if(r==null)throw new Error("no lod renderer assigned to provided lod renderer Id");r.addInstances(e.data)})}_removeLodInstances(e){return l(this,null,function*(){let r=this._lodRenderers.get(e.lodRendererId);if(r==null)throw new Error("no lod renderer assigned to provided lod renderer Id");r.removeInstances(e.featureIds)})}};function X(e,r){let t={anchorPosition:E.center,occlusionTest:!0,hasSlicePlane:!1},s=t,i=1;s.color=[1,0,0,1],s.outlineColor=[0,0,0,1],s.outlineSize=i;let a=null;if(e!=null){let n=e.fromData("circle-icon",()=>$("circle"));s.textureId=n.texture.id,s.textureIsSignedDistanceField=!0,s.sampleSignedDistanceFieldTexelCenter=W("circle")}return s.distanceFieldBoundingBox=re,[new J(t,r),a]}function Z(e,r,t){let s={usePBR:r.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:O,ambient:y,diffuse:y,hasSlicePlane:r.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:r.castShadows,offsetTransparentBackfaces:!r.isPrimitive};return ee(s),r.screenSizePerspectiveEnabled&&(s.screenSizePerspective=e.screenSizePerspectiveSettings),s.externalColor=S,s.isInstanced=!0,new j(s,{spherical:t,doublePrecisionRequiresObfuscation:!0})}function ee(e){let r=e.opacity??1,t=r<1;return e.transparent=t,e.opacity=r,e.cullFace=t?R.None:R.Back,e}Y=c([h("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],Y);var re=[f/2,f/2,1-f/2,1-f/2];export{Y as a,X as b};
