import{a as L,b,c as D,d as K,e as g,f as P,g as N,h as Y,i as _,j as G}from"./chunk-2JZ6XBZT.js";import{a as E}from"./chunk-7ITFLLSZ.js";import"./chunk-NUHIEXKU.js";import"./chunk-RK5X7LGN.js";import"./chunk-QPKFNEIN.js";import{a as M,b as R}from"./chunk-V5Q4ZJF2.js";import"./chunk-TJH2I4RU.js";import{a as U}from"./chunk-CJTT5UF4.js";import{a as J,d as v,e as f,f as A,g as u}from"./chunk-EYI3QUAE.js";import{b as m}from"./chunk-MBVOWLUI.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import{n as F}from"./chunk-LAJXTVEO.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-PYQRTZNZ.js";import"./chunk-BIVFGNT6.js";import"./chunk-EUZMXXZJ.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import"./chunk-GGZQ5GCM.js";import"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import"./chunk-BMVJCP2M.js";import"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{t as p}from"./chunk-3IBUFXWY.js";import{g as O,i as x,u as $}from"./chunk-BP73DJTS.js";import{g as l}from"./chunk-JEGVIFEP.js";var I="Feature Service",T="feature-layer-utils",te=`${T}-save`,re=`${T}-save-as`,d=`${T}-saveall`,h=`${T}-saveall-as`;function S(e){return{isValid:F(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function j(e){let a=[],t=[];for(let{layer:r,layerJSON:o}of e)r.isTable?t.push(o):a.push(o);return{layers:a,tables:t}}function k(e){return j([e])}function q(e,a){return l(this,null,function*(){return/\/\d+\/?$/.test(e.url)?k(a[0]):V(a,e)})}function V(e,a){return l(this,null,function*(){if(e.reverse(),!a)return j(e);let t=yield ne(a,e);for(let r of e)H(r.layer,r.layerJSON,t);return ie(t,e),t})}function ne(e,a){return l(this,null,function*(){let t=yield e.fetchData("json");if(se(t))return t;t||={},oe(t);let{layer:{url:r,customParameters:o,apiKey:s}}=a[0];return yield le(t,{url:r??"",customParameters:o,apiKey:s},a.map(n=>n.layer.layerId)),t})}function se(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function oe(e){e.layers||=[],e.tables||=[]}function ie(e,a){let t=[],r=[];for(let{layer:o}of a){let{isTable:s,layerId:n}=o;s?r.push(n):t.push(n)}C(e.layers,t),C(e.tables,r)}function C(e,a){if(e.length<2)return;let t=[];for(let{id:r}of e)t.push(r);O(t.sort(W),a.slice().sort(W))&&e.sort((r,o)=>{let s=a.indexOf(r.id),n=a.indexOf(o.id);return s<n?-1:s>n?1:0})}function W(e,a){return e<a?-1:e>a?1:0}function le(e,a,t){return l(this,null,function*(){let{url:r,customParameters:o,apiKey:s}=a,{serviceJSON:n,layersJSON:i}=yield M(r,{customParameters:o,apiKey:s}),c=z(e.layers,n.layers,t),y=z(e.tables,n.tables,t);e.layers=c.itemResources,e.tables=y.itemResources;let w=[...c.added,...y.added],ae=i?[...i.layers,...i.tables]:[];yield ce(e,w,r,ae)})}function z(e,a,t){let r=x(e,a,(s,n)=>s.id===n.id);e=e.filter(s=>!r.removed.some(n=>n.id===s.id));let o=r.added;return o.forEach(({id:s})=>{e.push({id:s})}),{itemResources:e,added:o.filter(({id:s})=>!t.includes(s))}}function ce(e,a,t,r){return l(this,null,function*(){let o=yield ue(a),s=a.map(({id:n,type:i})=>new(o.get(i))({url:t,layerId:n,sourceJSON:r.find(({id:c})=>c===n)}));yield Promise.allSettled(s.map(n=>n.load())),s.forEach(n=>{let{layerId:i,loaded:c,defaultPopupTemplate:y}=n;if(!c||y==null)return;let w={id:i,popupInfo:y.toJSON()};n.operationalLayerType!=="ArcGISFeatureLayer"&&(w.layerType=n.operationalLayerType),H(n,w,e)})})}function ue(e){return l(this,null,function*(){let a=[];e.forEach(({type:o})=>{let s=R(o),n=U[s];a.push(n())});let t=yield Promise.all(a),r=new Map;return e.forEach(({type:o},s)=>{r.set(o,t[s])}),r})}function H(e,a,t){e.isTable?B(t.tables,a):B(t.layers,a)}function B(e,a){let t=e.findIndex(({id:r})=>r===a.id);t===-1?e.push(a):e[t]=a}function Q(e,a){if(!e.length)throw new p(`${a}:missing-parameters`,"'layers' array should contain at least one feature layer")}function ye(e,a){let t=e.map(r=>r.portalItem.id);if(new Set(t).size>1)throw new p(`${a}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")}function X(e,a){let t=e.map(r=>r.layerId);if(new Set(t).size!==t.length)throw new p(`${a}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}function pe(e){return l(this,null,function*(){Q(e,d),yield Promise.all(e.map(a=>a.load()));for(let a of e)L(a,d,S),D({layer:a,itemType:I,errorNamePrefix:d});ye(e,d),X(e,d)})}function Z(e,a){let t=e.layers.some(r=>r.layerType==="OrientedImageryLayer");f(a,u.ORIENTED_IMAGERY_LAYER,t)}function ee(e,a){let t=e.some(r=>r.type==="oriented-imagery");f(a,u.ORIENTED_IMAGERY_LAYER,t)}function fe(e,a,t){return l(this,null,function*(){Z(t,a)})}function me(e,a){return l(this,null,function*(){let{url:t,layerId:r,title:o,fullExtent:s,isTable:n}=e,i=m(t);a.url=(i?.serverType==="FeatureServer"?t:`${t}/${r}`)??null,a.title||=o,a.extent=null,n||s==null||(a.extent=yield A(s)),v(a,u.METADATA),v(a,u.MULTI_LAYER),J(a,u.SINGLE_LAYER),f(a,u.TABLE,n),ee([e],a)})}function de(e,a){for(let s of e){let n=s.parsedUrl.path,i=m(n);if(!i?.url.path)throw new p(`${a}:invalid-parameters`,b(s,`has unsupported url pattern: ${n}`),{layer:s});let y=i?.serverType;if(y!=="FeatureServer"&&y!=="MapServer")throw new p(`${a}:invalid-parameters`,b(s,`has unsupported server type: ${y}`),{layer:s});if(y==="MapServer"&&e.length>1)throw new p(`${a}:invalid-parameters`,"Only one layer or table in a map service can be saved")}let t=m(e[0].parsedUrl.path),r=t?.url.path;if(!e.every(s=>m(s.parsedUrl.path)?.url.path===r))throw new p(`${a}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")}function he(e){return l(this,null,function*(){Q(e,h),yield Promise.all(e.map(a=>a.load()));for(let a of e)L(a,h,S);de(e,h),X(e,h)})}function we(e,a){Z(a,e),N(e)}function ve(e,a){return l(this,null,function*(){let t=0,r=0;for(let{isTable:n}of a)n?r++:t++;let o=a[0].parsedUrl.path,s=m(o);if(e.url=s?.serverType==="FeatureServer"?s.url.path:o,e.title||=s.title,e.extent=null,t>0){let n=a.map(i=>i.fullExtent).filter($).reduce((i,c)=>i.clone().union(c));n&&(e.extent=yield A(n))}v(e,u.METADATA),f(e,u.MULTI_LAYER,a.length>1),f(e,u.SINGLE_LAYER,a.length===1),f(e,u.TABLE,r>0&&t===0),ee(a,e),N(e)})}function Ne(e,a){return l(this,null,function*(){return _({layer:e,itemType:I,validateLayer:S,createItemData:(t,r)=>q(r,[t]),errorNamePrefix:te,setItemProperties:fe},a)})}function Oe(e,a){return l(this,null,function*(){yield pe(e);let t=e[0].portalItem,r=g(t),o=yield Promise.all(e.map(n=>P(n,r,a))),s=yield q(t,e.map((n,i)=>({layer:n,layerJSON:o[i]})));return we(t,s),yield t.update({data:s}),yield Promise.all(e.slice(1).map(n=>n.portalItem.reload())),E(r),t.clone()})}function xe(e,a,t){return l(this,null,function*(){return G({layer:e,itemType:I,validateLayer:S,createItemData:(r,o)=>Promise.resolve(k(r)),errorNamePrefix:re,newItem:a,setItemProperties:me},t)})}function $e(e,a,t){return l(this,null,function*(){yield he(e);let r=K({itemType:I,errorNamePrefix:h,newItem:a}),o=g(r),s=yield Promise.all(e.map(i=>P(i,o,t))),n=yield V(e.map((i,c)=>({layer:i,layerJSON:s[c]})));yield ve(r,e),yield Y(r,n,t);for(let i of e)i.portalItem=r.clone();return E(o),r})}export{Ne as save,Oe as saveAll,$e as saveAllAs,xe as saveAs};
