import{a as z}from"./chunk-S2HMCZNZ.js";import{i as at,j as le,k as ce,l as ot,m as nt,n as lt,o as ct}from"./chunk-WUAC4CFP.js";import{a as Ke,h as $e}from"./chunk-ONDKJR4V.js";import{a as pt}from"./chunk-NNNTRPDR.js";import{b as S}from"./chunk-J7UK2QPE.js";import{c as pe,d as ht}from"./chunk-GQ2SPTYG.js";import{a as ft}from"./chunk-RBWI4VLW.js";import{a as je,b as Je}from"./chunk-N6PITG7Q.js";import{a as rt}from"./chunk-GKUBZAEG.js";import{a as et,e as it,f as st}from"./chunk-UW734WOQ.js";import{f as Ge,k as Xe,l as Ye,m as Ze}from"./chunk-ATV5GTE5.js";import{f as tt}from"./chunk-PQPFAB53.js";import{c as qe,d as oe,e as He,f as We,i as ke,j as Qe}from"./chunk-MJXFSFCY.js";import{a as Be}from"./chunk-6N46AY7Z.js";import{a as ne}from"./chunk-G5SIQY64.js";import{a as Ve}from"./chunk-RDGFIF46.js";import{a as U,k as G}from"./chunk-NPIYHDQ7.js";import{a as j}from"./chunk-YJ3RZNO6.js";import{a as re}from"./chunk-NH3JQE75.js";import{a as Ue}from"./chunk-XXOIKNT6.js";import{a as ae}from"./chunk-DBLGLVAQ.js";import{b as Me}from"./chunk-J6ZRC6RI.js";import{a as we}from"./chunk-EBGO44EK.js";import{a as l}from"./chunk-7W6RATG7.js";import{b as se,i as Le}from"./chunk-BDF7KEUQ.js";import{a as ie,c as ze}from"./chunk-HWN5REN7.js";import{p as Ne}from"./chunk-B4JAL745.js";import{b as Pe,t as De}from"./chunk-XTES2GPX.js";import{a as M,b as F,c as H,d as W,e as _e,n as N,p as Re,u as te,v as xe,y as L,z as Fe}from"./chunk-2HUIJUS4.js";import{f as Ie}from"./chunk-5MNDZ6BX.js";import{a as be}from"./chunk-6WKJD7BM.js";import{a as $,d as ee,e as Ce}from"./chunk-YRTBL7EE.js";import{a as R,c as ye}from"./chunk-PYQRTZNZ.js";import{b as Ee,h as Ae}from"./chunk-5PTS4JDF.js";import{a as g}from"./chunk-BMVJCP2M.js";import{a as K}from"./chunk-JEGVIFEP.js";function yt(a){return a instanceof Float32Array&&a.length>=16}function It(a){return Array.isArray(a)&&a.length>=16}function dt(a){return yt(a)||It(a)}var X=class{constructor(){this.factor=new Y,this.factorAlignment=new Y}},Y=class{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}};var Z=class extends Je{constructor(e,i,t){super(e,i,new je(ht,()=>import("./chunk-QH2DJGNM.js")),t),this.primitiveType=i.occlusionPass?se.POINTS:se.TRIANGLES}initializePipeline(e){let{oitPass:i,hasPolygonOffset:t,draped:s,output:r,depthTestEnabled:n}=e,o=i===ne.NONE,h=t?Ct:null,d=i===ne.ColorAlpha,f=s||!n||d||r===U.Highlight?null:Xe;return Ze({blending:r===U.Color?o?Ge:Ke(i):null,depthTest:n&&!s?{func:Le.LEQUAL}:null,depthWrite:f,drawBuffers:$e(i,r),colorWrite:Ye,polygonOffset:h})}},Ct={factor:0,units:-4};var u=class extends pt{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.textureCoordinateType=et.None,this.emissionSource=rt.None,this.discardInvisibleFragments=!0,this.hasSliceInVertexProgram=!0,this.hasVvInstancing=!1}};g([S()],u.prototype,"screenCenterOffsetUnitsEnabled",void 0),g([S()],u.prototype,"occlusionTestEnabled",void 0),g([S()],u.prototype,"signedDistanceFieldEnabled",void 0),g([S()],u.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),g([S()],u.prototype,"vvSize",void 0),g([S()],u.prototype,"vvColor",void 0),g([S()],u.prototype,"hasVerticalOffset",void 0),g([S()],u.prototype,"hasScreenSizePerspective",void 0),g([S()],u.prototype,"hasRotation",void 0),g([S()],u.prototype,"debugDrawLabelBorder",void 0),g([S()],u.prototype,"hasSlicePlane",void 0),g([S()],u.prototype,"hasPolygonOffset",void 0),g([S()],u.prototype,"depthTestEnabled",void 0),g([S()],u.prototype,"pixelSnappingEnabled",void 0),g([S()],u.prototype,"draped",void 0),g([S()],u.prototype,"terrainDepthTest",void 0),g([S()],u.prototype,"cullAboveTerrain",void 0),g([S()],u.prototype,"occlusionPass",void 0),g([S()],u.prototype,"occludedFragmentFade",void 0),g([S()],u.prototype,"objectAndLayerIdColorInstanced",void 0),g([S()],u.prototype,"horizonCullingEnabled",void 0);var ut=class extends ke{constructor(e,i){super(e,ge),this.produces=new Map([[z.HUD_MATERIAL,t=>G(t)&&!this.parameters.drawInSecondSlot],[z.LABEL_MATERIAL,t=>G(t)&&this.parameters.drawInSecondSlot],[z.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[z.DRAPED_MATERIAL,t=>this.parameters.draped&&G(t)]]),this._visible=!0,this._configuration=new u(i)}getConfiguration(e,i){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=i.slot===z.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.depthTestEnabled=this.parameters.depthEnabled||i.slot===z.OCCLUSION_PIXELS,e===U.Color&&(this._configuration.debugDrawLabelBorder=!!Be.LABELS_SHOW_BORDER),this._configuration.oitPass=i.oitPass,this._configuration.terrainDepthTest=i.terrainDepthTest,this._configuration.cullAboveTerrain=i.cullAboveTerrain,this._configuration}intersect(e,i,t,s,r,n){let{options:{selectionMode:o,hud:h,excludeLabels:d},point:f,camera:c}=t,{parameters:m}=this;if(!o||!h||d&&m.isLabel||!e.visible||!f)return;let{scaleX:p,scaleY:T}=this._getScreenScale(e,c.pixelRatio);re(he,i),e.attributes.has(l.FEATUREATTRIBUTE)&&Dt(he);let v=e.attributes.get(l.POSITION),C=e.attributes.get(l.SIZE),P=e.attributes.get(l.NORMAL),A=e.attributes.get(l.ROTATION),I=e.attributes.get(l.CENTEROFFSETANDDISTANCE);we(v.size>=3);let _=pe(m),x=this.parameters.centerOffsetUnits==="screen";for(let D=0;D<v.data.length/v.size;D++){let J=D*v.size;H(O,v.data[J],v.data[J+1],v.data[J+2]),L(O,O,i),L(O,O,c.viewMatrix);let k=D*I.size;if(H(y,I.data[k],I.data[k+1],I.data[k+2]),!x&&(O[0]+=y[0],O[1]+=y[1],y[2]!==0)){let q=y[2];te(y,O),_e(O,O,N(y,y,q))}let Q=D*P.size;if(H(V,P.data[Q],P.data[Q+1],P.data[Q+2]),mt(V,he,c,ue),this._applyVerticalOffsetTransformationView(O,ue,c,fe),c.applyProjection(O,E),E[0]>-1){x&&(y[0]||y[1])&&(E[0]+=y[0]*c.pixelRatio,y[1]!==0&&(E[1]+=qe(y[1],fe.factorAlignment)*c.pixelRatio),c.unapplyProjection(E,O)),E[0]+=this.parameters.screenOffset[0]*c.pixelRatio,E[1]+=this.parameters.screenOffset[1]*c.pixelRatio,E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]);let q=D*C.size;b[0]=C.data[q],b[1]=C.data[q+1],He(b,fe.factor,b);let Et=Ft*c.pixelRatio,Oe=0;m.textureIsSignedDistanceField&&(Oe=Math.min(m.outlineSize,.5*b[0])*c.pixelRatio/2),b[0]*=p,b[1]*=T;let At=D*A.size,bt=m.rotation+A.data[At];if(gt(f,E[0],E[1],b,Et,Oe,bt,m,_)){let Te=t.ray;if(L(St,O,Ie(Rt,c.viewMatrix)),E[0]=f[0],E[1]=f[1],c.unprojectFromRenderScreen(E,O)){let w=R();F(w,Te.direction);let ve=1/M(w);N(w,w,ve),n(Re(Te.origin,O)*ve,w,-1,!0,1,St)}}}}}intersectDraped(e,i,t,s,r,n){let o=e.attributes.get(l.POSITION),h=e.attributes.get(l.SIZE),d=e.attributes.get(l.ROTATION),f=this.parameters,c=pe(f),{scaleX:m,scaleY:p}=this._getScreenScale(e,e.screenToWorldRatio),T=Nt*e.screenToWorldRatio;for(let v=0;v<o.data.length/o.size;v++){let C=v*o.size,P=o.data[C],A=o.data[C+1],I=v*h.size;b[0]=h.data[I],b[1]=h.data[I+1];let _=0;f.textureIsSignedDistanceField&&(_=Math.min(f.outlineSize,.5*b[0])*e.screenToWorldRatio/2),b[0]*=m,b[1]*=p;let x=v*d.size,D=f.rotation+d.data[x];gt(s,P,A,b,T,_,D,f,c)&&r(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new Se}_updateScaleInfo(e,i,t){let s=this.parameters;s.screenSizePerspective!=null?oe(t,i,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),s.screenSizePerspectiveAlignment!=null?oe(t,i,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,i,t,s,r,n,o){let h=mt(i,t,r,ue);return this._applyVerticalGroundOffsetView(e,h,r,o),this._applyVerticalOffsetTransformationView(o,h,r,n),this._applyPolygonOffsetView(o,h,s[3],r,o),this._applyCenterOffsetView(o,s,o),o}applyShaderOffsetsNDC(e,i,t,s,r){return this._applyCenterOffsetNDC(e,i,t,s),r!=null&&F(r,s),this._applyPolygonOffsetNDC(s,i,t,s),s}_applyPolygonOffsetView(e,i,t,s,r){let n=s.aboveGround?1:-1,o=Math.sign(t);o===0&&(o=n);let h=n*o;if(this.parameters.shaderPolygonOffset<=0)return F(r,e);let d=Ee(Math.abs(i.cosAngle),.01,1),f=1-Math.sqrt(1-d*d)/d/s.viewport[2];return N(r,e,h>0?f:1/f),r}_applyVerticalGroundOffsetView(e,i,t,s){let r=M(e),n=t.aboveGround?1:-1,o=t.computeRenderPixelSizeAtDist(r)*ft,h=N(O,i.normal,n*o);return W(s,e,h),s}_applyVerticalOffsetTransformationView(e,i,t,s){let r=this.parameters;if(!r.verticalOffset?.screenLength){if(r.screenSizePerspective||r.screenSizePerspectiveAlignment){let d=M(e);this._updateScaleInfo(s,d,i.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return e}let n=M(e),o=r.screenSizePerspectiveAlignment??r.screenSizePerspective,h=We(t,n,r.verticalOffset,i.cosAngle,o);return this._updateScaleInfo(s,n,i.cosAngle),N(i.normal,i.normal,h),W(e,e,i.normal)}_applyCenterOffsetView(e,i,t){let s=this.parameters.centerOffsetUnits!=="screen";return t!==e&&F(t,e),s&&(t[0]+=i[0],t[1]+=i[1],i[2]&&(te(V,t),W(t,t,N(V,V,i[2])))),t}_applyCenterOffsetNDC(e,i,t,s){let r=this.parameters.centerOffsetUnits!=="screen";return s!==e&&F(s,e),r||(s[0]+=i[0]/t.fullWidth*2,s[1]+=i[1]/t.fullHeight*2),s}_applyPolygonOffsetNDC(e,i,t,s){let r=this.parameters.shaderPolygonOffset;if(e!==s&&F(s,e),r){let n=t.aboveGround?1:-1,o=n*Math.sign(i[3]);s[2]-=(o||n)*r}return s}set visible(e){this._visible=e}get visible(){let{color:e,outlineSize:i,outlineColor:t}=this.parameters,s=e[3]>=j||i>=j&&t[3]>=j;return this._visible&&s}createGLMaterial(e){return new me(e)}calculateRelativeScreenBounds(e,i,t=be()){return Pt(this.parameters,e,i,t),t[2]=t[0]+e[0],t[3]=t[1]+e[1],t}_getScreenScale(e,i){let t=e.attributes.get(l.FEATUREATTRIBUTE);if(t==null)return{scaleX:i,scaleY:i};let s=Ce(t.data,xt);return tt(de,this.parameters,s),{scaleX:de[0]*i,scaleY:de[1]*i}}},me=class extends it{constructor(e){super(K(K({},e),e.material.parameters))}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.acquireTechnique(Z,e)}};function Pt(a,e,i,t){t[0]=a.anchorPosition[0]*-e[0]+a.screenOffset[0]*i,t[1]=a.anchorPosition[1]*-e[1]+a.screenOffset[1]*i}function mt(a,e,i,t){return dt(e)&&(e=re(_t,e)),Fe(t.normal,a,e),L(t.normal,t.normal,i.viewInverseTransposeMatrix),t.cosAngle=xe(Tt,zt),t}function Dt(a){let e=a[0],i=a[1],t=a[2],s=a[3],r=a[4],n=a[5],o=a[6],h=a[7],d=a[8],f=1/Math.sqrt(e*e+i*i+t*t),c=1/Math.sqrt(s*s+r*r+n*n),m=1/Math.sqrt(o*o+h*h+d*d);return a[0]=e*f,a[1]=i*f,a[2]=t*f,a[3]=s*c,a[4]=r*c,a[5]=n*c,a[6]=o*m,a[7]=h*m,a[8]=d*m,a}function gt(a,e,i,t,s,r,n,o,h){let d=e-s-t[0]*h[0],f=d+t[0]+2*s,c=i-s-t[1]*h[1],m=c+t[1]+2*s,p=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&p!=null&&(d+=t[0]*p[0],c+=t[1]*p[1],f-=t[0]*(1-p[2]),m-=t[1]*(1-p[3]),d-=r,f+=r,c-=r,m+=r),Pe(Ot,e,i),De(B,a,Ot,Ae(n)),B[0]>d&&B[0]<f&&B[1]>c&&B[1]<m}var fe=new X,O=R(),V=R(),E=$(),Tt=R(),St=R(),B=ie(),Ot=ie(),he=ae(),_t=ae(),Rt=Ue(),y=R(),de=R(),xt=$(),ue={normal:Tt,cosAngle:0},Ft=1,Nt=2,b=[0,0],zt=ye(0,0,1),ge=class extends st{constructor(){super(...arguments),this.renderOccluded=Qe.Occlude,this.isDecoration=!1,this.color=ee(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=ze(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=ee(1,1,1,1),this.outlineSize=0,this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1,this.isLabel=!1}},vt=Me().vec3f(l.POSITION).vec3f(l.NORMAL).vec2f(l.UV0).vec4u8(l.COLOR).vec2f(l.SIZE).f32(l.ROTATION).vec4f(l.CENTEROFFSETANDDISTANCE).vec4f(l.FEATUREATTRIBUTE),wt=vt.clone().vec4u8(l.OBJECTANDLAYERIDCOLOR),Se=class{constructor(){this.vertexBufferLayout=Ve()?wt:vt}elementCount(e){return 6*e.get(l.POSITION).indices.length}write(e,i,t,s,r,n){ot(t.get(l.POSITION),e,r.position,n,6),nt(t.get(l.NORMAL),i,r.normal,n,6);let o=t.get(l.UV0)?.data,h=0,d=0,f=1,c=1;o&&o.length>=4&&(h=o[0],d=o[1],f=o[2],c=o[3]),f=Math.min(1.99999,f+1),c=Math.min(1.99999,c+1);let m=t.get(l.POSITION).indices.length,p=n,T=r.uv0;for(let A=0;A<m;++A)T.set(p,0,h),T.set(p,1,d),p++,T.set(p,0,f),T.set(p,1,d),p++,T.set(p,0,f),T.set(p,1,c),p++,T.set(p,0,f),T.set(p,1,c),p++,T.set(p,0,h),T.set(p,1,c),p++,T.set(p,0,h),T.set(p,1,d),p++;lt(t.get(l.COLOR),4,r.color,n,6);let{data:v,indices:C}=t.get(l.SIZE);m=C.length;let P=r.size;p=n;for(let A=0;A<m;++A){let I=v[2*C[A]],_=v[2*C[A]+1];for(let x=0;x<6;++x)P.set(p,0,I),P.set(p,1,_),p++}if(at(t.get(l.ROTATION),r.rotation,n,6),t.get(l.CENTEROFFSETANDDISTANCE)?le(t.get(l.CENTEROFFSETANDDISTANCE),r.centerOffsetAndDistance,n,6):ce(r.centerOffsetAndDistance,n,6*m),t.get(l.FEATUREATTRIBUTE)?le(t.get(l.FEATUREATTRIBUTE),r.featureAttribute,n,6):ce(r.featureAttribute,n,6*m),s!=null){let A=t.get(l.POSITION)?.indices;if(A){let I=A.length,_=r.getField(l.OBJECTANDLAYERIDCOLOR,Ne);ct(s,_,I,n,6)}}}};export{X as a,ut as b};
