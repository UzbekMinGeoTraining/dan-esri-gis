import{a as w}from"./chunk-NDYVXEZ5.js";import{r as R,t as G}from"./chunk-3IBUFXWY.js";import{a as x,b as g,g as h}from"./chunk-JEGVIFEP.js";var U=()=>R.getLogger("esri.support.arcadeOnDemand"),v;function M(){return v||(v=h(this,null,function*(){let t=yield import("./chunk-LQSRWWXQ.js");return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature}})),v}var J=(t,e,a)=>o.create(t,e,a,null,["$feature","$view"],[]);var N=(t,e,a)=>o.create(t,e,a,null,["$feature","$view"],[]);var P=(t,e,a,c)=>o.create(t,e,a,c,["$feature","$view"],[]),o=class t{constructor(e,a,c,l,d,n,s){this.services=null,this.script=e,this.evaluate=l;let f=Array.isArray(n)?n:n?.fields;this.fields=f??[],this._syntaxTree=c,this._arcade=a,this._arcadeFeature=d,this._spatialReference=s,this._referencesGeometry=a.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static create(e,a,c,l,d,n){return h(this,null,function*(){let{arcade:s,Feature:f,Dictionary:$}=yield M(),m=a instanceof w?a:w.fromJSON(a),i;try{i=s.parseScript(e,n)}catch(r){return U().error(new G("arcade-bad-expression","Failed to parse arcade script",{script:e,error:r})),null}let F=d.reduce((r,y)=>g(x({},r),{[y]:null}),{}),u=null;l!=null&&(u=new $(l),u.immutable=!0,F.$config=null);let _=s.scriptUsesGeometryEngine(i),A=_&&s.enableGeometrySupport(),E=s.scriptUsesFeatureSet(i)&&s.enableFeatureSetSupport(),S=s.scriptIsAsync(i),b=S&&s.enableAsyncSupport(),D={vars:F,spatialReference:m,useAsync:!!b};yield Promise.all([A,E,b]);let O=new Set;yield s.loadDependentModules(O,i,null,S,_);let p=new $;p.immutable=!1,p.setField("scale",0);let T=s.compileScript(i,D),j=(r,y)=>{let L=r.$view?.timeZone;return"$view"in r&&r.$view&&(p.setField("scale",typeof r.$view=="object"&&"scale"in r.$view?r.$view.scale:void 0),r.$view=p),u&&(r.$config=u),T({vars:r,spatialReference:m,services:y,timeZone:L})};return new t(e,s,i,j,new f,c,m)})}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};export{M as a,J as b,N as c,P as d};
