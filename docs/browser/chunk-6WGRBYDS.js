import{a as Q,b}from"./chunk-E3DN7XQP.js";import{a as P}from"./chunk-MNOCKVQA.js";import{a as j}from"./chunk-6YHOGO6F.js";import{a as S}from"./chunk-VY6QN6EN.js";import{b as E}from"./chunk-ZGDQY5ZD.js";import{a as O,c as x,i as N}from"./chunk-MBJHSEMD.js";import{I as G,e as v,f as h,g as I,h as R,l as T,m as B,n as _,o as C,s as q}from"./chunk-7D4IYTAJ.js";import{a as L}from"./chunk-GLWPOGYF.js";import{Q as p}from"./chunk-GGZQ5GCM.js";import{U as A}from"./chunk-TFUPB3ZG.js";import{a as d}from"./chunk-BMVJCP2M.js";import{l as w}from"./chunk-GMC3I5VG.js";import{r as F,t as g}from"./chunk-3IBUFXWY.js";import{g as m}from"./chunk-JEGVIFEP.js";var ie=M=>{let u=class extends M{constructor(...t){super(...t),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([O(()=>{let t=this.layer;return[t&&"elevationInfo"in t?t.elevationInfo?.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),N),x(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),x(()=>{let t=this.layer;return t&&"sublayers"in t?t.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];let{layer:t,layer:{fieldsIndex:e},requiredFields:r}=this;return"outFields"in t&&t.outFields?v(e,[...R(e,t.outFields),...r]):v(e,r)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){F.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(t){throw new Error("missing implementation")}createQuery(){let t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new E(t);if("floorInfo"in this.layer&&this.layer.floorInfo){let r=P(this);r!=null&&(e.where=e.where?`(${e.where}) AND (${r})`:r)}return this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){let t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new E(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}fetchPopupFeaturesFromGraphics(t,e){return m(this,null,function*(){return this._validateFetchPopupFeatures(t,e),this._fetchPopupFeatures(t,e)})}_loadArcadeModules(t){return t.expressionInfos?.length||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression")?L():Promise.resolve()}_handleRequiredFieldsChange(){let t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then(()=>{this._updatingRequiredFieldsPromise===t&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){return m(this,null,function*(){if(!this.layer||!this.view)return;let t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:r,objectIdField:l}}=this,n="renderer"in e&&e.renderer,s="orderBy"in e&&e.orderBy,o="featureReduction"in e?e.featureReduction:null,i=new Set,c=yield Promise.allSettled([n?n.collectRequiredFields(i,r):null,q(i,e),t&&"elevationInfo"in e?T(i,e):null,this.filter!=null?_(i,e,this.filter):null,t||this.featureEffect==null?null:_(i,e,this.featureEffect.filter),!t&&o?B(i,e,o):null,!t&&s?C(i,e,s):null]);if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&h(i,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"floorInfo"in e&&e.floorInfo&&h(i,e.fieldsIndex,[e.floorInfo.floorField]),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&F.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),h(i,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){I(i,r,e.subtypeField);let a=e.sublayers.map(y=>Promise.all([y.renderer?.collectRequiredFields(i,r),q(i,y)]));yield Promise.allSettled(a)}if(e.type==="catalog-footprint"&&e.parent){let a=e.parent;h(i,r,[a.itemNameField,a.itemSourceField,a.itemTypeField,a.maxScaleField,a.minScaleField])}for(let a of c)a.status==="rejected"&&F.getLogger(this).error(a.reason);I(i,r,l),t&&"displayField"in e&&e.displayField&&I(i,r,e.displayField);let f=Array.from(i).sort();this._set("requiredFields",f)})}_validateFetchPopupFeatures(t,e){if(e!=null)for(let r of t){let l=r.origin&&"layer"in r.origin?r.origin.layer:r.layer;if("popupEnabled"in l&&!l.popupEnabled)throw new g("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:l});if(r.isAggregate){let n="featureReduction"in l?l.featureReduction:null;if(!(n&&"popupTemplate"in n&&n.popupEnabled&&n.popupTemplate))throw new g("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:l})}else if("popupTemplate"in l&&!b(l,e))throw new g("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:l})}}_popupFeatureHasRequiredFields(t,e){return G(e,t)}_fetchPopupFeatures(t,e){return m(this,null,function*(){let r=new Array(t.length),l=new Map,n=yield this._createPopupQuery(t.map(s=>s.origin?.layer??s.layer),e);for(let s=0;s<t.length;s++){let o=t[s];if(o.isAggregate){r[s]=o;continue}let i=o.origin?.layer??o.layer;if(!i||!("popupEnabled"in i))continue;let c=R(this.layer.fieldsIndex,n.outFields),f=b(i,e);if(f==null)continue;let a=yield this._loadArcadeModules(f);w(e),a&&a.arcadeUtils.hasGeometryOperations(f)||!this._popupFeatureHasRequiredFields(o,c)?l.set(o.getObjectId(),{graphic:o,index:s}):r[s]=o}if(this.layer.type==="stream"||this.layer.type==="parquet"||l.size===0)return r.filter(Boolean);n.objectIds=Array.from(l.keys());try{let s=yield this.layer.queryFeatures(n,e);for(let o of s.features){let{graphic:{geometry:i,origin:c},index:f}=l.get(o.getObjectId());o.geometry||=i,o.origin=c,r[f]=o}}catch{}return r.filter(Boolean)})}_createPopupQuery(t,e){return m(this,null,function*(){let r=this.layer.createQuery(),l=new Set,n=!1,s=t??[this.layer];for(let o of s){if(!("popupEnabled"in o))continue;let i=b(o,e);if(i==null)continue;let c=yield this._loadArcadeModules(i);w(e);let f=c&&c.arcadeUtils.hasGeometryOperations(i);n=!(this.layer.geometryType!=="point"&&!f);let a=yield Q(this.layer,i);w(e);for(let y of a)l.add(y)}if(r.returnGeometry=n,r.returnZ=n,r.returnM=n,r.outFields=Array.from(l),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){let o=P(this);o!=null&&(r.where=r.where?`(${r.where}) AND (${o})`:o)}return r})}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return d([p()],u.prototype,"_updatingRequiredFieldsPromise",void 0),d([p({readOnly:!0})],u.prototype,"availableFields",null),d([p({readOnly:!0})],u.prototype,"dataUpdating",void 0),d([p({type:j})],u.prototype,"featureEffect",null),d([p({type:S})],u.prototype,"filter",void 0),d([p()],u.prototype,"layer",void 0),d([p({type:Number})],u.prototype,"maximumNumberOfFeatures",null),d([p({readOnly:!0,type:Boolean})],u.prototype,"maximumNumberOfFeaturesExceeded",null),d([p({readOnly:!0})],u.prototype,"requiredFields",void 0),d([p()],u.prototype,"suspended",void 0),d([p()],u.prototype,"view",void 0),u=d([A("esri.views.layers.FeatureLayerView")],u),u};export{ie as a};
