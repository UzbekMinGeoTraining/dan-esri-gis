import{a as te,b as j,c as re}from"./chunk-UHCAZ4FA.js";import{c as G}from"./chunk-CYHJCRNT.js";import{a as A}from"./chunk-CDG4VMUI.js";import{d as Ce,e as Te,l as ee}from"./chunk-HW47RMVO.js";import{a as je}from"./chunk-NPSROKUX.js";import{a as Oe}from"./chunk-PHK5IJNU.js";import{e as be}from"./chunk-KAOR3JAH.js";import{a as Ae}from"./chunk-RB4JCGG3.js";import{a as W}from"./chunk-M2F4B74F.js";import{h as L}from"./chunk-7ISKCG7U.js";import{a as Me}from"./chunk-VY6QN6EN.js";import{a as Qe}from"./chunk-C3YONAAM.js";import{b as Fe}from"./chunk-ZGDQY5ZD.js";import{a as ve}from"./chunk-PFIMJ2UL.js";import{a as B}from"./chunk-PJX4LNSV.js";import{G as _e,b as Re,d as O}from"./chunk-EPTSNNZF.js";import{g as xe,h as Y}from"./chunk-FW33MEBA.js";import{c as K,d as J,z as P}from"./chunk-2HUIJUS4.js";import{d as ce}from"./chunk-MBJHSEMD.js";import{a as ge,d as Se,h as Ee,i as we,v as Ie}from"./chunk-6WKJD7BM.js";import{c as V}from"./chunk-PYQRTZNZ.js";import{a as le}from"./chunk-VWF5VUO3.js";import{b as he}from"./chunk-5PTS4JDF.js";import{e as X,y as fe}from"./chunk-N27U3N2T.js";import{a as $}from"./chunk-NDYVXEZ5.js";import{J as ye,ga as me,r as pe,u as de}from"./chunk-4DLSYLKE.js";import{a as ue}from"./chunk-VPXBKZQM.js";import{Q as p,S as T}from"./chunk-GGZQ5GCM.js";import{U as C}from"./chunk-TFUPB3ZG.js";import{a as c}from"./chunk-BMVJCP2M.js";import{b as ae}from"./chunk-WGF2T2BG.js";import{r as oe,t as Z}from"./chunk-3IBUFXWY.js";import{m as ne,n as se}from"./chunk-BP73DJTS.js";import{g as k}from"./chunk-JEGVIFEP.js";var De="esri.views.3d.layers.i3s.I3SMeshViewFilter",N=()=>oe.getLogger(De),f=class extends T{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){ce(()=>this.viewFilter?.geometry||this.layerFilter!=null).then(()=>this.loadAsyncModule(import("./chunk-RCUZLKRT.js").then(e=>{this.destroyed||(this._geometryEngine=e)})))}get sortedObjectIds(){if(this.viewFilter?.objectIds==null)return null;let e=Re(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){let e=this.viewFilter?.where;if(e==null||!e)return null;try{return be.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(t){N().error(`Failed to parse filter where clause: ${t}`)}return null}addFilters(e,t,r,s){let i=this.sortedObjectIds;i!=null&&e.push(a=>Te(i,!0,a)),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);let n=j(this._layerMaskGeometries),o=this._geometryEngine;if(n!=null&&this.layerFilter!=null&&o!=null){let a=this.layerFilter.spatialRelationship;e.push((u,m)=>Ne(o,u,m,s,t,r,n,a))}let l=j(this._viewMaskGeometries);if(l!=null&&this.viewFilter!=null&&o!=null){let a=this.viewFilter.spatialRelationship;e.push((u,m)=>Ne(o,u,m,s,t,r,l,a))}}isMBSGeometryVisible(e,t,r){let s=j(this._layerMaskGeometries),i=this._geometryEngine;if(s!=null&&this.layerFilter!=null&&i!=null){let o=this.layerFilter.spatialRelationship,l=s[0].spatialReference||t;return A(e,r,D,l)?Ge(i,D,s,l,o):(N().warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}let n=j(this._viewMaskGeometries);if(n!=null&&this.viewFilter!=null&&i!=null){let o=this.viewFilter.spatialRelationship,l=n[0].spatialReference||t;return A(e,r,D,l)?Ge(i,D,n,l,o):(N().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){let e=j(this._viewMaskGeometries),t=j(this._layerMaskGeometries);return e==null||t==null?e||t:t.concat(e)}get _layerMaskGeometries(){let e=this.layerFilter;return e==null?null:this._geometryEngine==null?te:e.spatialRelationship==="disjoint"?e.geometries.map(t=>({type:"polygon",rings:t.rings,spatialReference:t.spatialReference,cache:{}})):[e.geometries.reduce((t,r)=>(t.rings=[...t.rings,...r.rings],t),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(this.viewFilter==null)return null;let{geometry:e}=this.viewFilter;if(e==null)return null;if(this.viewFilter==null||this._geometryEngine==null)return te;let{distance:t,units:r}=this.viewFilter,s=this.viewFilter.spatialRelationship,i=e.type==="mesh"?e.extent:e;if(t==null||t===0)return q(this._geometryEngine,i,s);let n=r||me(i.spatialReference);if(i.spatialReference.isWGS84){let a=this._geometryEngine.geodesicBuffer(i,t,n);return q(this._geometryEngine,a,s)}let o=X(i,$.WGS84);if(o!=null){let a=X(this._geometryEngine.geodesicBuffer(o,t,n),i.spatialReference);return q(this._geometryEngine,a,s)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(xe().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;let l=null;try{l=Y(i,$.WGS84)}catch{}if(l)try{l=Y(this._geometryEngine.geodesicBuffer(l,t,n),i.spatialReference)}catch{l=null}return l||N().error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),q(this._geometryEngine,l,s)}get updating(){return re(this._layerMaskGeometries)||re(this._viewMaskGeometries)}static checkSupport(e){return e!=null&&(!!qe(e.spatialRelationship)||(N().warn(`Filters with spatialRelationship other than ${ke.join(", ")} are not supported for mesh scene layers`),!1))}};c([p()],f.prototype,"layerFilter",void 0),c([p({type:Me})],f.prototype,"viewFilter",void 0),c([p()],f.prototype,"layerFieldsIndex",void 0),c([p()],f.prototype,"loadAsyncModule",void 0),c([p()],f.prototype,"addSqlFilter",void 0),c([p()],f.prototype,"addTimeFilter",void 0),c([p({readOnly:!0})],f.prototype,"sortedObjectIds",null),c([p({readOnly:!0})],f.prototype,"parsedWhereClause",null),c([p({readOnly:!0})],f.prototype,"parsedGeometry",null),c([p({readOnly:!0})],f.prototype,"_layerMaskGeometries",null),c([p({readOnly:!0})],f.prototype,"_viewMaskGeometries",null),c([p()],f.prototype,"updating",null),c([p()],f.prototype,"_projectionEngineLoaded",void 0),c([p()],f.prototype,"_geometryEngine",void 0),f=c([C(De)],f);var ke=(e=>e)(["contains","intersects","disjoint"]);function qe(e){return e!=null&&ke.includes(e)}var y;function q(e,t,r){if(t==null)return null;if(r==="disjoint"&&t.type==="polygon"){let s=t.rings.length,i=t.spatialReference,n=new Array(s);for(let a=0;a<s;++a){let u=Se(1/0,1/0,-1/0,-1/0);we(u,t.rings[a]),n[a]={type:"polygon",rings:[t.rings[a]],spatialReference:i,cache:{},aabr:u}}n.sort((a,u)=>a.aabr[0]-u.aabr[0]);let o=new Set,l=new ne;for(let a=0;a<n.length;++a){let u=n[a],m=u.aabr[0];o.forEach(d=>{if(m>=d.aabr[2])return void o.delete(d);if(u.aabr[1]>d.aabr[3]||u.aabr[3]<d.aabr[1]||!e.intersects(u,d))return;u.rings=u.rings.concat(d.rings),Ee(u.aabr,d.aabr,u.aabr),u.cache={},o.delete(d);let g=se(n,d,n.length,l);n.splice(g,1)}),o.add(u)}for(let a of n)a.aabr=void 0;return n}return[t]}function Ge(e,t,r,s,i){if(t[3]>=.5*(t[2]+ye(s).radius))return!0;let n=Ve(e,t,s);return r.every(o=>Je(e,o,n,i)!==y.DISCARD)}function Ne(e,t,r,s,i,n,o,l){let a=o[0].spatialReference||i.spatialReference;if(!A(r.node.serviceMbsInIndexSR,n,D,a))return void N().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");let u=Ve(e,D,a),m=Ue(l,i,a,s,r.objectHandle);for(let d of o){if(t.length===0)return;switch(Je(e,d,u,l)){case y.DISCARD:return void(t.length=0);case y.KEEP:continue}Ce(t,r.featureIds,g=>ze(e,d,g,m))}}(function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"})(y||(y={}));var D=L(0,0,0,0);function Ue(e,t,r,s,i){let n=t.renderSpatialReference,o=new Map,l={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};l.rings[0][3]=l.rings[0][0];let a={indices:null,data:null,stride:0,startIndex:0,endIndex:0},u,m;switch(e){case"intersects":u=(d,g,b)=>d.intersects(g,b)?y.KEEP:y.TEST,m=ie;break;case"contains":u=(d,g,b)=>d.contains(g,b)?y.TEST:y.DISCARD,m=ie;break;default:u=(d,g,b)=>d.disjoint(g,b)?y.TEST:y.DISCARD,m=Pe}return{collection:s,object:i,type:e,maskSR:r,renderSR:n,aabbCache:o,triangle:l,positions:a,triangleTest:u,geometryTest:m}}function Ve(e,t,r){let s={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},i=!pe(r)&&!de(r),n=Number.isNaN(t[3])?0:he(t[3],0,2*ue.radius),o=i?e.buffer(s,n,1):e.geodesicBuffer(s,n,1);return o.type="polygon",o}function Je(e,t,r,s){switch(s){case"intersects":case"contains":return ie(e,t,r);case"disjoint":return Pe(e,t,r)}}function ie(e,t,r){return e.intersects(t,r)?e.contains(t,r)?y.KEEP:y.TEST:y.DISCARD}function Pe(e,t,r){return e.intersects(t,r)?e.contains(t,r)?y.DISCARD:y.TEST:y.KEEP}function ze(e,t,r,s){let{collection:i,object:n,renderSR:o,maskSR:l,geometryTest:a,aabbCache:u}=s,m=u.get(r);if(!m){let F=i.getObjectTransform(n);i.getComponentAabb(n,r,I);let S=[V(I[0],I[1],0),V(I[0],I[4],0),V(I[3],I[4],0),V(I[3],I[1],0)];for(let h=0;h<4;++h)P(S[h],S[h],F.rotationScale),J(S[h],S[h],F.position),W(S[h],o,S[h],l);m={type:"polygon",rings:[S],spatialReference:l,cache:{}},m.rings[0][4]=m.rings[0][0],u.set(r,m)}switch(a(e,t,m)){case y.DISCARD:return!1;case y.KEEP:return!0}let{triangle:d,triangleTest:g,positions:b}=s,_=d.rings[0][0],v=d.rings[0][1],x=d.rings[0][2],M=i.getObjectTransform(n);i.getComponentPositions(n,r,b);let{indices:U,data:w,stride:z,startIndex:Ke,endIndex:Le}=b;for(let F=Ke;F<Le;F+=3){let S=z*U[F],h=z*U[F+1],H=z*U[F+2];switch(K(_,w[S],w[S+1],w[S+2]),K(v,w[h],w[h+1],w[h+2]),K(x,w[H],w[H+1],w[H+2]),P(_,_,M.rotationScale),P(v,v,M.rotationScale),P(x,x,M.rotationScale),J(_,_,M.position),J(v,v,M.position),J(x,x,M.position),W(_,o,_,l),W(v,o,v,l),W(x,o,x,l),g(e,t,d)){case y.DISCARD:return!1;case y.KEEP:return!0}}return s.type!=="intersects"}var I=O();var He=je,R=class extends T{get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new Fe({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",()=>this.spatialIndex.events.emit("changed")))}destroy(){this._dataQueryEngineInstance=ae(this._dataQueryEngineInstance),this._set("layerView",null)}executeQueryForCount(e,t){return k(this,null,function*(){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)})}executeQueryForExtent(e,t){return k(this,null,function*(){let{count:r,extent:s}=yield this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:fe.fromJSON(s)}})}executeQueryForIds(e,t){return k(this,null,function*(){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)})}executeQuery(e,t){return k(this,null,function*(){let r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new Z("unsupported-query","returnGeometry is not supported when querying a mesh scene layer view, it is only supported when directly querying a scene layer");if(r.returnCentroid)throw new Z("unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");let s=yield this._dataQueryEngine.executeQuery(r,t),i=Qe.fromJSON(s);return i.features.forEach(n=>n.geometry=null),i})}_ensureQueryJSON(e){return e==null?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;let e=this.layer.objectIdField||Ae,t="esriGeometryPolygon",r=this.layer.fieldsIndex?.toJSON()||new ve([]),s=this.layerView.view.resourceController.scheduler,i=this.spatialReference.toJSON(),n=this.priority,o=this.spatialIndex;return this._dataQueryEngineInstance=new He({hasZ:!0,hasM:!1,geometryType:t,fieldsIndex:r,timeInfo:null,spatialReference:i,objectIdField:e,featureStore:o,scheduler:s,priority:n}),this._dataQueryEngineInstance}};c([p({constructOnly:!0})],R.prototype,"layerView",void 0),c([p({constructOnly:!0})],R.prototype,"priority",void 0),c([p({constructOnly:!0})],R.prototype,"spatialIndex",void 0),c([p()],R.prototype,"spatialReference",null),c([p()],R.prototype,"layer",null),c([p()],R.prototype,"defaultQueryJSON",null),R=c([C("esri.views.3d.layers.i3s.I3SQueryEngine")],R);var We=class{constructor(t){this._objectIdField=t.objectIdField,this._getFeatureExtent=t.getFeatureExtent}getObjectId(t){return t.id}getAttributes(t){let{meta:r,index:s}=t,i={};this._objectIdField&&(i[this._objectIdField]=t.id);let n=r.attributeInfo?.attributeData;if(n!=null)for(let o of Object.keys(n))i[o]=ee(n[o],s);return i}getAttribute(t,r){if(r===this._objectIdField)return t.id;let{meta:s,index:i}=t,n=s.attributeInfo?.attributeData;return n!=null?ee(n[r],i):null}getGeometry(t){if(t.geometry)return t.geometry;let[r,s,i,n,o]=this._getFeatureExtent(t,Be);return new B([5],[r,s,i,n,s,i,n,o,i,r,o,i,r,s,i])}getCentroid(t,r){if(t.geometry)return Oe(new B,t.geometry,r.hasZ,r.hasM);let[s,i,n,o,l,a]=this._getFeatureExtent(t,Be);return new B([0],[(s+o)/2,(i+l)/2,(n+a)/2])}cloneWithGeometry(t,r){let{id:s,index:i,meta:n}=t;return{id:s,index:i,meta:n,geometry:r}}},Be=O();var Ze=O(),Q=class extends T{constructor(e){super(e),this.events=new le}forEach(e){this.forAllFeatures(t=>(e(t),G.CONTINUE))}forEachBounds(e,t){let r=this.getFeatureExtent;for(let s of e)t(r(s,Ze))}forEachInBounds(e,t){this.forAllFeatures(r=>{let s=this.getFeatureExtent(r,$e);return Ie(e,_e(s,Xe))&&t(r),G.CONTINUE},r=>{if(A(r.node.serviceMbsInIndexSR,this.sourceSpatialReference,E,this.viewSpatialReference),E[0]>=e[0]&&E[2]<=e[2]&&E[1]>=e[1]&&E[3]<=e[3])return G.CONTINUE;let s=Math.max(e[0],Math.min(E[0],e[2])),i=Math.max(e[1],Math.min(E[1],e[3])),n=E[0]-s,o=E[1]-i;return n*n+o*o<=E[3]*E[3]?G.CONTINUE:G.SKIP})}};c([p({constructOnly:!0})],Q.prototype,"featureAdapter",void 0),c([p({constructOnly:!0})],Q.prototype,"forAllFeatures",void 0),c([p({constructOnly:!0})],Q.prototype,"getFeatureExtent",void 0),c([p({constructOnly:!0})],Q.prototype,"sourceSpatialReference",void 0),c([p({constructOnly:!0})],Q.prototype,"viewSpatialReference",void 0),Q=c([C("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],Q);var E=L(0,0,0,0),$e=O(),Xe=ge();export{f as a,R as b,We as c,Q as d};
