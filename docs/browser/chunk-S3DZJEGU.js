import{a as fe,c as ie,d as ce,f as w,g as xe}from"./chunk-ZBFN4RUB.js";import{a as de}from"./chunk-VDBWNYMF.js";import{b as pe}from"./chunk-3U6BMQLZ.js";import{a as ae}from"./chunk-TGSQQX44.js";import{a as se}from"./chunk-WPTVLDNN.js";import"./chunk-DRK6GLQ3.js";import{a as re,b as oe,d as ne}from"./chunk-BRKYWLZQ.js";import{o as te}from"./chunk-YNNF4FWO.js";import{a as Z,c as ee,d as $}from"./chunk-SUJDRDW4.js";import{a as me}from"./chunk-IXBI5R7J.js";import{a as le,c as ue}from"./chunk-GYJJE3EF.js";import"./chunk-25T3ULWN.js";import"./chunk-4OZVVJHM.js";import"./chunk-FOAEOOK3.js";import"./chunk-ILCAH2F6.js";import"./chunk-CYCLIMTY.js";import{a as F}from"./chunk-RRDM7P6F.js";import{a as J,c as X,e as _,h as Y}from"./chunk-LCTRO7CL.js";import"./chunk-7X2HMUNN.js";import{e as A}from"./chunk-LW2464MZ.js";import"./chunk-WJDHM47L.js";import"./chunk-LWJTIQQT.js";import"./chunk-IHBD2IWR.js";import{a as W,p as H}from"./chunk-NH3JQE75.js";import"./chunk-XXOIKNT6.js";import{a as R}from"./chunk-DBLGLVAQ.js";import"./chunk-EN6CTWVM.js";import"./chunk-IRJNWXGT.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-Y6H3NTW7.js";import{a as Q}from"./chunk-45SNVLPM.js";import{l as v}from"./chunk-BDF7KEUQ.js";import{b as U,c as S,d as C,k as q,o as M,p as E,s as k,t as K}from"./chunk-B4JAL745.js";import"./chunk-XTES2GPX.js";import"./chunk-2HUIJUS4.js";import"./chunk-P2YRCTWM.js";import"./chunk-5MNDZ6BX.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import{c as N}from"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{c as G}from"./chunk-PYQRTZNZ.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-3M7VXIQH.js";import{i as D,r as V}from"./chunk-5PTS4JDF.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import{k as z}from"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import"./chunk-GGZQ5GCM.js";import{u as b}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import"./chunk-BMVJCP2M.js";import"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{t as L}from"./chunk-3IBUFXWY.js";import"./chunk-BP73DJTS.js";import{a as P,b as j,g as B}from"./chunk-JEGVIFEP.js";function Te(e,t,r){let i=e.typedBuffer,n=e.typedBufferStride,s=t.typedBuffer,u=t.typedBufferStride,f=r?r.count:t.count,a=(r?.dstIndex??0)*n,m=(r?.srcIndex??0)*u;for(let l=0;l<f;++l){for(let o=0;o<9;++o)i[a+o]=s[m+o];a+=n,m+=u}}var ye=Object.freeze(Object.defineProperty({__proto__:null,copy:Te},Symbol.toStringTag,{value:"Module"}));function ve(e,t,r){let i=e.typedBuffer,n=e.typedBufferStride,s=t.typedBuffer,u=t.typedBufferStride,f=r?r.count:t.count,a=(r?.dstIndex??0)*n,m=(r?.srcIndex??0)*u;for(let l=0;l<f;++l){for(let o=0;o<16;++o)i[a+o]=s[m+o];a+=n,m+=u}}var we=Object.freeze(Object.defineProperty({__proto__:null,copy:ve},Symbol.toStringTag,{value:"Module"}));function x(e,t){return new e(new ArrayBuffer(t*e.ElementCount*Q(e.ElementType)))}function Bt(e,t,r){return B(this,null,function*(){let i=new me(Be(r)),n=(yield de(i,t,r,!0)).model,s=n.lods.shift(),u=new Map,f=new Map;n.textures.forEach((T,h)=>u.set(h,Se(T))),n.materials.forEach((T,h)=>f.set(h,Ce(T,u)));let a=Ve(s);for(let T of a.parts)Me(a,T,f);let{position:m,normal:l,tangent:o,color:c,texCoord0:p}=a.vertexAttributes,d=A(e,r),O=e.spatialReference.isGeographic?A(e):d,I=te({vertexAttributes:{position:m.typedBuffer,normal:l?.typedBuffer,tangent:o?.typedBuffer},vertexSpace:O,spatialReference:e.spatialReference},d,{allowBufferReuse:!0,sourceUnit:r?.unitConversionDisabled?void 0:"meters"});if(!I)throw new L("load-gltf-mesh:vertex-space-projection",`Failed to load mesh from glTF because we could not convert the vertex space from ${O.type} to ${d.type}`);return{transform:null,vertexSpace:d,components:a.components,spatialReference:e.spatialReference,vertexAttributes:new se(j(P({},I),{color:c?.typedBuffer,uv:p?.typedBuffer}))}})}function Be(e){let t=e?.resolveFile;return t?{busy:!1,request:(r,i,n)=>B(this,null,function*(){let s=t?.(r)??r;return(yield z(s,{responseType:i==="image"?"image":i==="binary"||i==="image+type"?"array-buffer":"json",signal:n?.signal,timeout:0})).data})}:null}function y(e,t){if(e==null)return"-";let r=e.typedBuffer;return`${b(t,r.buffer,()=>t.size)}/${r.byteOffset}/${r.byteLength}`}function be(e){return e!=null?e.toString():"-"}function Ve(e){let t=0,r={color:!1,tangent:!1,normal:!1,texCoord0:!1},i=new Map,n=new Map,s=[];for(let u of e.parts){let{attributes:{position:f,normal:a,color:m,tangent:l,texCoord0:o}}=u,c=`
      ${y(f,i)}/
      ${y(a,i)}/
      ${y(m,i)}/
      ${y(l,i)}/
      ${y(o,i)}/
      ${be(u.transform)}
    `,p=!1,d=b(n,c,()=>(p=!0,{start:t,length:f.count}));p&&(t+=f.count),a&&(r.normal=!0),m&&(r.color=!0),l&&(r.tangent=!0),o&&(r.texCoord0=!0),s.push({gltf:u,writeVertices:p,region:d})}return{vertexAttributes:{position:x(q,t),normal:r.normal?x(S,t):null,tangent:r.tangent?x(C,t):null,color:r.color?x(E,t):null,texCoord0:r.texCoord0?x(U,t):null},parts:s,components:[]}}function Se(e){return new re({data:(pe(e.data),e.data),wrap:Ae(e.parameters.wrap)})}function Ce(e,t){let r=new F(_e(e.color,e.opacity)),i=e.emissiveFactor?new F($e(e.emissiveFactor)):null,n=s=>s?new oe({scale:s.scale?[s.scale[0],s.scale[1]]:[1,1],rotation:D(s.rotation??0),offset:s.offset?[s.offset[0],s.offset[1]]:[0,0]}):null;return new ne({color:r,colorTexture:t.get(e.textureColor),normalTexture:t.get(e.textureNormal),emissiveColor:i,emissiveTexture:t.get(e.textureEmissive),occlusionTexture:t.get(e.textureOcclusion),alphaMode:Re(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.get(e.textureMetallicRoughness),colorTextureTransform:n(e.colorTextureTransform),normalTextureTransform:n(e.normalTextureTransform),occlusionTextureTransform:n(e.occlusionTextureTransform),emissiveTextureTransform:n(e.emissiveTextureTransform),metallicRoughnessTextureTransform:n(e.metallicRoughnessTextureTransform)})}function Me(e,t,r){t.writeVertices&&Ee(e,t);let{indices:i,attributes:n,primitiveType:s,material:u}=t.gltf,f=xe(i||n.position.count,s),a=t.region.start;if(a){let m=new Uint32Array(f);for(let l=0;l<f.length;l++)m[l]+=a;f=m}e.components.push(new ae({name:t.gltf.name,faces:f,material:r.get(u),shading:n.normal?"source":"flat",trustSourceNormals:!0}))}function Ee(e,t){let{position:r,normal:i,tangent:n,color:s,texCoord0:u}=e.vertexAttributes,f=t.region.start,{attributes:a,transform:m}=t.gltf,l=a.position.count;if(J(r.slice(f,l),a.position,m),a.normal!=null&&i!=null){let o=H(R(),m),c=i.slice(f,l);X(c,a.normal,o),V(o)&&Y(c,c)}else i!=null&&ue(i,0,0,1,{dstIndex:f,count:l});if(a.tangent!=null&&n!=null){let o=W(R(),m),c=n.slice(f,l);Z(c,a.tangent,o),V(o)&&ee(c,c)}else n!=null&&w(n,0,0,1,1,{dstIndex:f,count:l});if(a.texCoord0!=null&&u!=null?fe(u.slice(f,l),a.texCoord0):u!=null&&ie(u,0,0,{dstIndex:f,count:l}),a.color!=null&&s!=null){let o=a.color,c=s.slice(f,l);if(o.elementCount===4)o instanceof C?$(c,o,255):o instanceof E?ce(c,o):o instanceof K&&$(c,o,1/256);else{w(c,255,255,255,255);let p=M.fromTypedArray(c.typedBuffer,c.typedBufferStride);o instanceof S?_(p,o,255):o instanceof M?le(p,o):o instanceof k&&_(p,o,1/256)}}else s!=null&&w(s.slice(f,l),255,255,255,255)}function Re(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Ae(e){return{horizontal:ge(e.s),vertical:ge(e.t)}}function ge(e){switch(e){case v.CLAMP_TO_EDGE:return"clamp";case v.MIRRORED_REPEAT:return"mirror";case v.REPEAT:return"repeat"}}function g(e){return e**(1/2.1)*255}function _e(e,t){return N(g(e[0]),g(e[1]),g(e[2]),t)}function $e(e){return G(g(e[0]),g(e[1]),g(e[2]))}export{Bt as loadGLTFMesh};
