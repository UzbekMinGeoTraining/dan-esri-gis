import{a as ee,b as te,c as re}from"./chunk-UHCAZ4FA.js";import{a as Z}from"./chunk-2K35ZAGK.js";import{a as J}from"./chunk-NOFXYDQS.js";import{c as B,g as K,h as H,r as Q}from"./chunk-FW33MEBA.js";import{d as D}from"./chunk-VDNXTMSC.js";import{a as V,d as R,h as $}from"./chunk-MBJHSEMD.js";import{e as j,h as W,n as X,s as Y}from"./chunk-7D4IYTAJ.js";import{d as G}from"./chunk-HRP5LYWJ.js";import{Q as m,S as M}from"./chunk-GGZQ5GCM.js";import{U as _}from"./chunk-TFUPB3ZG.js";import{a as f}from"./chunk-BMVJCP2M.js";import{D as z,o as S,p as T}from"./chunk-GMC3I5VG.js";import{e as k}from"./chunk-WGF2T2BG.js";import{b as P,r as w}from"./chunk-3IBUFXWY.js";import{u as C}from"./chunk-BP73DJTS.js";import{g as b}from"./chunk-JEGVIFEP.js";var se={setAttribute(){},rollback(){},commit(){}},x;function be(e,t){let r=t.attributes[e.objectIdField];if(r==null)return se;let i=e.sessions.get(r);if(i)return i;let o=P(t.attributes),n=new Set,a=e.i3sOverrides.createInteractiveEditSession(r),s=new Map,p=(c,d)=>{let g=s.get(c);if(g==null){let y=d.indexOf(r);return s.set(c,y),y}return g},l=x.EDITING,u={setAttribute(c,d){if(l!==x.EDITING)return;let g=e.fieldsIndex.get(c);if(!g)return;let y=e.attributeStorageInfo.findIndex(F=>F.name===g.name);if(y<0)return;if(!(c in o))throw new Error(`Attribute "${c}" is not an attribute of the edited feature.`);a.setAttribute(y,d);let I=e.attributeStorageInfo[y],A=!1;n.add(c),e.forEachNode((F,v)=>{let L=p(F,v);if(L===-1)return;let O=e.getAttributeData(F.index);if(O){let N=O[I.name];N&&(N[L]=d,e.setAttributeData(F.index,O,t),A=!0)}}),A&&e.clearMemCache()},rollback(){if(l===x.EDITING){for(let c of n)this.setAttribute(c,o[c]);a.remove(),l=x.ROLLED_BACK,e.sessions.delete(r)}},commit(){l===x.EDITING&&(a.remove(),l=x.COMMITTED,e.sessions.delete(r))}};return e.sessions.set(r,u),u}function le(e,t,r){let{gidToFeatureInfo:i,oidToFeatureInfo:o,fieldsIndex:n,objectIdField:a,globalIdField:s,featureOrIdentifierList:p}=r;if(!r.featuresResolved&&p!=null){for(let l of p){let u={feature:null,oid:-1,gid:null};if("attributes"in l){u.feature=l;let c=l.attributes;if(c!=null)for(let d in c){if(u.oid!==-1&&u.gid!=null)break;let g=n.normalizeFieldName(d);g===a&&(u.oid=c[d]??-1),g===s&&(u.gid=c[d])}}else u.oid=l.objectId??-1,u.gid=l.globalId;u.gid!=null&&i.set(u.gid,u),u.oid!==-1&&o.set(u.oid,u)}r.featuresResolved=!0}return(e!==-1?o.get(e):null)??(t!=null?i.get(t):null)}function U(e,t,r,i,o=null,n=!0){let a=[],s={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:r==null,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:r};for(let p of t){if(p.error!=null)continue;let l=p.objectId??-1,u=p.globalId,c=(l===-1||n?le(l,u,s):null)??{feature:null,oid:l,gid:u},d={oid:l===-1?c.oid:l,gid:u??c.gid,feature:c.feature,result:p};a.push(d);let g=d.gid?D(d.gid):null;if(d.oid===-1&&g!=null&&o!=null&&(d.oid=o.get(g)??-1),d.oid===-1&&g!=null){let y=i.get(g);y==null&&(y={gid:d.gid,edits:[]},i.set(g,y)),y.edits.push(d)}}return a}function Fe(e,t){return b(this,null,function*(){let r=new Map,i=U(e,t.addedFeatures,t.edits?.addFeatures,r),o=U(e,t.updatedFeatures,t.edits?.updateFeatures,r),n=U(e,t.deletedFeatures,t.edits?.deleteFeatures,r,t.globalIdToObjectId,!1);return r.size>0&&(yield ae(e,r)),{adds:i.filter(a=>a.oid!==-1),updates:o.filter(a=>a.oid!==-1),deletes:n.filter(a=>a.oid!==-1)}})}function ae(e,t){return b(this,null,function*(){let r=e.i3sOverrides.layer.associatedLayer;if(r?.globalIdField==null)return;let i=r.createQuery(),{objectIdField:o,globalIdField:n}=r;i.where=Array.from(t.values()).map(({gid:p})=>`${n}='${p}'`).join(" OR "),i.returnGeometry=!1,i.outFields=[o,n],i.cacheHint=!1;let a=yield G(J(r,i));if(!a.ok)return;let s=a.value.features;for(let p of s){let l=p.attributes[n],u=p.attributes[o];if(l==null||u==null||u===-1)continue;let c=t.get(D(l));if(c!=null)for(let d of c.edits)d.oid=u}})}function Ie(e,t){let r=new Map,i=o=>{for(let{oid:n,feature:a}of o){let s=a?.geometry;s?.type==="mesh"&&r.set(n,s)}};i(t.adds),i(t.updates);for(let o of t.deletes)r.set(o.oid,null);for(let[o,n]of r)e.i3sOverrides.updateGeometry(o,n)}function we(e,t){let r=ue(e,t),i=de(e,t);if(r.size===0&&i.size===0)return;let o=new Map;for(let d=0;d<e.attributeStorageInfo.length;d++)o.set(e.attributeStorageInfo[d].name,d);let n=!1;r.forEach((d,g)=>{let y=e.getAttributeData(g),I=!1;d.forEach((A,F)=>{let v=y!=null?y[F]:null,L=o.get(F);for(let{featureIndex:O,value:N,featureId:ne}of A)v&&(v[O]=N,I=!0,n=!0),e.i3sOverrides.updateAttributeValue(ne,L,N)}),I&&e.setAttributeData(g,y,null)}),n&&e.clearMemCache();let{fieldsIndex:a,i3sOverrides:s,objectIdField:p,globalIdField:l}=e,u=s.layer.associatedLayer?.infoFor3D,c=new Set(u?[...Object.values(u.assetMapFieldRoles),...Object.values(u.transformFieldRoles)]:[]);for(let[d,g]of i){s.featureAdded(d);let{attributes:y}=g;for(let I in y){if(I!==p&&I!==l&&c.has(I))continue;let A=a.normalizeFieldName(I),F=A!=null?o.get(A):null;if(F==null)continue;let v=y[I];s.updateAttributeValue(d,F,v)}}}function de(e,t){let r=new Map,i=t.adds;if(!i||i.length===0||e.globalIdField==null)return r;for(let o of i){let n=o.oid,a=o.feature;a?.geometry?.type==="mesh"&&r.set(n,a)}return r}function ue(e,t){let r=t.updates;if(!r||r.length===0)return new ie;let i=new ie,o=new Map;for(let n=0;n<e.attributeStorageInfo.length;n++)o.set(e.attributeStorageInfo[n].name,n);return e.forEachNode((n,a)=>{for(let s of r){if(s.feature==null)continue;let p=s.feature,l=s.oid,u=a.indexOf(l);for(let c in p.attributes){let d=e.fieldsIndex.normalizeFieldName(c),g=ce(i,n.index,d),y=p.attributes[c];g.push({featureIndex:u,featureId:l,value:y})}}}),i}function ce(e,t,r){let i=fe(e,t),o=r!=null&&i.get(r);if(o)return o;let n=new Array;return i.set(r,n),n}function fe(e,t){let r=e.get(t);if(r)return r;let i=new pe;return e.set(t,i),i}(function(e){e[e.EDITING=0]="EDITING",e[e.ROLLED_BACK=1]="ROLLED_BACK",e[e.COMMITTED=2]="COMMITTED"})(x||(x={}));var pe=Map,ie=Map;function _e(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){let{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return e.outFields?j(t,[...W(t,e.outFields),...r]):j(t,r)}}}}var q=e=>{let t=class extends e{constructor(){super(...arguments),this._numUpdating=0}get updating(){return this._numUpdating>0}autoUpdateAsync(r,i){let o=z(n=>b(this,null,function*(){++this._numUpdating;try{let a=yield n;this.destroyed||this._set(r,a)}catch{w.getLogger(this).warn(`Async update of "${String(r)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating}));return V(i,o,$)}};return f([m({readOnly:!0})],t.prototype,"updating",null),f([m()],t.prototype,"_numUpdating",void 0),t=f([_("esri.core.AsyncUpdate")],t),t},oe=class extends q(M){};oe=f([_("esri.core.AsyncUpdate")],oe);var E=class extends q(M){get layer(){return this.layerView.layer}get requiredFields(){let{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:r,labelingFields:i,viewFilterFields:o}=this;return j(e,[...t??[],...r??[],...i??[],...o??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",()=>b(this,null,function*(){let{fieldsIndex:e,renderer:t}=this.layer;return t?this._getFieldsAsync(r=>t.collectRequiredFields(r,e)):null})),this.autoUpdateAsync("labelingFields",()=>b(this,null,function*(){let{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(t=>Y(t,e)):null})),this.autoUpdateAsync("viewFilterFields",()=>{let{layer:e,mergedFilter:t}=this.layerView;return this._getFieldsAsync(r=>X(r,e,t))})])}_getFieldsAsync(e){return b(this,null,function*(){let t=new Set;try{return yield e(t),Array.from(t).sort()}catch(r){return w.getLogger(this).error(r),null}})}};f([m()],E.prototype,"layerView",void 0),f([m()],E.prototype,"layer",null),f([m()],E.prototype,"requiredFields",null),f([m()],E.prototype,"rendererFields",void 0),f([m()],E.prototype,"labelingFields",void 0),f([m()],E.prototype,"viewFilterFields",void 0),E=f([_("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],E);var h=class extends Z{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return te(this._layerFilter)}get _layerFilter(){let e=this.layer?.filter;if(e==null||e.geometries.length<1)return null;let t=this._geometryEngine;if(t==null||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return ee;let r=e.geometries.at(0).spatialReference,i=e.geometries.toArray().map(s=>{try{s=t.simplify(s)}catch{return w.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(s==null)return null;if(s.spatialReference.equals(r))return s;try{return H(s,r)}catch{return w.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(C).sort((s,p)=>s.extent.xmin-p.extent.xmin),o=new Set,n=new Array,a=new Array;for(let s of i){let p=s.extent.xmin;if(n.length=0,o.forEach(l=>{if(p>=l.extent.xmax)return a.push(l),void o.delete(l);s.extent.ymin<=l.extent.ymax&&s.extent.ymax>=l.extent.ymin&&t.intersects(s,l)&&n.push(l)}),n.length>0){n.push(s);try{s=t.union(n)}catch{w.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}n.pop(),n.forEach(l=>o.delete(l))}o.add(s)}return o.forEach(s=>a.push(s)),a.length>0?{spatialRelationship:e.spatialRelationship,geometries:a}:null}get _filterNeedsProjectionEngine(){let e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;let t=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:r})=>!r.equals(t)&&!Q(r,t))}get layerFilterUpdating(){return re(this._layerFilter)}initialize(){let{signal:e}=this._abortController;R(()=>this.destroyed||!this._geometryEngine&&this.layer?.filter?.geometries?.length,e).then(()=>b(this,null,function*(){S(e),this._geometryEngine=yield import("./chunk-RCUZLKRT.js")})).catch(T),this._projectionEngineLoaded=B(),R(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(()=>b(this,null,function*(){S(e),yield K(),this._projectionEngineLoaded=!0})).catch(T)}destroy(){this._abortController=k(this._abortController)}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}};f([m()],h.prototype,"layer",void 0),f([m()],h.prototype,"availableFields",null),f([m()],h.prototype,"maximumNumberOfFeatures",null),f([m({readOnly:!0})],h.prototype,"maximumNumberOfFeaturesExceeded",null),f([m()],h.prototype,"filter",void 0),f([m({readOnly:!0})],h.prototype,"layerFilter",null),f([m({readOnly:!0})],h.prototype,"_layerFilter",null),f([m()],h.prototype,"_geometryEngine",void 0),f([m()],h.prototype,"_projectionEngineLoaded",void 0),f([m()],h.prototype,"_filterNeedsProjectionEngine",null),f([m()],h.prototype,"layerFilterUpdating",null),h=f([_("esri.views.layers.SceneLayerView")],h);var at=h;export{be as a,Fe as b,Ie as c,we as d,_e as e,E as f,at as g};
