import{a as pt,b as gt,c as bt,d as vt}from"./chunk-T2AXATG3.js";import{b as ft}from"./chunk-CDG4VMUI.js";import{a as dt}from"./chunk-QN72YLVS.js";import{a as lt}from"./chunk-2K35ZAGK.js";import{a as u,b as M,c as z,d as I,e as $,f as E,g as P,h as F,i as he,k as Ze,l as et}from"./chunk-XGB5KN4W.js";import{a as ct,b as mt,c as fe,f as Tt}from"./chunk-PVWWD2I2.js";import"./chunk-PX7LT6IQ.js";import"./chunk-ZQL3TKF7.js";import{a as wt,b as _t}from"./chunk-U4ERJPQO.js";import{b as yt}from"./chunk-ZRDZCHT6.js";import"./chunk-RHS3EARZ.js";import"./chunk-W4FJ4A5Q.js";import"./chunk-EDY6B353.js";import"./chunk-KS6SWJU3.js";import"./chunk-JHBR5RZV.js";import"./chunk-6J446DPN.js";import"./chunk-E3LKQDEM.js";import{a as ht}from"./chunk-AR3SF3CU.js";import{c as ut}from"./chunk-DQVRRO4N.js";import"./chunk-DYNH5H2C.js";import"./chunk-WP7QHDBV.js";import{e as nt}from"./chunk-GLY75KSJ.js";import{u as pe}from"./chunk-3KFX3FFC.js";import{c as st}from"./chunk-6ISQQD7M.js";import{a as tt,b as rt}from"./chunk-N3AGC3JB.js";import"./chunk-IGNHVSQC.js";import{a as at,q as ot}from"./chunk-WUAC4CFP.js";import"./chunk-ONDKJR4V.js";import"./chunk-QB4KDO4M.js";import{b as it}from"./chunk-KDLA3TQ2.js";import"./chunk-RPMDOAYZ.js";import"./chunk-J7UK2QPE.js";import"./chunk-3PK63SMD.js";import"./chunk-7OTZECLS.js";import"./chunk-XBFBZZXW.js";import"./chunk-K5V3S3K3.js";import"./chunk-HCCGI45Q.js";import"./chunk-Q6D44QVW.js";import"./chunk-C3EWQ5V5.js";import"./chunk-3UBXEUOT.js";import"./chunk-6WV5YJL7.js";import"./chunk-3AMG6HG6.js";import"./chunk-I6ETUG5Q.js";import"./chunk-4MZSW4Z6.js";import"./chunk-BERIM72F.js";import"./chunk-YOBNM4T6.js";import"./chunk-MEBZWNWT.js";import"./chunk-XZ52TEBV.js";import"./chunk-WAPQB6I3.js";import"./chunk-L3GHXHDP.js";import"./chunk-N6PITG7Q.js";import"./chunk-S3ASAZCA.js";import"./chunk-ZUUCQTSR.js";import"./chunk-GKUBZAEG.js";import{a as ue}from"./chunk-UW734WOQ.js";import"./chunk-BIZV3H6H.js";import"./chunk-ATV5GTE5.js";import"./chunk-TCQTMUK4.js";import"./chunk-AY3YVZUY.js";import"./chunk-ZG3FCPXY.js";import"./chunk-RIUAG34V.js";import"./chunk-G5SIQY64.js";import"./chunk-WW7S4V24.js";import"./chunk-UGAMS6PU.js";import"./chunk-EHDNZUTT.js";import"./chunk-NH7OOX2I.js";import"./chunk-B72PB7U4.js";import"./chunk-K55ZDM2S.js";import"./chunk-UHYNS4LH.js";import"./chunk-Z3USGHSR.js";import"./chunk-SLEIRDN7.js";import"./chunk-W3OGU5I2.js";import"./chunk-OO4IIGVK.js";import"./chunk-KQHYII76.js";import"./chunk-6I6DPRXI.js";import"./chunk-RNN6GAXL.js";import"./chunk-4IVMQ5PX.js";import"./chunk-CQUOQXLP.js";import"./chunk-3ZOLHUAU.js";import{a as Qe}from"./chunk-O6YJVL7E.js";import"./chunk-BNUQT6PD.js";import{d as Ke}from"./chunk-5DAF2FXI.js";import{a as Ye}from"./chunk-M2F4B74F.js";import"./chunk-2WNCPIJC.js";import"./chunk-GDB2EJGA.js";import"./chunk-RDGFIF46.js";import"./chunk-C2ONI6UP.js";import"./chunk-H6LJ2DCJ.js";import"./chunk-IMNO5TXZ.js";import"./chunk-LCDA6FHZ.js";import"./chunk-RZPELDHM.js";import"./chunk-S3J33BKD.js";import"./chunk-NPIYHDQ7.js";import"./chunk-BL63T6AU.js";import"./chunk-AOTWUAUY.js";import"./chunk-VI4TDFI5.js";import"./chunk-GXSLPADW.js";import"./chunk-2HN33SWB.js";import"./chunk-523X5JOP.js";import"./chunk-BXR2KKYP.js";import"./chunk-7ISKCG7U.js";import"./chunk-OFGHVREP.js";import"./chunk-U3ETEC6R.js";import{a as ze}from"./chunk-YJ3RZNO6.js";import"./chunk-OC7V2CEX.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-R7P6RQXJ.js";import{a as Je,b as Xe}from"./chunk-4I7LQWUX.js";import{b as S}from"./chunk-JLNQ6WQT.js";import{a as qe}from"./chunk-GB5RQL32.js";import{a as x,g as U,h as de}from"./chunk-4OZVVJHM.js";import"./chunk-IZRBPB5G.js";import"./chunk-X7XJWAFC.js";import"./chunk-ILCAH2F6.js";import{c as $e}from"./chunk-CYCLIMTY.js";import{a as We}from"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-7X2HMUNN.js";import"./chunk-LWJTIQQT.js";import{b as Ne}from"./chunk-IHBD2IWR.js";import{a as ke,e as Ge}from"./chunk-NH3JQE75.js";import{a as me}from"./chunk-XXOIKNT6.js";import{a as ce,d as W}from"./chunk-DBLGLVAQ.js";import"./chunk-HVNRUZWJ.js";import"./chunk-AYOI2Y26.js";import"./chunk-3IK5VXZ3.js";import"./chunk-MBVOWLUI.js";import"./chunk-EN6CTWVM.js";import"./chunk-IRJNWXGT.js";import"./chunk-6GGK7PRJ.js";import"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import{c as je}from"./chunk-7KH77MT4.js";import"./chunk-I6LCIPDY.js";import"./chunk-J6ZRC6RI.js";import"./chunk-EBGO44EK.js";import{a as L}from"./chunk-7W6RATG7.js";import"./chunk-45SNVLPM.js";import{b as le,l as v}from"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import{C as He,b as De,c as N,d as Le,o as Se,p as Fe,q as oe,s as Re,t as Be,u as ne}from"./chunk-B4JAL745.js";import"./chunk-XTES2GPX.js";import{d as Ie,z as Ae}from"./chunk-2HUIJUS4.js";import{a as ae,h as xe}from"./chunk-MBJHSEMD.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import{h as Oe,t as Ve}from"./chunk-5MNDZ6BX.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import{c as Ue}from"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{a as G,e as Ee}from"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import{F as Pe}from"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as D,u as Me}from"./chunk-GGZQ5GCM.js";import{U as Ce}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as V}from"./chunk-BMVJCP2M.js";import"./chunk-GMC3I5VG.js";import{b as ie}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{r as se,t as k}from"./chunk-3IBUFXWY.js";import{a as re}from"./chunk-BP73DJTS.js";import{g as Te}from"./chunk-JEGVIFEP.js";var q=class extends ht{constructor(e,h,i,o,n,m,l){super(e,0,0,0,h),this.nodesCached=i,this.vboMB=o,this.textureMB=n,this.vboMBCached=m,this.textureMBCached=l}};var Mt={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:le.TRIANGLES,[E.TriangleStrip]:le.TRIANGLE_STRIP,[E.NotSet]:null},ye={[$.Opaque]:U.Opaque,[$.Mask]:U.Mask,[$.Blend]:U.Blend},Ct={[F.Back]:x.Back,[F.Front]:x.Front,[F.None]:x.None,[F.NotSet]:x.Back},xt={[P.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[P.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[P.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[P.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[P.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},Pt={[u.U8]:1,[u.I8]:1,[u.U16]:2,[u.I16]:2,[u.U32]:4,[u.I32]:4,[u.F32]:4,[u.F64]:8,[u.Utf8String]:1,[u.NotSet]:1};var J=class{constructor(e){this.layerUid=[],this.type=tt.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,h,i,o,n,m){let l=e.results,w=e.options.store===rt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;let f=this.layerView.view._stage.renderView.componentObjectCollection,p=new at(m??!1,e.options.normalRequired);this.layerView.objects.forEach(a=>{a.visible&&a.intersectionGeometry&&f.intersect(a,i,o,e.tolerance,null,p,(c,r,g,d)=>{if(r>=0){if(h!=null&&!h(i,o,r))return;let C=b=>{let _=new nt(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));b.set(this.type,_,r,g)};if(this.isGround&&(l.ground.dist==null||r<l.ground.dist)&&C(l.ground),e.options.isFiltered)return;if((l.min.dist==null||r<l.min.dist)&&C(l.min),(l.max.dist==null||r>l.max.dist)&&C(l.max),w){let b=st(e.ray);C(b),e.results.all.push(b)}}})})}_createTiles3DGraphic(e,h){return new We({layer:e,sourceLayer:e,attributes:h})}};var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));var ge=class{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}};function X(t){return Math.round(t/1048.576)/1e3}var O=class extends dt(lt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=ut.WithoutRasterImage,this._applySSAO=!re("disable-feature:im-ssao"),this._shadeNormals=!!re("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new k("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});let t=ct(this).then(e=>{this._intersectionHandler=new J(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,i=>this._slicePlaneEnabledChange(i)),this._elevationProvider=new gt({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;let h=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,i=>this._onRemoveFromCache(i));this._memCache=h,this.addHandles([ae(()=>this.layer.elevationInfo,i=>this._elevationInfoChanged(i))]),this._suspendedHandle=ae(()=>this.suspended,i=>this._wasm?.setEnabled(this,!i),xe)}).catch(e=>{if(fe(this),this._wasmLayerId=-1,e===Ze)throw new k("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===et)throw new k("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),fe(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ie(this._memCache),this._updatingHandles=ie(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=Me(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{let h=this._collection.getMaterial(e);h.commonMaterialParameters.hasSlicePlane=t,h.commonMaterialParameters.cullFace=t?x.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){this._wasm?.setLayerOffset(this,pe(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return mt(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get visibleAtCurrentScale(){return Ke(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,h=0,i=0,o=0,n=0;return this._lyrHandleToObjects.forEach(m=>{m.isVisible?(t+=m.texMemoryUsage,e+=m.vboMemoryUsage,o++):(h+=m.texMemoryUsage,i+=m.vboMemoryUsage,n++)}),new q(this.usedMemory,o,n,X(e),X(t),X(i),X(h))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===qe.Local){let t=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(t!==3857&&t!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return pe(this.layer.elevationInfo)}get elevationRange(){let t=this.fullExtent;return t?.zmin&&t?.zmax?new Qe(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){let t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}createRenderable(t){return Te(this,null,function*(){let e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");let h=Ee(e.desc.origin),i=new Array,o=new Map,n=new ge;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);let m=this.view.basemapTerrain.spatialReference,l,w;if(this.view.viewingMode==="global"){let r=me();Ne(Pe,h,r,m),l=ke(ce(),r),w=Ge(ce(),l)}else l=W,w=W;let f=me();Oe(f,f,h);let p=Ve(G(),f),a=null,c=G();if(e.desc.obb){let r=e.desc.obb.quaternion;a=new Je(e.desc.obb.center,e.desc.obb.halfSize,$e(r[0],r[1],r[2],r[3]))}for(let r=0;r<e.desc.prims.length;r++){let g=e.desc.prims[r];if(this._dbg(y.VerboseAPI,JSON.stringify(g)),Mt[g.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}let d=e.desc?.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,C=d!=null?d.lightingModel:he.Unlit,{positionView:b,positionAttr:_,normalsView:Y,normalsAttr:K,colorAttr:R,texCoord0Attr:B,indicesView:A}=this.getBufferViews(g,e.data.buffer,l);if(_==null||b==null||A==null)continue;let be=new wt(R!=null,B!=null?ue.Default:ue.None,Y!=null,this._shadeNormals,this._applySSAO),Et=_.data.length/_.size,Q=(s,T)=>!s||s.data.length/s.size===Et||(this._dbg(y.Error,`${T} !== numPos. Skipping primitive.`),!1);if(!Q(B,"numTexcoord")||!Q(R,"numColors")||!Q(K,"normals"))continue;let we=_t(be);if(a!=null?a=a.clone():(a=Xe(_),Ie(c,a.center,h),a.center=c),l!==W)for(let s=0;s<b.count;s++)b.getVec(s,c),Ae(c,c,l),b.setVec(s,c);let Z=we.createBuffer(_.data.length),H=new Map([[L.POSITION,_]]);B!=null&&H.set(L.UV0,B),R!=null&&H.set(L.COLOR,R),K!=null&&H.set(L.NORMALCOMPRESSED,K),H.forEach((s,T)=>{s!=null&&ot(T,s,null,null,Z,0)});let Ot=new Uint32Array([0,A.typedBuffer.length]),Vt={vertices:{data:Z.buffer,count:Z.byteLength/we.stride,layoutParameters:be},positionData:{positions:b.typedBuffer,indices:A.typedBuffer},indices:A.typedBuffer,componentOffsets:Ot};n.cpuMemoryUsage+=b.count,n.cpuMemoryUsage+=A.count;let _e=this.view.renderSpatialReference,ee=G(),te=[1,1,1];pt(p,_e,te,m)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),Ye(p,_e,ee,m);let j=this._collection.createObject(new bt(Ue(ee[0],ee[1],te[0],te[1]),new vt(p,w),a,Vt));d&&this._collection.updateMaterial(j,s=>{s.baseColor=d.baseColorFactor,s.usePBR=C===he.Pbr,s.hasParametersFromSource=!1,s.baseColorTexture=this._getTexture(d.baseColorTex,e,o),s.usePBR&&(s.mrrFactors=[d.metallicFactor,d.roughnessFactor,0],s.emissiveFactor=d.emissiveFactor??[0,0,0],s.metallicRoughnessTexture=this._getTexture(d.metalTex,e,o),s.emissionTexture=this._getTexture(d.emissiveTex,e,o),s.occlusionTexture=this._getTexture(d.occlusionTex,e,o),s.normalTexture=this._getTexture(d.normalTex,e,o)),s.objectOpacity=0,s.alphaDiscardMode=U.Mask;let T=[];s.baseColorTexture&&T.push(s.baseColorTexture.loadPromise),s.usePBR&&s.metallicRoughnessTexture&&T.push(s.metallicRoughnessTexture.loadPromise),s.usePBR&&s.emissionTexture&&T.push(s.emissionTexture.loadPromise),s.usePBR&&s.occlusionTexture&&T.push(s.occlusionTexture.loadPromise),s.usePBR&&s.normalTexture&&T.push(s.normalTexture.loadPromise);let ve=Promise.all(T);i.push(ve),ve.then(()=>{s.alphaDiscardMode=ye[d.alphaMode],s.objectOpacity=1,n.texMemoryUsage+=s.baseColorTexture?.glTexture?.usedMemory||0,s.usePBR&&(n.texMemoryUsage+=s.metallicRoughnessTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.emissionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.occlusionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.normalTexture?.glTexture?.usedMemory||0)}),s.commonMaterialParameters.doubleSided=d.isDoubleSided,s.commonMaterialParameters.cullFace=d.faceCulling?Ct[d.faceCulling]:x.Back,this._initialCullFace.set(j,s.commonMaterialParameters.cullFace),s.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,s.componentParameters.castShadows=Tt.All,s.textureAlphaCutoff=d.alphaCutoff??ze,s.alphaDiscardMode=ye[d.alphaMode],s.isIntegratedMesh=!0,s.polygonOffsetEnabled=!1,s.hasOccludees=!1,s.ellipsoidMode=yt(this.view.spatialReference)}),n.components.push(j),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(j)}if(yield Promise.all(i),o.forEach(r=>{n.textures.push(r)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n,n.totalMemory()),{memUsageBytes:n.totalMemory()}})}freeRenderable(t){let e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(h=>{this._stage.remove(h)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,h){if(this._memCache){for(let i=0;i<h;++i){let o=t[i],n=e[i];if(!n)continue;let m=this._lyrHandleToObjects.get(o);m&&(this._visibleGeometryChanged(),m.isVisible=n,m.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.pop(`${o}`))}for(let i=0;i<h;++i){let o=t[i],n=e[i];if(n)continue;let m=this._lyrHandleToObjects.get(o);m&&(this._visibleGeometryChanged(),m.isVisible=n,m.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.put(`${o}`,m,m.totalMemory()))}}}_getTexture(t,e,h){let i=null;if(t&&e.desc?.images&&e.data?.buffer){let o=e.desc.images[t?.imageId];if(i=h.get(o),!i&&o){let n=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,m=!!o.mipCount||n>1,l=xt[t.wrapMode??P.None],w=o.alpha?4:3,f=new Uint8Array(e.data.buffer,o.data.byteOffset,o.data.byteCount),p=null,a=null,c=null;switch(o.format){case M.Raw:o.pixelFormat===z.R8?(p=f,w=1,a=""):o.pixelFormat===z.Rgb8?(p=f,w=3,a=""):o.pixelFormat===z.Rgba8&&(p=f,w=4,a="");break;case M.Dxt1:p=f,w=3,a=de.DDS_ENCODING;break;case M.Dxt5:p=f,w=4,a=de.DDS_ENCODING;break;case M.Png:a="image/png",c=document.createElement("img");break;case M.Jpeg:a="image/jpeg",c=document.createElement("img");break;case M.Etc2:a="image/ktx",c=document.createElement("img");break;case M.Astc:this._dbg(y.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(c&&a){let r=new Blob([f],{type:a});c.src=URL.createObjectURL(r),p=c}p&&a!=null&&(i=new it(p,{mipmap:m,maxAnisotropy:n,encoding:a,wrap:l,components:w,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(i),h.set(o,i))}}return i?new ft(this.view._stage.renderView.textures,i.id):null}getBufferViews(t,e,h){let i,o,n,m,l,w,f,p=null;for(let a=0;a<t.atrbs.length;a++){let c=t.atrbs[a],r=c.view,g=void 0,d=r.byteOffset+r.byteCount,C=r.byteCount/Pt[r.type],b=[...Array(C).keys()].map(_=>_);try{switch(c.sem){case I.Position:r.ncomp!==3||r.type!==u.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(i=new N(e,r.byteOffset,g,d),o=new S(i.typedBuffer,b,3));break;case I.Normal:if(r.ncomp!==3||r.type!==u.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else{let _=new N(e,r.byteOffset,g,d),Y=je(_.typedBuffer,h);l=new He(Y),w=new S(l.typedBuffer,b,2)}break;case I.TexCoord:r.ncomp!==2||r.type!==u.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):m===void 0&&(m=new S(new De(e,r.byteOffset,g,d).typedBuffer,b,2));break;case I.Color:r.ncomp===4?(r.type===u.F32&&(p=new Le(e,r.byteOffset,g,d)),r.type===u.U8&&(p=new Fe(e,r.byteOffset,g,d)),r.type===u.U16&&(p=new Be(e,r.byteOffset,g,d))):r.ncomp===3&&(r.type===u.F32&&(p=new N(e,r.byteOffset,g,d)),r.type===u.U8&&(p=new Se(e,r.byteOffset,g,d)),r.type===u.U16&&(p=new Re(e,r.byteOffset,g,d))),p==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+r+")"):n=new S(p.typedBuffer,b,r.ncomp);break;case I.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){let a=t.index.view,c=void 0,r=a.byteOffset+a.byteCount;switch(t.index.view.type){case u.U16:f=new oe(e,a.byteOffset,c,r);break;case u.U32:f=new ne(e,a.byteOffset,c,r);break;case u.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+a.type+").")}}if(f==null&&i!=null){let a=i.count;if(a<65535){let c=new Uint16Array(a);f=new oe(c)}else{let c=new Uint32Array(a);f=new ne(c)}for(let c=0;c<a;c++)f.set(c,c)}return{positionView:i,positionAttr:o,colorAttr:n,texCoord0Attr:m,indicesView:f,normalsView:l,normalsAttr:w}}_onRemoveFromCache(t){this._wasm?.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?se.getLogger(this).error(e):se.getLogger(this).warn(e))}};V([D()],O.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),V([D()],O.prototype,"layer",void 0),V([D({readOnly:!0})],O.prototype,"visibleAtCurrentScale",null),V([D()],O.prototype,"elevationOffset",null),O=V([Ce("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],O);var Hr=O;export{Hr as default};
