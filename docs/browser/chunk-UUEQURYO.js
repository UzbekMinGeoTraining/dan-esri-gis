import{a as D,b as N}from"./chunk-6COCDKCX.js";import"./chunk-D4SBRLEM.js";import"./chunk-46ZNFCJZ.js";import"./chunk-4FRQLB6H.js";import"./chunk-6VWB6ZLL.js";import{a as W}from"./chunk-2YEZLTQO.js";import"./chunk-TOUCHIYC.js";import{C as U,E as q}from"./chunk-AB4CTIUZ.js";import"./chunk-2HYJESCC.js";import"./chunk-VJX4SEWU.js";import"./chunk-OZ5LGYCJ.js";import{b as T}from"./chunk-DKD4OKJ2.js";import{a as m,b as L,c as g}from"./chunk-YGTZKLHU.js";import{a as O}from"./chunk-BEXNUKSP.js";import"./chunk-7I5SNEJE.js";import"./chunk-Z7HQSEFF.js";import{a as M}from"./chunk-NPSROKUX.js";import"./chunk-RI2HJFLU.js";import"./chunk-7YHK56KB.js";import"./chunk-PHK5IJNU.js";import"./chunk-OH475TQV.js";import"./chunk-S2YELA2I.js";import"./chunk-KAOR3JAH.js";import"./chunk-ACVF7Z7X.js";import"./chunk-LCRAHT7B.js";import"./chunk-QMGVGOIN.js";import"./chunk-M7Q5ICON.js";import"./chunk-DSHXH3B4.js";import"./chunk-F7R3VTP4.js";import"./chunk-MNU4KXU7.js";import"./chunk-AJSXTGZB.js";import{o as f}from"./chunk-4QRGVGHK.js";import"./chunk-VWT6NXFZ.js";import{p as j}from"./chunk-3KFX3FFC.js";import"./chunk-2WNCPIJC.js";import"./chunk-7ISKCG7U.js";import"./chunk-OFGHVREP.js";import"./chunk-YIBWVOPM.js";import"./chunk-PY5WUUCV.js";import"./chunk-AXPRNSO3.js";import"./chunk-3HX6VT75.js";import"./chunk-U4Y7WABQ.js";import"./chunk-25T3ULWN.js";import"./chunk-X7XJWAFC.js";import"./chunk-CYCLIMTY.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-NH3JQE75.js";import"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import"./chunk-HVNRUZWJ.js";import{a as Z}from"./chunk-AYOI2Y26.js";import"./chunk-ZGDQY5ZD.js";import"./chunk-QH2MD2O2.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import"./chunk-7XLHE26H.js";import"./chunk-EN6CTWVM.js";import"./chunk-LVPMJTA6.js";import{d as R}from"./chunk-O4AQRVFI.js";import"./chunk-NDPAZKBG.js";import"./chunk-7AZ5UVCG.js";import"./chunk-6GGK7PRJ.js";import"./chunk-G3PA3VVF.js";import"./chunk-AO7UDTUI.js";import"./chunk-Q7O5PY54.js";import{a as H}from"./chunk-PFIMJ2UL.js";import"./chunk-CY477QBZ.js";import"./chunk-EJO53FLN.js";import"./chunk-XXR5OT24.js";import"./chunk-4XIZVPNF.js";import"./chunk-F7VAE37R.js";import{m as P}from"./chunk-PM4ZR7W6.js";import"./chunk-ENLR2WBX.js";import{a as G}from"./chunk-RI3FIROF.js";import"./chunk-PJX4LNSV.js";import"./chunk-NNETCWLJ.js";import"./chunk-EPTSNNZF.js";import{h as I,r as x,t as z}from"./chunk-FW33MEBA.js";import"./chunk-RM6CXOHZ.js";import"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-HWN5REN7.js";import"./chunk-XTES2GPX.js";import"./chunk-2HUIJUS4.js";import{a as E,c as C,h as y}from"./chunk-MBJHSEMD.js";import"./chunk-K72LO6P2.js";import"./chunk-R7Q3STHM.js";import"./chunk-G4PDP3HY.js";import"./chunk-EKU2FJZS.js";import"./chunk-NHN544WL.js";import"./chunk-WZ5A3YGX.js";import"./chunk-NKMODNM6.js";import"./chunk-SEKMXZL5.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-LAJXTVEO.js";import"./chunk-5MNDZ6BX.js";import"./chunk-RDHMB7M5.js";import{a as A}from"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import{o as F}from"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import"./chunk-VQHENXDQ.js";import"./chunk-VWF5VUO3.js";import{f as k}from"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-EUZMXXZJ.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{Q as l,S as b}from"./chunk-GGZQ5GCM.js";import{U as w}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as s}from"./chunk-BMVJCP2M.js";import{l as c,s as v,x as S}from"./chunk-GMC3I5VG.js";import"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import"./chunk-3IBUFXWY.js";import{o as _}from"./chunk-BP73DJTS.js";import{g as d}from"./chunk-JEGVIFEP.js";var J="graphics-collections",a=class extends b{get updating(){return this._updatingHandles.updating}get _hasZ(){let e=this.view;return e!=null&&e.type==="3d"&&this.layerSource.layer.type!=="map-notes"}get _snappingElevationAligner(){let{view:e}=this,{layer:t}=this.layerSource,i=e!=null&&e.type==="3d";if(!i||t.type==="map-notes")return m();let o=(r,n)=>d(this,null,function*(){return(yield v(e.whenLayerView(t),n)).elevationAlignPointsInFeatures(r,n)});return m(i,{elevationInfo:t.elevationInfo,alignPointsInFeatures:o})}get _snappingElevationFilter(){let{view:e}=this,t=e!=null&&e.type==="3d"&&this.layerSource.layer.type!=="map-notes";return L(t)}get _symbologySnappingFetcher(){let{view:e}=this,{layer:t}=this.layerSource,i=e!=null&&e.type==="3d",o=this._extrudedPolygonSymbolsCount>0;return i&&t.type!=="map-notes"&&o?g(o,(r,n)=>d(this,null,function*(){let p=yield e.whenLayerView(t);return c(n),p.queryForSymbologySnapping({candidates:r,spatialReference:e.spatialReference},n)})):g()}constructor(e){super(e),this.availability=1,this._sources={multipoint:null,point:null,polygon:null,polyline:null},this._loadedWkids=new Set,this._loadedWkts=new Set,this._pendingAdds=[],this._extrudedPolygonSymbolsCount=0,this._updatingHandles=new Z,this._memoizedMakeGetGroundElevation=W(N)}destroy(){for(let e of this._pendingAdds)e.task.abort();this._pendingAdds.length=0,this._mapSources(e=>this._destroySource(e)),this._updatingHandles.destroy()}initialize(){this._updatingHandles.add(()=>this.getGraphicsLayers(),i=>{this._updatingHandles.removeHandles(J);for(let o of i)this._addMany(o.graphics.toArray()),this.addHandles([o.on("graphic-update",r=>this._onGraphicUpdate(r)),this._updatingHandles.addOnCollectionChange(()=>o.graphics,r=>this._onGraphicsChanged(r))],J)},y);let{view:e}=this,{layer:t}=this.layerSource;e!=null&&e.type==="3d"&&t.type!=="map-notes"&&e.elevationProvider&&this.addHandles([e.elevationProvider.on("elevation-change",({context:i})=>{j(i,t.elevationInfo)&&this._snappingElevationAligner.notifyElevationSourceChange()}),E(()=>t.elevationInfo,()=>this._snappingElevationAligner.notifyElevationSourceChange(),y),C(()=>t,["edits","apply-edits","graphic-update"],()=>this._symbologySnappingFetcher.notifySymbologyChange())])}fetchCandidates(e,t){return d(this,null,function*(){let{point:i,coordinateHelper:{spatialReference:o}}=e,r=yield S(this._mapSources(h=>this._fetchCandidatesForSource(h,e,t)));c(t);let n=this._memoizedMakeGetGroundElevation(this.view,o),p=r.flat().map(h=>D(h,n));return U(i,p),p})}_fetchCandidatesForSource(e,t,i){return d(this,null,function*(){let o=q(t,this.view?.type??"2d"),r=yield e.queryEngine.executeQueryForSnapping(o,i);c(i);let n=yield this._snappingElevationAligner.alignCandidates(r.candidates,t.coordinateHelper.spatialReference,i);c(i);let p=yield this._symbologySnappingFetcher.fetch(n,i);c(i);let h=p.length===0?n:[...n,...p];return this._snappingElevationFilter.filter(o,h)})}refresh(){}_onGraphicUpdate(e){if(this.getGraphicsLayers().some(t=>t.graphics.includes(e.graphic)))switch(e.property){case"geometry":case"visible":this._remove(e.graphic),this._addMany([e.graphic])}}_onGraphicsChanged(e){for(let t of e.removed)this._remove(t);this._addMany(e.added)}_addMany(e){let t=[],i=new Map;for(let o of e)o.geometry!=null&&(this._needsInitializeProjection(o.geometry.spatialReference)?(t.push(o.geometry.spatialReference),i.set(o.uid,o)):this._add(o));this._createPendingAdd(t,i)}_createPendingAdd(e,t){if(!e.length)return;let i=k(n=>d(this,null,function*(){yield z(e.map(p=>({source:p,dest:this.spatialReference})),{signal:n}),this._markLoadedSpatialReferences(e);for(let p of t.values())this._add(p)}));this._updatingHandles.addPromise(i.promise);let o={task:i,graphics:t},r=()=>_(this._pendingAdds,o);i.promise.then(r,r),this._pendingAdds.push(o)}_markLoadedSpatialReferences(e){for(let t of e){t.wkid!=null&&this._loadedWkids.add(t.wkid);let i=t.wkt2||t.wkt;i&&this._loadedWkts.add(i)}}_add(e){if(e.geometry==null||!e.visible)return;let t=e.geometry;if(t.type==="mesh")return;t.type==="extent"&&(t=F.fromExtent(t));let i=this._ensureSource(t.type);if(i==null)return;let o=this._createOptimizedFeature(e.uid,t);o!=null&&(i.featureStore.add(o),f(e.symbol)&&this._extrudedPolygonSymbolsCount++)}_needsInitializeProjection(e){if(e.wkid!=null&&this._loadedWkids.has(e.wkid))return!1;let t=e.wkt2||e.wkt;return(!t||!this._loadedWkts.has(t))&&!x(e,this.spatialReference)}_createOptimizedFeature(e,t){let i=I(T(t),this.spatialReference);if(!i)return null;let o=this._ensureGeometryHasZ(i),r=P(o,this._hasZ,!1);return new G(r,{[u]:e},null,e)}_ensureGeometryHasZ(e){if(!this._hasZ)return e;let t=o=>{for(;o.length<3;)o.push(0)},i=e.clone();switch(i.hasZ=!0,i.type){case"point":i.z=i.z??0;break;case"multipoint":i.points.forEach(t);break;case"polyline":i.paths.forEach(o=>o.forEach(t));break;case"polygon":i.rings.forEach(o=>o.forEach(t))}return i}_ensureSource(e){let t=this._sources[e];if(t!=null)return t;let i=this._createSource(e);return this._sources[e]=i,i}_createSource(e){let t=A.toJSON(e),i=this._hasZ,o=new O({geometryType:t,hasZ:i,hasM:!1});return{featureStore:o,queryEngine:new M({featureStore:o,fieldsIndex:H.fromLayerJSON({fields:[{name:u,type:"esriFieldTypeOID",alias:u}]}),geometryType:t,hasM:!1,hasZ:i,objectIdField:u,spatialReference:this.spatialReference,priority:R.SNAPPING,scheduler:this.view!=null&&this.view.type==="3d"?this.view.resourceController.scheduler:null}),type:e}}_remove(e){this._mapSources(t=>this._removeFromSource(t,e));for(let t of this._pendingAdds)t.graphics.delete(e.uid),t.graphics.size===0&&t.task.abort()}_removeFromSource(e,t){let i=t.uid;e.featureStore.has(i)&&(e.featureStore.removeById(t.uid),f(t.symbol)&&this._extrudedPolygonSymbolsCount--)}_destroySource(e){e.queryEngine.destroy(),this._sources[e.type]=null}_mapSources(e){let{point:t,polygon:i,polyline:o,multipoint:r}=this._sources,n=[];return t!=null&&n.push(e(t)),i!=null&&n.push(e(i)),o!=null&&n.push(e(o)),r!=null&&n.push(e(r)),n}};s([l()],a.prototype,"getGraphicsLayers",void 0),s([l({constructOnly:!0})],a.prototype,"layerSource",void 0),s([l({constructOnly:!0})],a.prototype,"spatialReference",void 0),s([l({constructOnly:!0})],a.prototype,"view",void 0),s([l({readOnly:!0})],a.prototype,"updating",null),s([l({readOnly:!0})],a.prototype,"availability",void 0),s([l()],a.prototype,"_hasZ",null),s([l()],a.prototype,"_snappingElevationAligner",null),s([l()],a.prototype,"_snappingElevationFilter",null),s([l()],a.prototype,"_symbologySnappingFetcher",null),s([l()],a.prototype,"_extrudedPolygonSymbolsCount",void 0),a=s([w("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],a);var u="OBJECTID";export{a as GraphicsSnappingSource};
