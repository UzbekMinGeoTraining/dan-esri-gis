import{a as Ce,b as Oe,d as De,e as Se,f as Fe,g as Ge}from"./chunk-KENSNH4H.js";import{a as Ne}from"./chunk-DLQRCAZ4.js";import{d as Ie,e as xe}from"./chunk-UHCAZ4FA.js";import{i as ve,j as M}from"./chunk-3NGMQGRU.js";import"./chunk-CDG4VMUI.js";import{a as Ee,c as we}from"./chunk-YV4C5J3O.js";import"./chunk-GBBCQMJZ.js";import"./chunk-X6MZ5ATR.js";import"./chunk-D4P3UBRY.js";import"./chunk-NVD74CNP.js";import{a as fe}from"./chunk-QN72YLVS.js";import"./chunk-IVZ2RXL2.js";import"./chunk-NPHNUKYC.js";import"./chunk-2K35ZAGK.js";import"./chunk-YFTQBYV4.js";import{a as pe}from"./chunk-6GII4ES2.js";import{c as ce}from"./chunk-E3DN7XQP.js";import"./chunk-XH7FW5RT.js";import"./chunk-V2QHUPXP.js";import"./chunk-4RJTDUBN.js";import"./chunk-MTRBRBPC.js";import"./chunk-A7GYEEN6.js";import"./chunk-DJGT5PK5.js";import{b as ne,j as de,l as R,p as le,q as he}from"./chunk-HW47RMVO.js";import"./chunk-6GQ5JB2B.js";import"./chunk-3U6BMQLZ.js";import"./chunk-EPEHXQDG.js";import"./chunk-5POQUC4T.js";import"./chunk-ELOFFQD3.js";import"./chunk-VFQ7QZ34.js";import"./chunk-JGPFCHHF.js";import"./chunk-VQ5WF3XI.js";import"./chunk-J2D4NQQB.js";import"./chunk-TGSQQX44.js";import"./chunk-WPTVLDNN.js";import"./chunk-DRK6GLQ3.js";import"./chunk-BRKYWLZQ.js";import"./chunk-DGD6TNOG.js";import"./chunk-YNNF4FWO.js";import"./chunk-SUJDRDW4.js";import"./chunk-WUZAEWWX.js";import"./chunk-Z7HQSEFF.js";import"./chunk-NPSROKUX.js";import"./chunk-RI2HJFLU.js";import"./chunk-7YHK56KB.js";import"./chunk-PHK5IJNU.js";import"./chunk-OH475TQV.js";import"./chunk-S2YELA2I.js";import"./chunk-TOCNTYZ2.js";import"./chunk-KAOR3JAH.js";import"./chunk-ACVF7Z7X.js";import"./chunk-LCRAHT7B.js";import"./chunk-QMGVGOIN.js";import"./chunk-M7Q5ICON.js";import"./chunk-DSHXH3B4.js";import"./chunk-LSPZMBFV.js";import"./chunk-UMYW2XL7.js";import"./chunk-ZRDZCHT6.js";import"./chunk-7BVEXOSH.js";import"./chunk-OW4OHJOK.js";import"./chunk-SV4KOVAG.js";import"./chunk-RHS3EARZ.js";import"./chunk-UYKI77KI.js";import"./chunk-4FO73WSB.js";import"./chunk-Q5GL3CSI.js";import"./chunk-X7CRJ427.js";import"./chunk-4DR6EKLV.js";import"./chunk-2SZOQMAQ.js";import"./chunk-OT635BJR.js";import"./chunk-WCQK6XOZ.js";import"./chunk-RCCESRES.js";import{b as ye}from"./chunk-PA5IAWXD.js";import{a as _e}from"./chunk-AR3SF3CU.js";import"./chunk-DQVRRO4N.js";import{a as be}from"./chunk-MM6IP4FS.js";import"./chunk-WP7QHDBV.js";import"./chunk-BJF27AOA.js";import"./chunk-MNU4KXU7.js";import"./chunk-AJSXTGZB.js";import{h as me}from"./chunk-2F2E6NNR.js";import{a as ge}from"./chunk-RB4JCGG3.js";import"./chunk-MNOCKVQA.js";import"./chunk-SDHCGQUI.js";import"./chunk-VSPQNL6A.js";import"./chunk-7H32J6FD.js";import"./chunk-WIJFCRLT.js";import"./chunk-6ISQQD7M.js";import"./chunk-VHVYC3RW.js";import"./chunk-ZBOVC36T.js";import{b as ue}from"./chunk-RLQK45UV.js";import"./chunk-N3AGC3JB.js";import"./chunk-KHTVZWEX.js";import"./chunk-IGNHVSQC.js";import"./chunk-B3W5V2XP.js";import"./chunk-NP35J4DQ.js";import"./chunk-JBGML6IF.js";import"./chunk-S2HMCZNZ.js";import"./chunk-WUAC4CFP.js";import"./chunk-ONDKJR4V.js";import"./chunk-QB4KDO4M.js";import"./chunk-NNNTRPDR.js";import"./chunk-KDLA3TQ2.js";import"./chunk-RPMDOAYZ.js";import"./chunk-J7UK2QPE.js";import"./chunk-6DXGZQQN.js";import"./chunk-3PK63SMD.js";import"./chunk-RBWI4VLW.js";import"./chunk-MEA3RU4I.js";import"./chunk-3QNHUVFJ.js";import"./chunk-7OTZECLS.js";import"./chunk-XBFBZZXW.js";import"./chunk-LWUJWBPJ.js";import"./chunk-V7QAQAGA.js";import"./chunk-K5V3S3K3.js";import"./chunk-HCCGI45Q.js";import"./chunk-Q6D44QVW.js";import"./chunk-C3EWQ5V5.js";import"./chunk-3UBXEUOT.js";import"./chunk-6WV5YJL7.js";import"./chunk-3AMG6HG6.js";import"./chunk-I6ETUG5Q.js";import"./chunk-4MZSW4Z6.js";import"./chunk-BERIM72F.js";import"./chunk-YOBNM4T6.js";import"./chunk-MEBZWNWT.js";import"./chunk-XZ52TEBV.js";import"./chunk-WAPQB6I3.js";import"./chunk-L3GHXHDP.js";import"./chunk-N6PITG7Q.js";import"./chunk-XC4LDHG5.js";import"./chunk-S3ASAZCA.js";import"./chunk-ZUUCQTSR.js";import"./chunk-GKUBZAEG.js";import"./chunk-UW734WOQ.js";import"./chunk-BIZV3H6H.js";import"./chunk-UCYGH5UZ.js";import"./chunk-ATV5GTE5.js";import"./chunk-X7WNJQZZ.js";import"./chunk-PQPFAB53.js";import"./chunk-QPPQKNYU.js";import"./chunk-MJXFSFCY.js";import{a as C}from"./chunk-6N46AY7Z.js";import"./chunk-TCQTMUK4.js";import"./chunk-AY3YVZUY.js";import"./chunk-7DCEI345.js";import"./chunk-ZG3FCPXY.js";import"./chunk-RIUAG34V.js";import"./chunk-G5SIQY64.js";import"./chunk-WW7S4V24.js";import"./chunk-UGAMS6PU.js";import"./chunk-EHDNZUTT.js";import"./chunk-ECBUS54L.js";import"./chunk-NH7OOX2I.js";import"./chunk-B72PB7U4.js";import"./chunk-644SLL4Y.js";import"./chunk-A54VD7GL.js";import"./chunk-K55ZDM2S.js";import"./chunk-UHYNS4LH.js";import"./chunk-Z3USGHSR.js";import"./chunk-SLEIRDN7.js";import"./chunk-W3OGU5I2.js";import"./chunk-OO4IIGVK.js";import"./chunk-KQHYII76.js";import"./chunk-6I6DPRXI.js";import"./chunk-RNN6GAXL.js";import"./chunk-4IVMQ5PX.js";import"./chunk-CQUOQXLP.js";import"./chunk-VMYCUJRH.js";import"./chunk-PTVRFY4B.js";import"./chunk-3ZOLHUAU.js";import"./chunk-O6YJVL7E.js";import"./chunk-I6ZCG7XQ.js";import"./chunk-URULUATZ.js";import"./chunk-WOTA3FFP.js";import"./chunk-BNUQT6PD.js";import"./chunk-5DAF2FXI.js";import{a as ae}from"./chunk-M2F4B74F.js";import{a as oe}from"./chunk-2WNCPIJC.js";import"./chunk-GDB2EJGA.js";import"./chunk-RDGFIF46.js";import"./chunk-C2ONI6UP.js";import"./chunk-H6LJ2DCJ.js";import"./chunk-IMNO5TXZ.js";import"./chunk-LCDA6FHZ.js";import"./chunk-RZPELDHM.js";import"./chunk-S3J33BKD.js";import"./chunk-NPIYHDQ7.js";import"./chunk-BL63T6AU.js";import"./chunk-AOTWUAUY.js";import"./chunk-VI4TDFI5.js";import"./chunk-GXSLPADW.js";import"./chunk-2HN33SWB.js";import"./chunk-523X5JOP.js";import"./chunk-BXR2KKYP.js";import"./chunk-7ISKCG7U.js";import"./chunk-OFGHVREP.js";import"./chunk-U3ETEC6R.js";import{a as re}from"./chunk-VY6QN6EN.js";import"./chunk-3A66AUSD.js";import"./chunk-UUKQEAQR.js";import"./chunk-6UUMJQNV.js";import"./chunk-ISUG5L3D.js";import"./chunk-FKKNYWR6.js";import"./chunk-YJ3RZNO6.js";import"./chunk-M4PATAW3.js";import"./chunk-NOFXYDQS.js";import"./chunk-4BLMEKFL.js";import"./chunk-RPIA54UY.js";import"./chunk-WRN6YTSB.js";import"./chunk-BQ7BWYEG.js";import"./chunk-H7Y5XCPW.js";import"./chunk-OC7V2CEX.js";import"./chunk-VTCODMOL.js";import"./chunk-B7GIKKEW.js";import"./chunk-AXPRNSO3.js";import"./chunk-FIUHDVVO.js";import"./chunk-3HX6VT75.js";import"./chunk-U4Y7WABQ.js";import"./chunk-WYOOSF42.js";import"./chunk-R7P6RQXJ.js";import{b as se}from"./chunk-4I7LQWUX.js";import{a as ie}from"./chunk-JLNQ6WQT.js";import"./chunk-GB5RQL32.js";import"./chunk-R6S6A5GA.js";import"./chunk-25T3ULWN.js";import"./chunk-4OZVVJHM.js";import"./chunk-IZRBPB5G.js";import"./chunk-X7XJWAFC.js";import"./chunk-FOAEOOK3.js";import"./chunk-ILCAH2F6.js";import"./chunk-CYCLIMTY.js";import"./chunk-C3YONAAM.js";import"./chunk-2GSAHDXY.js";import"./chunk-OL24FY3J.js";import"./chunk-QBRYULPI.js";import"./chunk-GPQLPPA5.js";import"./chunk-OXRGERMH.js";import"./chunk-HVNUIUKO.js";import"./chunk-Y5M2SONX.js";import"./chunk-Q6ZVH4MK.js";import"./chunk-OL43UY3L.js";import"./chunk-H2QMNAXT.js";import"./chunk-GKUDWGVQ.js";import"./chunk-NZ7WSL6F.js";import"./chunk-RRDM7P6F.js";import"./chunk-LCTRO7CL.js";import"./chunk-7X2HMUNN.js";import"./chunk-LW2464MZ.js";import"./chunk-WJDHM47L.js";import"./chunk-LWJTIQQT.js";import"./chunk-IHBD2IWR.js";import"./chunk-NH3JQE75.js";import"./chunk-XXOIKNT6.js";import"./chunk-DBLGLVAQ.js";import"./chunk-HVNRUZWJ.js";import"./chunk-AYOI2Y26.js";import{b as G}from"./chunk-ZGDQY5ZD.js";import"./chunk-QH2MD2O2.js";import"./chunk-6EZNY6L4.js";import"./chunk-3IK5VXZ3.js";import"./chunk-7XLHE26H.js";import"./chunk-MBVOWLUI.js";import"./chunk-EN6CTWVM.js";import{e as te}from"./chunk-KLUVHTFQ.js";import"./chunk-JMSMQ4Z7.js";import"./chunk-IRJNWXGT.js";import"./chunk-LVPMJTA6.js";import"./chunk-7LUQF6AI.js";import{d as X}from"./chunk-O4AQRVFI.js";import"./chunk-NDPAZKBG.js";import"./chunk-7AZ5UVCG.js";import"./chunk-6GGK7PRJ.js";import"./chunk-G3PA3VVF.js";import"./chunk-AO7UDTUI.js";import"./chunk-Q7O5PY54.js";import"./chunk-PFIMJ2UL.js";import"./chunk-CY477QBZ.js";import"./chunk-EJO53FLN.js";import"./chunk-XXR5OT24.js";import"./chunk-4XIZVPNF.js";import"./chunk-F7VAE37R.js";import"./chunk-PM4ZR7W6.js";import"./chunk-ENLR2WBX.js";import"./chunk-RI3FIROF.js";import"./chunk-PJX4LNSV.js";import"./chunk-NNETCWLJ.js";import{a as A,b as Y}from"./chunk-EPTSNNZF.js";import"./chunk-FW33MEBA.js";import{a as J}from"./chunk-RM6CXOHZ.js";import{p as P}from"./chunk-AOA5JMXK.js";import"./chunk-TWW3KW7Z.js";import"./chunk-I6LCIPDY.js";import"./chunk-Y6H3NTW7.js";import"./chunk-J6ZRC6RI.js";import"./chunk-EBGO44EK.js";import"./chunk-7W6RATG7.js";import"./chunk-45SNVLPM.js";import"./chunk-BDF7KEUQ.js";import"./chunk-HWN5REN7.js";import"./chunk-B4JAL745.js";import"./chunk-XTES2GPX.js";import{c as ee}from"./chunk-2HUIJUS4.js";import"./chunk-VDNXTMSC.js";import{a as z,h as N}from"./chunk-MBJHSEMD.js";import"./chunk-K72LO6P2.js";import"./chunk-R7Q3STHM.js";import{d as $}from"./chunk-G4PDP3HY.js";import"./chunk-EKU2FJZS.js";import"./chunk-NHN544WL.js";import"./chunk-WZ5A3YGX.js";import"./chunk-NKMODNM6.js";import"./chunk-SEKMXZL5.js";import"./chunk-2R4SNL6O.js";import"./chunk-MXOOOTCV.js";import"./chunk-7D4IYTAJ.js";import"./chunk-TSNWBMBA.js";import"./chunk-GLWPOGYF.js";import"./chunk-YFBPRKIN.js";import"./chunk-P2YRCTWM.js";import"./chunk-OFZ6SV37.js";import"./chunk-LAJXTVEO.js";import"./chunk-5MNDZ6BX.js";import"./chunk-RDHMB7M5.js";import"./chunk-YSOJWUIW.js";import"./chunk-Q5WFUDPQ.js";import"./chunk-DPZGANVI.js";import"./chunk-T7BKG6V3.js";import"./chunk-R6VC74T7.js";import"./chunk-6WKJD7BM.js";import"./chunk-3CR7P5WT.js";import"./chunk-YRTBL7EE.js";import"./chunk-3FPO2LOS.js";import"./chunk-QNZSBADV.js";import{a as Z,i as K}from"./chunk-PYQRTZNZ.js";import"./chunk-S4PLWG55.js";import"./chunk-DZAY272R.js";import"./chunk-GYH7NDHH.js";import"./chunk-S3UQHW42.js";import"./chunk-VQHENXDQ.js";import{a as U}from"./chunk-VWF5VUO3.js";import"./chunk-HRP5LYWJ.js";import"./chunk-BIVFGNT6.js";import"./chunk-EUZMXXZJ.js";import"./chunk-7PEPFLZH.js";import"./chunk-BRVOQZDM.js";import"./chunk-3M7VXIQH.js";import"./chunk-TBYT66N3.js";import"./chunk-5PTS4JDF.js";import"./chunk-MUI46NAG.js";import{o as B,p as W}from"./chunk-N27U3N2T.js";import"./chunk-4R5NBZMW.js";import"./chunk-NDYVXEZ5.js";import"./chunk-CMMPCPP5.js";import"./chunk-4DLSYLKE.js";import"./chunk-VPXBKZQM.js";import"./chunk-ZTKK3KB7.js";import"./chunk-GZXWFBZI.js";import"./chunk-B7IARA3F.js";import"./chunk-IZVEJCCI.js";import"./chunk-TEY6TKJV.js";import"./chunk-4M6XQSBA.js";import"./chunk-2JF6YUJG.js";import{K as F,Q as g}from"./chunk-GGZQ5GCM.js";import{U as k,s as Q,t as T}from"./chunk-TFUPB3ZG.js";import"./chunk-ANPNMGFG.js";import{a as c}from"./chunk-BMVJCP2M.js";import"./chunk-GMC3I5VG.js";import{b as _}from"./chunk-WGF2T2BG.js";import"./chunk-YZP43POT.js";import"./chunk-VEDIBGHD.js";import{r as E}from"./chunk-3IBUFXWY.js";import{M as q,l as j}from"./chunk-BP73DJTS.js";import{g as f}from"./chunk-JEGVIFEP.js";var w=class extends pe{constructor(e){super("SceneLayerWorker","dracoDecompressPointCloudData",{dracoDecompressPointCloudData:r=>[r.geometryBuffer]},e,{hasInitialize:!0})}};var O=class extends U{constructor(e,r){super(),this._updateAndCompare=e,this._notifyUpdated=r,this._nodes=new Map,this._graphics=new Map,this._duplicates=new Map}clear(){if(this._graphics.size>0){let e=this.toArray();this._graphics.clear(),this.emit("change",{added:[],removed:e})}this._nodes.clear()}get length(){return this._graphics.size}get(e){return this._graphics.get(e)}getNode(e){return this._nodes.get(e)}hasNode(e){return this._nodes.has(e)}nodes(){return this._nodes.values()}addNode(e,r){this._nodes.set(e,r);let i=r.graphics;if(i.length===0)return;let s=new Set;for(let a=0;a<i.length;a++){let n=i[a],d=n.objectId,p=this._graphics.get(d);if(p){s.add(d),n!==p&&(i[a]=p);let h=this._duplicates.get(d);h?h.push(e):this._duplicates.set(d,[p.nodeIndex,e])}else n.nodeIndex=e,this._graphics.set(d,n)}s.size&&this._updateForeignGraphics(r);let o=s.size>0?i.filter(a=>!s.has(a.objectId)):i;o.length>0&&this.emit("change",{added:o,removed:[]})}removeNode(e){let r=this._nodes.get(e);if(!r)return;this._nodes.delete(e);let i=new Set,s=[];for(let o of r.graphics){let a=o.objectId,n=this._graphics.get(a);if(!n)continue;let d=this._duplicates.get(a);if(d){let p=d.indexOf(e);if(p===-1)continue;if(d.splice(p,1),n.nodeIndex===e){let h=this.getNode(d[0]);for(let l=1;l<d.length;l++){let b=this.getNode(d[l]);(h==null||b!=null&&b.node.level>h.node.level)&&(h=b)}h!=null&&i.add(h)}d.length===1&&this._duplicates.delete(a)}else this._graphics.delete(a),s.push(o)}s.length>0&&this.emit("change",{added:[],removed:s}),i.forEach(o=>this._updateForeignGraphics(o))}_updateForeignGraphics(e){let r=[],i=e.node.index,s=e.node.level,o=0;for(;o<e.graphics.length;){let a=e.graphics[o].nodeIndex;if(a===i){o++;continue}let n=1;for(;o+n<e.graphics.length&&e.graphics[o+n].nodeIndex===a;)n++;let d=this.getNode(a);if(d!=null&&d.node.level>s)o+=n;else{for(let p=o;p<o+n;p++){let h=e.graphics[p];h.nodeIndex=i,this._updateAndCompare(h,e,p)&&r.push(h)}o+=n}}r.length>0&&this._notifyUpdated(r)}toArray(){return Array.from(this._graphics.values())}find(e){return T(this._graphics,e)}some(e){return Q(this._graphics,e)}forEach(e){this._graphics.forEach(r=>e(r))}forEachNode(e){this._nodes.forEach((r,i)=>e(r,i))}get nodeCount(){return this._nodes.size}_checkInvariants(){let e=new Map;this._nodes.forEach((r,i)=>{r.graphics.forEach(s=>{e.set(s.objectId,1+(e.get(s.objectId)??0)),this._duplicates.get(s.objectId)})}),e.forEach((r,i)=>{let s=this._graphics.get(i);if(!s||!this._nodes.get(s.nodeIndex))return;let o=this._duplicates.get(i);o&&o.forEach(a=>{this._nodes.get(a)})})}};var Ae=Se(),H=class{constructor(e,r,i,s){this.graphics=e,this.featureIds=r,this.attributeInfo=i,this.node=s}},u=class extends xe(Ie(Ne(fe(Ge)))){constructor(){super(...arguments),this.type="scene-layer-graphics-3d",this._queryEngine=null,this._memCache=null,this._interactiveEditingSessions=new Map,this._pendingEditsQueue=Promise.resolve(),this.loadedGraphics=new O((t,e,r)=>Me(t,e,r),t=>this.processor.graphicsCore.recreateGraphics(t)),this.holeFilling="always",this.progressiveLoadFactor=1,this.supportsHeightUnitConversion=!0,this._coordinatesOutsideExtentErrors=0,this._maxCoordinatesOutsideExtentErrors=20}tryRecycleWith(t,e){return t.url===this.layer.url&&this._i3sOverrides.isEmpty?t.load(e).then(()=>{le(this.layer,t,this._i3sOverrides),this.layer=t,this._i3sOverrides.destroy();let r=this.view.resourceController?.memoryController;this._i3sOverrides=new M({view:this.view,layer:t,memoryController:r}),_(this._queryEngine),this._setupQueryEngine(),this.processor.resetObjectStates()}):null}initialize(){this.addResolvingPromise(this.layer.indexInfo);let t=this.view.resourceController?.memoryController;this._i3sOverrides=new M({view:this.view,layer:this.layer,memoryController:t}),he(this.layer,this.view.spatialReference,this.view.viewingMode),this._fieldsHelper=new Fe({layerView:this}),this._updatingHandles.add(()=>this.layer.rangeInfos,e=>this._rangeInfosChanged(e),N),this._updatingHandles.add(()=>this.layer.renderer,(e,r)=>this._rendererChange(e,r)),this._updatingHandles.add(()=>[this.parsedDefinitionExpression,this._excludeObjectIdsSorted],()=>this._filterChange()),this.addHandles(z(()=>C.I3S_TREE_SHOW_TILES,e=>{if(e&&!this._treeDebugger){let r=this._controller.crsIndex;import("./chunk-6APADQGB.js").then(({I3STreeDebugger:i})=>{!this._treeDebugger&&C.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new i({lv:this,view:this.view,nodeSR:r}))})}else e||!this._treeDebugger||C.I3S_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)},N)),this._set("processor",new we({owner:this,preferredUpdatePolicy:be.ASYNC,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,setUidToIdOnAdd:!1,dataExtent:this.layer.fullExtent,updateClippingExtent:e=>this._updateClippingExtent(e)})),this.processor.elevationAlignment?.events.on("invalidate-elevation",({extent:e,spatialReference:r})=>this._controller.updateElevationChanged(e,r)),this.supportsHeightUnitConversion&&(this._verticalScale=J("point",this.layer.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.processor.when()),this._memCache=this.view.resourceController.memoryController.newCache(`psl-${this.uid}`),this._controller=new ve({layerView:this}),ne(this.layer.geometryDefinitions)&&(this._worker=new w(e=>this.view.resourceController.immediate.schedule(e))),this.addHandles(this.layer.on("apply-edits",e=>this._updatingHandles.addPromise(e.result))),this.addHandles(this.layer.on("edits",e=>{let r=this._pendingEditsQueue.then(()=>this._handleEdits(e)).then();this._pendingEditsQueue=r,this._updatingHandles.addPromise(r)})),this.when(()=>{this._setupQueryEngine(),this._updatingHandles.add(()=>this.maximumNumberOfFeatures,e=>this._controller.featureTarget=e,N),this._updatingHandles.add(()=>this.suspended,e=>{e&&this._removeAllNodeData()})})}destroy(){this._treeDebugger=_(this._treeDebugger),this._i3sOverrides=_(this._i3sOverrides),this._set("processor",_(this.processor)),this._controller=_(this._controller),this._queryEngine=_(this._queryEngine),this._worker=_(this._worker),this._memCache=_(this._memCache),this.loadedGraphics.clear(),this._fieldsHelper=_(this._fieldsHelper)}get i3slayer(){return this.layer}get updatingProgressValue(){return this._controller?.updatingProgress??1}get requiredFields(){return this._fieldsHelper?.requiredFields??[]}get maximumNumberOfFeatures(){return this.processor?.graphicsCore?.displayFeatureLimit?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(t){t!=null?(this._override("maximumNumberOfFeatures",t),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}get maximumNumberOfFeaturesExceeded(){return!this.suspended&&!!this._controller?.useMaximumNumberOfFeatures&&!this._controller.leavesReached}get _excludeObjectIdsSorted(){let t=this.layer.excludeObjectIds;return t.length?t.toArray().sort((e,r)=>e-r):null}get lodFactor(){return this.layer.semantic==="Labels"?1:this.view.qualitySettings.sceneService.point.lodFactor}get hasM(){return!1}get hasZ(){return!0}get contentVisible(){return!this.suspended&&!!this._controller?.rootNodeVisible}get legendEnabled(){return this.contentVisible&&this.i3slayer?.legendEnabled===!0}whenGraphicAttributes(t,e){return f(this,null,function*(){return de(this.layer,t,this._getObjectIdField(),e,()=>[...this.loadedGraphics.nodes()])})}getHit(t){if(!this.loadedGraphics)return null;let e=ue(this.loadedGraphics.find(i=>i.uid===t),this.layer),r=this._getObjectIdField();return e?.attributes?.[r]?(e.layer=this.layer,e.sourceLayer=this.layer,{type:"graphic",graphic:e,layer:e.layer}):null}whenGraphicBounds(t,e){return this.processor.whenGraphicBounds(t,e)}computeAttachmentOrigin(t,e){return this.processor.computeAttachmentOrigin(t,e)}isUpdating(){return!!(this._controller?.updating||this.processor?.updating||this._fieldsHelper?.updating||this.layerFilterUpdating)}highlight(t,e){return this.processor.highlight(t,this.layer.objectIdField,e??me)}get updatePolicy(){return this.processor.graphicsCore.effectiveUpdatePolicy}createInteractiveEditSession(t){return Ce(this._attributeEditingContext,t)}_decompressBinaryPointData(t,e){return f(this,null,function*(){let r={geometryBuffer:t.geometryBuffer};this._worker==null&&(this._worker=new w(s=>this.view.resourceController.immediate.schedule(s)));let i=yield this._worker.invoke(r,e);if(i==null)throw new Error("Failed to decompress Draco point data");return{positionData:i.positions,featureIds:i.featureIds}})}addNode(t,e,r){return f(this,null,function*(){if(!V(e)&&!Re(e))throw new Error;if(this.loadedGraphics.hasNode(t.index))return void E.getLogger(this).error("I3S node "+t.id+" already added");let i=this.layer.fullExtent!=null?Ve(this.layer.fullExtent.clone(),.5):null,{featureIds:s,pointPositions:o}=V(e)?yield this._extractBinaryPointPositions(t,e,r):this._extractLegacyPointPositions(e),a=new Array;this._validatePositions(t,s,o,i,a);let n=this._controller.crsVertex,d=this.view.spatialReference;P(o,n,0,o,d,0,s.length);let p=V(e)?t.level:0,h=this._createGraphics(s,o,t.index,p),l=new H(h,s,e.attributeDataInfo,t);if(yield this._i3sOverrides.applyAttributeOverrides(l.featureIds,e.attributeDataInfo,r),t.numFeatures=l.graphics.length,this._updateNodeMemory(t),L(l),a.length>0&&(this._computeObb(t,a,n),this._controller.updateVisibility(t.index)),!this._controller.isGeometryVisible(t))return void this._cacheNodeData(l);if(this._verticalScale!=null)for(let x of l.graphics)this._verticalScale(x.geometry);let b=this.view._stage.renderView.olidRenderHelper;if(b){let x=$(this.view.map,this.layer.uid);for(let m=0;m<l.featureIds.length;m++){let D=l.featureIds[m];b.setUidToObjectAndLayerId(D,l.graphics[m].uid,this.layer.id,this.layer.uid,this.layer.popupEnabled&&!x&&ce(this.layer,this.view.popup?.defaultPopupTemplateEnabled),l.node.resources.attributes,m)}}this.loadedGraphics.addNode(t.index,l),this._controller.updateLoadStatus(t.index,!0),this._filterNode(l),this._treeDebugger&&this._treeDebugger.update()})}_computeObb(t,e,r){let i=this._controller.crsIndex,s=i.isGeographic?this.view.renderSpatialReference:i;P(e,r,0,e,s,0),t.serviceObbInIndexSR=se(new ie(e,3)),i.isGeographic&&(ae(t.serviceObbInIndexSR.center,s,I,i),t.serviceObbInIndexSR.center=I)}isNodeLoaded(t){return this.loadedGraphics.hasNode(t)}isNodeReloading(){return!1}updateNodeState(){}_extractBinaryPointPositions(t,e,r){return f(this,null,function*(){let i=yield this._decompressBinaryPointData(e,r),s=i.positionData,o=3,a=s.length/o,n=A(3*a),d=t.serviceObbInIndexSR!=null?t.serviceObbInIndexSR.center:K,p=Math.abs(d[2])*2**-20;for(let h=0;h<a;h++){let l=h*o;n[l]=s[l]+d[0],n[l+1]=s[l+1]+d[1],n[l+2]=s[l+2]+d[2],Math.abs(n[l+2])<p&&(n[l+2]=0)}return{featureIds:i.featureIds?Y(i.featureIds):[],pointPositions:n}})}_extractLegacyPointPositions(t){let e=t.pointData.length,r=A(3*e),i=new Array;for(let s=0;s<e;s++){let o=t.pointData[s],a=o.featureDataPosition,n=a.length,d=o.geometries?.[0]??Le[n],p=o.featureIds[0];if(d.type!=="Embedded"||d.params.type!=="points"||n<2||n>3)continue;let h=d.params.vertexAttributes?.position??[0,0,0],l=3*i.length;r[l]=a[0]+h[0],r[l+1]=a[1]+h[1],r[l+2]=n===3?a[2]+h[2]:NaN,i.push(p)}return{featureIds:i,pointPositions:r}}_validatePositions(t,e,r,i,s){if(i==null&&t.serviceObbInIndexSR)return;let o=e.length,a=3;for(let n=0;n<o;n++){let d=n*a;ee(I,r[d],r[d+1],r[d+2]);let p=!Number.isNaN(r[2]);i==null||(p?W(i,I):B(i,I))||(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&E.getLogger(this).error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&E.getLogger(this).error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++),t.serviceObbInIndexSR||s.push(I[0],I[1],I[2])}}_createGraphics(t,e,r,i){let s=t.length,o=3,a=this._getObjectIdField(),n=this.processor.graphicsCore,d=new Array,p=this.view.spatialReference;for(let h=0;h<s;h++){let l=t[h],b={};l!=null&&(b[a]=l);let x=l??F(),m=h*o,D=isNaN(e[m+2])?void 0:e[m+2],S=oe(e[m],e[m+1],D,p),v=this.loadedGraphics.get(x);if(v!=null)(v.level==null||v.level<i)&&(y.property="geometry",y.graphic=v,y.oldValue=v.geometry,y.newValue=S,v.geometry=S,v.level=i,n.graphicUpdateHandler(y)),d.push(v);else{let Pe=F();d.push({objectId:x,uid:Pe,geometry:S,attributes:b,visible:!0,nodeIndex:r,level:i})}}return d}_updateNodeMemory(t){t.memory=4096+(t.numFeatures!=null?t.numFeatures*this.processor.graphicsCore.usedMemoryPerGraphic:0)}_cacheNodeData(t){let e=t.graphics.reduce((r,i)=>te(i)+r,q(t.featureIds)+1024);this._memCache.put(this._getMemCacheKey(t.node),t,e)}_getMemCacheKey(t){return`${t.index}`}_removeAllNodeData(){this.loadedGraphics.forEachNode((t,e)=>{if(t){let r=t.node;this._updateNodeMemory(r),this._cacheNodeData(t)}this._controller.updateLoadStatus(e,!1)}),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}removeNode(t){let e=this._removeNodeStageData(t);e&&(this._updateNodeMemory(e.node),this._cacheNodeData(e))}_removeNodeStageData(t){let e=this.loadedGraphics.getNode(t);return e==null?null:(this._controller.updateLoadStatus(t,!1),this.loadedGraphics.removeNode(t),this._treeDebugger&&this._treeDebugger.update(),e)}loadCachedNodeData(t){return f(this,null,function*(){return this._memCache?.pop(this._getMemCacheKey(t))})}addCachedNodeData(t,e,r,i){return f(this,null,function*(){this.loadedGraphics.hasNode(t.index)?E.getLogger(this).error("I3S node "+t.id+" already added"):(yield this._i3sOverrides.applyAttributeOverrides(e.featureIds,r,i),e.attributeInfo=r,this.loadedGraphics.addNode(t.index,e),this._controller.updateLoadStatus(t.index,!0),this._updateNodeMemory(t),L(e),this._filterNode(e),this._treeDebugger&&this._treeDebugger.update())})}getLoadedNodeIds(){let t=[];return this.loadedGraphics.forEachNode(e=>t.push(e.node.id)),t.sort()}getVisibleNodes(){let t=new Array;return this.loadedGraphics.forEachNode(e=>t.push(e.node)),t}getLoadedNodeIndices(t){this.loadedGraphics.forEachNode((e,r)=>t.push(r))}getLoadedAttributes(t){let e=this.loadedGraphics.getNode(t);if(e?.attributeInfo!=null)return e.attributeInfo.loadedAttributes}getAttributeData(t){let e=this.loadedGraphics.getNode(t);if(e?.attributeInfo!=null)return e.attributeInfo.attributeData}_setAttributeData(t,e){let r=this.loadedGraphics.getNode(t);r?.attributeInfo!=null&&(r.attributeInfo.attributeData=e,this._attributeValuesChanged(r))}updateAttributes(t,e,r){return f(this,null,function*(){let i=this.loadedGraphics.getNode(t);i!=null&&(yield this._i3sOverrides.applyAttributeOverrides(i.featureIds,e,r),i.attributeInfo=e,this._attributeValuesChanged(i))})}_attributeValuesChanged(t){L(t),this._filterNode(t);let{processor:e}=this,{graphicsCore:r}=e;if(r.labelsEnabled){let i=t.node.index,s=new Array;t.graphics.forEach(o=>o.nodeIndex===i&&s.push(o.uid)),r.updateLabelingInfo(s)}e.refreshFilter()}_updateClippingExtent(t){return this._controller&&this._controller.updateClippingArea(t),!1}_getObjectIdField(){return this.layer.objectIdField||ge}_getGlobalIdField(){return this.layer.associatedLayer?.globalIdField}_rendererChange(t,e){return f(this,null,function*(){let{layer:{fieldsIndex:r}}=this,i=new Set,s,o;t?(yield t.collectRequiredFields(i,r),s=Array.from(i).sort()):s=[],i.clear(),e?(yield e.collectRequiredFields(i,r),o=Array.from(i).sort()):o=[],s.length===o.length&&s.every((a,n)=>s[n]===o[n])||this._reloadAllNodes()})}_rangeInfosChanged(t){t!=null&&t.length>0&&E.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}_filterChange(){this.loadedGraphics.forEachNode(t=>this._filterNode(t))}_reloadAllNodes(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}_filterNode(t){let e=this.parsedDefinitionExpression,r=this._excludeObjectIdsSorted,i=this._getObjectIdField();for(let s of t.graphics){let o=s.visible,a=!e||this._evaluateClause(e,s),n=r==null||j(r,s.attributes[i])<0;s.visible=a&&n,o!==s.visible&&(y.graphic=s,y.property="visible",y.oldValue=o,y.newValue=s.visible,this.processor.graphicsCore.graphicUpdateHandler(y))}}createQuery(){let t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return this.filter!=null?this.filter.createQuery(t):new G(t)}queryFeatures(t,e){return this._queryEngine.executeQuery(this._ensureQuery(t),e?.signal)}queryObjectIds(t,e){return this._queryEngine.executeQueryForIds(this._ensureQuery(t),e?.signal)}queryFeatureCount(t,e){return this._queryEngine.executeQueryForCount(this._ensureQuery(t),e?.signal)}queryExtent(t,e){return this._queryEngine.executeQueryForExtent(this._ensureQuery(t),e?.signal)}_ensureQuery(t){return this._addDefinitionExpressionToQuery(t==null?this.createQuery():G.from(t))}_setupQueryEngine(){let t=()=>this.processor.featureStore;this._queryEngine=new Ee({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return t()},hasZ:this.hasZ,hasM:this.hasM},priority:X.FEATURE_QUERY_ENGINE})}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return .8*((this._controller?.unloadedMemoryEstimate??0)+(this.processor?.graphicsCore?.unprocessedMemoryEstimate??0))}get ignoresMemoryFactor(){return this._controller&&this._controller.fixedFeatureTarget}_handleEdits(t){return f(this,null,function*(){let e=this._attributeEditingContext,r=yield Oe(e,t);De(e,r)})}get _attributeEditingContext(){let t=this._getObjectIdField(),e=this._getGlobalIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:t,globalIdField:e,forEachNode:r=>this.loadedGraphics.forEachNode(i=>r(i.node,i.featureIds)),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this._i3sOverrides,getAttributeData:r=>this.getAttributeData(r),setAttributeData:(r,i,s)=>{this._setAttributeData(r,i);let o=this.loadedGraphics.getNode(r);if(s!=null){let a=this.loadedGraphics.get(s.attributes[t]);a!=null&&this.processor.graphicsCore.recreateGraphics([a])}else o!=null&&this.processor.graphicsCore.recreateGraphics(o.graphics)},clearMemCache:()=>{}}}get performanceInfo(){return new _e(this.usedMemory,this.loadedGraphics.length,-1,this.maximumNumberOfFeatures,this.loadedGraphics.nodeCount,this.processor.graphicsCore.performanceInfo)}get test(){}};c([g()],u.prototype,"processor",void 0),c([g({type:re})],u.prototype,"filter",void 0),c([g()],u.prototype,"loadedGraphics",void 0),c([g()],u.prototype,"i3slayer",null),c([g()],u.prototype,"_controller",void 0),c([g()],u.prototype,"updating",void 0),c([g()],u.prototype,"suspended",void 0),c([g()],u.prototype,"holeFilling",void 0),c([g(ye)],u.prototype,"updatingProgress",void 0),c([g()],u.prototype,"updatingProgressValue",null),c([g(Ae.requiredFields)],u.prototype,"requiredFields",null),c([g(Ae.availableFields)],u.prototype,"availableFields",void 0),c([g()],u.prototype,"_fieldsHelper",void 0),c([g({type:Number})],u.prototype,"maximumNumberOfFeatures",null),c([g({readOnly:!0})],u.prototype,"maximumNumberOfFeaturesExceeded",null),c([g()],u.prototype,"_excludeObjectIdsSorted",null),c([g({readOnly:!0})],u.prototype,"lodFactor",null),c([g({readOnly:!0})],u.prototype,"hasM",null),c([g({readOnly:!0})],u.prototype,"hasZ",null),c([g()],u.prototype,"contentVisible",null),c([g({readOnly:!0})],u.prototype,"legendEnabled",null),u=c([k("esri.views.3d.layers.SceneLayerGraphicsView3D")],u);var Ht=u;function Re(t){return"pointData"in t}function V(t){return"geometryBuffer"in t&&t.geometryBuffer!==null}function Me(t,e,r){let i=e.attributeInfo;if(i?.loadedAttributes==null||i.attributeData==null)return!1;let s=!1;for(let{name:o}of i.loadedAttributes)if(i.attributeData[o]){let a=R(i.attributeData[o],r);a!==t.attributes[o]&&(t.attributes[o]=a,s=!0)}return s}function L(t){let e=t.attributeInfo,r=t.node.index;if(e?.loadedAttributes!=null&&e.attributeData!=null)for(let i=0;i<t.graphics.length;i++){let s=t.graphics[i];if(s.nodeIndex===r){s.attributes||(s.attributes={});for(let{name:o}of e.loadedAttributes)e.attributeData[o]&&(s.attributes[o]=R(e.attributeData[o],i))}}}function Ve(t,e){return t.xmin-=e,t.ymin-=e,t.xmax+=e,t.ymax+=e,t.zmin!=null&&t.zmax!=null&&(t.zmin-=e,t.zmax+=e),t.mmin!=null&&t.mmax!=null&&(t.mmin-=e,t.mmax+=e),t}var Le={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},I=Z(),y={graphic:null,property:null,oldValue:null,newValue:null};export{Ht as default};
